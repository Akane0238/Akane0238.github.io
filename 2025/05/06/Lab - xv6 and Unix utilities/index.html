<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>6.s081 Lab: Xv6 and Unix utilities | Tech_Islet</title><meta name="author" content="è˜‹æœ«é£"><meta name="copyright" content="è˜‹æœ«é£"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="sleep  Implement a user-levelÂ sleepÂ program for xv6, along the lines of the UNIX sleep command. YourÂ sleepÂ should pause for a user-specified number of ticks. A tick is a notion of time defined by the">
<meta property="og:type" content="article">
<meta property="og:title" content="6.s081 Lab: Xv6 and Unix utilities">
<meta property="og:url" content="http://example.com/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/index.html">
<meta property="og:site_name" content="Tech_Islet">
<meta property="og:description" content="sleep  Implement a user-levelÂ sleepÂ program for xv6, along the lines of the UNIX sleep command. YourÂ sleepÂ should pause for a user-specified number of ticks. A tick is a notion of time defined by the">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/avatar.jpg">
<meta property="article:published_time" content="2025-05-06T09:13:39.861Z">
<meta property="article:modified_time" content="2025-05-06T09:20:33.730Z">
<meta property="article:author" content="è˜‹æœ«é£">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.jpg"><link rel="shortcut icon" href="../../../../img/crown.png"><link rel="canonical" href="http://example.com/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="../../../../css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '6.s081 Lab: Xv6 and Unix utilities',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-06 17:20:33'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="atom.xml" title="Tech_Islet" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="../../../../img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="../../../../archives/"><div class="headline">æ–‡ç« </div><div class="length-num">27</div></a><a href="../../../../tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="../../../../categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="../../../../index.html"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="../../../../archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://wallpaperaccess.com/full/8045532.png')"><nav id="nav"><span id="blog-info"><a href="../../../../index.html" title="Tech_Islet"><span class="site-name">Tech_Islet</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="../../../../index.html"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="../../../../archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">6.s081 Lab: Xv6 and Unix utilities</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-05-06T09:13:39.861Z" title="å‘è¡¨äº 2025-05-06 17:13:39">2025-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-05-06T09:20:33.730Z" title="æ›´æ–°äº 2025-05-06 17:20:33">2025-05-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="6.s081 Lab: Xv6 and Unix utilities"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="sleep"><a class="markdownIt-Anchor" href="#sleep"></a> sleep</h1>
<blockquote>
<p>Implement a user-levelÂ <code>sleep</code>Â program for xv6, along the lines of the UNIX sleep command. YourÂ sleepÂ should pause for a user-specified number of ticks. A tick is a notion of time defined by the xv6 kernel, namely the time between two interrupts from the timer chip.</p>
</blockquote>
<p>å®éªŒè¦æ±‚å®ç°ä¸€ä¸ª sleep å‘½ä»¤è¡Œå‘½ä»¤<code>sleep.c</code>ï¼Œåœ¨å®ç°ä¸­è°ƒç”¨çš„<code>int sleep(int)</code>æ˜¯ xv6 æä¾›çš„ sleep syscall çš„ç³»ç»Ÿè°ƒç”¨å°è£…ï¼Œé€šè¿‡é“¾æ¥<code>user/usys.S</code>è·³è½¬åˆ°å®é™…å†…æ ¸ä»£ç çš„å®ç°<code>sys_sleep</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.global sleep         ; å£°æ˜ sleep ä¸ºå…¨å±€ç¬¦å·ï¼Œå¯ä¾›å¤–éƒ¨è°ƒç”¨</span><br><span class="line">sleep:                ; å‡½æ•°å…¥å£</span><br><span class="line">    li a7, SYS_sleep  ; å°†ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼ˆSYS_sleepï¼‰åŠ è½½åˆ°å¯„å­˜å™¨ a7</span><br><span class="line">    ecall             ; è§¦å‘environmental callï¼ˆå³trapï¼‰</span><br><span class="line">    ret               ; è¿”å›è°ƒç”¨è€…</span><br></pre></td></tr></table></figure>
<p>å†…æ ¸çš„<code>sys_sleep</code>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line">uint64 <span class="title function_">sys_sleep</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  uint ticks0;</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;n);</span><br><span class="line">  <span class="keyword">if</span>(n &lt; <span class="number">0</span>)</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">  acquire(&amp;tickslock);</span><br><span class="line">  ticks0 = ticks;</span><br><span class="line">  <span class="keyword">while</span>(ticks - ticks0 &lt; n)&#123;</span><br><span class="line">    <span class="keyword">if</span>(killed(myproc()))&#123;</span><br><span class="line">      release(&amp;tickslock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(&amp;ticks, &amp;tickslock);</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;tickslock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç”¨æˆ·æ€ä¸­ä¼ å…¥çš„å‚æ•°ä¼šé€šè¿‡<code>argint</code>è·å–ï¼Œ<code>n</code>å³ä»£è¡¨ç¡çœ å¤šå°‘ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œæ¯ä¸€è¿‡ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œ<code>clockintr()</code>éƒ½ä¼šä½¿å…¨å±€å˜é‡<code>ticks</code>åŠ  1ï¼Œä»¥æ­¤æ¨¡æ‹Ÿæ—¶é—´çš„å˜åŒ–ã€‚ä¸ºäº†ä¿æŠ¤å…±äº«å˜é‡<code>ticks</code>ï¼Œå®ç°ä¸­ä½¿ç”¨äº†è‡ªæ—‹é”<code>tickslock</code>æ¥ä¿æŠ¤å¯¹å˜é‡<code>ticks</code>çš„è¯»å†™ï¼Œå¦‚å‰é¢æ—¶é’Ÿä¸­æ–­å¯¹<code>ticks</code>çš„å†™æ“ä½œï¼Œä»¥åŠä¸Šé¢å¯¹<code>ticks</code>çš„è¯»æ“ä½œã€‚</p>
<p><code>acquire()</code>è·å¾—é”åï¼Œé€šè¿‡<code>sleep(&amp;ticks, &amp;tickslock)</code>å®ç°å•æ¬¡ tick çš„è¿›ç¨‹ç¡çœ æ¨¡æ‹Ÿã€‚è¿™ä¸ªè¿‡ç¨‹äº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼šè¿›ç¨‹å¸¦ç€é”<code>tickslock</code>ç¡çœ ï¼Œé‚£ä¹ˆæ—¶é’Ÿä¸­æ–­å°±æ— æ³•ä¿®æ”¹<code>ticks</code>ã€‚ä¸è¿‡æˆ‘ä»¬çœ‹<code>sleep</code>çš„å®ç°å¯ä»¥çŸ¥é“ï¼Œè¿‡ç¨‹ä¼šå…ˆè·å¾—è¿›ç¨‹çš„é”<code>acquire(&amp;p-&gt;lock)</code>å†é‡Šæ”¾<code>ticks</code>çš„é” <code>release(lk)</code>ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿæ­»é”ï¼</p>
<p>è¿›ç¨‹çš„é”çš„ä½œç”¨ä»¥åŠ<code>sleep</code>æ¥ä¸‹æ¥çš„å…·ä½“è¡Œä¸ºæ¶‰åŠ xv6 <code>process</code>è¿›ç¨‹æ¦‚å¿µçš„å®šä¹‰ï¼Œä¼šåœ¨æŠ¥å‘Šåé¢è§£é‡Šåˆ†æåå†å›è¿‡æ¥çœ‹<code>void sleep(void *chan, struct spinlock *lk)</code>ã€‚</p>
<hr>
<p>ä»¥ä¸‹ä¸ºæµ‹è¯•ç»“æœï¼š<br>
<img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/sleep.png" alt="sleep.png"></p>
<h1 id="pingpong"><a class="markdownIt-Anchor" href="#pingpong"></a> pingpong</h1>
<blockquote>
<p>Write a user-level program that uses xv6 system calls to â€˜â€˜ping-pongâ€™â€™ a byte between two processes over a pair of pipes, one for each direction. The parent should send a byte to the child; the child should print â€œ&lt;pid&gt;: received pingâ€, where &lt;pid&gt; is its process ID, write the byte on the pipe to the parent, and exit; the parent should read the byte from the child, print â€œ&lt;pid&gt;: received pongâ€, and exit.</p>
</blockquote>
<p>æ³¨æ„åŒ¿åç®¡é“çš„æ•°æ®ä¼ è¾“æ˜¯å•å‘çš„ï¼Œä¸ºäº†åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´åŒå‘åœ°ä¼ é€’æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ªç®¡é“ï¼šä¸€ä¸ªæ•°æ®ä»çˆ¶è¿›ç¨‹æµå‘å­è¿›ç¨‹ï¼Œå¦ä¸€ä¸ªæ•°æ®ä»å­è¿›ç¨‹æµå‘çˆ¶è¿›ç¨‹ã€‚è¿‡ç¨‹ä¸ºï¼š</p>
<ol>
<li>çˆ¶è¿›ç¨‹å‘é€æ¶ˆæ¯ç»™å­è¿›ç¨‹</li>
<li>å­è¿›ç¨‹è¯»åˆ°æ¶ˆæ¯å¹¶å“åº”åˆ°ç»ˆç«¯</li>
<li>å­è¿›ç¨‹å‘é€æ¶ˆæ¯ç»™çˆ¶è¿›ç¨‹</li>
<li>çˆ¶è¿›ç¨‹æ¥æ”¶æ¶ˆæ¯å¹¶å“åº”åˆ°ç»ˆç«¯</li>
</ol>
<p>ç¬¬ä¸€æ¬¡å®ç°å‘ç°æ‰“å°å‡ºæ¥çš„æ¶ˆæ¯ç›¸äº’äº¤å‰ï¼Œäº§ç”Ÿ<strong>ç»ˆç«¯è¾“å‡ºç«äº‰</strong>ï¼<br>
<img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/pingpong_failed.png" alt="pingpong_failed.png"><br>
å‘ç°é—®é¢˜åæˆ‘çŒœæµ‹äº†å‡ºé”™çš„å¯èƒ½æ˜¯ xv6 æä¾›çš„ <code>read</code>/<code>write</code>æ²¡æœ‰å®ç°äº’æ–¥ï¼Œå³ä¸ä¿éšœåŸå­æ€§ï¼ˆå¯èƒ½æ€§å¾ˆå°â€¦ï¼‰ï¼Œ<strong>ç”±äº parent å’Œ child ä¹‹é—´æ²¡æœ‰åŒæ­¥</strong>ï¼Œå¯¼è‡´ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶é€šè¿‡<code>printf()</code>å‘ç»ˆç«¯è¾“å‡ºï¼Œå¯¼è‡´äº† race condition ã€‚</p>
<p>ç”±äºæˆ‘ä»¬ä½¿ç”¨ç®¡é“ï¼ˆä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼‰è¿›è¡Œè¯»å†™ï¼Œ<code>sys_read</code>å’Œ<code>sys_write</code>åˆ†åˆ«è°ƒç”¨çš„<code>fileread</code>å’Œ<code>filewrite</code>ä¼šæ¥ç€è°ƒç”¨<code>piperead</code>å’Œ<code>pipewrite</code>ã€‚åœ¨å¯¹ç®¡é“è¿›è¡Œæ“ä½œä¹‹å‰ï¼Œä¼šå°è¯•<code>acquire(&amp;pi-&gt;lock)</code>ï¼Œå› æ­¤å¯ä»¥ä¿è¯ <code>read</code>/<code>write</code>çš„åŸå­æ€§ã€‚</p>
<p>æ—¢ç„¶<code>read</code>/<code>write</code>æ»¡è¶³åŸå­æ€§ï¼Œé‚£å°±æ˜¯çˆ¶å­è¿›ç¨‹ä¹‹é—´åŒæ­¥çš„é€»è¾‘ç¼–å†™ä¸Šå‡ºç°äº†é—®é¢˜ï¼Œäºæ˜¯å‘ç°ç¡®å®å¦‚æ­¤ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éƒ¨åˆ†é€»è¾‘ä»£ç </span></span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="comment">// Child process</span></span><br><span class="line">  read();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d: received ping\n&quot;</span>, getpid());</span><br><span class="line">  write();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="comment">// Parent process</span></span><br><span class="line">  write();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, getpid());   <span class="comment">// Fault!!</span></span><br><span class="line">  read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­è¿›ç¨‹è°ƒç”¨<code>read</code>ä¼šè¢«é˜»å¡ï¼Œä½†å½“çˆ¶è¿›ç¨‹<code>write</code>æ—¶ï¼Œå­è¿›ç¨‹æ¥æ”¶æ¶ˆæ¯ï¼Œç„¶åä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è°ƒç”¨<code>printf</code>å‘ç»ˆç«¯è¾“å‡ºï¼æ­£ç¡®çš„é€»è¾‘åº”è¯¥æ˜¯çˆ¶è¿›ç¨‹è°ƒç”¨<code>read</code>è¢«é˜»å¡ï¼Œç›´åˆ°å­è¿›ç¨‹<code>write</code>æ‰ä¼šè°ƒç”¨<code>printf</code>ã€‚æ­£ç¡®é€»è¾‘ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parent process</span></span><br><span class="line">write();</span><br><span class="line">read();   <span class="comment">// Block until child call write to pipe</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, getpid());</span><br></pre></td></tr></table></figure>
<p><img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/pingpong_succeed.png" alt="pingpong_succeed.png"></p>
<hr>
<p>å›è¿‡å¤´æ¥æˆ‘ä»¬å†çœ‹<code>printf</code>ç«äº‰çš„å…·ä½“è¿‡ç¨‹ã€‚<code>printf</code>åœ¨<code>va_start</code>è§£æå®Œå‚æ•°åˆ—è¡¨åè°ƒç”¨<code>vprintf</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/printf.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vprintf</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span>&#123;</span><br><span class="line">  <span class="type">char</span> *s;</span><br><span class="line">  <span class="type">int</span> c, i, state;</span><br><span class="line"></span><br><span class="line">  state = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; fmt[i]; i++)&#123;</span><br><span class="line">    c = fmt[i] &amp; <span class="number">0xff</span>;   <span class="comment">// Question</span></span><br><span class="line">    <span class="keyword">if</span>(state == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(c == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">        state = <span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        putc(fd, c);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(state == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(c == <span class="string">&#x27;d&#x27;</span>)&#123;</span><br><span class="line">        printint(fd, va_arg(ap, <span class="type">int</span>), <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;l&#x27;</span>) &#123;</span><br><span class="line">        printint(fd, va_arg(ap, uint64), <span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;x&#x27;</span>) &#123;</span><br><span class="line">        printint(fd, va_arg(ap, <span class="type">int</span>), <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;p&#x27;</span>) &#123;</span><br><span class="line">        printptr(fd, va_arg(ap, uint64));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;s&#x27;</span>)&#123;</span><br><span class="line">        s = va_arg(ap, <span class="type">char</span>*);</span><br><span class="line">        <span class="keyword">if</span>(s == <span class="number">0</span>)</span><br><span class="line">          s = <span class="string">&quot;(null)&quot;</span>;</span><br><span class="line">        <span class="keyword">while</span>(*s != <span class="number">0</span>)&#123;</span><br><span class="line">          putc(fd, *s);</span><br><span class="line">          s++;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;c&#x27;</span>)&#123;</span><br><span class="line">        putc(fd, va_arg(ap, uint));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(c == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">        putc(fd, c);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Unknown % sequence.  Print it to draw attention.</span></span><br><span class="line">        putc(fd, <span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">        putc(fd, c);</span><br><span class="line">      &#125;</span><br><span class="line">      state = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">putc</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> c)</span>&#123;</span><br><span class="line">  write(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒå°†æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶æè¿°ç¬¦ä¸º<code>fd</code>çš„æ–‡ä»¶ä¸­ï¼Œåœ¨<code>printf</code>ä¸­ä¼ å…¥ 1ï¼Œå³æ ‡å‡†è¾“å‡ºã€‚é™¤å»è½¬ä¹‰å­—ç¬¦å¤„ç†è¿‡ç¨‹ï¼Œ<code>vprintf</code>çš„æ ¸å¿ƒæ˜¯<code>putc</code>ï¼Œå³å•ä¸ªå­—ç¬¦çš„è¾“å‡ºã€‚<code>putc</code>è°ƒç”¨<code>write</code>ç³»ç»Ÿè°ƒç”¨æ˜¯åŸå­çš„ï¼Œä½†å¯¹æ•´ä¸ªå­—ç¬¦ä¸²çš„è¾“å‡ºä¸æ˜¯åŸå­çš„ï¼Œå› æ­¤ä¸Šé¢ parent å’Œ child ä¸¤ä¸ª<code>putc</code>æµå°±äº¤æ›¿åœ¨äº†ä¸€èµ·å¹¶å‘åœ°è¾“å‡ºå­—ç¬¦ä¸²ã€‚</p>
<blockquote>
<p><code>vprintf</code>ä¸­çš„ä¸€ä¸ªç–‘é—®ï¼š<code>c = fmt[i] &amp; 0xff</code>çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸å£°æ˜ <code>c</code>ä¸º charï¼Ÿ</p>
</blockquote>
<p><code>c</code>è¢«å£°æ˜ä¸º int ç±»å‹ï¼Œ<code>fmt[i]</code>æ˜¯æœ‰ç¬¦å·çš„ char ç±»å‹ï¼Œå¦‚æœ<code>fmt[i]</code>æ˜¯è´Ÿæ•°ï¼ˆå¦‚<code>0x80</code>ï¼‰ï¼Œé‚£ä¹ˆç›´æ¥èµ‹ç»™ int ä¼šè¿›è¡Œç¬¦å·æ‰©å±•ï¼Œå¯¼è‡´<code>c</code>çš„å€¼å˜ä¸º<code>0xffffff80</code>ï¼Œæ˜¾ç„¶ä¸åœ¨ ASCII ç¼–ç çš„èŒƒå›´å†…ï¼ˆ0~255ï¼‰ã€‚ <code>fmt[i] &amp; 0xff</code>Â  ä¼šå¼ºåˆ¶å°† Â <code>fmt[i]</code>Â  è½¬æ¢ä¸º â€‹<strong>â€‹ æ— ç¬¦å· 8 ä½å€¼ â€‹</strong>â€‹ï¼Œæ¸…é™¤é«˜ä½ç¬¦å·æ‰©å±•ï¼Œç¡®ä¿ Â <code>c</code>Â  å§‹ç»ˆæ˜¯ Â <code>0~255</code>Â  çš„æ­£æ•°ã€‚æ­¤å¤„å£°æ˜<code>c</code>ä¸º int æ˜¯ä¸ºäº†åŒ¹é…æ ‡å‡†åº“çš„ Â <code>getc</code>/<code>putc</code> çš„è§„èŒƒ â€‹ã€‚</p>
<hr>
<h1 id="find"><a class="markdownIt-Anchor" href="#find"></a> find</h1>
<blockquote>
<p>Write a simple version of the UNIX <code>find</code> program for xv6: find all the files in a directory tree with a specific name.</p>
</blockquote>
<p>è¿™ä¸ªä»»åŠ¡çš„å®Œæˆæ¶‰åŠ xv6 æ–‡ä»¶ç³»ç»Ÿæ¥å£ä»¥åŠâ€œæ–‡ä»¶â€çš„å®šä¹‰ã€‚åœ¨å®ç°ä¹‹å‰éœ€è¦å‚è€ƒ<code>ls</code>çš„å®ç°æ¥åˆæ­¥äº†è§£ file systemã€‚</p>
<hr>
<p><strong>æ–‡ä»¶æè¿°ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//--------kernel/fs.h----------//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DIRSIZ 14</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> &#123;</span></span><br><span class="line">  ushort inum;</span><br><span class="line">  <span class="type">char</span> name[DIRSIZ];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//------------------------------//</span></span><br><span class="line"><span class="comment">//--------kernel/stat.h---------//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_DIR     1   <span class="comment">// Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_FILE    2   <span class="comment">// File</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_DEVICE  3   <span class="comment">// Device</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> dev;     <span class="comment">// File system&#x27;s disk device</span></span><br><span class="line">  uint ino;    <span class="comment">// Inode number</span></span><br><span class="line">  <span class="type">short</span> type;  <span class="comment">// Type of file</span></span><br><span class="line">  <span class="type">short</span> nlink; <span class="comment">// Number of links to file</span></span><br><span class="line">  uint64 size; <span class="comment">// Size of file in bytes</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ–‡ä»¶åä¸èƒ½å”¯ä¸€æè¿°æ–‡ä»¶æœ¬èº«ï¼Œå¯¹äºæ¯ä¸ªæ–‡ä»¶ä½¿ç”¨å”¯ä¸€çš„<code>inode</code>ï¼ˆ32-bits æ— ç¬¦å· intï¼‰æ¥é™å®šã€‚Unix å°†èµ„æºè§†ä½œæ–‡ä»¶ï¼Œå› æ­¤è®¾å¤‡ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼Œé€šè¿‡<code>T_DEVICE</code>æ¥å®šä¹‰ã€‚åŒæ—¶ï¼Œæ–‡ä»¶å¤¹ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼ˆ<code>T_DIR</code>ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªç›®å½•æ¡ç›®<code>dirent</code>çš„åºåˆ—ï¼Œå…¶ä¸­æ¯ä¸ª<code>dirent</code>æ˜¯<code>inode</code>å¼•ç”¨å’Œæ–‡ä»¶å<code>name</code>çš„åºåˆ—å¯¹ã€‚æ–‡ä»¶çŠ¶æ€<code>stat</code>ä¸­çš„å­—æ®µ<code>nlink</code>æ˜¯æŒ‡æ‰€æœ‰è¿æ¥åˆ°è¯¥<code>inode</code>ä¸Šçš„æ–‡ä»¶ï¼Œå¯¹è¿™äº›æ–‡ä»¶çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šæ˜ å°„åˆ°åŒä¸€ inode ä¸Šã€‚</p>
<p><strong>æ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system call</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span>, <span class="type">void</span>*, <span class="type">int</span>)</span>;            <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span>)</span>;                       <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">int</span>)</span>;           <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mknod</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">short</span>, <span class="type">short</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fstat</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> stat*)</span>;      <span class="comment">// âˆš</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">link</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">mkdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">chdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ulib.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">stat</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="keyword">struct</span> stat*)</span>;  <span class="comment">// âˆš</span></span><br></pre></td></tr></table></figure>
<ol>
<li><code>open</code> ä¸ <code>fstat</code> ç³»ç»Ÿè°ƒç”¨çš„è§£è€¦ä»¥åŠç”¨æˆ·æ€<code>stat</code>åº“å‡½æ•°ï¼š</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/ls.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ls</span><span class="params">(<span class="type">char</span> *path)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>((fd = open(path, O_RDONLY)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(fstat(fd, &amp;st) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span>(st.type)&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">case</span> T_DIR:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">while</span>(read(fd, &amp;de, <span class="keyword">sizeof</span>(de)) == <span class="keyword">sizeof</span>(de))&#123;</span><br><span class="line">      <span class="keyword">if</span>(de.inum == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      memmove(p, de.name, DIRSIZ);</span><br><span class="line">      p[DIRSIZ] = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// <span class="doctag">NOTE:</span> buf is the path to file</span></span><br><span class="line">      <span class="keyword">if</span>(stat(buf, &amp;st) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ls: cannot stat %s\n&quot;</span>, buf);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ ls çš„æŸ¥è¯¢æ–‡ä»¶å®ä¾‹ä¸­ï¼Œä¼ å…¥çš„<code>path</code>ä¼šè¢«ä½œä¸º<code>open</code>ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼ŒæˆåŠŸæ‰“å¼€æ–‡ä»¶å¾—åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptï¼‰ã€‚æ¥ä¸‹æ¥è°ƒç”¨<code>fstat</code>çš„ç³»ç»Ÿè°ƒç”¨ä¼šè§£æè¯¥æ–‡ä»¶çš„çŠ¶æ€<code>stat</code>ï¼Œè¿™é‡Œæˆ‘ä»¬æœ€å…³å¿ƒçš„å­—æ®µæ˜¯æ–‡ä»¶ç±»å‹ <code>type</code> ã€‚</p>
<p>æ ¹æ®æ–‡ä»¶çš„ä¸åŒç±»å‹å¯¹æ–‡ä»¶ä¿¡æ¯çš„è¾“å‡ºä¹Ÿä¸åŒã€‚å¦‚æœæ˜¯æ–‡ä»¶ç›®å½•çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦éå†è¯¥ç›®å½•ï¼š<code>while(read(fd, &amp;de, sizeof(de)) == sizeof(de))</code>ã€‚æ¯æ¬¡<code>read</code>è¯»å–ä¸€ä¸ªç›®å½•æ¡ç›®å¹¶å†™åœ¨ <code>struct stat de</code>ä¸­ã€‚ä¹‹åä¸€ç³»åˆ—å¯¹<code>buf</code>å†™å…¥çš„ç»“æœæ˜¯å®ƒä¿å­˜äº†æºç›®å½•ä¸‹çš„å•ä¸ªæ–‡ä»¶ï¼ˆå½“ç„¶å®ƒå¯ä»¥æ˜¯æ–‡ä»¶ï¼Œè®¾å¤‡æˆ–è€…å­ç›®å½•ï¼‰ã€‚</p>
<p>ä¸ºäº†ç»§ç»­è¯»å–è¯¥æ–‡ä»¶çš„çŠ¶æ€ï¼ŒåŸæœ¬åº”è¯¥åƒä¸€å¼€å§‹ä¸€æ ·å…ˆæ‰“å¼€æ–‡ä»¶å†è§£æï¼Œè€Œ <code>ls</code> ç›´æ¥è°ƒç”¨äº†ä¸€ä¸ªåº“å‡½æ•° <code>stat</code>ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯å°è£…äº† <code>open</code> ï¼Œ<code>fstat</code> å’Œ <code>close</code> ä¸‰ä¸ª syscall ã€‚</p>
<ol start="2">
<li>å†çœ‹ç³»ç»Ÿè°ƒç”¨ <code>read</code></li>
</ol>
<ul>
<li>å¯¹äºæ–‡ä»¶çš„ readï¼š<br>
åœ¨<code>find</code>çš„å®ç°ä¸­ï¼Œå¯¹äº<code>T_FILE</code>çš„å¤„ç†æˆ‘ç…§æ¬äº† <code>read(fd, &amp;de, sizeof(de))</code> ï¼Œä½¿å¾—æŸ¥è¯¢é€»è¾‘å‡ºé”™ã€‚å®é™…ä¸Šå¯¹äº file æˆ‘æ²¡æœ‰å¿…è¦å»è§£ææ–‡ä»¶çŠ¶æ€ï¼ˆéœ€è¦çš„è¯å®é™…ä¸Šä¹Ÿå› è¯¥æ˜¯ç”¨ <code>stat</code> ï¼‰ï¼Œç›´æ¥æå– <code>path</code> ä¸­çš„ base name å°±è¡Œäº†ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_FILE:</span><br><span class="line">  p = path + <span class="built_in">strlen</span>(path) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>(*p != <span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">	p--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">strcmp</span>(p+<span class="number">1</span>, filename) == <span class="number">0</span>)&#123;</span><br><span class="line">	  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, path);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯¹äºè®¾å¤‡æ–‡ä»¶çš„<code>read</code>ï¼š<br>
ä¸€å¼€å§‹æˆ‘å¿˜è®°äº†è¿˜æœ‰è®¾å¤‡è¿™ç§æ–‡ä»¶ï¼Œäºæ˜¯æ¯æ¬¡è¯»åˆ°<code>/console</code>éƒ½ä¼šè·³åˆ°æˆ‘çš„ default è¯­å¥ã€‚åé¢æ„è¯†åˆ°åæŠŠ <code>T_DEVICE</code> çš„å¤„ç†å’Œ <code>T_FILE</code> å’Œåˆ°äº†ä¸€èµ·ï¼Œè€Œæˆ‘çš„ file å¤„ç†é€»è¾‘ä¸­åˆæœ‰é”™è¯¯çš„ <code>read</code>ï¼Œæ­¤æ—¶å‡ºç°ä¸€ä¸ªå·¨å¤§çš„ error ï¼š<code>read</code> è¯»å–è®¾å¤‡æ–‡ä»¶ä¸ä¼šé€šè¿‡æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯è°ƒç”¨çš„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œäº§ç”Ÿé˜»å¡ï¼å› æ­¤æ¯æ¬¡è¯»åˆ°<code>/console</code>å°±å¡æ­»äº† ğŸ˜¦</li>
</ul>
<hr>
<p>äº†è§£äº† xv6 åŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿå®šä¹‰ <code>find</code> çš„å¤„ç†é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼Œå…¶å®å’Œ <code>ls</code> çš„å·®åˆ«åªåœ¨å¯¹äº file å’Œ device æˆ‘ä»¬ä¸ç”¨è§£ææ–‡ä»¶çŠ¶æ€ã€‚æ ¹æ®æœ€åˆçš„ path æˆ‘ä»¬è§£ææŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼šå¦‚æœæ˜¯è®¾å¤‡æˆ–è€…æ–‡ä»¶ï¼Œæˆ‘ä»¬åŒ¹é… file name å¹¶ç›´æ¥æ‰“å°è·¯å¾„ï¼›å¦‚æœæ˜¯æ–‡ä»¶ç›®å½•ï¼Œæˆ‘ä»¬åˆ™éœ€è¦å¾ªç¯è¯»å–æ¯ä¸€ä¸ªæ¡ç›®å¹¶é€’å½’ <code>find</code> ã€‚</p>
<p>å®è·µä¸­æœ‰ä¸€ä¸ªç‚¹æˆ‘æ²¡æœ‰æ³¨æ„åˆ°ï¼Œé‚£å°±æ˜¯ç›®å½•æ–‡ä»¶çš„åºåˆ—ä¸­æœ‰ä¸¤ä¸ªæ¡ç›®ï¼Œåˆ†åˆ«æ˜¯å½“å‰ç›®å½• <code>&quot;.&quot;</code> å’Œä¸Šä¸€ä¸ªç›®å½• <code>&quot;..&quot;</code> ï¼Œä¸èƒ½é€’å½’è¿›å»ï¼å®é™…ä¸Š Lab å¯¹æ­¤è¡Œä¸ºæœ‰æé†’ï¼š</p>
<blockquote>
<p><strong>Donâ€™t recurse into â€œ.â€ and â€œâ€¦â€.</strong></p>
</blockquote>
<p><img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/find.png" alt="find.png"></p>
<h1 id="xargs"><a class="markdownIt-Anchor" href="#xargs"></a> xargs</h1>
<blockquote>
<p>Write a simple version of the UNIX xargs program for xv6: its arguments describe a command to run, it reads lines from the standard input, and it runs the command for each line, appending the line to the commandâ€™s arguments.</p>
</blockquote>
<p>è¿™é‡Œæˆ‘æ²¡æœ‰ç†è§£å¥½ <code>xargs</code> çš„åŠŸèƒ½ï¼Œè¯¯ä»¥ä¸ºæŠŠæ‰€æœ‰çš„ stdin ç»“åˆèµ·æ¥ç„¶åä¼ é€’åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤ä½œä¸ºå‚æ•°ã€‚å®é™…ä¸Šåº”è¯¥æ¯è¯»å–ä¸€è¡Œä½œä¸ºä¸€ä¸ª append çš„å‚æ•°æ‰§è¡Œ <code>xargs</code> åé¢çš„æŒ‡ä»¤ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> from world | xargs <span class="built_in">echo</span> hello</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç¬¬ä¸€ä¸ª <code>echo</code> ä¼šè¾“å‡ºåˆ° stdout <code>from world\n</code>ï¼Œ<code>xargs</code> ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ä¸€è¡Œï¼Œç„¶ååŠ åœ¨ <code>echo hello</code> è¿™ä¸ªâ€œå‘½ä»¤â€åé¢ï¼Œå½¢æˆ <code>echo hello from world\n</code>ã€‚</p>
<p>æ³¨æ„æ¯æ¬¡è¯»å–ä¸€è¡Œéƒ½éœ€è¦å»é™¤æœ«å°¾çš„æ¢è¡Œç¬¦ï¼ŒåŒæ—¶æ³¨æ„ä¼ é€’ç»™ <code>exec</code> çš„ <code>argv[]</code> çš„æœ€åä¸€ä¸ªå‚æ•°å¾—æ˜¯ <code>NULL</code> ï¼<br>
<img src="/2025/05/06/Lab%20-%20xv6%20and%20Unix%20utilities/xargs.png" alt="xargs.png"></p>
</article><div class="tag_share"><div class="post_share"><div class="social-share" data-image="../../../../img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="../../15/Lab-System%20Calls/" title="6.s081 Lab: System Calls"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">6.s081 Lab: System Calls</div></div></a></div><div class="next-post pull-right"><a href="../../../04/28/SYSU%20W4terCTF%202025/" title="SYSU W4terCTF 2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">SYSU W4terCTF 2025</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="../../../../img/avatar.jpg" onerror="this.onerror=null;this.src='../../../../img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">è˜‹æœ«é£</div><div class="author-info__description">éšç¼˜æ›´å„ç§æ‚ä¸ƒæ‚å…«çš„ä¸œè¥¿</div></div><div class="card-info-data site-data is-center"><a href="../../../../archives/"><div class="headline">æ–‡ç« </div><div class="length-num">27</div></a><a href="../../../../tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="../../../../categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Akane0238" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="../../../../mailto:qweasd28848@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sleep"><span class="toc-number">1.</span> <span class="toc-text"> sleep</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pingpong"><span class="toc-number">2.</span> <span class="toc-text"> pingpong</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#find"><span class="toc-number">3.</span> <span class="toc-text"> find</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#xargs"><span class="toc-number">4.</span> <span class="toc-text"> xargs</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="" title="6.s081 Lab: Copy-on-Write Fork">6.s081 Lab: Copy-on-Write Fork</a><time datetime="2025-07-17T13:39:26.689Z" title="å‘è¡¨äº 2025-07-17 21:39:26">2025-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="../../16/Lab-Locks/" title="6.s081 Lab: Locks">6.s081 Lab: Locks</a><time datetime="2025-07-16T07:32:21.288Z" title="å‘è¡¨äº 2025-07-16 15:32:21">2025-07-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="../../08/Lab-Traps/" title="6.s081 Lab: Traps">6.s081 Lab: Traps</a><time datetime="2025-07-08T13:09:32.852Z" title="å‘è¡¨äº 2025-07-08 21:09:32">2025-07-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="../../05/Lab-Page%20Tables/" title="6.s081 Lab: Page Tables">6.s081 Lab: Page Tables</a><time datetime="2025-07-05T09:18:36.952Z" title="å‘è¡¨äº 2025-07-05 17:18:36">2025-07-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="../../../05/19/Operating-System-Concepts-Ch8&amp;Ch9/" title="Operating System Concepts: Memory Management">Operating System Concepts: Memory Management</a><time datetime="2025-05-19T13:32:29.399Z" title="å‘è¡¨äº 2025-05-19 21:32:29">2025-05-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="../../../../js/utils.js?v=4.13.0"></script><script src="../../../../js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>